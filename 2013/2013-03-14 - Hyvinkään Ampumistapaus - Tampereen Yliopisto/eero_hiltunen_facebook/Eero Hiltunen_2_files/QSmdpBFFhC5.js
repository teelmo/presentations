/*1337934321,176820662*/

if (window.CavalryLogger) { CavalryLogger.start_js(["hZ7Kb"]); }

__d("legacy:MusicButtonManager",["MusicButtonManager"],function(a,b,c,d){a.MusicButtonManager=b('MusicButtonManager');},3);
__d("legacy:CompactTypeaheadRenderer",["CompactTypeaheadRenderer"],function(a,b,c,d){if(!a.TypeaheadRenderers)a.TypeaheadRenderers={};a.TypeaheadRenderers.compact=b('CompactTypeaheadRenderer');},3);
__d("notifications-counter",["Arbiter","DocumentTitle","JSLogger"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('DocumentTitle'),i=b('JSLogger'),j={messages:0,notifications:0,requests:0};a.NotificationCounter=e.exports={init:function(){g.subscribe('update_title',this._handleUpdate.bind(this));g.subscribe('jewel/count-updated',this._handleCountUpdate.bind(this));},getCount:function(){var k=0;for(var l in j){var m=Number(j[l]);if(typeof j[l]=='string'&&isNaN(m))return j[l];if(isNaN(m)||m<0){i.create('jewels').error('bad_count',{jewel:l,count:j[l]});continue;}k+=m;}return k;},updateTitle:function(){var k=this.getCount(),l=h.get();l=k?'('+k+') '+l:l;h.set(l,true);},_handleCountUpdate:function(k,l){j[l.jewel]=l.count;this.updateTitle();},_handleUpdate:function(k,l){this.updateTitle();}};},3);
__d("FBDesktopPlugin",["$","DOM","Env","FBDesktopDetect","HTML","URI"],function(a,b,c,d,e,f){var g=b('$'),h=b('DOM'),i=b('Env'),j=b('FBDesktopDetect'),k=b('HTML'),l=b('URI'),m={_plugin:'_not_checked',getPlugin:function(){if(this._plugin==='_not_checked'){this._plugin=null;if(j.isPluginInstalled()){var n=h.create('div');document.body.appendChild(n);h.setContent(n,k('<object id="kiwi_plugin" '+'type="'+j.mimeType+'" width="0" height="0">'+'</object>'));this._plugin=g('kiwi_plugin');}}return this._plugin;},getUserID:function(){var n=this.getPlugin();return n&&'getUserID' in n&&n.getUserID();},isAppRunning:function(){var n=this.getPlugin();return n&&'isAppRunning' in n&&n.isAppRunning();},logout:function(n){n=n||"0";var o=this.getPlugin();if(o)o.logout(n);},recheck:function(){if(this._plugin===null)this._plugin='_not_checked';},shouldSuppressBeeper:function(){return this.isAppRunning();},shouldSuppressUserMessages:function(){var n=this.getUserID();if(n){return n===i.user;}else return this.isAppRunning();},shouldSuppressSidebar:function(){var n=this.getPlugin();return n&&'isAppDocked' in n&&n.isAppDocked();},transferAuthToken:function(n,o){if(n&&n.length>0){var p=this.getPlugin();if(p){p.setAccessToken(n,o);var q=setInterval(function(){p.setAccessToken(n,o);},500);setTimeout(function(){clearInterval(q);},10*1000);}}if(this.redirectHome)window.location.href=l().setPath().toString();}};e.exports=m;});
__d("legacy:fbdesktop-plugin",["FBDesktopPlugin"],function(a,b,c,d){a.FbDesktopPlugin=b('FBDesktopPlugin');},3);
function FriendBrowserCheckboxController(){}copy_properties(FriendBrowserCheckboxController,{instances:{},getInstance:function(a){return this.instances[a];}});copy_properties(FriendBrowserCheckboxController.prototype,{init:function(a,b){FriendBrowserCheckboxController.instances[a]=this;this._id=a;this._form=b;this._contentGrid=DOM.find(b,'.friendBrowserCheckboxContentGrid');this._loadingIndicator=DOM.find(b,'.friendBrowsingCheckboxContentLoadingIndicator');this._checkboxResults=DOM.find(b,'.friendBrowserCheckboxResults');this._contentPager=DOM.find(b,'.friendBrowserCheckboxContentPager');this.numGetNewRequests=0;this.queuedRequests={};},addTypeahead:function(a,b){a.subscribe('select',this.onHubSelect.bind(this,a,b));},onHubSelect:function(a,b,event,c){if(!((event=='select')&&c.selected))return;var d=this.buildNewCheckbox(b,c.selected.text,c.selected.uid),e=DOM.find(this._form,'.checkboxes_'+b);DOM.appendContent(e.firstChild,d);var f=DOM.scry(a.getElement(),'input[type="button"]');if(f&&f[0])f[0].click();this.getNew(true);},buildNewCheckbox:function(a,b,c){var d=a+'_ids_'+c,e=a+'_ids[]',f=$N('input',{id:d,type:'checkbox',value:c,name:e,checked:true});Event.listen(f,'click',bind(this,'getNew',false));var g=$N('td',null,f);CSS.addClass(g,'vTop');CSS.addClass(g,'hLeft');var h=$N('label',null,b),i=$N('td',null,h);CSS.addClass(i,'vMid');CSS.addClass(i,'hLeft');var j=$N('tr');j.appendChild(g);j.appendChild(i);return j;},showMore:function(){var a=DOM.scry(this._contentPager,'.friendBrowserMorePager')[0];if(!a)return false;if(CSS.hasClass(a,'async_saving'))return false;var b=this.numGetNewRequests,c=Form.serialize(this._form);c.show_more=true;var d=new AsyncRequest().setURI('/ajax/growth/friend_browser/checkbox.php').setData(c).setHandler(bind(this,function(e){this.showMoreHandler(e,b);})).setStatusElement(a).send();},showMoreHandler:function(a,b){if(b==this.numGetNewRequests){var c=a.payload;DOM.appendContent(this._contentGrid,c.results);this.updatePagerAndExtraData(c.pager,c.extra_data);}},getNew:function(a){this.numGetNewRequests++;var b=this.numGetNewRequests;CSS.addClass(this._checkboxResults,'friendBrowserCheckboxContentOnload');if(ge('friendBrowserCI'))CSS.addClass($('friendBrowserCI'),'friendBrowserCheckboxContentOnload');CSS.show(this._loadingIndicator);var c=Form.serialize(this._form);c.used_typeahead=a;new AsyncRequest().setURI('/ajax/growth/friend_browser/checkbox.php').setData(c).setHandler(bind(this,function(d){this.getNewHandler(d,b);})).send();},getNewHandler:function(a,b){if(b==this.numGetNewRequests){var c=a.payload;DOM.setContent(this._contentGrid,c.results);CSS.removeClass(this._checkboxResults,'friendBrowserCheckboxContentOnload');if(ge('friendBrowserCI'))CSS.hide($('friendBrowserCI'));CSS.hide(this._loadingIndicator);this.updatePagerAndExtraData(c.pager,c.extra_data);}},updatePagerAndExtraData:function(a,b){DOM.setContent(this._contentPager,a);this.setupOnVisible();DOM.replace(this._form.elements.extra_data,b);},setupOnVisible:function(){var a=DOM.scry(this._contentPager,'.friendBrowserMorePager')[0];if(a&&this._id!='jewel'){this._onVisible&&this._onVisible.remove();this._onVisible=new OnVisible(a,bind(this,'showMore'),false,1000);}}});
function RequestsJewel(){}copy_properties(RequestsJewel.prototype,{init:function(a,b,c){this.countNew=0;this.jewel=a;this.jewelFlyoutCase=a.getRoot();this.jewelFlyout=ge('fbRequestsFlyout');this.newCountSpan=ge('newRequestCount');this.folder=b;this.doNewMarkRead=c;this._requestList={};this._requestCount=0;var d=ge('requestsMarkReadButton');if(d)Event.listen(d,'click',this._markRead.shield(this));this.jewel.subscribe('marked-seen',this._markSeenCallback.shield(this));this.jewel.subscribe('closed',this._clearNewItems.shield(this));this.jewel.subscribe('updated',this._updateCount.bind(this));this.jewel.subscribe('opened',this._openHandler.bind(this));LinkController.registerHandler(this._handleLink.bind(this));Arbiter.subscribe(ChannelConstants.getArbiterType('jewel/requests/add'),this._addRequest.bind(this));Arbiter.subscribe(ChannelConstants.getArbiterType('jewel/requests/remove_old'),this._removeOldRequest.bind(this));Event.listen(this.jewelFlyout,'submit',function(f){var g=Parent.byClass(f.getTarget(),'objectListItem');if(g){CSS.removeClass(g,'jewelItemNew');CSS.addClass(g,'jewelItemResponded');}}.bind(this));var e=DOM.scry(this.jewelFlyout,'.uiScrollableAreaWrap')[0];if(e){this._scrollableWrap=e;this._lastLinkPosition=0;this._scrollListener=Event.listen(e,'scroll',this._handleScroll.bind(this),Event.Priority._BUBBLE);}return this;},fromDom:function(){DOM.scry(this.jewelFlyout,'.jewelItemList li.objectListItem').forEach(function(a){var b=a.getAttribute('id'),c=b&&parseInt(this._parseID(b).requester,10);if(c&&!isNaN(c)){this._requestList[c]=b;++this._requestCount;}}.bind(this));this._conditionShowEmptyMessage();},_parseID:function(a){var b=a.match(/^(\d+)_(\d+)/);return (b)?{requester:b[1],type:b[2]}:undefined;},_handleLink:function(a,event){var b=Parent.byClass(a,'jewelItemNew');if(b&&Parent.byClass(b,'fbRequestList')&&Parent.byClass(b,'beeperEnabled')){var c=this._parseID(b.id);c&&this._markSeenCallback(c.requester,c.type);Arbiter.inform('jewel/count-updated',{jewel:'requests',count:--this.countNew});CSS.removeClass(b,'jewelItemNew');}return true;},_handleScroll:function(){var a=DOM.scry(this._scrollableWrap,'.uiMorePager')[0];if(a){var b=Vector2.getElementPosition(a,'viewport').y;if(b>0)CSS.addClass(Parent.byClass(this._scrollableWrap,'uiScrollableArea'),'contentAfter');var c=DOM.find(a,'a');if(!c)return;var d=Vector2.getElementPosition(c,'viewport').y;if(d==this._lastLinkPosition)return;var e=Vector2.getElementPosition(this._scrollableWrap,'viewport').y+Vector2.getElementDimensions(this._scrollableWrap).y;if(d-300<e&&d>0){this._lastLinkPosition=d;var f=c.getAttribute('ajaxify');if(f){new AsyncRequest(f).setRelativeTo(c).setStatusElement(Parent.byClass(c,'stat_elem')).send();}else FriendBrowserCheckboxController.getInstance('jewel').showMore();}}},_addRequest:function(a,b){if(!b||this._requestList[b.obj.from])return;var c=DOM.scry(this.jewelFlyout,'.fbRequestList .uiList')[0];if(!c)return;DOM.prependContent(c,b.obj.markup);var d={jewel:'requests',count:++this.countNew};Arbiter.inform('jewel/count-updated',d);this._requestList[b.obj.from]=elem.id;++this._requestCount;this._conditionShowEmptyMessage();},_removeOldRequest:function(a,b){if(!b)return;var c=this._requestList[b.obj.from],d=c&&ge(c);if(d){CSS.hasClass(d,'jewelItemNew')&&Arbiter.inform('jewel/count-updated',{jewel:'requests',count:--this.countNew});if(!CSS.hasClass(d,'jewelItemResponded')){DOM.remove(d);delete this._requestList[c];--this._requestCount;this._conditionShowEmptyMessage();}}},_markRead:function(){this.jewel.markSeen();this._clearNewItems();},_markSeenCallback:function(a,b){new AsyncSignal('/ajax/gigaboxx/endpoint/UpdateLastSeenTime.php',{folder:this.folder}).send();var c=typeof a!='undefined'&&typeof b!='undefined'?{requester:a,type:b}:{};this.doNewMarkRead&&new AsyncSignal('/ajax/requests/mark_read/',c).send();},_removeRequest:function(a,b){var c=b.obj.item_id;if(c){var d=ge(c),e=d&&CSS.hasClass(d,'jewelItemNew');d?DOM.remove(d):false;e&&Arbiter.inform('jewel/count-updated',{jewel:'requests',count:--this.countNew});}},_clearNewItems:function(a,b){DOM.scry(this.jewel.root,'li.jewelItemNew').forEach(function(c){CSS.removeClass(c,'jewelItemNew');});},_updateCount:function(a,b){this.countNew=b.count;CSS.conditionClass(this.jewelFlyout,'beeperUnread',this.countNew>0);CSS.conditionClass(this.jewelFlyoutCase,'showRequests',this.countNew>0);if(this.newCountSpan){var c=this.countNew==1?tx._("{num} UUSI PYYNT\u00d6",{num:this.countNew}):tx._("{num} UUTTA PYYNT\u00d6\u00c4",{num:this.countNew});DOM.setContent(this.newCountSpan,c);}},_conditionShowEmptyMessage:function(){DOM.scry(this.jewelFlyout,'li.empty').forEach(function(a){CSS.conditionShow(a,this._requestCount<=0);}.bind(this));},_openHandler:function(){var a=DOM.scry(this.jewelFlyout,'.uiScrollableArea')[0];a&&ScrollableArea.poke(a);}});
__d("JewelX",["event-extensions","Arbiter","ArbiterMixin","Class","CSS","DOM","HTML","Toggler","copyProperties","userAction"],function(a,b,c,d,e,f){b('event-extensions');var g=b('Arbiter'),h=b('ArbiterMixin'),i=b('Class'),j=b('CSS'),k=b('DOM'),l=b('HTML'),m=b('Toggler'),n=b('copyProperties'),o=b('userAction'),p=function(q,r){q&&r&&this.init(q,r);};n(p,{_instancesByName:{},_resizeListener:null});n(p.prototype,h,{init:function(q,r){this.name=r.name;this.root=q;this.countNew=0;this.initialCount=0;this.disableMarkAllRead=r.disableMarkAllRead||false;p._instancesByName[this.name]=this;m.listen(['show','hide'],this.root,function(s){var t=s==='show';t&&this._logFirstClick();if(!this.disableMarkAllRead){this.hasNew()&&this.markSeen();this.reset();}this.inform(t?'opened':'closed');g.inform(t?'layer_shown':'layer_hidden',{type:'Jewel'});}.bind(this));g.subscribe('jewel/count-updated',function(s,t){t.jewel==this.name&&this.update(t);}.bind(this));g.subscribe('jewel/count-initial',function(s,t){t.jewel==this.name&&this.setInitial(t);}.bind(this));g.subscribe('jewel/reset',function(s,t){t.jewel==this.name&&this.reset();}.bind(this));p._resizeListener=p._resizeListener||(function(){var s=null;return Event.listen(window,'resize',function(event){clearTimeout(s);s=g.inform.bind(g,'jewel/resize',event).defer(100,false);});})();},getRoot:function(){return this.root;},hasNew:function(){return j.hasClass(this.root,'hasNew');},isOpen:function(){return j.hasClass(this.root,'openToggler');},reset:function(){j.removeClass(this.root,'hasNew');},setContent:function(q){var r=k.find(this.root,'ul.jewelItemList');k.setContent(r,l(q));},update:function(q){this.countNew=q.count;var r=k.find(this.root,'span.jewelCount span');k.setContent(r,this.countNew);var s=isNaN(this.countNew)||this.countNew>0;j.conditionClass(this.root,'hasNew',s);this.inform('updated',q);},setInitial:function(q){this.initialCount=q;},markSeen:function(){g.inform('jewel/count-updated',{jewel:this.name,count:0},g.BEHAVIOR_STATE);this.inform('marked-seen');},_logFirstClick:function(){this._logFirstClick=bagofholding;o('jewel_click',null,null,'FORCE',{gt:{count:this.countNew,initial:this.initialCount,jewel:this.name}});}});e.exports=p;});
__d("RangedCallbackManager",["CallbackManagerController","copyProperties","createObjectFrom"],function(a,b,c,d,e,f){var g=b('CallbackManagerController'),h=b('copyProperties'),i=b('createObjectFrom'),j=function(k,l,m){this._resources=[];this._reachedEndOfArray=false;this._existingIDs={};this._controller=new g(this._constructCallbackArg.bind(this));this._getValueHandler=k;this._compareValuesHandler=l;this._skipOnStrictHandler=m;};h(j.prototype,{executeOrEnqueue:function(k,l,m,n){return this._controller.executeOrEnqueue({start:k,limit:l},m,{strict:!!n});},unsubscribe:function(k){this._controller.unsubscribe(k);},getUnavailableResources:function(k){var l=this._controller.getRequest(k),m=[];if(l&&!this._reachedEndOfArray){var n=l.request,o=this._filterForStrictResults(l.options),p=n.start+n.limit;for(var q=o.length;q<p;q++)m.push(q);}return m;},addResources:function(k){k.forEach(function(l){if(!this._existingIDs[l]){this._existingIDs[l]=true;this._resources.push(l);}}.bind(this));this.resortResources();this._controller.runPossibleCallbacks();},addResourcesWithoutSorting:function(k,l){var m=this._resources.slice(0,l);m=m.concat(k);m=m.concat(this._resources.slice(l));this._resources=m;h(this._existingIDs,i(k,true));this._controller.runPossibleCallbacks();},removeResources:function(k){k.forEach(function(l){if(this._existingIDs[l]){this._existingIDs[l]=false;this._resources.remove(l);}}.bind(this));},removeAllResources:function(){this._resources=[];this._existingIDs={};},resortResources:function(){this._resources=this._resources.sort(function(k,l){return this._compareValuesHandler(this._getValueHandler(k),this._getValueHandler(l));}.bind(this));},setReachedEndOfArray:function(){if(!this._reachedEndOfArray){this._reachedEndOfArray=true;this._controller.runPossibleCallbacks();}},hasReachedEndOfArray:function(){return this._reachedEndOfArray;},hasResource:function(k){return this._existingIDs[k];},getResourceAtIndex:function(k){return this._resources[k];},getAllResources:function(){return this._resources.concat();},getCurrentArraySize:function(){return this._resources.length;},_filterForStrictResults:function(k){var l=this._resources;if(k&&k.strict&&this._skipOnStrictHandler)l=l.filter(this._skipOnStrictHandler);return l;},_constructCallbackArg:function(k,l){var m=this._filterForStrictResults(l);if(!this._reachedEndOfArray&&k.start+k.limit>m.length){return false;}else return m.slice(k.start,k.start+k.limit);},getElementsUntil:function(k){var l=[];for(var m=0;m<this._resources.length;m++){var n=this._getValueHandler(this._resources[m]);if(this._compareValuesHandler(n,k)>0)break;l.push(this._resources[m]);}return l;}});e.exports=j;});
__d("ChatBehavior",["Arbiter","AvailableList","AvailableListConstants","copyProperties","MercuryConstants","ChatSidebarCalloutData"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('AvailableList'),i=b('AvailableListConstants'),j=b('copyProperties'),k=c('MercuryConstants').ChatNotificationConstants,l=c('ChatSidebarCalloutData').isShown,m=h.getWebChatNotification(),n=l,o=j(new g(),{ON_CHANGED:'changed',notifiesUserMessages:function(){return m!==k.NO_USER_MESSAGE_NOTIFICATION;},ignoresRemoteTabRaise:function(){return n;}});function p(){o.inform(o.ON_CHANGED);}h.subscribe(i.ON_CHAT_NOTIFICATION_CHANGED,function(){var q=m,r=h.getWebChatNotification();m=r;if(q!=r)p();});g.subscribe('chat/set_does_page_occlude_tabs',function(q,r){n=!!r;p();});e.exports=o;});
__d("MercuryChannelHandler",["Arbiter","ChannelConstants","copyProperties","MessagingReliabilityLogger","MercuryParticipants","PresenceUtil","MercuryServerRequests","MercuryThreadInformer","MercuryThreads","MercuryConstants"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('ChannelConstants'),i=b('copyProperties'),j=b('MessagingReliabilityLogger'),k=b('MercuryParticipants'),l=b('PresenceUtil'),m=b('MercuryServerRequests'),n=b('MercuryThreadInformer'),o=b('MercuryThreads'),p=c('MercuryConstants');function q(ga,ha){var ia=ha.obj.to;o.getCanonicalThreadToGroup(ia,function(ja){var ka=ja.thread_id;m.getServerThreadID(ka,function(la){var ma=z(ia,ha.obj.from,ha.obj.msg.time),na={obj:{message:{action_id:null,body:ha.obj.msg.text,is_unread:true,mid:ma,mercury_author_id:'fbid:'+ha.obj.from,mercury_source:p.MercurySourceType.CHAT_WEB,sender_fbid:ha.obj.from,tid:la,timestamp:ha.obj.msg.time,threading_id:ha.obj.sync_id},folder:'group_chat'}};s(h.getArbiterType('messaging'),na);});});}function r(ga,ha){var ia=ha.obj.to;o.getCanonicalThreadToLiveListen(ia,function(ja){var ka=ja.thread_id;m.getServerThreadID(ka,function(la){var ma=z(ia,ha.obj.from,ha.obj.msg.time),na={obj:{message:{action_id:null,body:ha.obj.msg.text,is_unread:true,mid:ma,mercury_author_id:'fbid:'+ha.obj.from,mercury_source:p.MercurySourceType.CHAT_WEB,sender_fbid:ha.obj.from,tid:la,timestamp:ha.obj.msg.time,threading_id:ha.obj.sync_id},folder:'live_listen'}};s(h.getArbiterType('messaging'),na);});});}function s(ga,ha){if(ga!=h.getArbiterType('messaging')||!ha.obj||!ha.obj.message){j.addEntry('channel_receive','invalid_data');return;}var ia=ha.obj.message,ja={author:ia.mercury_author_id,body:ia.body,subject:ia.subject,has_attachment:ia.has_attachment,attachments:ia.attachments,is_html:ia.is_html,thread_id:ia.tid,message_id:ia.mid,source:ia.mercury_source,threading_id:ia.threading_id,timestamp:ia.timestamp,timestamp_absolute:new Date(ia.timestamp).toLocaleString(),action_type:p.MercuryActionType.USER_GENERATED_MESSAGE,is_unread:ia.is_unread,action_id:ia.action_id,is_forward:false,forward_count:ia.forward_count||ia.forward,forward_message_ids:ia.forward_msg_ids,location_text:ia.location_text,folder:ha.obj.folder},ka=[i({},ja)];ka=ka.concat(ia.forward_actions||[]);var la=p.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE;m.handleUpdateWaitForThread({actions:ka,payload_source:la},ia.tid);if(!ia.is_unread&&ia.mercury_author_id===k.user){var ma={};ma[ia.tid]=ha.obj.folder;t(h.getArbiterType('messaging'),{obj:{event:p.MessagingEventTypes.READ,tids:[ia.tid],folder_info:ma}});}j.addEntry('channel_receive','success',[ja.thread_id,ja.message_id,l.getSessionID()]);}function t(ga,ha){if(ga!=h.getArbiterType('messaging')||!ha.obj||!ha.obj.tids)return;var ia=[],ja=ha.obj.event==p.MessagingEventTypes.READ;ha.obj.tids.forEach(function(ka){ia.push({action_type:p.MercuryActionType.CHANGE_READ_STATUS,action_id:null,thread_id:ka,mark_as_read:ja,timestamp:ha.obj.timestamp||0,folder:ha.obj.folder_info[ka]});});m.handleUpdate({actions:ia,payload_source:p.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE});}function u(ga,ha){if(ga!=h.getArbiterType('messaging')||!ha.obj||!ha.obj.tids)return;var ia=[];ha.obj.tids.forEach(function(ja){ia.push({action_type:p.MercuryActionType.DELETE_THREAD,action_id:null,thread_id:ja});});m.handleUpdate({actions:ia,payload_source:p.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE});}function v(ga,ha){if(ga!=h.getArbiterType('messaging')||!ha.obj||!ha.obj.folder||ha.obj.folder!=p.MessagingTag.INBOX)return;var ia={action_type:p.MercuryGlobalActionType.MARK_ALL_READ,action_id:ha.obj.action_id};m.handleUpdate({global_actions:[ia]});}function w(ga,ha){if(ga!=h.getArbiterType('messaging')||!ha.obj.tids)return;var ia=p.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE;ha.obj.tids.forEach(function(ja){var ka={action_type:p.MercuryActionType.CHANGE_ARCHIVED_STATUS,action_id:null,thread_id:ja,archived:ha.obj.state};m.handleUpdateWaitForThread({actions:[i({},ka)],payload_source:ia},ja);});}function x(ga,ha){if(ga!=h.getArbiterType('messaging')||!ha.obj.tids)return;var ia=p.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE,ja;ha.obj.tids.forEach(function(ka){if(ha.obj.event==p.MessagingEventTypes.TAG){ja=ha.obj.tag;}else ja=ha.obj.marked_as_spam?p.MessagingTag.SPAM:p.MessagingTag.INBOX;var la={action_type:p.MercuryActionType.CHANGE_FOLDER,action_id:null,thread_id:ka,new_folder:ja};m.handleUpdateWaitForThread({actions:[i({},la)],payload_source:ia},ka);});}function y(ga,ha){if(ga!=h.getArbiterType('messaging')||!ha.obj.tag)return;switch(ha.obj.tag){case p.MessagingTag.ACTION_ARCHIVED:w(ga,ha);break;case p.MessagingTag.INBOX:case p.MessagingTag.OTHER:x(ga,ha);break;}}function z(ga,ha,ia){return ga+':'+ha+':'+ia;}function aa(ga,ha){if(ga!=h.getArbiterType('inbox')||!ha.obj||!ha.obj.seen_timestamp)return;m.handleUpdate({message_counts:[{seen_timestamp:ha.obj.seen_timestamp,folder:p.MessagingTag.INBOX}],unseen_thread_ids:[{thread_ids:[],folder:p.MessagingTag.INBOX}],payload_source:p.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE});}function ba(ga,ha){if(ga!=h.getArbiterType('mercury')||!ha.obj)return;n.synchronizeInforms(function(){var ia=ha.obj,ja=[];(ia.actions||[]).forEach(function(ka){var la=p.MercuryActionType.USER_GENERATED_MESSAGE;if(ka.action_type==p.MercuryActionType.LOG_MESSAGE){var ma=p.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE;m.handleUpdateWaitForThread({actions:[i({},ka)],payload_source:ma},ka.thread_id);}else if(ka.action_type!=la)ja.push(ka);});ia.actions=ja;ia.payload_source=p.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE;m.handleUpdate(ia);});}function ca(ga,ha){m.handleRoger(ha.obj);}function da(ga,ha){switch(ha.obj.event){case p.MessagingEventTypes.DELIVER:s(ga,ha);break;case p.MessagingEventTypes.READ:case p.MessagingEventTypes.UNREAD:t(ga,ha);break;case p.MessagingEventTypes.READ_ALL:v(ga,ha);break;case p.MessagingEventTypes.DELETE:u(ga,ha);break;case p.MessagingEventTypes.TAG:y(ga,ha);break;case p.MessagingEventTypes.REPORT_SPAM:x(ga,ha);break;case p.MessagingEventTypes.READ_RECEIPT:ca(ga,ha);break;}}var ea=[],fa={turnOn:function(){if(!ea.length){var ga={mercury:ba,messaging:da,group_msg:q,livelisten_msg:r,inbox:aa};for(var ha in ga)ea.push(g.subscribe(h.getArbiterType(ha),ga[ha]));}},turnOff:function(){if(ea.length){ea.forEach(g.unsubscribe);ea=[];}}};fa.turnOn();e.exports=fa;});
__d("MercuryUnseenState",["Arbiter","copyProperties","TimestampConverter","KeyedCallbackManager","JSLogger","createObjectFrom","MercuryServerRequests","MercuryThreadInformer","MercuryConstants"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('copyProperties'),i=b('TimestampConverter'),j=b('KeyedCallbackManager'),k=b('JSLogger'),l=b('createObjectFrom'),m=b('MercuryServerRequests'),n=b('MercuryThreadInformer'),o=c('MercuryConstants'),p=o.MercuryThreadlistConstants.MAX_UNSEEN_COUNT,q=0,r=0,s=false,t=new j(),u='unseen_thread_hash',v='unseen_thread_list',w=k.create('mercury_unseen_state'),x={getUnseenCount:function(){if(this.exceedsMaxCount()){w.error('unguarded_unseen_count_fetch',{});return 0;}return ba();},exceedsMaxCount:function(){return s||(ba()>p);},markAsSeen:function(){if(ba()>0||s){m.markSeen();da(i.convertActionIDToTimestamp(m.getLastActionID()),[]);}},markThreadSeen:function(ka,la){var ma={};ma[ka]=null;fa(ma,la);}};function y(ka){t.setResource(u,ka);t.setResource(v,Object.keys(ka));}function z(ka){var la=t.executeOrEnqueue(u,ka),ma=t.getUnavailableResources(la);if(ma.length)m.fetchUnseenThreadIDs();}function aa(){return t.getResource(u);}function ba(){var ka=t.getResource(v);if(ka){return ka.length;}else return q;}function ca(ka){var la=ja(ka);if(ka.unseen_thread_ids){ka.unseen_thread_ids.forEach(function(wa){if(wa.folder!=o.MessagingTag.INBOX)return;var xa=ha(wa.thread_ids),ya=r;if(la&&la.seen_timestamp)ya=la.seen_timestamp;da(ya,xa);if(la&&la.unseen_count>p)s=true;});}else if(la&&la.seen_timestamp){r=la.seen_timestamp;if(la.unseen_count>p){s=true;y({});}else{q=la.unseen_count;if(q===0)y({});}}else{if(s)return;var ma=ka.actions;if(!ma||!(ma.length))return;var na={},oa={};for(var pa=0;pa<ma.length;pa++){var qa=ma[pa];if(qa.is_forward)continue;var ra=qa.action_type,sa=qa.action_id,ta=qa.thread_id?qa.thread_id:qa.server_thread_id,ua=qa.folder===undefined||qa.folder==o.MessagingTag.INBOX;if(!ua)continue;if(ra==o.MercuryActionType.USER_GENERATED_MESSAGE||ra==o.MercuryActionType.LOG_MESSAGE){var va=i.isGreaterThan(sa,na[ta]);if(qa.is_unread&&(!na[ta]||va))na[ta]=sa;}else if(ra==o.MercuryActionType.CHANGE_READ_STATUS&&qa.mark_as_read)oa[ta]=sa;}ea(na);fa(oa);}}function da(ka,la){var ma=aa();if(ma===undefined||ka>r||s){r=ka;la=la||[];if(la.length<=p)s=false;var na={},oa=aa()||{};for(var pa in oa)if(oa[pa]!==true){var qa=oa[pa];if(ga(qa))na[pa]=qa;}var ra=h(l(la,true),na);y(ra);n.updatedUnseenState();}}function ea(ka){if(s)return;var la={},ma=false;for(var na in ka){var oa=ka[na];if(ga(oa)){la[na]=oa;ma=true;}}if(!ma)return;z(function(pa){for(var qa in la){var ra=la[qa];if(!pa[qa]&&ga(ra))pa[qa]=la[qa];}y(pa);n.updatedUnseenState();});}function fa(ka,la){var ma=false;for(var na in ka){ma=true;break;}if(ma)z(function(oa){var pa=false;for(var qa in ka){var ra=ka[qa],sa=i.isGreaterThan(ra,oa[qa]);if(oa[qa]&&(!ra||sa)){delete oa[qa];pa=true;}}if(pa){y(oa);n.updatedUnseenState();if(la&&ba()===0)m.markSeen();}});}function ga(ka){return i.convertActionIDToTimestamp(ka)>r;}function ha(ka){return ka.map(m.convertThreadIDIfAvailable);}function ia(ka){var la=aa();if(!la)return;for(var ma in ka){var na=ka[ma];if(la[ma]){la[na]=la[ma];delete la[ma];}}y(la);}function ja(ka){var la=(ka.message_counts||[]);for(var ma=0;ma<la.length;ma++)if(la[ma].folder==o.MessagingTag.INBOX)return la[ma];return null;}m.subscribe('update-unseen',function(ka,la){ca(la);});m.subscribe('update-thread-ids',function(ka,la){ia(la);});g.subscribe(k.DUMP_EVENT,function(ka,la){la.messaging=la.messaging||{};la.messaging.unseen=h({},aa());la.messaging.unseen_max_count=s;la.messaging.unseen_time=r;});e.exports=x;});
__d("MercuryJewelCountControl",["Arbiter","DOM","JewelX","MercuryUnseenState","MercuryServerRequests","MercuryThreadInformer","copyProperties","tx","MercuryConstants"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=c('MercuryConstants'),i=b('DOM'),j=b('JewelX'),k=b('MercuryUnseenState'),l=b('MercuryServerRequests'),m=b('MercuryThreadInformer'),n=b('copyProperties'),o=b('tx'),p,q,r,s=function(u){if(u||r.isOpen())k.markAsSeen();},t=function(u,v){p=u;q=i.find(p,'#mercurymessagesCountValue');r=v;this.render();l.subscribe('model-update-completed',function(w,x){s(false);});m.subscribe('unseen-updated',this.render.bind(this));r.subscribe('marked-seen',s.shield(this,true));};n(t.prototype,{render:function(){var u='';if(k.exceedsMaxCount()){u=o._("{count}+",{count:h.MercuryThreadlistConstants.MAX_UNSEEN_COUNT});}else u=k.getUnseenCount().toString();g.inform('jewel/count-updated',{jewel:'mercurymessages',count:u},g.BEHAVIOR_STATE);}});e.exports=t;});
__d("MercuryOrderedThreadlist",["JSLogger","MercuryServerRequests","RangedCallbackManager","MercuryThreadInformer","MercuryThreads","MercuryConstants"],function(a,b,c,d,e,f){var g=b('JSLogger'),h=b('MercuryServerRequests'),i=b('RangedCallbackManager'),j=b('MercuryThreadInformer'),k=b('MercuryThreads'),l=c('MercuryConstants'),m=g.create('ordered_threadlist_model'),n=[l.MessagingTag.INBOX,l.MessagingTag.OTHER,l.MessagingTag.ACTION_ARCHIVED],o={};n.forEach(function(x){o[x]=new i(function(y){return k.getThreadMetaNow(y).timestamp;},function(y,z){return z-y;},h.canLinkExternally.bind(h));});function p(x,y){var z=[],aa=false,ba=(x||[]).filter(function(ca){return ca.folder==y||(!ca.folder&&y==l.MessagingTag.INBOX);});ba.forEach(function(ca){z=z.concat(ca.thread_ids);var da=ca.end-ca.start;if(ca.thread_ids.length<da)aa=true;});o[y].addResources(z);if(aa)o[y].setReachedEndOfArray();}function q(x){n.forEach(function(y){p(x,y);});}function r(x){var y={};n.forEach(function(z){y[z]={to_add:[],to_remove:[],to_remove_if_last_after_add:{}};});x.forEach(function(z){if(z.is_forward)return;var aa=z.thread_id,ba=t(aa);function ca(){y[ba].to_add.push(aa);if(!o[ba].hasReachedEndOfArray()&&!o[ba].hasResource(aa))y[ba].to_remove_if_last_after_add[aa]=true;}if(!ba){if(z.action_type===l.MercuryActionType.CHANGE_FOLDER||z.action_type===l.MercuryActionType.CHANGE_ARCHIVED_STATUS)n.forEach(function(da){if(da!==ba)o[da].removeResources([aa]);});return;}switch(z.action_type){case l.MercuryActionType.DELETE_THREAD:y[ba].to_remove.push(aa);break;case l.MercuryActionType.CHANGE_ARCHIVED_STATUS:case l.MercuryActionType.CHANGE_FOLDER:ca();n.forEach(function(da){if(da!==ba)y[da].to_remove.push(aa);});break;case l.MercuryActionType.USER_GENERATED_MESSAGE:case l.MercuryActionType.LOG_MESSAGE:if(u(aa,ba))y[ba].to_add.push(aa);break;}});n.forEach(function(z){var aa=o[z];aa.addResources(y[z].to_add);for(var ba=aa.getCurrentArraySize()-1;ba>=0;ba--){var ca=aa.getResourceAtIndex(ba);if(!y[z].to_remove_if_last_after_add[ca])break;y[z].to_remove.push(ca);}aa.removeResources(y[z].to_remove);});}function s(x){var y={};n.forEach(function(z){y[z]=[];});x.forEach(function(z){var aa=t(z.thread_id);if(aa&&u(z.thread_id,aa))y[aa].push(z.thread_id);});n.forEach(function(z){if(y[z].length>0)o[z].addResources(y[z]);});}function t(x){var y=k.getThreadMetaNow(x),z=null;if(!y){z='No thread metadata';}else if(!y.folder)z='No thread folder';if(z){var aa={error:z,tid:x};m.warn('no_thread_folder',aa);return null;}var ba=y.folder;if(y.is_archived)ba=l.MessagingTag.ACTION_ARCHIVED;if(o[ba]){return ba;}else return null;}function u(x,y){var z=k.getThreadMetaNow(x);return z&&z.timestamp&&t(x)==y;}var v={getThreadlist:function(x,y,z,aa,ba){var ca=o[z],da=ca.executeOrEnqueue(x,y,aa,ba),ea=ca.getUnavailableResources(da);if(ea.length){if(ca.getCurrentArraySize()<x){var fa={start:x,limit:y,resources_size:ca.getCurrentArraySize()};m.warn('range_with_gap',fa);y+=x-ca.getCurrentArraySize();x=ca.getCurrentArraySize();}h.fetchThreadlistInfo(x,y,z);}return da;},getThreadlistUntilTimestamp:function(x,y){return o[y].getElementsUntil(x);},unsubscribe:function(x,y){o[y].unsubscribe(x);}};function w(x){switch(x){case l.MercuryPayloadSource.CLIENT_CHANGE_ARCHIVED_STATUS:case l.MercuryPayloadSource.CLIENT_CHANGE_FOLDER:case l.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE:case l.MercuryPayloadSource.CLIENT_DELETE_THREAD:case l.MercuryPayloadSource.CLIENT_SEND_MESSAGE:case l.MercuryPayloadSource.SERVER_INITIAL_DATA:case l.MercuryPayloadSource.SERVER_SEND_MESSAGE:case l.MercuryPayloadSource.SERVER_CONFIRM_MESSAGES:case l.MercuryPayloadSource.SERVER_FETCH_THREADLIST_INFO:case l.MercuryPayloadSource.SERVER_THREAD_SYNC:return true;default:return false;}}h.subscribe('update-threadlist',function(x,y){if(!w(y.payload_source))return;var z=y.ordered_threadlists;if(z&&z.length){q(z);}else{var aa=(y.actions||[]).filter(function(ba){return ba.thread_id;});s(y.threads||[]);r(aa);}j.updatedThreadlist();});e.exports=v;});
__d("Emote",["DOM","Env","StringEscape"],function(a,b,c,d,e,f){var g=b('DOM'),h=b('Env'),i=b('StringEscape'),j=e.exports={_initialized:false,_imageBase:null,_emoteMap:null,_emoteOrderMap:null,_fbidEmoticonPattern:'\\[\\[([A-Za-z0-9\\.]+)\\]\\]',_fbidEmoticonRegex:null,_imageURLs:null,_regex:null,_init:function(){var k=h.static_base;j._imageBase=k+'images/emote/';j._blankImgSrc=k+'images/blank.gif';var l=['smile','frown','tongue','grin','gasp','wink','glasses','sunglasses','grumpy','unsure','cry','devil','angel','kiss','heart','kiki','squint','confused','upset','pacman','colonthree','like'];j._emoteMap={':-)':['\\:\\-\\)','smile'],':)':['\\:\\)','smile'],':]':['\\:\\]','smile'],'=)':['=\\)','smile'],':-(':['\\:\\-\\(','frown'],':(':['\\:\\(','frown'],':[':['\\:\\[','frown'],'=(':['=\\(','frown'],':-P':['\\:\\-P','tongue'],':P':['\\:P','tongue'],':-p':['\\:\\-p','tongue'],':p':['\\:p','tongue'],'=P':['=P','tongue'],':-D':['\\:\\-D','grin'],':D':['\\:D','grin'],'=D':['=D','grin'],':-O':['\\:\\-O','gasp'],':O':['\\:O','gasp'],':-o':['\\:\\-o','gasp'],':o':['\\:o','gasp'],';-)':['\\;\\-\\)','wink'],';)':['\\;\\)','wink'],'8-)':['8\\-\\)','glasses'],'8)':['8\\)','glasses'],'B-)':['B\\-\\)','glasses'],'B)':['B\\)','glasses'],'8-|':['8\\-\\|','sunglasses'],'8|':['8\\|','sunglasses'],'B-|':['B\\-\\|','sunglasses'],'B|':['B\\|','sunglasses'],'>:(':['>\\:\\(','grumpy'],'>:-(':['>\\:\\-\\(','grumpy'],':/':['\\:/','unsure'],':-/':['\\:\\-/','unsure'],':\\':['\\:\\\\','unsure'],':-\\':['\\:\\-\\\\','unsure'],":'(":["\\:'\\(",'cry'],'3:)':['3\\:\\)','devil'],'3:-)':['3\\:\\-\\)','devil'],'O:)':['O\\:\\)','angel'],'O:-)':['O\\:\\-\\)','angel'],':-*':['\\:\\-\\*','kiss'],':*':['\\:\\*','kiss'],'<3':['<3','heart'],'&lt;3':['&lt\\;3','heart'],'\u2665':['\u2665','heart'],'^_^':['\\^_\\^','kiki'],'-_-':['\\-_\\-','squint'],'o.O':['o\\.O','confused'],'O.o':['O\\.o','confused'],'>:O':['>\\:O','upset'],'>:-O':['>\\:\\-O','upset'],'>:o':['>\\:o','upset'],'>:-o':['>\\:\\-o','upset'],'>_<':['>_<','upset'],'>.<':['>\\.<','upset'],':v':['\\:v','pacman'],':|]':['\\:\\|\\]','robot'],':3':['\\:3','colonthree'],'<(")':['<\\(\\"\\)','penguin'],':putnam:':['\\:putnam\\:','putnam'],'(^^^)':['\\(\\^\\^\\^\\)','shark'],':42:':['\\:42\\:','42'],':like:':['\\:like\\:','like'],'(y)':['\\(y\\)','like'],'(Y)':['\\(Y\\)','like']};var m=[];if(h.fbid_emoticons){j._fbidEmoticonRegex=new RegExp(j._fbidEmoticonPattern);m.push(j._fbidEmoticonPattern);}for(var n in j._emoteMap)m.push(j._emoteMap[n][0]);var o='(?:^|\\s|\'|"|\\.)('+m.join('|')+')(?:\\s|\'|"|\\.|,|!|\\?|<br>|$)';j._regex=new RegExp(o);j._emoteOrderMap={};for(var p=0;p<l.length;p++)j._emoteOrderMap[l[p]]=p;j._initialized=true;},htmlEmote:function(k,l){if(typeof l!='function')l=i.htmlize;if(!j._initialized)j._init();var m=k,n=[];while(true){var o=j._regex.exec(m);if(!o||!o.length)break;var p=o[1],q=m.indexOf(p),r=m.substring(0,q);if(r)n.push(l(r));n.push('<span class="emote_text">');n.push(p);n.push('</span>');var s={title:p},t=j._fbidEmoticonRegex&&(j._fbidEmoticonRegex.exec(p)||[])[1];if(t){s.className='emote_custom';s.src=window.location.protocol+'//graph.facebook.com/'+encodeURIComponent(t)+'/picture';}else{var u=j._emoteMap[p][1],v=j._emoteOrderMap[u];if(v===undefined){s.className='emote_custom';s.src=j._imageBase+u+'.gif';}else{var w=v*-16;s.className='emote_img';s.src=j._blankImgSrc;s.style={backgroundPosition:w+'px 0'};}}var x=g.create('img',s);n.push(g.create('span',{},x).innerHTML);m=m.substring(q+p.length);}if(m)n.push(l(m));return n.join('');}};});
__d("MercuryThreadMetadataRenderer",["DOM","HTML","Emote","CSS","LiveTimer","MercuryAttachment","MercuryParticipants","MercuryServerRequests","MercuryThreads","Tooltip","URI","createArrayFrom","tx","MercuryImageTemplates","MercuryThreadlistIconTemplates","MercuryStatusTemplates","MercuryConstants"],function(a,b,c,d,e,f){var g=b('DOM'),h=b('HTML'),i=b('Emote'),j=b('CSS'),k=b('LiveTimer'),l=b('MercuryAttachment'),m=b('MercuryParticipants'),n=b('MercuryServerRequests'),o=b('MercuryThreads'),p=b('Tooltip'),q=b('URI'),r=c('MercuryImageTemplates'),s=c('MercuryThreadlistIconTemplates'),t=c('MercuryStatusTemplates'),u=c('MercuryConstants'),v=b('createArrayFrom'),w=b('tx');e.exports={renderLiveTimestamp:function(z,aa,ba,ca){if(aa){z.setAttribute('data-utime',Math.floor(ca/1000));z.setAttribute('title',aa);if(ba)k.updateNode(z,ba);k.addTimeStamps(z);j.show(z);}},renderCoreThreadlist:function(z,aa,ba){o.getThreadMeta(z,function(ca){this.renderThreadImage(ca.thread_id,aa.getNode('image'));this.renderCommaSeparatedParticipantList(ca.thread_id,aa.getNode('name'));var da=aa.getNode('timestamp');this.renderLiveTimestamp(da,ca.timestamp_absolute,ca.timestamp_relative,ca.timestamp);this.renderSnippet(ca.thread_id,aa.getNode('snippet'));ba(aa,ca);}.bind(this));},renderCommaSeparatedParticipantList:function(z,aa){aa=v(aa);return this._renderParticipantList(z,aa,true,false,false,true);},renderAndSeparatedParticipantList:function(z,aa,ba,ca){aa=v(aa);return this._renderParticipantList(z,aa,false,ba,ca);},renderSnippet:function(z,aa){o.getThreadMeta(z,function(ba){if(ba.participants.length>0&&ba.participants[0]==m.user){var ca=s[':fb:mercury:replied-indicator'].build().getRoot();g.appendContent(aa,ca);}if(ba.snippet_has_attachment)if(!ba.snippet&&ba.snippet_attachments){ba.snippet_attachments.forEach(function(ga){if(ga.attach_type!=u.MercuryAttachmentType.FILE)return;var ha=l.getAttachIconClass(ga.icon_type),ia=s[':fb:mercury:attachment-icon-text'].build().getRoot();g.appendContent(ia,ga.name);j.addClass(ia,ha);g.appendContent(aa,ia);}.bind(this));}else{var da=s[':fb:mercury:attachment-indicator'].build().getRoot();g.appendContent(aa,da);}if(ba.is_forwarded_snippet){var ea;if(ba.snippet){ea="V\u00e4litetty viesti:";}else ea="V\u00e4litetty viesti";g.appendContent(aa,g.$N('strong',{className:'mercuryLeftAlignStatusIndicator'},ea));}var fa=ba.snippet;if(fa)if(fa.substr(0,4)=='?OTR'){fa="[salattu viesti]";}else fa=fa.replace(/\r\n|[\r\n]/g," ");g.appendContent(aa,h(i.htmlEmote(fa)));}.bind(this));},renderTitanLink:function(z,aa,ba){var ca=z.indexOf(':'),da=new q().setSubdomain('www');if(z.substr(0,ca)=='user'){da.setPath('/messages/'+z.substr(ca+1));aa.setAttribute('href',da.toString());ba&&ba();}else n.getServerThreadID(z,function(ea){da.setPath('/messages/');da.setQueryData({action:'read',tid:ea});aa.setAttribute('href',da.toString());ba&&ba();});},renderThreadImage:function(z,aa){o.getThreadMeta(z,function(ba){if(ba.image_src){this._renderThreadImageSingle(ba.image_src,aa);return;}var ca=[],da=ba.participants.filter(function(ea){return ea!=m.user;});if(!da.length){ca=[m.user];}else if(da.length==1){ca=[da[0]];}else{ca=da.slice(0,3);if(ca.length==2)ca.push(m.user);}m.getMulti(ca,function(ea){var fa=ca.map(function(ga){return ea[ga];});this.renderParticipantImages(fa,aa);}.bind(this));}.bind(this));},renderParticipantImages:function(z,aa){if(z.length>2){this._renderThreadImageSplit(z,aa);}else this._renderThreadImageSingle(z[0].image_src,aa);},renderErrorIndicator:function(z,aa){var ba=t[':fb:mercury:error-indicator'].render(),ca;switch(z){case u.MercuryActionStatus.REQUEST_ERROR:case u.MercuryActionStatus.TRANSPORT_ERROR:case u.MercuryActionStatus.FAILED_UNKNOWN_REASON:case u.MercuryActionStatus.UNABLE_TO_CONFIRM:ca="Viestin l\u00e4hetys ep\u00e4onnistui. L\u00e4het\u00e4 uudelleen klikkaamalla.";break;default:throw new Error('Invalid error code '+z);}p.set(ba,ca,'above','center');if(aa){Event.listen(ba,'click',aa);j.addClass(ba,'mercuryClickableErrorIndicator');}return ba;},renderResendIndicator:function(){return t[':fb:mercury:resend-indicator'].render();},renderStatusIndicator:function(z,aa){var ba=u.MercuryActionStatus,ca;if(z==ba.RESENDING){ca=this.renderResendIndicator();}else if(z!=ba.UNCONFIRMED&&z!=ba.SUCCESS)ca=this.renderErrorIndicator(z,aa);return ca;},_renderParticipantList:function(z,aa,ba,ca,da,ea){o.getThreadMeta(z,function(fa){if(fa.name){aa.forEach(function(ha){var ia=y(fa.name,ea?fa.unread_count:0);g.setContent(ha,ia);});return;}var ga=fa.participants;if(fa.participants.length>1)ga=fa.participants.filter(function(ha){return ha!=m.user;});m.getMulti(ga,function(ha){var ia=ga.map(function(ka){return ha[ka];}),ja=this.renderParticipantListString(ia,ga.length,ba,ca);aa.forEach(function(ka){ja=y(ja,ea?fa.unread_count:0);g.setContent(ka,ja);if(da&&ka.scrollWidth>ka.clientWidth){var la=this.renderParticipantListString(ia,ga.length,ba,ca,true);la=y(la,ea?fa.unread_count:0);g.setContent(ka,la);}}.bind(this));}.bind(this));}.bind(this));},renderParticipantListString:function(z,aa,ba,ca,da){var ea=null;if(z.length==1){ea=z[0].name;}else if(z.length==2){var fa={participant1:x(z[0],ca),participant2:x(z[1],ca)};if(ba){ea=w._("{participant1}, {participant2}",fa);}else ea=w._("{participant1} ja {participant2}",fa);}else if(ba){if(z.length==3){ea=w._("{participant1}, {participant2}, {participant3}",{participant1:x(z[0],ca),participant2:x(z[1],ca),participant3:x(z[2],ca)});}else ea=w._("{participant1}, {participant2}, {participant3}, {others_count} muuta",{participant1:x(z[0],ca),participant2:x(z[1],ca),participant3:x(z[2],ca),others_count:aa-3});}else{var ga=x(z[0],ca),ha=x(z[1],ca),ia=x(z[2],ca);if(da){ea=w._("{participant1} ja {others_count} muuta",{participant1:ga,others_count:aa-1});}else if(z.length==3){ea=w._("{participant1}, {participant2} ja {participant3}",{participant1:ga,participant2:ha,participant3:ia});}else ea=w._("{participant1}, {participant2} ja {others_count} muuta",{participant1:ga,participant2:ha,others_count:aa-2});}return ea;},_renderThreadImageSingle:function(z,aa){var ba=r[':fb:mercury:thread-image:single'].build().getRoot();ba.src=z;g.setContent(aa,ba);},_renderThreadImageSplit:function(z,aa){var ba=r[':fb:mercury:thread-image:split'].build().setNodeProperty('left','src',z[0].image_src).setNodeProperty('topRight','src',z[1].image_src).setNodeProperty('bottomRight','src',z[2].image_src);g.setContent(aa,ba.getRoot());}};function x(z,aa){return aa?z.short_name:z.name;}function y(z,aa){var ba=z;if(aa&&aa>1)ba=w._("{conversation_title} ({unread_count})",{conversation_title:z,unread_count:aa});return ba;}});
__d("WebMessengerStateConstants",[],function(a,b,c,d,e,f){var g={SELECTION:'selection',COMPOSE:'compose',SEARCH_THREAD:'search-thread',SEARCH_THREAD_SELECTION:'search-thread-selection',SEARCH_SNIPPET:'search-snippet',SEARCH_SNIPPET_SELECTION:'search-snippet-selection',STATE_CHANGE_EVENT:'state-changed',COMPOSE_SHOWING_CONTEXT:'showing_context',COMPOSE_SHOWING_TYPEAHEAD_RESULTS:'showing_typeahead_results',COMPOSE_SHOWING_ALL_PEOPLE:'showing_all_people'};e.exports=g;});
__d("WebMessengerPermalinks",["MercuryIDs","MercuryServerRequests","WebMessengerStateConstants","URI","goURI"],function(a,b,c,d,e,f){var g=b('MercuryIDs'),h=b('MercuryServerRequests'),i=b('WebMessengerStateConstants'),j=b('URI'),k=b('goURI'),l={BASE_PATH:'/webmessenger',goNextURI:function(q,r){if(p(q,r)){var s=l.getURI(q,r);k(s);return true;}return false;},getURI:function(q,r){var s=new j().setSubdomain('www');s.setPath(l.BASE_PATH);if(q){s.addQueryData({action:q});if(r.thread_id){var t=h.getServerThreadIDNow(r.thread_id),u=t?t:r.thread_id;s.addQueryData({tid:u});}if(r.query)s.addQueryData({query:r.query});if(r.message_id)s.addQueryData({mid:r.message_id});}return s;},processURI:function(q){if(q.getPath()!=l.BASE_PATH)return false;var r={redirect:false,data:{}},s=q.getQueryData().action||i.SELECTION;r.state=s;switch(s){case i.SELECTION:return o(q,r);case i.COMPOSE:r.data.start=true;r.data.contents_state=i.COMPOSE_SHOWING_CONTEXT;return r;case i.SEARCH_THREAD:case i.SEARCH_SNIPPET:return n(q,r);case i.SEARCH_THREAD_SELECTION:r=n(q,r);return o(q,r);case i.SEARCH_SNIPPET_SELECTION:r=n(q,r);r=o(q,r);return m(q,r);}r.redirect=true;return r;}};function m(q,r){var s=q.getQueryData().mid;if(s){r.data.message_id=s;}else r.redirect=true;return r;}function n(q,r){var s=q.getQueryData().query;if(s){r.data.query=s;}else r.redirect=true;return r;}function o(q,r){var s=q.getQueryData().tid;if(s){var t=g.isValid(s)?s:h.getClientThreadIDNow(s);if(t){r.data.thread_id=t;}else r.redirect=true;}else r.data.thread_id=null;return r;}function p(q,r){if(q==i.COMPOSE&&!r.start)return false;return true;}e.exports=l;});
__d("MercuryJewelThreadlistControl",["CSS","copyProperties","DOM","MercuryOrderedThreadlist","Parent","MercuryThreadInformer","MercuryThreadMetadataRenderer","MercuryThreads","tx","WebMessengerStateConstants","WebMessengerPermalinks","MercuryConfig","MercuryConstants","MercuryJewelTemplates"],function(a,b,c,d,e,f){var g=b('CSS'),h=b('copyProperties'),i=b('DOM'),j=b('MercuryOrderedThreadlist'),k=b('Parent'),l=b('MercuryThreadInformer'),m=b('MercuryThreadMetadataRenderer'),n=b('MercuryThreads'),o=b('tx'),p=b('WebMessengerStateConstants'),q=b('WebMessengerPermalinks'),r=c('MercuryConfig'),s=c('MercuryConstants'),t=c('MercuryJewelTemplates');function u(v){this._rootElement=v;this._contentElement=i.find(this._rootElement,'.jewelContent');this._loadingElement=i.find(this._rootElement,'.jewelLoading');l.subscribe('threadlist-updated',this.render.bind(this));this.render();}h(u.prototype,{render:function(){i.empty(this._contentElement);g.show(this._loadingElement);var v=i.$N('div');i.appendContent(this._contentElement,v);j.getThreadlist(s.MercuryThreadlistConstants.RECENT_THREAD_OFFSET,s.MercuryThreadlistConstants.JEWEL_THREAD_COUNT,s.MessagingTag.INBOX,this.renderThreads.bind(this,v),true);},renderThreads:function(v,w){if(w.length){w.forEach(function(x){var y=t[':fb:mercury:jewel:threadlist-row'].build();m.renderCoreThreadlist(x,y,this.renderSingleThread.bind(this));i.appendContent(v,y.getRoot());}.bind(this));}else i.setContent(this._rootElement,this.renderEmptyThreadlist());g.hide(this._loadingElement);},renderSingleThread:function(v,w){if(w.unread_count>0)g.addClass(v.getRoot(),'jewelItemNew');if(r.MessagesMercuryIntegrationGK){v.getNode('link').setAttribute('href',q.getURI(p.SELECTION,{thread_id:w.thread_id}));}else m.renderTitanLink(w.thread_id,v.getNode('link'));Event.listen(v.getRoot(),'mouseover',function(event){var x=v.getRoot();if(!k.byClass(x,'notifNegativeBase'))g.addClass(x,'selected');});Event.listen(v.getRoot(),'mouseout',function(event){g.removeClass(v.getRoot(),'selected');});},renderEmptyThreadlist:function(){return i.$N('li',{className:'empty'},"Ei viestej\u00e4");}});e.exports=u;});
__d("MercuryJewel",["MercuryChannelHandler","MercuryJewelCountControl","DOM","MercuryJewelThreadlistControl","MercuryServerRequests"],function(a,b,c,d,e,f){b('MercuryChannelHandler');var g=b('MercuryJewelCountControl'),h=b('DOM'),i=b('MercuryJewelThreadlistControl'),j=b('MercuryServerRequests'),k=false;e.exports=function(m,n,o,p){j.handleUpdate(p);var q=new g(n,o),r=h.find(m,'#MercuryJewelThreadList');if(o.getRoot()&&o.isOpen()){l(r);}else o.subscribe('opened',l.bind(null,r));};function l(m){if(!k){var n=new i(m);k=true;}}});
__d("RenderManager",["function-extensions","copyProperties"],function(a,b,c,d,e,f){b('function-extensions');var g=b('copyProperties');function h(i){this._isDirty=false;this._obj=i;}g(h.prototype,{dirty:function(){if(!this._isDirty){this._isDirty=true;this._doPaint.bind(this).defer();}},_doPaint:function(){this._isDirty=false;this._obj.paint();}});e.exports=h;});
__d("CounterDisplay",["Arbiter","CSS","DOM","RenderManager","Run","$","copyProperties"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('CSS'),i=b('DOM'),j=b('RenderManager'),k=b('Run'),l=b('$'),m=b('copyProperties');function n(o,p,q,r,s,t){m(this,{_name:o,_valueNode:l(p),_wrapperNode:l(q)||null,_statusClass:s,_rm:new j(this),_arbiterSubscription:null,_count:0});var u=this._valueNode.firstChild;if(u){var v=parseInt(u.nodeValue,10);if(!isNaN(v))this._count=v;}this._statusNode=r?l(r):null;this._subscribeAll();n.instances.push(this);if(!t)k.onLeave(this._destroy.bind(this),true);}m(n,{EVENT_TYPE_ADJUST:'CounterDisplay/adjust',EVENT_TYPE_UPDATE:'CounterDisplay/update',instances:[],adjustCount:function(o,p){g.inform(n.EVENT_TYPE_ADJUST+'/'+o,p);},setCount:function(o,p){g.inform(n.EVENT_TYPE_UPDATE+'/'+o,p);}});m(n.prototype,{_destroy:function(){delete this._valueNode;delete this._wrapperNode;if(this._arbiterSubscription){this._arbiterSubscription.unsubscribe();delete this._arbiterSubscription;}n.instances.remove(this);},adjustCount:function(o){this._count=Math.max(0,this._count+o);this._rm.dirty();return this;},setCount:function(o){this._count=Math.max(0,o);this._rm.dirty();return this;},paint:function(){i.setContent(this._valueNode,this._count);this._toggleNodes();},_toggleNodes:function(){if(this._wrapperNode)h.conditionClass(this._wrapperNode,'hidden_elem',this._count<=0);if(this._statusClass&&this._statusNode)h.conditionClass(this._statusNode,this._statusClass,this._count>0);},_subscribeAll:function(){var o=[n.EVENT_TYPE_ADJUST+'/'+this._name,n.EVENT_TYPE_UPDATE+'/'+this._name];this._arbiterSubscription=g.subscribe(o,this._onInform.bind(this),g.SUBSCRIBE_NEW);},_onInform:function(o,p){p=parseInt(p);if(isNaN(p))return;if(o.indexOf(n.EVENT_TYPE_ADJUST)!=-1){this.adjustCount(p);}else if(o.indexOf(n.EVENT_TYPE_UPDATE)!=-1){this.setCount(p);}else return;return;}});e.exports=n;});
__d("MessagingEvents",["array-extensions","Arbiter","ChannelConstants","copyProperties","isEmpty"],function(a,b,c,d,e,f){b('array-extensions');var g=b('Arbiter'),h=b('ChannelConstants'),i=b('copyProperties'),j=b('isEmpty'),k={},l=new g();function m(n){if(!j(k))return;for(var o in n)l.inform('count/'+o,n[o]);}l.subscribe('mark-as-read',function(n,o){(o.tids||o.chat_ids||[]).forEach(function(p){p=''+p;if(!(p in k)){k[p]=true;var q=function(){l.unsubscribe(r);clearTimeout(s);delete k[p];},r=l.subscribe('read',function(t,u){if((u.tids||[]).contains(p)||(u.chat_ids||[]).contains(p))q();}),s=q.defer(60000);}});});g.subscribe(h.getArbiterType('messaging'),function(n,o){var p=i({},o.obj),event=p.event||'';delete p.type;delete p.event;l.inform(event,p);if('unread_counts' in p){var q=p.unread_counts;m({unread:q.inbox,other_unseen:q.other});}});g.subscribe(h.getArbiterType('inbox'),function(n,o){var p=i(o.obj);delete p.type;m(p);});a.MessagingEvents=e.exports=l;},3);
__d("TitanLeftNav",["CounterDisplay","MessagingEvents"],function(a,b,c,d,e,f){var g=b('CounterDisplay'),h=b('MessagingEvents'),i={initialize:function(){h.subscribe('count/other_unseen',function(j,k){g.setCount('other_unseen',k);});}};e.exports=i;});
__d("DoublyLinkedListMap",["copyProperties"],function(a,b,c,d,e,f){var g=b('copyProperties');function h(){this._head=null;this._tail=null;this._nodes={};this._nodeCount=0;}g(h.prototype,{get:function(i){return this._nodes[i]?this._nodes[i].data:null;},_insert:function(i,j,k,l){k&&!this._nodes[k]&&(k=null);var m=(k&&this._nodes[k])||(l?this._head:this._tail),n={data:j,key:i,next:null,prev:null};if(m){this.remove(i);if(l){n.prev=m.prev;m.prev&&(m.prev.next=n);m.prev=n;n.next=m;}else{n.next=m.next;m.next&&(m.next.prev=n);m.next=n;n.prev=m;}}n.prev===null&&(this._head=n);n.next===null&&(this._tail=n);this._nodes[i]=n;this._nodeCount++;return this;},insertBefore:function(i,j,k){return this._insert(i,j,k,true);},insertAfter:function(i,j,k){return this._insert(i,j,k,false);},prepend:function(i,j){return this.insertBefore(i,j,this._head&&this._head.key);},append:function(i,j){return this.insertAfter(i,j,this._tail&&this._tail.key);},remove:function(i){var j=this._nodes[i];if(j){var k=j.next,l=j.prev;k&&(k.prev=l);l&&(l.next=k);this._head===j&&(this._head=k);this._tail===j&&(this._tail=l);delete this._nodes[i];this._nodeCount--;}return this;},find:function(i){for(var j=this._head;j;j=j.next)if(i(j.data))return j.key;return null;},reduce:function(i,j){for(var k=this._head;k;k=k.next)j=i(k.data,j);return j;},exists:function(i){return !!this._nodes[i];},isEmpty:function(){return !this._head;},reset:function(){this._head=null;this._tail=null;this._nodes={};this._nodeCount=0;},map:function(i){for(var j=this._head;j;j=j.next)i(j.data);},getCount:function(){return this._nodeCount;}});e.exports=h;});
__d("setTimeoutAcrossTransitions",[],function(a,b,c,d,e,f){function g(h,i){return setTimeout(h,i,false);}e.exports=g;});
__d("MusicButtonStore",[],function(a,b,c,d,e,f){var g={},h={addButton:function(i,j){g[i]=j;return j;},getButton:function(i){return g[i];},getButtons:function(){return g;},removeButton:function(i){g[i]&&g[i].resetLoadingTimers();delete g[i];}};e.exports=h;});
__d("MusicEvents",["Arbiter"],function(a,b,c,d,e,f){var g=b('Arbiter');e.exports=a.MusicEvents=new g();});
__d("MusicProviders",[],function(a,b,c,d,e,f){e.exports=a.MusicProviders={SPOTIFY:'open.spotify.com'};});
__d("MusicConstants",["Arbiter","MusicEvents","MusicProviders"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('MusicEvents'),i=b('MusicProviders'),j={DEBUG:false,LIVE_LISTEN_MIN_SPOTIFY_VERSION:'spotify-0.6.6.0.g5a9eaca5',enableDebug:function(){this.DEBUG=true;},sameURLs:function(k,l){var m=/\/$/;if(k&&l){k=URI(k);l=URI(l);return k.getDomain()==l.getDomain()&&k.getPath()==l.getPath();}return false;},greaterOrEqualToMinimumVersion:function(k,l){var m=/(?:\d+\.)+/,n=k.match(m)[0].split('.').slice(0,-1),o=l.match(m)[0].split('.').slice(0,-1);if(n.length!==o.length)return false;for(var p=0;p<o.length;p++)if(+n[p]<+o[p]){return false;}else if(+n[p]>+o[p])return true;return true;},sanitizeForProviders:function(k){var l={};for(var m in k)if(this.ALLOWED_EXTERNAL_CONTEXT_PARAMS[m])l[m]=k[m];return l;},OP:{RESUME:'RESUME',PAUSE:'PAUSE',PLAY:'PLAY',VERSION:'VERSION'},STATUS_CHANGE_OP:{STATUS:'STATUS',LOGIN:'LOGIN',REINFORM:'REINFORM'},STATUS_CHANGE_EVENT:{playing:'PLAY_STATE_CHANGED',track:'TRACK_CHANGED'},DIAGNOSTIC_EVENT:{ALL_PAUSED:'ALL_PAUSED',ALL_OFFLINE:'ALL_OFFLINE',OFFLINE:'OFFLINE',ONLINE:'ONLINE',SEARCHING:'SEARCHING',HIT:'HIT',MISS:'MISS',RESIGN:'RESIGN',IFRAME_POLLING:'IFRAME_POLLING',RELAUNCH:'RELAUNCH',STATE_CHANGE:'STATE_CHANGE',WRONG_VERSION:'WRONG_VERSION',SERVICE_ERROR:'SERVICE_ERROR',INCORRECT_ONLINE_STATE:'INCORRECT_ONLINE_STATE',LOG_SEND_OP:'LOG_SEND_OP',REQUEUE_OP:'REQUEUE_OP'},ALLOWED_STATUS_PARAMS:{playing:'playing',track:'track',context:'context',client_version:'client_version',start_time:'start_time',expires_in:'expires_in',open_graph_state:'open_graph_state'},ALLOWED_EXTERNAL_CONTEXT_PARAMS:{uri:true,song:true,radio_station:true,album:true,playlist:true,musician:true,song_list:true,offset:true,title:true,request_id:true,listen_with_friends:true,needs_tos:true},LIVE_LISTEN_OP:{NOW_LEADING:'NOW_LEADING',NOW_LISTENING:'NOW_LISTENING',END_SESSION:'END_SESSION',SONG_PLAYING:'SONG_PLAYING',LISTENER_UPDATE:'LISTENER_UPDATE',QUEUE_SESSION:'QUEUE_SESSION',PLAY_ERROR:'PLAY_ERROR',SESSION_UPDATED:'SESSION_UPDATED',QUEUING_SESSION:'QUEUING_SESSION'},MUSIC_BUTTON:{ACTIVATE:'ACTIVATE'},ERROR:{1:'SERVICE_UNAVAILABLE_WITHOUT_PREMIUM',2:'SERVICE_UNAVAILABLE_WITHOUT_PREMIUM_OR_WAIT',3:'SERVICE_UNAVAILABLE_BILLING_ISSUE',4:'SERVICE_UNAVAILABLE_TECHNICAL_ISSUE',5:'AUDIO_AD_PLAYING',99:'SERVICE_TEMPORARILY_UNAVAILABLE',101:'SONG_UNAVAILABLE_WITHOUT_PURCHASE',102:'SONG_UNAVAILABLE_WITHOUT_PREMIUM',103:'SONG_UNAVAILABLE_INDEFINITELY'}};e.exports=a.MusicConstants||j;});
__d("MusicWaterfallLogger",["JSLogger"],function(a,b,c,d,e,f){var g=b('JSLogger'),h=g.create('music_waterfall'),i={click:function(l){j('click',l);},musicLoadedFromClick:function(l){j('music_loaded_from_click',l);},playPause:function(l){j('play_pause',l);}};function j(l,m){h.debug(l+'_debug',m);h.bump(l);h.bump(l+'_'+k(m));}function k(l){return l?l.replace(/\.|-/g,'_'):'';}e.exports=i;});
__d("MusicButton",["Bootloader","copyProperties","CSS","DOM","MusicButtonStore","MusicConstants","MusicEvents","MusicWaterfallLogger","Parent","Tooltip"],function(a,b,c,d,e,f){var g=b('Bootloader'),h=b('copyProperties'),i=b('CSS'),j=b('DOM'),k=b('MusicButtonStore'),l=b('MusicConstants'),m=b('MusicEvents'),n=b('MusicWaterfallLogger'),o=b('Parent'),p=b('Tooltip'),q=function(r,s,t,u,v,w){this.provider=r;this.buttonElem=s;this.url=t;this.context=u||{};this.mediaType=v;this.setState(this.STATES.OFFLINE);this.tooltip=w||'';m.subscribe(l.MUSIC_BUTTON.ACTIVATE,this.processClick.bind(this));};h(q,{tracksetableTypes:[]});h(q.prototype,{SHOW_LOADING_TIMEOUT:500,HIDE_LOADING_TIMEOUT:4000,RECENTLY_ONLINE_TIMEOUT:6000,STATES:{PLAYING:'music_playing',PAUSED:'music_paused',LOADING:'music_loading',DISABLED:'music_disabled',OFFLINE:'music_offline'},setState:function(r){if(r!==this.STATES.LOADING){this.resetLoadingTimers();this.previousState=this.state||r;}if(r===this.STATES.PLAYING){p.set(this.buttonElem,this.tooltip);}else p.set(this.buttonElem,'');var s=this.buttonElem.parentNode;this.state&&i.removeClass(s,this.state);this.state=r;i.addClass(s,this.state);},isTracksetable:function(r){return q.tracksetableTypes.indexOf(this.mediaType)!==-1;},handleIncomingEvent:function(r,s){clearTimeout(this._showLoadingTimer);if(s&&s.provider&&s.provider!=this.provider)return;switch(r){case l.DIAGNOSTIC_EVENT.ONLINE:case l.STATUS_CHANGE_EVENT.track:case l.STATUS_CHANGE_EVENT.playing:var t=s&&s.track&&s.track.uri,u=s&&s.context&&s.context.uri;if(s&&s.playing&&(l.sameURLs(t,this.url)||l.sameURLs(u,this.url))){this.setState(this.STATES.PLAYING);}else if(this.state===this.STATES.LOADING&&(this.previousState===this.STATES.PAUSED||this.previousState===this.STATES.OFFLINE)){clearTimeout(this._attemptingPlayTimer);this._attemptingPlayTimer=this.setState.bind(this,this.STATES.PAUSED).defer(this.RECENTLY_ONLINE_TIMEOUT,false);}else if(!this._attemptingPlayTimer)this.setState(this.STATES.PAUSED);break;case l.DIAGNOSTIC_EVENT.OFFLINE:this.setState(this.STATES.OFFLINE);break;case l.DIAGNOSTIC_EVENT.ALL_OFFLINE:this.setState(this.STATES.OFFLINE);break;}},processClick:function(r,s){if(s!=this.buttonElem){if(this.state===this.STATES.LOADING)this.previousState&&this.setState(this.previousState);return;}n.click(this.provider);var t=this.isTracksetable()&&o.byClass(this.buttonElem,'music_trackset_container'),u=[];if(t){var v=t.getAttribute('data-trackset-title'),w=this.provider,x=j.scry(t,'.music_button');for(var y=0;y<x.length;y++){var z=k.getButton([x[y].id]);if(z&&z.provider==w&&z.isTracksetable())u.push(z.url);}}if(!a.Music)this.showLoading(true);g.loadModules(['Music'],function(aa){n.musicLoadedFromClick(this.provider);var ba=(t&&u.length>1)?aa.playPauseSongList(this.provider,this.url,u,v,this.context):aa.playPauseSong(this.provider,this.url,this.context);this.showLoading(!ba);}.bind(this));},showLoading:function(r){this.resetLoadingTimers();this._hideLoadingTimer=this._timeout.bind(this,r).defer(this.HIDE_LOADING_TIMEOUT,false);this._showLoadingTimer=this.setState.bind(this,this.STATES.LOADING).defer(this.SHOW_LOADING_TIMEOUT,false);},resetLoadingTimers:function(){clearTimeout(this._hideLoadingTimer);clearTimeout(this._showLoadingTimer);clearTimeout(this._attemptingPlayTimer);this._attemptingPlayTimer=null;},destroy:function(){this.resetLoadingTimers();this.buttonElem=null;},_timeout:function(r){a.Music&&a.Music.reInform([this.provider]);if(!r&&this.state===this.STATES.LOADING)this.setState(this.STATES.PAUSED);}});e.exports=q;});
__d("MusicButtonManager",["DOM","Layer","MusicButton","MusicButtonStore","MusicConstants","MusicEvents","Parent","$","event-extensions","copyProperties","ge"],function(a,b,c,d,e,f){var g=b('DOM'),h=b('Layer'),i=b('MusicButton'),j=b('MusicButtonStore'),k=b('MusicConstants'),l=b('MusicEvents'),m=b('Parent'),n=b('$'),o=b('event-extensions').$E,p=b('copyProperties'),q=b('ge'),r=(function(){var s=null,t={};function u(event){var z=o(event).getTarget(),aa=m.byClass(z,'music_button');aa=aa||(!event.getModifiers().any&&v(z));if(!aa)return;return w(aa,event);}function v(z){var aa=m.byClass(z,'music_button_trigger')&&m.byClass(z,'music_button_trigger_group');if(aa){var ba=g.scry(aa,'.music_button');if(ba.length)return ba[0];}return null;}function w(z,event){event&&o(event).stop();l.inform(k.MUSIC_BUTTON.ACTIVATE,z);return false;}function x(z){a.Music&&a.Music.reInform(z);}function y(z,aa){var ba=j.getButtons();for(var ca in ba)if(ba[ca].noGC||q(ca)){ba[ca].handleIncomingEvent(z,aa);}else j.removeButton(ca);}return {init:function(z){if(s)return;s=true;i.tracksetableTypes=z||[];Event.listen(document.body,'click',u);l.subscribe([k.STATUS_CHANGE_EVENT.playing,k.STATUS_CHANGE_EVENT.track,k.DIAGNOSTIC_EVENT.OFFLINE,k.DIAGNOSTIC_EVENT.ALL_OFFLINE,k.DIAGNOSTIC_EVENT.ONLINE],y);},addButton:function(z,aa,ba,ca,da,ea){s||r.init();if(!q(aa))return;var fa=j.getButton(aa);fa;var ga=n(aa);fa=j.addButton(aa,new i(z,ga,ba,p({button_id:aa},ca),da,ea));var ha=m.byClass(ga,'uiOverlay');if(ha){fa.noGC=true;var ia=h.subscribe('destroy',function(ja,ka){if(g.contains(ka.getRoot(),ga)){j.removeButton(aa);h.unsubscribe(ia);}});}if(z&&!t[z])t[z]=function(){var ja=Object.keys(t);ja.length&&x(ja);t={};}.defer();return fa;}};})();e.exports=a.MusicButtonManager||r;});
__d("NotificationList",["Arbiter","ArbiterMixin","Class","CSS","DOM","DoublyLinkedListMap","HTML","URI","$","copyProperties","ge","isEmpty","tx"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('ArbiterMixin'),i=b('Class'),j=b('CSS'),k=b('DOM'),l=b('DoublyLinkedListMap'),m=b('HTML'),n=b('URI'),o=b('$'),p=b('copyProperties'),q=b('ge'),r=b('isEmpty'),s=b('tx'),t=k.$N;function u(v,w){this._list=new l();this._filter_func=null;this.unreadCount=0;this.contentRoot=v;this.noItemsElement=null;this.ITEM_TAG='li';this.ITEM_CLASS='notification';this.NO_ITEMS_ID='jewelNoNotifications';this.NO_ITEMS_CLASS='empty';this.compare=w.compare||this.compare;}p(u,{ITEM_UNREAD_CLASS:'jewelItemNew',MARK_READ_TYPE:'mark_read',UNREAD_COUNT_CHANGE_TYPE:'unread_count_change',INSERTION_TYPE:'insert',REMOVAL_TYPE:'remove',getIdFromDom:function(v){return v.getAttribute('id').replace('notification_','');},localizeUrls:function(v){k.scry(v,'a').forEach(function(w){n(w.href).isFacebookURI()&&(w.href=n(w.href).getUnqualifiedURI().getQualifiedURI().setSubdomain(n(w.href).getSubdomain()).toString());});}});p(u.prototype,h,{_getField:function(v,w){var x=this._list.get(v);return x&&x[w];},getDomObj:function(v){return this._getField(v,'obj');},fromDom:function(){var v=this.ITEM_TAG+'.'+this.ITEM_CLASS,w=k.scry(this.contentRoot,v);for(var x=0;x<w.length;++x){var y=w[x],z=u.getIdFromDom(y);this.insert(z,y.getAttribute('data-notiftime'),null);}},compare:function(v,w){return v.time<w.time||(v.time===w.time&&v.id<w.id);},insert:function(v,w,x,y,z,aa){var ba=true,ca=0,da=this._list.exists(v),ea=aa&&this._list.exists(aa),fa=null,ga;if(da||ea)if(!(y&&x)){return false;}else{if(this._filter_func){ga={notif_id:v,notif_time:w,notif_markup:x,replace:y,ignoreUnread:z,notif_alt_id:aa};if(this._filter_func(ga))return false;}ba=this._getField(v,'unread');ca=this._getField(v,'time');if(ca>w)return false;fa=da?v:aa;this.remove(fa);}var ha=(x&&m(x).getRootNode())||o('notification_'+v),ia=Math.max(w,ca),ja=j.hasClass(ha,u.ITEM_UNREAD_CLASS);ga={id:v,obj:ha,time:ia,unread:ja,app_id:ha.getAttribute('data-appid')};this._insert(ga);u.localizeUrls(ha);this.noItemsElement&&j.hide(this.noItemsElement);if(ja){this.unreadCount=this.getUnreadIds().length;this.inform(u.UNREAD_COUNT_CHANGE_TYPE);z&&!ba&&this.markRead([v]);}var ka=!fa||ca<ia||(ja&&!ba&&!z);this.inform(u.INSERTION_TYPE,{id:v,is_new:ka,obj:ha,replaced_id:fa,time:ia});return true;},showNoNotifications:function(){if(null==this.noItemsElement)this.noItemsElement=q(this.NO_ITEMS_ID);if(null==this.noItemsElement){this.noItemsElement=t(this.ITEM_TAG,{id:this.NO_ITEMS_ID,className:this.NO_ITEMS_CLASS},"Ei uusia ilmoituksia");k.appendContent(this.contentRoot,this.noItemsElement);}j.show(this.noItemsElement);},_insert:function(v){this._list.remove(v.id);var w=null;this._list.find(function(y){var z=this.compare(y,v);!z&&(w=y.id);return z;}.bind(this));var x=this.getDomObj(w);if(x){this._list.insertAfter(v.id,v,w);k.insertAfter(x,v.obj);}else{this._list.prepend(v.id,v);k.prependContent(this.contentRoot,v.obj);}},remove:function(v){var w=this._getField(v,'obj');if(!w)return false;this.inform(u.REMOVAL_TYPE,{id:v});this.markRead([v]);this._list.remove(v);k.remove(w);this.isEmpty()&&this.showNoNotifications();return true;},_getIds:function(v,w){return this._list.reduce(function(x,y){!(x.unread?v:w)&&y.push(x.id);return y;},[]);},getUnreadIds:function(){return this._getIds(false,true);},getReadIds:function(){return this._getIds(true);},getIds:function(){return this._getIds();},isUnreadId:function(v){return this._getField(v,'unread');},markRead:function(v){v=v?v.filter(this.isUnreadId.bind(this)):this.getUnreadIds();for(var w=0;w<v.length;w++){var x=this._list.get(v[w]);if(x){this.inform(u.MARK_READ_TYPE,x.obj);x.unread=false;}}if(v.length){this.unreadCount=this.getUnreadIds().length;this.inform(u.UNREAD_COUNT_CHANGE_TYPE);}},insertMany:function(v,w){if('object'==typeof v&&!r(v)){for(var x in v){var y=v[x];this.insert(x,y.time,y.markup,true,w,y.alt_id||null);}this.noItemsElement&&j.hide(this.noItemsElement);}else this.isEmpty()&&this.showNoNotifications();},isEmpty:function(){return this._list.isEmpty();},getEarliestNotifTime:function(){return Math.min.apply(null,this.getIds().map(function(v){return this._getField(v,'time');}.bind(this)));},setFilterFn:function(v){this._filter_func=v;},toggleNotifsSimilarTo:function(v,w,x){var y=this._getField(v,'app_id');if(y){var z=this.getIds();for(var aa=0;aa<z.length;++aa)if(y==this._getField(z[aa],'app_id')){var ba=this.getDomObj(z[aa]);if(v!=z[aa])w?j.hide(ba):j.show(ba);var ca=k.scry(ba,'.first_receipt_div');if(ca.length==1)if(x){j.hide(ca[0]);j.removeClass(ba,'first_receipt');}else{j.show(ca[0]);j.addClass(ba,'first_receipt');}}}}});e.exports=u;});
__d("legacy:notifications-list",["NotificationList"],function(a,b,c,d){a.NotificationList=b('NotificationList');},3);
function Notifications(a){this.updateTime=a.updateTime||Date.now();this.user=Env.user;this.cache_version=a.cacheVersion||0;this.allowDesktopNotifications=a.allowDesktopNotifications||false;this.latest_notif_time=a.latestNotif||0;this.latest_read_notif_time=a.latestReadNotif||0;this.update_period=a.updatePeriod||60000;this.notifReceivedType=a.notifReceivedType||'notification';this.wrapperID=a.wrapperID||'notificationsWrapper';this.contentID=a.contentID||'jewelNotifs';this.timeElement='small.time';this.shouldLogImpressions=a.shouldLogImpressions||false;this.ua=new UserNoOp();this._init();}Notifications.BEEPS_EXPIRED='beeper/beeps_expired';copy_properties(Notifications.prototype,{_init:function(){this.cookieName='notifications_'+this.user;this.beepsExpiredToken=null;this.updateCheckCount=0;this.fetchListeners=[];this.currentFetchRequest=null;this.wrapper=ge(this.wrapperID);this.content=ge(this.contentID);this.jewelFlyout=ge('fbNotificationsFlyout');this.loadingIndicator=ge(this.contentID+'_loading_indicator');this.NOTIF_JEWEL_REF='notif_jewel';this.BEEPER_REF='beeper';NotificationCounter.init();this.alertList=new NotificationList(this.content,this._getListParams());this._updateCount();window.MinNotifications&&MinNotifications.fetchSent()&&(this.fetch=bagofholding);Arbiter.subscribe(ChannelConstants.getArbiterType(this.notifReceivedType),this._handleNotificationMsg.bind(this));Arbiter.subscribe(ChannelConstants.getArbiterType('notifications_read'),this._handleNotificationsReadMsg.bind(this));Arbiter.subscribe(ChannelConstants.getArbiterType('notifications_seen'),this._handleNotificationsSeenMsg.bind(this));this.alertList.subscribe(NotificationList.UNREAD_COUNT_CHANGE_TYPE,this._updateCount.bind(this));this._poller=new Poller(this.update_period,this._update.bind(this),true);if(this.wrapper)this.countSpan=DOM.find(this.wrapper,'span.jewelCount span');this.initializeEvents();this.fromDom();},_getListParams:function(){return {};},fromDom:function(){this.alertList.fromDom();window.MinNotifications&&MinNotifications.fetched()&&this.alertList.isEmpty()&&this.alertList.showNoNotifications();},initializeEvents:function(){var a=this.alertList.ITEM_TAG,b=null;Event.listen(this.content,{mouseover:function(event){var d=event.getTarget();b=Parent.byTag(d,a);if(b&&d!=b)if(Parent.byClass(b,'notifNegativeBase')){CSS.addClass(b,'notifHover');}else CSS.addClass(b,'selected');},mouseout:function(event){b&&CSS.removeClass(b,'selected');b&&CSS.removeClass(b,'notifHover');b=null;},mousedown:this.onContentMouseDown.bind(this)});Event.listen(this.wrapper,'mouseover',this.onMouseOver.bind(this));Toggler.listen('show',this.wrapper,this.onClick.bind(this));Toggler.listen('hide',this.wrapper,this.onHide.bind(this));this.shouldLogImpressions&&Toggler.listen('show',this.wrapper,this._logImpression.bind(this));var c=this._poller.requestNow.shield(this._poller);SystemEvents.subscribe(SystemEvents.TIME_TRAVEL,c);SystemEvents.subscribe(SystemEvents.ONLINE,function(d,e){e&&c();});},onContentMouseDown:function(event){var a=Parent.byTag(event.getTarget(),this.alertList.ITEM_TAG),b=a&&NotificationList.getIdFromDom(a);b&&this.alertList.isUnreadId(b)&&this.markRead(true,[b]);b&&CSS.hasClass(a,NotificationList.ITEM_UNREAD_CLASS)&&this._stopNotifAnimation(undefined,{id:b})&&CSS.removeClass(a,NotificationList.ITEM_UNREAD_CLASS);},onMouseOver:function(event){this.ua=user_action('jewel',event.target,event).set_namespace('notifs').set_ua_id('prefetch').add_event('hover');this.fetch();},onClick:function(){window.ArbiterMonitor&&this.fetch!=bagofholding&&Arbiter.registerCallback(bagofholding,['notifs/fetched']);this.ua.add_event('show');this.fetch();this.markRead(true);},onHide:function(){this.ua.add_event('hide');this.markRead(true);},_sendIDs:function(a,b,c){var d=c||{};for(var e=0;e<a.length;++e)d['alert_ids['+e+']']=a[e];new AsyncSignal(URI(b).getQualifiedURI().toString(),d).send();},_waitForFetch:function(a){return this.currentFetchRequest&&this.fetchListeners.push(a.bind(this));},_logImpression:function(){var a=this.alertList.getIds();if(a.length===0&&this._waitForFetch(this._logImpression))return;this.logImpressionIds(a,this.NOTIF_JEWEL_REF);},logImpressionIds:function(a,b){this.shouldLogImpressions&&this._sendIDs(a,'/ajax/notifications/impression.php',{ref:b});},markRead:function(a,b){var c=!hasArrayNature(b);b=c?this.alertList.getUnreadIds():b.filter(this.alertList.isUnreadId.bind(this.alertList));if(b.length){a&&this._sendIDs(b,'/ajax/notifications/mark_read.php',{seen:c?1:0});this.alertList.markRead(b);this._updateCount();}c&&this._waitForFetch(this.markRead.bind(this,a));},_updateErrorHandler:function(a){},_updateURI:'/ajax/presence/update.php',_update:function(a){a.setHandler(this._handleUpdate.bind(this)).setOption('suppressErrorAlerts',true).setErrorHandler(this._updateErrorHandler.bind(this)).setData({notif_latest:this.latest_notif_time,notif_latest_read:this.latest_read_notif_time}).setURI(this._updateURI).setAllowCrossPageTransition(true);},_handleUpdate:function(a){var b=a.payload.notifications;if(!b.no_change){this.updateTime=a.payload.time;this.latest_notif_time=b.latest_notif;this.latest_read_notif_time=b.latest_read_notif;this._updateDisplayDelayed();this.alertList.insertMany(b.notifications);}},_updateDisplayDelayed:function(){if(typeof Beeper!='undefined'){this.beepsExpiredToken=Arbiter.subscribe(Notifications.BEEPS_EXPIRED,this._updateDisplay.bind(this));}else this._updateDisplay();},_updateDisplay:function(){if(!this.content)return;this._updateCount();if(this.beepsExpiredToken)this.beepsExpiredToken.unsubscribe();},_updateCount:function(){Arbiter.inform('jewel/count-updated',{jewel:'notifications',count:this.alertList.unreadCount},Arbiter.BEHAVIOR_STATE);},fetch:function(a){this._sendFetchRequest(a);},_getFetchQueryData:function(){return {time:this.latest_notif_time,user:this.user,version:this.cache_version,locale:Env.locale};},_sendFetchRequest:function(a){var b=URI('/ajax/notifications/get.php'),c=a||this.loadingIndicator;if(this.currentFetchRequest)return true;this.ua.add_event('fetch');b.setQueryData(this._getFetchQueryData());this.currentFetchRequest=new AsyncRequest().setURI(b).setStatusElement(c).setMethod('GET').setReadOnly(true).setTimeoutHandler(30000,this.fetchErrorHandler.bind(this)).setHandler(this.fetchHandler.bind(this)).setErrorHandler(this.fetchErrorHandler.bind(this)).setAllowCrossPageTransition(true);!this.currentFetchRequest.send()&&this.fetchErrorHandler();return true;},fetchErrorHandler:function(a){this.currentFetchRequest=null;this.ua.add_event('fetch_error');},fetchHandler:function(a){this.ua.add_event('fetch_success');var b=a.getPayload();this.alertList.insertMany(b.notifications,true);this.loadingIndicator&&CSS.hide(this.loadingIndicator);this.loadingIndicator=null;this.currentFetchRequest=null;this.fetch=bagofholding;if(this.fetchListeners){for(var c=0;c<this.fetchListeners.length;c++)this.fetchListeners[c]();this.fetchListeners=[];}window.ArbiterMonitor&&Arbiter.inform('notifs/fetched','',Arbiter.BEHAVIOR_STATE);},_mergeNotification:function(a,b,c,d){var e=!this.alertList.isUnreadId(a);this.alertList.insert(a,b,c,true,null,d||null);this.latest_notif_time=0;if(e)this._updateCount();},_handleNotificationMsg:function(a,b){var c=b.obj;if(typeof this.useDesktopNotifications=='undefined'){var d;this.useDesktopNotifications=this.allowDesktopNotifications&&window.webkitNotifications&&window.webkitNotifications.checkPermission()===0;}if(this.useDesktopNotifications)Bootloader.loadComponents('desktop-notifications',function(){DesktopNotifications.addNotification(c.alert_id);});if(c.markup){this._mergeNotification(c.alert_id,c.time,c.markup,c.alt_id||null);}else this._poller.requestNow();},_handleNotificationsReadMsg:function(a,b){var c=b.obj;if(typeof Beeper!='undefined')Beeper.getInstance().markRead(false,c.alert_ids);this.markRead(false,c.alert_ids);},_handleNotificationsSeenMsg:function(a,b){return this._handleNotificationsReadMsg(a,b);}});
function OriginalNotifications(a){this.scrollableAreaNode=null;this.useInfiniteScroll=a.useInfiniteScroll||false;this.useUnaggregatedBeeper=a.unaggregatedBeeper||false;this.useShortJewel=a.useShortJewel||false;this.persistUnreadColor=a.persistUnreadColor||false;this.firstReceiptMap={};this.notifAnimations={};this.parent.construct(this,a);}Class.extend(OriginalNotifications,'Notifications');copy_properties(OriginalNotifications.prototype,{_init:function(){this.ignoreBeeps=false;this.BEEPER_APPID=30729425562;this.parent._init();this.alertList.subscribe(NotificationList.MARK_READ_TYPE,this._animateMarkRead.bind(this));this.alertList.subscribe(NotificationList.REMOVAL_TYPE,this._stopNotifAnimation.bind(this));Arbiter.subscribe('jewel/resize',this._hideOverflow.shield(this));if(this.useInfiniteScroll){this._autoLoadNotifIndex=1;this._truncate=false;this.alertList.subscribe(NotificationList.INSERTION_TYPE,this._handleInsert.bind(this));}},initializeEvents:function(){this.parent.initializeEvents();if(Parent.byClass(this.wrapper,'notifJewelBeeper')&&!FbDesktopPlugin.shouldSuppressBeeper()&&(this.beeper=window.NotifBeeper))this._initBeeper();if(Parent.byClass(this.wrapper,'notifNegativeBase')){this.negativeNotifs={};this._initNotifNegativeFeedback();}if(this.useInfiniteScroll){this._setupScroll();this._initializeScrollEvents();this._updateScrollDataStructures.bind(this).defer();this._hideOverflow();}},_setupScroll:function(){this._scrollArea=DOM.scry(this.jewelFlyout,'div.uiScrollableAreaWrap')[0];this._morePagerLink=DOM.find(this.jewelFlyout,'.notifMorePager a');this._morePager=Parent.byClass(this._morePagerLink,'notifMorePager')||this._morePagerLink;this._infiniteScrollNotif=null;this.afterFirstFetch=false;this.animate=false;if(window.MinNotifications&&MinNotifications.fetched()){this.afterFirstFetch=true;CSS.show(this._morePager);}},_initializeScrollEvents:function(){Event.listen(this._scrollArea,'scroll',throttle(this._handleScroll.bind(this)));Event.listen(this._morePagerLink,'success',function(a){this.fetchHandler(a.getData().response);}.bind(this));},_updateScrollDataStructures:function(){var a=this.alertList.getIds(),b=Math.max(0,a.length-this._autoLoadNotifIndex);this._infiniteScrollNotif=this.alertList.getDomObj(a[b]);this._annotateMorePagerURI();},_annotateMorePagerURI:function(){this._morePagerLink.setAttribute('ajaxify',new URI(this._morePagerLink.getAttribute('ajaxify')).addQueryData({earliest_time:this.alertList.getEarliestNotifTime()}));},_handleInsert:function(a,b){if(b.is_new)this._newDataFromInsert=true;this._updateScrollDataStructures();},_handleScroll:function(){if(this._checkInfiniteScroll()){this._autoLoadNotifIndex=5;this._sendFetchRequest(this._morePager);}},_checkInfiniteScroll:function(){if(this._infiniteScrollNotif&&this._scrollArea){var a=Vector2.getElementPosition(this._infiniteScrollNotif).y,b=Vector2.getElementPosition(this._scrollArea).y+Vector2.getElementDimensions(this._scrollArea).y;return a<b;}return false;},_sendFetchRequest:function(a){if(this.useInfiniteScroll){this._infiniteScrollNotif=null;this._newDataFromInsert=false;this._truncate=true;}this.parent._sendFetchRequest(a);},_getFetchQueryData:function(){var a=this.parent._getFetchQueryData();if(this.useInfiniteScroll)a.earliest_time=this.alertList.getEarliestNotifTime();return a;},fromDom:function(){this.ignoreBeeps=true;this.parent.fromDom();this.ignoreBeeps=false;},_initBeeper:function(){this.beeper.init(this.jewelFlyout);!this.useUnaggregatedBeeper&&this.alertList.subscribe(NotificationList.INSERTION_TYPE,function(a,b){if(Toggler.getInstance(this.wrapper).getActive()!==this.wrapper&&!this.ignoreBeeps&&this.alertList.isUnreadId(b.id)){b.is_new?this.beeper.addBeep(b.id,b.obj):this.beeper.updateBeep(b.replaced_id,b.id,b.obj);this.logImpressionIds([b.id],this.BEEPER_REF);}}.bind(this));!this.useUnaggregatedBeeper&&this.alertList.subscribe(NotificationList.REMOVAL_TYPE,function(a,b){this.beeper.removeBeep(b.id);}.bind(this));this.useUnaggregatedBeeper&&new LiveMessageReceiver('unaggregated_beep').setAppId(this.BEEPER_APPID).setHandler(function(a){Toggler.getInstance(this.wrapper).getActive()!==this.wrapper&&this.beeper.fromMessage(a);}.bind(this)).register();},_initNotifNegativeFeedback:function(){this.notifXList=null;var a=function(b){Bootloader.loadComponents('notif-experiment-negative-notif',b);};a(function(){this.notifXList=window.NotifXList;this.notifXList.init(this);this.alertList.setFilterFn(this.notifXList.filterStoreClicked);Toggler.listen('hide',$(this.wrapperID),function(){for(var b in this.negativeNotifs)if(b)this.negativeNotifs[b] instanceof NegativeNotif&&this.negativeNotifs[b].reset();}.bind(this));Arbiter.subscribe('notif/negativeCancel',function(b,c){this.negativeNotifs[c.id]&&this.negativeNotifs[c.id].restore();}.bind(this));Arbiter.subscribe('notif/negativeConfirmed',function(b,c){this.negativeNotifs[c.id]&&this.negativeNotifs[c.id].onTurnedOff();this.alertList.toggleNotifsSimilarTo(c.id,true,true);this._hideOverflow();this._handleScroll();}.bind(this));Arbiter.subscribe('notif/negativeUndid',function(b,c){this.negativeNotifs[c.id]&&this.negativeNotifs[c.id].onUndid();this.alertList.toggleNotifsSimilarTo(c.id,false,true);this._hideOverflow();}.bind(this));Arbiter.subscribe('notif/negativeMarkedSpam',function(b,c){this.negativeNotifs[c.id]&&this.negativeNotifs[c.id].onMarkedSpam();}.bind(this));Arbiter.subscribe('notif/negativeFirstReceiptYes',function(b,c){this.negativeNotifs[c.id]&&this.negativeNotifs[c.id].onFirstReceiptYes();this.alertList.toggleNotifsSimilarTo(c.id,false,true);}.bind(this));Arbiter.subscribe('notif/negativeFirstReceiptNo',function(b,c){this.negativeNotifs[c.id]&&this.negativeNotifs[c.id].onFirstReceiptNo();this.alertList.toggleNotifsSimilarTo(c.id,false,true);}.bind(this));}.bind(this));this.alertList.subscribe(NotificationList.INSERTION_TYPE,function(b,c){a(function(){var d=DOM.scry(c.obj,'.notif_x');if(d.length==1)this.negativeNotifs[c.id]=new NegativeNotif(this,c);}.bind(this));this._updateFirstReceipt(c);}.bind(this));},fetchHandler:function(a){this.parent.fetchHandler(a);var b=a.getPayload(),c=b.generated,d=Math.round((new Date()).getTime()/1000);if(d-c>15)c=d;Bootloader.loadComponents('live-timer',function(){LiveTimer.restart(c);LiveTimer.startLoop(0);});if(this.useInfiniteScroll){if(is_empty(b.notifications)||!this._newDataFromInsert){this._noMoreNotifications();}else CSS.show(this._morePager);this._updateScrollDataStructures();if(Toggler.getInstance(this.wrapper).getActive()==this.wrapper&&this.afterFirstFetch)this.animate=true;this.afterFirstFetch=true;}this._hideOverflow();},fetchErrorHandler:function(a){this.parent.fetchErrorHandler();this.useInfiniteScroll&&this._updateScrollDataStructures();},_noMoreNotifications:function(){CSS.hide(this._morePager);this.useInfiniteScroll=false;},_mergeNotification:function(a,b,c,d){this.parent._mergeNotification(a,b,c,d);var e=this.alertList.getDomObj(a);if(e)Bootloader.loadComponents('live-timer',function(){LiveTimer.addTimeStamps(e);});},_animateMarkRead:function(a,b){if(!CSS.hasClass(b,NotificationList.ITEM_UNREAD_CLASS))return;var c=NotificationList.getIdFromDom(b),d=function(){CSS.removeClass(b,NotificationList.ITEM_UNREAD_CLASS);delete this.notifAnimations[c];}.bind(this);if(CSS.hasClass(b,'fbJewelBeep')){d();return;}if(this.persistUnreadColor&&Toggler.getInstance(this.wrapper).getActive()===this.wrapper)return;if(this.negativeNotifs!==undefined){d.defer(10000);}else{this._stopNotifAnimation(undefined,{id:c});this.notifAnimations[c]=animation(b).duration(5000).checkpoint().to('backgroundColor','#FFFFFF').duration(2250).ondone(d).go();}},_stopNotifAnimation:function(a,b){b.id in this.notifAnimations&&this.notifAnimations[b.id].stop();delete this.notifAnimations[b.id];return true;},onClick:function(){this.beeper&&this.beeper.clearBeeps();this.parent.onClick();this._hideOverflow();},onHide:function(){this.animate=false;this.animation&&this.animation.stop();this.parent.onHide();},_updateCount:function(){this.parent._updateCount();this._hideOverflow();},_handleNotificationsReadMsg:function(a,b){this.parent._handleNotificationsReadMsg(a,b);this.beeper&&this.beeper.fadeOutBeeps(b.obj.alert_ids);},_hideOverflow:function(a,b){a=a||DOM.find(this.jewelFlyout,'.jewelFooter');b=b||DOM.scry($('fbNotificationsList'),'.notification');this.scrollableAreaNode=this.scrollableAreaNode||DOM.scry(this.jewelFlyout,'.uiScrollableArea')[0];var c=20;if(!b.length||(CSS.hasClass(document.documentElement,'tinyViewport')&&!CSS.hasClass(document.body,'fixedBody'))){CSS.setStyle(this.scrollableAreaNode,'height','100%');return;}var d=this.scrollableAreaNode||b[0],e=Vector2.getViewportDimensions().y-Vector2.getElementPosition(d,'viewport').y-Vector2.getElementDimensions(a).y-5,f=e,g=0;for(;g<b.length&&f>0;++g)if(CSS.shown(b[g]))f-=Vector2.getElementDimensions(b[g]).y;var h=this.useShortJewel?300:530,i=Math.min(h,e-Math.max(f,0));if(f>=0&&i<h){if(!this.useInfiniteScroll||(this.beeper&&this.beeper.hasBeeps())){i='100%';}else{if(this._truncate&&b.length>=5)i-=c;i+='px';}}else i+='px';if(this.useInfiniteScroll&&this.animate&&i!='100%'){this.animation&&this.animation.stop();this.animation=animation(this.scrollableAreaNode).to('height',i).duration(200).go();}else{var j=ScrollableArea.getInstance(this.scrollableAreaNode);j&&j.showScrollbar.bind(j).defer();CSS.setStyle(this.scrollableAreaNode,'height',i);}},_updateFirstReceipt:function(a){var b=a.obj.getAttribute('data-appid'),c=DOM.scry(a.obj,'.first_receipt_div');if(b&&c.length==1){if(this.firstReceiptMap[b]){if(a.id!=this.firstReceiptMap[b].id&&this.firstReceiptMap[b].time>a.time)return;CSS.removeClass(this.firstReceiptMap[b].obj,'first_receipt');}this.firstReceiptMap[b]=a;CSS.addClass(a.obj,'first_receipt');}}});
__d("SearchDataSource",["event-extensions","Arbiter","AsyncResponse","Class","DataSource","copyProperties","createArrayFrom"],function(a,b,c,d,e,f){b('event-extensions');var g=b('Arbiter'),h=b('AsyncResponse'),i=b('Class'),j=b('DataSource'),k=b('copyProperties'),l=b('createArrayFrom');function m(n){this._token=n.token||'';this._lazyonload=n.lazyonload===false?false:true;this._extraTypes=n.extraTypes;this._buckets=n.buckets;this._noMultiFetch=n.noMultiFetch||false;var o=n.maxResults||8;this.parent.construct(this,n);this._numResults={min:3,max:o};this._genTime=n.genTime;}i.extend(m,j);k(m.prototype,{init:function(){this.parent.init();this._leanPayload=null;this._bootstrapRequestsPending=0;this._criticalOnly=true;this._updateMaxResults();Event.listen(window,'resize',this._updateMaxResults.bind(this));},dirty:function(){this.parent.dirty();this._fetchOnUseRequests=[];},asyncErrorHandler:function(n){if(window.Dialog&&window.Dialog.getCurrent()==null&&n.getError()==1400003)h.verboseErrorHandler(n);},fetch:function(n,o,p){p=p||{};p.fetch_start=Date.now();this.parent.fetch(n,o,p);},fetchHandler:function(n,o){var p=n.getPayload(),q=k({fetch_end:Date.now()},o),r=q.value?g.BEHAVIOR_EVENT:g.BEHAVIOR_PERSISTENT;this.inform('beginFetchHandler',{response:n});if(o.type=='lean'){this._leanPayload=p;this._processLean();}else{if(p.coeff2_ts)q.coeff2_ts=p.coeff2_ts;this.parent.fetchHandler(n,o);if(o.bootstrap&&!n.getRequest().getData().no_cache)q.browserCacheHit=(p.timestamp<this._genTime);if(o.bootstrap&&!p.no_data&&this._bootstrapRequestsPending>0){o.bootstrap=false;--this._bootstrapRequestsPending;!this._bootstrapRequestsPending&&this._bootstrapPostProcess();}if(p.no_data||p.token!==this._token){var s=k({},n.getRequest().getData());if(s.lazy){delete s.lazy;s.token=this._token;this._fetchOnUse(s,o);}}}this.inform('endpointStats',q,r);},_bootstrapPostProcess:function(){var n={time:Date.now()};this.inform('bootstrapped',n,g.BEHAVIOR_PERSISTENT);this._processLean();},_processLean:function(){if(this._leanPayload){var n,o=this._leanPayload.entries;for(var p in o){n=this.getEntry(p);n&&(n.index=o[p]);}this.setExclusions(this._leanPayload.blocked);this._leanPayload=null;}},_updateMaxResults:function(){var n=window.innerHeight||document.documentElement.clientHeight;this.setMaxResults(Math.max(this._numResults.min,Math.min(this._numResults.max,Math.ceil(2+((n-370)/56)))));},_bootstrapFetch:function(n,o){var p=k(o,this.bootstrapData);if(this._criticalOnly&&this._lazyonload)p.lazy=1;this.fetch(this.bootstrapEndpoint,p,{bootstrap:true,type:n});++this._bootstrapRequestsPending;},_fetchOnUse:function(n,o){for(var p in this.bootstrapData)!n.hasOwnProperty(p)&&(n[p]=this.bootstrapData[p]);if(this._criticalOnly){this._fetchOnUseRequests.push({args:n,ctx:o});}else this.fetch(this.bootstrapEndpoint,n,o);},_fetchLean:function(){var n={no_cache:1};n.options=l(n.options);n.options.push('lean');this._fetchOnUse(n,{type:'lean'});},bootstrap:function(n){if(!n){this._criticalOnly=false;this._flushFetchOnUseRequests();}if(this._bootstrapped)return;var o={filter:['event'],no_cache:1};this._fetchOnUse(o,{type:'event'});var p=['app','page','group','friendlist'];p=p.concat(this._extraTypes||[]);if(this._noMultiFetch){p.push('user');this._bootstrapFetch('user',{filter:p});}else{this._bootstrapFetch('other',{filter:p});if(this._buckets){for(var q=0;q<this._buckets.length;++q){var r={filter:['user'],buckets:this._buckets[q]};this._bootstrapFetch('user',r);}}else this._bootstrapFetch('user',{filter:['user']});}this._fetchLean();this._bootstrapped=true;},_flushFetchOnUseRequests:function(){var n=this._fetchOnUseRequests.length;for(var o=0;o<n;++o){var p=this._fetchOnUseRequests[o];this.fetch(this.bootstrapEndpoint,p.args,p.ctx);}this._fetchOnUseRequests=[];},onLoad:function(n,o){this.inform('onload',{time:Date.now()},g.BEHAVIOR_PERSISTENT);if(n)this.bootstrap.bind(this,o).defer();},mergeUids:function(n,o,p,q){var r=p[0]?this.getEntry(p[0]):null,s=o[0]?this.getEntry(o[0]):null,t=(r&&r.replace_results)?r:null;t=(!t&&s&&s.replace_results)?s:t;var u=this.parent.mergeUids(n,o,p,q);if(t){this.inform('backend_topreplace',{});return this.deduplicateByKey([t.uid].concat(u));}return u;}});e.exports=m;});
__d("legacy:SearchDataSource",["SearchDataSource"],function(a,b,c,d){a.SearchDataSource=b('SearchDataSource');},3);
__d("SearchTypeaheadCore",["event-extensions","function-extensions","Arbiter","Class","DOM","Input","Parent","TypeaheadCore","URI","copyProperties"],function(a,b,c,d,e,f){b('event-extensions');b('function-extensions');var g=b('Arbiter'),h=b('Class'),i=b('DOM'),j=b('Input'),k=b('Parent'),l=b('TypeaheadCore'),m=b('URI'),n=b('copyProperties');function o(p){this.parent.construct(this,p);}h.extend(o,l);n(o.prototype,{init:function(p,q,r){this.parent.init(p,q,r);var s=k.byTag(r,'form'),t=this.reset.bind(this);g.subscribe('pre_page_transition',function(event,v){var w=/^\/search/,x=w.test(v.from.path),y=w.test(v.to.path);if(x&&!y)t.defer();});if(s){var u=i.find(s,'input.search_sid_input');Event.listen(s,'submit',function(){if(this.data&&this.data.queryData)u.value=this.data.queryData.sid;t.defer();}.bind(this),Event.Priority.URGENT);}},select:function(){this.reset();this.element.focus();(function(){this.element.blur();}).bind(this).defer();},handleTab:function(event){var p=this.view.getQuerySuggestion(this.value);if(p){j.setValue(this.element,p);this.checkValue();event.kill();}else this.parent.handleTab(event);}});e.exports=o;});
__d("legacy:SearchTypeaheadCore",["SearchTypeaheadCore"],function(a,b,c,d){a.SearchTypeaheadCore=b('SearchTypeaheadCore');},3);
__d("SearchTypeaheadView",["Arbiter","ContextualTypeaheadView","Class","ContextualLayerUpdateOnScroll","copyProperties","DOM","goURI","MusicConstants","MusicEvents","tx","URI"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('ContextualTypeaheadView'),i=b('Class'),j=b('ContextualLayerUpdateOnScroll'),k=b('copyProperties'),l=b('DOM'),m=b('goURI'),n=b('MusicConstants'),o=b('MusicEvents'),p=b('tx'),q=b('URI');function r(s,t){this.parent.construct(this,s,t);}i.extend(r,h);k(r.prototype,{initializeLayer:function(){this.parent.initializeLayer();this.layer.setOffsetY(-1);this.layer.enableBehavior(j);},ignoreClick:function(event){event.prevent();},shouldShowSeeMore:true,queryData:{init:'quick'},render:function(s,t,u){var v={results:t};this.inform('beginRender',v);return this.parent.render(s,v.results,u);},buildBuckets:function(s,t){var u=t.length;if(s&&this.shouldShowFindFriends)t.push({text:"Etsi kavereita",category:"Etsi lis\u00e4\u00e4 kavereita kaverihakuty\u00f6kalulla",path:"/find-friends",photo:"/images/growth/find_friends.png",type:"user"});this.setWebSuggLoggingParams(s,t);t=this.parent.buildBuckets(s,t);if(s&&this.shouldShowSeeMore)t.push(this.buildSeeMore(s,u));return t;},buildSeeMore:function(s,t){var u=t>0?p._("Katso lis\u00e4\u00e4 tuloksia haulle {query}",{query:s}):p._("N\u00e4yt\u00e4 tulokset haulle {query}",{query:s}),v=t==1?"N\u00e4ytet\u00e4\u00e4n parhaat tulokset":p._("N\u00e4ytet\u00e4\u00e4n parhaat {number} tulosta",{number:t}),w=l.create('li',{className:'calltoaction'},[l.create('a',{href:this.getSeeMoreEndpoint(s),rel:'ignore'},[l.create('span',{className:'text'},[l.create('span',{className:'seeMore'},[u,l.create('span',{className:'arrow'})]),l.create('span',{className:'subtext'},[v])])])]);w.setAttribute('aria-label',u);return {uid:'search',node:w,search:true};},searchPageQueryData:function(s){return k({q:s},this.queryData||{});},select:function(s){var t=this.index,u=this.results[t];if(!u||u.type=='header')return;var v=this.items[t],w=l.scry(v,'a')[0];if(u.song){if(w)o.inform(n.MUSIC_BUTTON.ACTIVATE,w);s&&this.inform('highlight',{index:t,selected:u});}else{this.parent.select(s);if(w&&w.href)if(w.target=='_blank'){window.open(w.href);}else m(w.href);}},setSid:function(s){this.queryData.tas=s;},getSeeMoreEndpoint:function(s){return q(this.seeMoreEndpoint).addQueryData(this.searchPageQueryData(s)).toString();},show:function(){if(!this.isVisible()){g.inform('layer_shown',{type:'SearchTypeahead'});this.parent.show();}},hide:function(){if(this.isVisible()){g.inform('layer_hidden',{type:'SearchTypeahead'});this.parent.hide();}},getQuerySuggestion:function(s){var t=this.results[this.index],u=t&&t.type!='header'?t.text.toLowerCase():'';return u==s.toLowerCase()?'':u;},setWebSuggLoggingParams:function(s,t){var u=0;for(var v=0;v<t.length;v++)if(t[v].type==='websuggestion'){t[v].path+='&wssk=FR'+(v-u)+'AS'+u;u++;}for(v=0;v<t.length;v++)if(t[v].type==='websuggestion')t[v].path+='&wssc='+t.length+'-'+u+'-'+s.length;}});e.exports=r;});
__d("legacy:SearchTypeaheadView",["SearchTypeaheadView"],function(a,b,c,d){a.SearchTypeaheadView=b('SearchTypeaheadView');},3);
__d("legacy:Typeahead",["Typeahead"],function(a,b,c,d){a.Typeahead=b('Typeahead');},3);
__d("SearchTypeaheadRecorder",["AsyncRequest","Keys","$","copyProperties","userAction"],function(a,b,c,d,e,f){var g=b('AsyncRequest'),h=b('Keys'),i=b('$'),j=b('copyProperties'),k=b('userAction');function l(m){this.init(m);this.initEvents();}j(l.prototype,{_endPoint:'/ajax/typeahead/record_metrics.php',init:function(m){this.core=m.getCore();this.data=m.getData();this.view=m.getView();this.element=this.core.getElement();this.initTime=Date.now();this._onloadTime=0;this.initStartTime=i('search_first_focus').value;this.bootstrapStats={bootstrapped:0};this._reset();},_reset:function(){this.stats={};this.avgStats={};this.appendStats={};this._backspacing=false;this._topreplace=false;this._inflightRequests={};var m=Math.random();this.data.setQueryData({sid:m});this.view.setSid(m);this.recordStat('sid',m);},initEvents:function(){this.core.subscribe('focus',function(event){if(!this.stats.session_start_time)this.recordStat('session_start_time',Date.now());}.bind(this));this.core.subscribe('blur',function(event){var m=Date.now();for(var n in this._inflightRequests){var o=this._inflightRequests[n],p=m-o;this.recordAvgStat('search_endpoint_ms_from_js',p);}this.recordStat('session_end_time',m);this.submit();}.bind(this));this.view.subscribe('select',function(m,n){this.recordSelectInfo(n);}.bind(this));this.view.subscribe('render',function(m,n){this.recordRender(n);}.bind(this));this.view.subscribe('recordAfterReorder',function(m,n){this._reorderInfo=n;}.bind(this));this.data.subscribe('activity',function(m,n){this.recordStat('pending_request',n.activity);}.bind(this));this.data.subscribe('beforeQuery',function(m,n){if(!n.value)return;if(!this.stats.first_query_time)this.recordStat('first_query_time',Date.now());this.query=n.value;this.recordCountStat('num_queries');}.bind(this));this.data.subscribe('queryEndpoint',function(m,n){this.recordCountStat('num_search_ajax_requests');this.recordAvgStat('endpoint_query_length',n.value.length);this._inflightRequests[n.value]=Date.now();}.bind(this));this.data.subscribe('onload',function(m,n){this._onloadTime=n.time;}.bind(this));this.data.subscribe('bootstrapped',function(m,n){this.bootstrapStats.endTime=n.time;this.bootstrapStats.bootstrapped=1;}.bind(this));this.data.subscribe('endpointStats',function(m,n){var o=n.fetch_end-n.fetch_start;if(n.value){this.recordAvgStat('search_endpoint_ms_from_js',o);}else this.bootstrapStats[n.type]=o;if(n.coeff2_ts)this.bootstrapStats.coeff2_ts=n.coeff2_ts;if(typeof n.browserCacheHit!='undefined')this.recordCountStat(n.browserCacheHit?'bootstrap_cachehits':'bootstrap_cachemisses');if(this._inflightRequests[n.value])delete this._inflightRequests[n.value];}.bind(this));this.data.subscribe('query',function(m,n){this.recordAvgStat('num_results_from_cache',n.results.length);}.bind(this));this.data.subscribe('backend_topreplace',function(m,n){if(false===this._topreplace){this.recordStat("backend_topreplace",1);this._topreplace=true;}}.bind(this));Event.listen(this.element,'keydown',function(event){if(Event.getKeyCode(event)==h.BACKSPACE){if(!this._backspacing){this._backspacing=true;this.recordAppendStat('before_backspace_queries',this.query);}}else this._backspacing=false;}.bind(this));},recordStat:function(m,n){this.stats[m]=n;},recordCountStat:function(m){var n=this.stats[m];this.stats[m]=n?n+1:1;},recordAvgStat:function(m,n){if(this.avgStats[m]){this.avgStats[m][0]+=n;++this.avgStats[m][1];}else this.avgStats[m]=[n,1];},recordAppendStat:function(m,n){if(!this.appendStats.hasOwnProperty(m))this.appendStats[m]=[];this.appendStats[m].push(n);},recordRender:function(m){this.results=m.filter(function(n){return n.uid!='search'&&n.type!='header';});if(this.results.length>0&&!this.stats.first_result_time)this.recordStat('first_result_time',Date.now());},recordSelectInfo:function(m){var n=m.selected,o=m.index-n.groupIndex-1,p={href:n.path},q=n.dataGT?{gt:JSON.parse(n.dataGT)}:{};k('click',p,null,null,q);if(n.uid=='search'){this.recordStat('selected_search',1);}else{var r=n.rankType||n.render_type||n.type,s=(r=='friend'?'user':r);this.recordStat('selected_'+s,1);this.recordStat('selected_position',o);this.recordStat('selected_type',r);this.recordStat('selected_name_length',n.text.length);this.recordStat('selected_id',n.uid);this.recordStat('selected_degree',n.bootstrapped?1:2);}this.recordStat('selected_with_mouse',m.clicked?1:0);},_dataToSubmit:function(){this.recordStat('candidate_results',this.buildResults());this.recordStat('query',this.query);this.recordStat('init_time',this.initTime);if(this.initStartTime){this.recordStat('init_start_time',this.initStartTime);this.recordStat('onload_time',this._onloadTime);this.initStartTime=0;}this.recordStat('bootstrapped',this.bootstrapStats.bootstrapped);if(this.bootstrapStats.endTime){this.recordStat('bootstrapped_time',this.bootstrapStats.endTime);this.recordStat('user_bootstrap_ms',this.bootstrapStats.user);this.recordStat('other_bootstrap_ms',this.bootstrapStats.other);this.bootstrapStats.endTime=0;}this.recordStat('coeff2_ts',this.bootstrapStats.coeff2_ts);this.recordStat('max_results',this.data._maxResults);if(this._reorderInfo){var m=this._reorderInfo;this.recordStat('s_organic_results',JSON.stringify(m.organic));this.recordStat('s_candidate_tokens',JSON.stringify(m.tokens));}var n=this.stats;for(var o in this.avgStats){var m=this.avgStats[o];n[o]=m[0]/m[1];}for(var p in this.appendStats)n[p]=JSON.stringify(this.appendStats[p]);return n;},buildResults:function(){var m=(this.results||[]).map(function(n,o){var p=n.rankType||n.render_type||n.type,q=n.bootstrapped?1:0,r=n.s_token||'';if(typeof n.groupIndex=='number')return [n.groupIndex,n.indexInGroup,n.uid,p,q,r];return [0,o,n.uid,p,q,r];});return JSON.stringify(m);},submit:function(){var m=this._dataToSubmit();if(Object.keys(m).length>0)new g().setURI(this._endPoint).setMethod('POST').setData({stats:m}).setOption('handleErrorAfterUnload',true).setErrorHandler(function(n){m.retry=true;new g().setURI(this._endPoint).setMethod('POST').setData({stats:m}).setOption('asynchronous',false).send();}.bind(this)).send();this._reset();}});e.exports=l;});
__d("TypeaheadSearchRecorderBasic",["SearchTypeaheadRecorder","copyProperties"],function(a,b,c,d,e,f){var g=b('SearchTypeaheadRecorder'),h=b('copyProperties');function i(j){this._typeahead=j;}h(i.prototype,{enable:function(){new g(this._typeahead);},disable:bagofholding});e.exports=i;});
__d("legacy:SearchRecorderBasicTypeaheadBehavior",["TypeaheadSearchRecorderBasic"],function(a,b,c,d){var e=b('TypeaheadSearchRecorderBasic');if(!a.TypeaheadBehaviors)a.TypeaheadBehaviors={};a.TypeaheadBehaviors.searchRecorderBasic=function(f){f.enableBehavior(e);};},3);
__d("SearchTypeaheadRenderer",["DOM","Env","MusicButtonManager","TypeaheadUtil"],function(a,b,c,d,e,f){var g=b('DOM'),h=b('Env'),i=b('MusicButtonManager'),j=b('TypeaheadUtil');function k(l,m){var n=[];if(l.photo){n.push(g.create('img',{className:'photo',alt:'',src:l.photo}));if(l.song){n.push(g.create('span',{className:'playButton'}));n.push(g.create('span',{className:'playLoader'}));}}if(l.text){var o=l.alias,p=this.value,q=l.text,r=[q];if(o&&j.isQueryMatch(p,o)&&!j.isQueryMatch(p,q))r.push(g.create('span',{className:'alias'},[' \xB7 '+o]));n.push(g.create('span',{className:'text'},r));}if(l.category){var s=[l.category];if(l.is_external)s.push(g.create('span',{className:'arrow'}));var t=l.message?'preCategory':'category';n.push(g.create('span',{className:t},s));}if(l.message)n.push(g.create('span',{className:'category'},[l.message]));var u=l.subtextOverride||l.subtext;if(u)n.push(g.create('span',{className:'subtext'},[u]));var v=l.classNames||l.type||'',w=l.is_external?'_blank':'',x=!l.song&&l.path||'';if(x){if(!(/^https?\:\/\//).test(x))x=h.www_base+x.substr(1);x+=(x.indexOf('?')>0?'&':'?')+'ref=ts';}var y=g.create('a',{href:x,rel:'ignore',target:w},n);if(l.song){y.id='mb_'+(Math.random()*1e+06|0);i.addButton.curry(l.song.provider,y.id,l.song.url,l.song.context,l.song.media_type).defer();y.onclick=this.ignoreClick;}var z=g.create('li',{className:v},[y]);z.setAttribute('role','option');if(l.text)z.setAttribute('aria-label',l.text);return z;}k.className='search';e.exports=k;});
__d("legacy:SearchTypeaheadRenderer",["SearchTypeaheadRenderer"],function(a,b,c,d){if(!a.TypeaheadRenderers)a.TypeaheadRenderers={};a.TypeaheadRenderers.search=b('SearchTypeaheadRenderer');},3);
void(0);
__d("TypeaheadSearchFilter",["Arbiter","copyProperties"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('copyProperties');function i(j){this._typeahead=j;}h(i.prototype,{_subscription:null,enable:function(){var j=this._typeahead;this._subscriptions=[g.subscribe('search/typeahead/updateFilter',function(k,l){if(l.filter_type=='web')j.getView().queryData.form='FBKBFR';j.getView().queryData.type=l.filter_type;}),g.subscribe('page_transition',function(k,l){if(j.getView().queryData.form)delete j.getView().queryData.form;delete j.getView().queryData.type;},g.SUBSCRIBE_NEW)];},disable:function(){this._subscriptions.forEach(function(j){j.unsubscribe();});this._subscriptions=null;}});e.exports=i;});
__d("legacy:SearchFilterTypeaheadBehavior",["TypeaheadSearchFilter"],function(a,b,c,d){var e=b('TypeaheadSearchFilter');if(!a.TypeaheadBehaviors)a.TypeaheadBehaviors={};a.TypeaheadBehaviors.initFilters=function(f){f.enableBehavior(e);};},3);
__d("legacy:LayerFadeOnHide",["LayerFadeOnHide"],function(a,b,c,d){a.LayerFadeOnHide=b('LayerFadeOnHide');},3);
__d("legacy:ufi-optimistic",["OptimisticUFI"],function(a,b,c,d){a.UFIOptimistic=b('OptimisticUFI');},3);
function TickerController(){}!function(){var a=1,b=2,c=3,d=4;copy_properties(TickerController,{_instances:{},_activeInstance:null,_placeholders:{},_logPositionChange:false,getInstance:function(e){var f=Parent.byClass($(e),'fbFeedTicker');return f?TickerController._instances[f.id]:null;},isLoaded:function(e){var f=TickerController._placeholders[e.id];return !f||f.status==c;},show:function(e,f){f=f||bagofholding;for(var g in TickerController._instances){var h=ge(g);if(!h||h.parentNode.id==e.id)continue;TickerController.hide(h.parentNode);}TickerController._doPositionChange(e);CSS.show(e);var i=TickerController._placeholders[e.id];if(i&&i.status==a){TickerController._fetchTickerForPlaceholder(e,f);}else{var j=DOM.scry(e,'.fbFeedTicker')[0],k=j&&TickerController.getInstance(j);TickerController._activeInstance=k;k&&k._poll();TickerController._placeholders[e.id]={status:d,callback:f};f();}},_doPositionChange:function(e){if(!TickerController._logPositionChange||CSS.shown(e))return;new AsyncSignal('/common/ods_endpoint.php',{k:'ticker.render.switch.'+e.id}).send();},hide:function(e){var f=DOM.scry(e,'.fbFeedTicker')[0],g=f&&TickerController.getInstance(f);g&&g.hideActiveStory();CSS.hide(e);},hideStoriesByClass:function(e){for(var f in TickerController._instances)DOM.scry($(f),e).forEach(CSS.hide);},hideStory:function(e){var f=e&&TickerController.getInstance(e);f&&f.hideStory(e);},undoHideStory:function(e){var f=e&&TickerController.getInstance(e);f&&f.undoHideStory(e);},_fetchTickerForPlaceholder:function(e,f){var g={handler:function(){TickerController._placeholders[e.id].status=c;f();}};UIPagelet.loadFromEndpoint('TickerPagelet',e.id,TickerController._placeholders[e.id].pageletData,g);TickerController._placeholders[e.id].status=b;},registerStoryDialog:function(e,f){Arbiter.subscribe('ticker/init',function(){var g=ge(e),h=g&&TickerController.getInstance(g);h&&h.registerStoryDialog(g,f);},Arbiter.SUBSCRIBE_ALL);},registerPlaceholder:function(e,f){var g=TickerController._placeholders[e];TickerController._placeholders[e]={status:a,pageletData:f};if(g&&g.status==d){TickerController.show($(e));g.callback();}}});}();copy_properties(TickerController.prototype,{ADS_IDLE_MS:300000,FLYOUT_MAX_HEIGHT:450,FLYOUT_OFFSET_THRESHOLD:20,FLYOUT_COMMENT_OFFSET:15,FLYOUT_VIEWPORT_PADDING:75,FLYOUT_TARGET_HEIGHT_OFFSET:25,init:function(a,b,c){TickerController._instances[a.id]=this;TickerController._activeInstance=this;this._root=a;this._content=DOM.find(a,'.ticker_stream');this._stories=DOM.find(this._root,'.tickerActivityStories');this._scrollableArea=b;this._container=DOM.find(a,'div.uiScrollableAreaWrap');this._newestStory={};this._storyIDs=[];this._objectIDs=[];this._fetchedStories={};this._removedStoryIDs=[];this._storiesToRemove=[];var d=Date.now();this._initTime=d;this._lastUpdate=d;this._lastPull=d;this._lastInsert=d;this._lastCustomStory=0;this._pollOnly=false;this._needNonCustomStoryNum=0;this._doCustomUpdate=true;this._autoloadStoryIndex=1;this._scrollTopThreshold=100;this._scrollTopPrompt=DOM.find(this._root,'.scrollTopPrompt');this._scrollTopPromptVisible=false;this._maxStoriesToKeep=50;this._minStoriesToKeep=25;this._tickerInSidebarMode=!!Parent.byClass(this._root,'fbChatSidebar');this._loadStoriesWithActions();this._ua={flyout:user_action('ticker_flyout').set_namespace('ticker').set_ua_id('flyout'),flyout_prefetch:user_action('ticker_flyout_prefetch').set_namespace('ticker').set_ua_id('flyout_prefetch'),flyout_loadtime:user_action('ticker_flyout_loadtime').set_namespace('ticker').set_ua_id('flyout_loadtime'),stream:user_action('ticker_stream').set_namespace('ticker').set_ua_id('stream')};this._uaCurStoryIDFetch=null;this._uaCurStoryIDPrefetch=null;var e=$N('div',{className:'storyQueue hidden_elem'});this._storyQueue=e;DOM.appendContent(this._root,e);this._initObjectIDs();this._initPageletCache(c);this._initConfig(c);this._resetMorePager();this._initListeners();this._initSubscriptions(c);Arbiter.inform('ticker/init',this,Arbiter.BEHAVIOR_PERSISTENT);this._poll();if(this._prefetchAfterLoad){this._logUserEvent('stream','prefetch');this._fetchStories(this._getInsertedStories().slice(0,5));}},_loadStoriesWithActions:function(){var a=ge('rightCol');if(!a)return;this._toggleWrapper=DOM.scry(a,'.tickerToggleWrapper')[0];if(this._toggleWrapper){var b=DOM.scry(this._stories,'.tickerStoryWithButton');this._storiesWithActions={};for(var c=0;c<b.length;c++){var d=b[c];this._storiesWithActions[d.getAttribute('data-story-key')]=d;}}},_initPageletCache:function(a){if(window.PageletCacheController){this._cache=PageletCacheController.registerController(this._root.parentNode.id,this);if(this._cache){copy_properties(a,this._cache.loadData());this._cache.registerCleanup('Ticker/cleanup');}}},_initConfig:function(a){copy_properties(this,{_newest:a.newest,_page_newest:a.newest,_timeout:a.timeout,_heartbeatTimeout:Math.max(15000,a.heartbeatTimeout),_pullTimeout:Math.max(30000,a.pullTimeout),_insertTimeout:a.insertTimeout,_friendCount:a.friendCount,_maxQueueLength:a.maxQueueLength,_heartbeatEndpoint:a.heartbeatEndpoint,_noPoll:a.nopoll,_maxCustomQueueLength:a.maxCustomQueueLength,_customStoryInsertTimeout:Math.max(5000,a.customStoryInsertTimeout),_nonCustomToCustomStoryRatio:a.nonCustomToCustomStoryRatio,_minForceUpdateInterval:Math.max(a.insertTimeout,a.minForceUpdateInterval),_popupOnHover:a.popupOnHover,_priorityAppId:a.priorityAppId,_prefetchOnHover:a.prefetchStoriesOnHover,_userIdleTimeout:a.userIdleTimeout,_firstCustomStoryDelay:a.firstCustomStoryDelay,_pollOnly:a.pollOnly,_tickerDebug:a.tickerDebug,_tickerSource:a.tickerSource,_prefetchAfterLoad:a.prefetchAfterLoad,_logFlyouts:a.logFlyouts,_userScrollGaurdDelay:a.userScrollGaurdDelay,_rescheduleScrollToTopDelay:a.rescheduleScrollToTopDelay,_aggressiveRegulator:a.aggressiveRegulator});this._queueCustomStories(a.customStories);},_initListeners:function(){this._listeners=Event.listen(this._root,{click:this._handleClick.bind(this),keydown:this._handleKeydown.bind(this),mouseout:this._handleMouseout.bind(this),mouseover:this._handleMouseover.bind(this),mousedown:this._tickerDeClicker.bind(this),mouseup:this._handleMouseup.bind(this)});this._listeners.scroll=Event.listen(this._container,'scroll',throttle(this._handleScroll.bind(this)));this._initInfiniteScrollListener.bind(this).defer();},_initSubscriptions:function(a){onleaveRegister(this._cleanup.bind(this));this._subscriptions=[Arbiter.subscribe(NavigationMessage.NAVIGATION_BEGIN,this._onNavHandler.bind(this)),Arbiter.subscribe(ChannelConstants.getArbiterType('ticker_update'),this._handleTickerPush.bind(this)),Arbiter.subscribe('composer/publish',this._handleComposerPublish.bind(this)),Arbiter.subscribe('Ticker/storiesInserted',this._handleStoriesInserted.bind(this)),Arbiter.subscribe('Ticker/fixed',this._setFixed.bind(this,true)),Arbiter.subscribe('Ticker/unfixed',this._setFixed.bind(this,false)),Arbiter.subscribe('Ticker/resized',this._checkInfiniteScroll.bind(this)),Arbiter.subscribe(UFIOptimistic.COMMENT_SEND_EVENT,this._scrollDialogToBottom.bind(this)),Arbiter.subscribe('Ticker/chatOpened',this._handleChatOpened.bind(this))];if(a.pushChannel)this.setPushChannel(a.pushChannel);},_handleClick:function(event){var a=event.getTarget();if(this._getButtonFromNode(a)){this._logUserAction(a,'click',event);this._handleActionButton(event);return;}var b=this._getStoryFromNode(a),c=Parent.byClass(a,'tickerStoryAllowClick');if(!b||b==this._selectedStory||c)return;if(this._storyIsHidden(b))return;if(b==this._activeStory&&!this._selectedStory)this._selecting=true;this._clearNux();this._logUserEvent('flyout','click');this._logUserEvent('flyout_loadtime','open');if(this._storyCanOpenExternally(b)){var d=b.getAttribute('data-href');if(d&&!a.getAttribute('href')){var e={href:d},f=collect_data_attribs(a,['ft','gt']);user_action('click',e,event,'FORCE',f);}else this._logUserAction(a,'click',event);this._openStoryExternally(b,event);return;}this._logUserAction(a,'flyout',event);this._activateStory(b,'click');this._selectStory(b);},_handleMouseover:function(event){this._setLocked(true);var a=event.getTarget(),b=this._getOpenableStory(a);if(!b)return;event.kill();if(this._prefetchOnHover||this._popupOnHover){if(!(b.id in this._fetchedStories)){this._logUserEvent('flyout_prefetch','prefetch_on_hover');this._uaCurStoryIDPrefetch=b.id;}this._fetchStory(b);}if(this._selectedStory)return;if(this._popupOnHover){this._clearHoverTimeouts();var c=this._storyCanOpenExternally(b)?500:1000,d=this._activeStory?75:c;if(!window.addEventListener&&document.createEventObject)event=document.createEventObject(event);this._hoverShowTimeout=this._setTimeout(function(){this._logUserEvent('flyout','hover',d);this._logUserEvent('flyout_loadtime','open');this._activateStory(b,'hover');this._logUserAction(a,'flyout',event);}.bind(this),d);}},_handleMouseout:function(event){var a=event.getTarget();this._setLocked(false);if(a==this._getStoryFromNode(a)){var b=DOM.scry(a.parentNode,'.openToggler');for(var c=0;c<b.length;c++)Selector.toggle(b[c]);}this._clearClickedStory();this._scheduleHide();},_handleKeydown:function(event){this._tickerDeClicker(event);var a=this._activeStory;if(!a)return;var b=Event.getKeyCode(event);switch(b){case KEYS.UP:case KEYS.DOWN:var c=this._getInsertedStories(),d;if(event.getModifiers().any){d=b===KEYS.UP?0:c.length-1;}else d=c.indexOf(a)+(b===KEYS.UP?-1:1);a=c[d];break;case KEYS.ESC:this._deactivateStory(true);return;default:return;}if(!a)return;event.kill();this._activateStory(a,'keypress');this._selectStory(a);},_fadeTopmostStoryButton:function(){var a=0,b=15;if(this._storiesWithActions)for(var c in this._storiesWithActions){var d=this._storiesWithActions[c],e=DOM.scry(d,'.tickerInlineActionButton')[0],f=DOM.scry(e,'.tickerActionIcon')[0],g=Vector2.getElementPosition(e).y-Vector2.getElementPosition(this._toggleWrapper).y;if(g<a){CSS.setStyle(e,'opacity',0);CSS.setStyle(f,'opacity',0);}else if(g>=a&&g<b){var h=(g-a)/(b-a);CSS.setStyle(e,'opacity',h);CSS.setStyle(f,'opacity',h);break;}else{CSS.setStyle(e,'opacity',1);CSS.setStyle(f,'opacity',1);}}},_handleScroll:function(){this._fadeTopmostStoryButton();!this._preventScrollDismiss&&this._deactivateStory(true);this._checkInfiniteScroll();this._setIsUserScrolling();if(!this._scrollLogged){this._scrollLogged=true;var a=this._stories.childNodes.length,b=this._stories.getAttribute('data-gt'),c={ticker_scroll:1,number_stories:a,source:b};report_data('scroll',{gt:c});}},_setIsUserScrolling:function(){clearTimeout(this._userScrollingToken);if(this._isScrolledToTop()){this._userScrolling=false;return;}this._userScrolling=true;this._userScrollingToken=setTimeout(function(){this._userScrolling=false;this._userScrollingToken=null;}.bind(this),this._userScrollGaurdDelay);},_isUserScrolling:function(){return this._userScrolling;},_handleStoriesInserted:function(){this._initInfiniteScrollListener();this._scrollableArea.adjustGripper();this._logUserEvent('stream','insert');},_handleActionButton:function(event){var a=event.getTarget(),b=this._getButtonFromNode(a),c=this._getOpenableStory(a),d=this._getStoryDialog(c);if(d)var e=d.subscribe('beforehide',function(){d.unsubscribe(e);return false;});},_handleScrollToTopClick:function(){this._scrollToTop(this._poll.bind(this));},_scheduleScrollToTop:function(){this._scrollToTopToken&&clearTimeout(this._scrollToTopToken);this._scrollToTopToken=setTimeout(function(){if(this._isLocked()||this._isUserScrolling()){this._scheduleScrollToTop();}else{this._scrollToTopToken=null;this._scrollToTop();}}.bind(this),this._rescheduleScrollToTopDelay);},_scrollToTop:function(a){animation(this._container).to('scrollTop',0).ease(animation.ease.end).ondone(a).go();},_clearHoverTimeouts:function(){clearTimeout(this._hoverShowTimeout);clearTimeout(this._hoverHideTimeout);},_getAllStories:function(){return DOM.scry(this._root,'div.fbFeedTickerStory');},_getInsertedStories:function(){return this._getAllStories().filter(function(a){return !CSS.hasClass(a,'queuedStory')&&!CSS.hasClass(a,'customStory');});},_getQueuedStories:function(){return DOM.scry(this._storyQueue,'.fbFeedTickerStory.queuedStory');},_getQueuedCustomStories:function(){return DOM.scry(this._storyQueue,'.fbFeedTickerStory.customStory');},_getButtonFromNode:function(a){return Parent.byClass(a,'tickerInlineOverlay');},_getStoryFromNode:function(a){return Parent.byClass(a,'fbFeedTickerStory');},_getActionButtonFromStory:function(a){return DOM.scry(a,'.tickerInlineActionButton')[0];},_getOpenableStory:function(a){var b=this._getStoryFromNode(a);return this._storyCanOpenDialog(b)?b:null;},_getStoryDialog:function(a){return window.ContextualDialogX&&ContextualDialogX.getInstance(a)||null;},_getStoryDialogEndpoint:function(a){return a&&a.getAttribute('data-rel')=='async'&&a.getAttribute('data-ajaxify')||null;},_storyCanOpenDialog:function(a){return !!this._getStoryDialogEndpoint(a)&&!this._storyIsHidden(a);},_storyCanOpenExternally:function(a){return !!a.getAttribute('data-href')||!this._storyCanOpenDialog(a);},_storyIsHidden:function(a){return CSS.hasClass(a,'tickerStoryHidden');},hideActiveStory:function(){this._activeStory&&this.hideStory(this._activeStory);},hideStory:function(a){this._deactivateStory();CSS.addClass(a,'tickerStoryHidden');CSS.removeClass(a,'tickerStoryClickable');},undoHideStory:function(a){CSS.addClass(a,'tickerStoryClickable');CSS.removeClass(a,'tickerStoryHidden');},_scheduleHide:function(){if(this._popupOnHover&&!this._selectedStory){this._clearHoverTimeouts();this._hoverHideTimeout=this._setTimeout(this._deactivateStory.bind(this),100);}},_setScrollTopPromptVisible:function(a){this._scrollTopPromptVisible=a;CSS.conditionShow(this._scrollTopPrompt,a);if(a&&!this._listeners.scrollTop){this._listeners.scrollTop=Event.listen(this._scrollTopPrompt,{click:this._handleScrollToTopClick.bind(this)});}else if(!a&&this._listeners.scrollTop){this._listeners.scrollTop.click.remove();this._listeners.scrollTop=null;}},_isUserIdle:function(){return !UserActivity.isActive(this._userIdleTimeout);},_schedulePoll:function(){clearTimeout(this._pollToken);this._pollToken=this._setTimeout(this._poll.bind(this),this._timeout);},_poll:function(){this._debug('poll');if(!this._isTickerVisible()){this._debug('not polling: ticker not visible');return;}if(this._storiesToRemove.length>0){if(this._isInsertingStory)return this._schedulePoll();var a=this._storiesToRemove.pop();this.removeStory(a);}if(this._isUserIdle()){this._debug('not polling: idle');return UserActivity.subscribeOnce(this._poll.bind(this));}var b=!this._isScrolledToTop()&&this._getQueuedStories().length;this._setScrollTopPromptVisible(b);var c=Date.now(),d=c-this._lastInsert;if(d<this._insertTimeout||this._isLocked())return this._schedulePoll();var e=this._getQueuedStories(),f=this._getQueuedCustomStories(),g=e.length>0,h=f.length>0&&(c-this._initTime>this._firstCustomStoryDelay)&&(this._needNonCustomStoryNum===0||(!g&&(c-this._lastCustomStory)>this._customStoryInsertTimeout));if(h){this.insertStory(f.shift());this._lastCustomStory=c;this._needNonCustomStoryNum=this._nonCustomToCustomStoryRatio;this._debug('not polling: should insert custom story');return this._schedulePoll();}if(g){this.insertStory(e.shift());this._needNonCustomStoryNum--;if(this._needNonCustomStoryNum<0)this._needNonCustomStoryNum=0;this._debug('not polling: should insert story');return this._schedulePoll();}var i=f.length===0&&this._needNonCustomStoryNum===0&&this._nonCustomToCustomStoryRatio>0&&UserActivity.isActive(this.ADS_IDLE_MS)&&((c-this._lastUpdate)>this._minForceUpdateInterval),j=false,k=false;if(this._pollOnly){k=c-this._lastUpdate>this._heartbeatTimeout;}else j=(c-this._lastPull>this._pullTimeout);var l=(i&&this._doCustomUpdate)||j||k;if(!l)return this._schedulePoll();if(i)this._doCustomUpdate=false;this._debug('polling for new stories');this.update({pull:j,fullpoll:k,needcustomstory:i});},update:function(a){if(this._noPoll&&!this._pollOnly){this._debug('not updating - in no poll mode');return this._schedulePoll();}var b={newest:(a.fullpoll||a.cache_update)?this._newest:this._page_newest,storyids:this._storyIDs,friendcount:this._friendCount,priorityappid:this._priorityAppId,source:this._tickerSource,needcustomstory:this._nonCustomToCustomStoryRatio>0};copy_properties(b,a);new AsyncRequest().setURI(this._heartbeatEndpoint).setReadOnly(true).setOption('retries',0).setData(b).setHandler(this._handleResponse.bind(this)).setFinallyHandler(this._poll.bind(this)).setAllowCrossPageTransition(true).send();this._lastUpdate=Date.now();if(b.pull)this._lastPull=this._lastUpdate;this._storyIDs=[];},insertStory:function(a,b,c){this._lastInsert=Date.now();window.LiveTimer&&LiveTimer.addTimeStamps(a);CSS.removeClass(a,'queuedStory');CSS.removeClass(a,'customStory');if(b!==false){var d=c?this._fadeStoryIn:this._flyStoryIn;if(this._isUserScrolling()){var e=function(){this._container.scrollTop=this._container.scrollTop+this._stories.firstChild.offsetHeight;this._scheduleScrollToTop();}.bind(this);this._fadeStoryIn(a,e);this._debug("insertStory: scheduled a scroll to top");}else this._scrollToTop(d.bind(this,a));}else DOM.prependContent(this._stories,a);if(this._storiesWithActions&&CSS.hasClass(a,'tickerStoryWithButton'))this._storiesWithActions[a.getAttribute('data-story-key')]=a;this._removeOldStories();},_removeOldStories:function(){var a=this._getInsertedStories();if(a.length<=this._maxStoriesToKeep)return;var b=this._minStoriesToKeep,c=a.slice(b);c.forEach(DOM.remove);if(this._storiesWithActions)for(var d=0;d<c.length;d++)delete this._storiesWithActions[c[d].getAttribute('data-story-key')];this._resetMorePager();},_resetMorePager:function(){var a=this._getInsertedStories();if(!a||!a.length)return;var b=a[a.length-1].getAttribute('data-ticker-timestamp'),c=DOM.scry(this._root,'.tickerMorePager a')[0];if(!c||!b)return;var d=new URI(c.getAttribute('ajaxify'));d.addQueryData({oldest:b});c.setAttribute('ajaxify',d);},_setLocked:function(a){this._locked=a;},_isLocked:function(){return !!(this._locked||this._activeStory);},informAndRemoveStory:function(a,b,c){var d=this._getStoryFromNode(a),e=d.getAttribute('data-story-key');DOM.setContent(d,b);CSS.addClass(d,'highlightedStory');this._setTimeout(this.removeStory.bind(this,e),c||6000);},_getStoryByStoryKey:function(a){var b=this._getAllStories();for(var c=0;c<b.length;c++){var d=b[c];if(d.getAttribute('data-story-key')==a)return d;}return null;},removeStory:function(a){this._removedStoryIDs[a]=true;var b=this._getStoryByStoryKey(a);if(!b)return;if(this._storiesWithActions)delete this._storiesWithActions[a];if(b==this._activeStory)this._deactivateStory();var c=this._getStoryDialog(b);c&&c.destroy();if(CSS.hasClass(b,'queuedStory')){DOM.remove(b);return;}this._animateStoryOut(b);},_isScrolledToTop:function(){return this._container.scrollTop<=this._scrollTopThreshold;},_flyStoryIn:function(a){var b=$N('div',{style:{marginTop:'-1000px'}},a);CSS.setStyle(b,'opacity',0);DOM.prependContent(this._stories,b);var c=Vector2.getElementDimensions(b).y;CSS.setStyle(b,'marginTop','-'+c+'px');this._isInsertingStory=true;animation(b).to('marginTop',0).ease(animation.ease.end).checkpoint(.5).to('opacity',1).ondone(function(){DOM.replace(b,a);this._afterInsert(a);this._isInsertingStory=false;}.bind(this)).go();},_fadeStoryIn:function(a,b){animation(this._stories).to('opacity',.5).ondone(function(){DOM.prependContent(this._stories,a);if(b)b();animation(this._stories).to('opacity',1).ondone(function(){this._afterInsert(a);}.bind(this)).go();}.bind(this)).go();},_animateStoryOut:function(a){var b=$N('div',{style:{overflow:'hidden',position:'relative'}});DOM.insertBefore(a,b);DOM.appendContent(b,a);animation(b).to('top',20).to('height',0).to('opacity',0).ease(animation.ease.end).ondone(function(){DOM.remove.curry(b);Arbiter.inform('Ticker/animateOut');}.bind(this)).go();},_afterInsert:function(a){Arbiter.inform('Ticker/afterInsert');},setPushChannel:function(a){this._pushSubscription&&this._pushSubscription.unsubscribe();this._pushSubscription=Arbiter.subscribe(ChannelConstants.getArbiterType(a),this._handleTickerPush.bind(this));requireLazy(['ChatConfig','ChannelConnection'],function(b,c){this._channelConnection=c;this._checkChannelConnection();this._channelConnectionSubscription=this._channelConnection.subscribe([this._channelConnection.CONNECTED,this._channelConnection.RECONNECTING,this._channelConnection.SHUTDOWN,this._channelConnection.MUTE_WARNING,this._channelConnection.UNMUTE_WARNING],this._handleChannelConnection.bind(this));}.bind(this));},_checkChannelConnection:function(){CSS.conditionClass(this._root,'disconnected',this._channelConnection.disconnected());},setCurrentAppId:function(a){this._priorityAppId=a;},_handleTickerPush:function(a,b){var c=b.obj;if(c.delete_id){this._storiesToRemove.push(c.delete_id);return;}if(c.fromups){this._debug('discarding story: dark launch');if(c.do_logging)this._logDarkLaunch(c);}var d=c.story_xhp;if(!d){this._debug('discarding story: no markup');return;}this._newest=c.story_time;var e=HTML(d).getRootNode();this.queueStory(e,c.flyout_js_cmds);if(this._aggressiveRegulator&&c.actor==this._newestStory.actorID){this.removeStory(this._newestStory.storyKey);new AsyncSignal('/common/ods_endpoint.php',{k:'ticker.aggr.remove'}).send();}this._newestStory={actorID:c.actor,storyKey:e.getAttribute('data-story-key')};},_handleComposerPublish:function(a,b){b.tickerMarkup&&this.insertStory(b.tickerMarkup);},_clearNux:function(){var a=DOM.scry(document.body,'div.tickerNUXContainer');if(a.length){a.forEach(function(b){var c=ContextualDialogX.getInstance(b);c&&c.hide();});new AsyncRequest().setURI('/ajax/feed/ticker/nux.php').send();}this._clearNux=bagofholding;},_logDarkLaunch:function(a){data={actor:a.actor,story_time:a.story_time,key:a.story_obj_id,dark:1};new AsyncRequest().setURI('/alite/push/log.php').setData({msg:JSON.stringify(data)}).send();},_logRender:function(){if(this._loggedRender)return;var a=this._tickerInSidebarMode;if(a||Parent.byClass(this._content,'home_right_column')){new AsyncSignal('/ajax/log_ticker_render.php',{sidebar_mode:a}).send();this._loggedRender=true;}},_isTickerVisible:function(){var a=(TickerController._activeInstance==this);a&&this._logRender();return a;},_handleResponse:function(a){var b=a.getPayload();if(b.newest)this._newest=this._page_newest=b.newest;if(b.content)if(b.cache_update&&this._cache){this._cache.insertStory(b.content);}else if(b.content instanceof Array){for(var c=0;c<b.content.length;c++)this.queueStoryMarkup(b.content[c]);}else this.queueStoryMarkup(b.content);if(b.custom_stories&&b.custom_stories.length){this._queueCustomStories(b.custom_stories);this._doCustomUpdate=true;}},queueStoryMarkup:function(a){var b=HTML(a).getRootNode();this.queueStory(b);},dedupeStory:function(a){var b=a.getAttribute('data-story-key'),c=b&&(!!this._objectIDs[b]||!!this._removedStoryIDs[b]);if(c)this._debug('discarding story: duplicated object id');b&&(this._objectIDs[b]=true);return c;},queueStory:function(a,b){if(this.dedupeStory(a))return;CSS.addClass(a,'queuedStory');DOM.appendContent(this._storyQueue,a);var c=b&&b.length;if(c)b.forEach(function(e){new Function(e).apply();});a.setAttribute('id',a.id+'_'+this._root.id);var d=this._getQueuedStories();d.slice(0,-this._maxQueueLength).forEach(DOM.remove);if(c)this._fetchedStories[a.id]=true;},_queueCustomStories:function(a){while(a.length){var b=a.shift();b=HTML(b).getRootNode();var c=b.getAttribute('data-story-key');if(this.dedupeStory(b))continue;CSS.addClass(b,'customStory');DOM.appendContent(this._storyQueue,b);}var d=this._getQueuedCustomStories();d.slice(0,-this._maxQueueLength).forEach(DOM.remove);},_cleanup:function(){TickerController._placeholders.pagelet_rhc_ticker=null;if(!Parent.byClass(this._content,'hasRightCol'))return;this._objectIDs=[];this._subscriptions.forEach(Arbiter.unsubscribe);this._channelConnectionSubscription&&this._channelConnection.unsubscribe(this._channelConnectionSubscription);this._pushSubscription&&this._pushSubscription.unsubscribe();for(var a in this._listeners)this._listeners[a]&&this._listeners[a].remove();clearTimeout(this._pollToken);this._pollToken=null;this._cleanupInputFocusListener();this._cleanupContentResizeListener();Arbiter.inform('Ticker/cleanup');},_onNavHandler:function(a,b){var c=b.params.key;if(c!='lf'&&c!='h')this._cleanup();},registerStoryDialog:function(a,b){if(this._uaCurStoryIDFetch==a.id){this._uaCurStoryIDFetch=null;this._logUserEvent('flyout','fetch_success');}if(this._uaCurStoryIDPrefetch==a.id){this._uaCurStoryIDPrefetch=null;this._logUserEvent('flyout_prefetch','prefetch_success');}this._fetchedStories[a.id]=true;b.setContext(a);b.subscribe('hide',this._deactivateStory.bind(this,true));b.subscribe('success',this._focusStory.bind(this,a));b.subscribe('beforehide',function(){if(this._selecting){this._selecting=false;return false;}}.bind(this));if(this._popupOnHover){b.subscribe('mouseenter',this._clearHoverTimeouts.bind(this));b.subscribe('mouseleave',this._scheduleHide.bind(this));b.subscribe('show',function(){this._highlightDialogScrollbar.bind(this,b).defer();var c=Event.listen(b.getContent(),'click',function(){this._selectStory(a);c.remove();}.bind(this));}.bind(this));}if(a==this._activeStory){this._logUserEvent('flyout_loadtime','show_fetched');this._logUserEvent('flyout','show');this._openDialog(b);}},_highlightDialogScrollbar:function(a){var b=DOM.scry(a.getContent(),'.uiScrollableArea')[0];b&&ScrollableArea.poke(b);},_openStoryExternally:function(a,event){var b=a.getAttribute('data-href');if(!b||b=='#')return;var c=a.getAttribute('data-story-rel');switch(c){case 'theater':this._deactivateAndClearStory();Bootloader.loadComponents('PhotoViewer',function(){PhotoViewer.bootstrap(b,a);});return;case 'async':this._deactivateAndClearStory();Bootloader.loadComponents('async',function(){AsyncRequest.bootstrap(b,a);});return;}var d=a.getAttribute('data-target'),e=(event.which!=1||event.getModifiers().any||d=='_blank');e?window.open(b,'_blank'):goURI(b);},_deactivateAndClearStory:function(){this._clearHoverTimeouts();this._deactivateStory();},_focusStory:function(a){clearTimeout(this._scrollDismissal);this._preventScrollDismiss=true;this._scrollDismissal=this._setTimeout(function(){this._preventScrollDismiss=false;}.bind(this),100);a.focus();},_selectStory:function(a){this._selectedStory=a;CSS.addClass(a,'tickerStorySelected');CSS.addClass(this._root,'tickerChildSelected');},_activateStory:function(a,b){this._clearHoverTimeouts();if(a==this._activeStory||!this._storyCanOpenDialog(a))return;this._deactivateStory();this._focusStory(a);this._activeStory=a;CSS.addClass(a,'tickerStoryActive');window.Toggler&&Toggler.hide();if(this._logFlyouts){b=b||'unknown';new AsyncSignal('/ajax/feed/ticker/flyout.php',{src:b}).send();}var c=this._getStoryDialog(a);if(c){this._logUserEvent('flyout_loadtime','show_prefetched');this._logUserEvent('flyout','show');this._openDialog(c);return;}if(!(a.id in this._fetchedStories)){this._uaCurStoryIDFetch=a.id;this._logUserEvent('flyout','fetch');}this._fetchStory(a);},_deactivateStory:function(a){if(this._activeStory===this._deactivatingStory)return;this._deactivatingStory=this._activeStory;if(this._dialog){if(a===true){this._dialog.enableBehavior(LayerFadeOnHide);}else this._dialog.disableBehavior(LayerFadeOnHide);this._dialog.hide();this._logUserEvent('flyout','close');}if(this._activeStory){CSS.removeClass(this._activeStory,'tickerStoryActive');CSS.removeClass(this._activeStory,'tickerStorySelected');CSS.removeClass(this._root,'tickerChildSelected');}this._dialog=this._selectedStory=this._activeStory=null;this._cleanupInputFocusListener();this._cleanupContentResizeListener();this._deactivatingStory=null;},_logUserAction:function(a,b,event){user_action(b,a,event,'FORCE',null);},_logUserEvent:function(a,event){if(this._ua[a])this._ua[a].add_event(event);},_fetchStory:function(a){clearTimeout(this._fetchToken);var b=[],c=this._getInsertedStories(),d=c.indexOf(a);[-1,0,1].forEach(function(e){var f=c[d+e];f&&b.push(f);},this);this._fetchToken=setTimeout(this._fetchStories.bind(this,b),100);},_fetchStories:function(a){var b=[],c,d=function(e){clearTimeout(c);a.forEach(function(f){CSS.conditionClass(f,'tickerStoryFetching',e);});};a=a.filter(function(e){if(e.id in this._fetchedStories)return false;this._fetchedStories[e.id]=true;var f=this._getStoryDialogEndpoint(e),g=URI(f).getQueryData();if(!f||!g)return false;g.uniq_id=e.getAttribute('id');g.referrer=this._tickerSource;b.push(g);return true;},this);if(!b.length)return;c=this._setTimeout(d.curry(true),500);new AsyncRequest('/ajax/feed/ticker/multi_story').setFinallyHandler(d.curry(false)).setErrorHandler(bagofholding).setData({stories:b}).setAllowCrossPageTransition(this._tickerInSidebarMode).send();},_tickerDeClicker:function(event){var a=event.getTarget(),b=Parent.byTag(a,'a'),c=this._getStoryFromNode(a),d=this._getButtonFromNode(a);if(c&&b&&!d&&CSS.hasClass(c,'tickerStoryClickable')&&!CSS.hasClass(b,'tickerStoryAllowClick')&&!this._storyIsHidden(c)){b.setAttribute('rel','ignore');b.removeAttribute('onclick');b.removeAttribute('ajaxify');b.removeAttribute('href');}var e=(event.button==2),f=c&&this._getActionButtonFromStory(c);if(!e&&f)this._setClickedStory(c);},_handleMouseup:function(event){this._clearClickedStory();},_setClickedStory:function(a){this._clearClickedStory();CSS.addClass(a,'tickerStoryClicked');this._clickedStory=a;},_clearClickedStory:function(){if(this._clickedStory){CSS.removeClass(this._clickedStory,'tickerStoryClicked');this._clickedStory=null;}},_initInfiniteScrollListener:function(){var a=this._getInsertedStories();if(this._storiesWithActions)for(var b=0;b<a.length;b++){var c=a[b];if(CSS.hasClass(c,'tickerStoryWithButton'))this._storiesWithActions[c.getAttribute('data-story-key')]=c;}var d=Math.max(0,a.length-this._autoloadStoryIndex);this._infiniteScrollStory=a[d];this._checkInfiniteScroll();},_checkInfiniteScroll:function(){if(this._infiniteScrollStory){var a=Vector2.getElementPosition(this._infiniteScrollStory).y,b=Vector2.getElementPosition(this._container).y+Vector2.getElementDimensions(this._container).y;if(a<b){var c=DOM.scry(this._root,'.tickerMorePager a')[0];if(c){var d=Parent.byClass(c,'stat_elem')||c,e=new AsyncRequest(c.getAttribute('ajaxify')).setReadOnly(true).setRelativeTo(c).setStatusElement(d).setAllowCrossPageTransition(true).send();this._logUserEvent('stream','scroll');}this._infiniteScrollStory=null;this._autoloadStoryIndex=5;}}},_setFixed:function(a){if(!this._selectedStory)return;var b=this._getStoryDialog(this._selectedStory);if(b){b.setFixed(a);b.updatePosition();}},_setTimeout:function(a,b){return setTimeout(a,b,!this._tickerInSidebarMode);},_scrollDialogToBottom:function(){var a=this._dialog&&this._dialog.getContent(),b=a&&DOM.scry(a,'.uiScrollableAreaWrap')[0],c=b&&ScrollableArea.getInstance(b);c&&c.scrollToBottom();},_openDialog:function(a){this._dialog=a.show();this._updateDialogPosition();this._writeSwfFrame(a);this._initCommentFocusListener.bind(this).defer();this._initContentResizeListener.bind(this).defer();this._stupidIE7VideoResizeHack(a);},_stupidIE7VideoResizeHack:function(a){if(ua.ie()===7){var b=DOM.scry(a.getContent(),'.uiVideoThumb .img');b.forEach(function(c){CSS.setStyle(c,'width','');});}},_updateDialogPosition:function(){var a=this._tickerInSidebarMode||!!Parent.byClass(this._root,'fixed_elem');this._dialog.setFixed(a);this._adjustFlyoutContentHeight();this._dialog.updatePosition();},_writeSwfFrame:function(a){var b=this._dialog&&this._dialog.getContent(),c=DOM.scry(b,'.swfObject')[0];if(!c)return;var d=c.getAttribute('data-swfid');if(d&&window[d]){var e=window[d];e.write(c);}},_initCommentFocusListener:function(){var a=this._dialog&&this._dialog.getContent(),b=a&&DOM.scry(a,'.tickerDialogFooter textarea')[0];if(!b)return;this._listeners.inputFocus=Event.listen(b,'focus',this._scrollDialogToBottom.bind(this));},_cleanupInputFocusListener:function(){if(this._listeners.inputFocus){this._listeners.inputFocus.remove();this._listeners.inputFocus=null;}},_initContentResizeListener:function(){var a=this._dialog&&this._dialog.getContent();if(!a)return;this._listeners.contentResize=Event.listen(a,'click',function(){this._dialog.updatePosition.bind(this._dialog).defer();}.bind(this));},_cleanupContentResizeListener:function(){if(this._listeners.contentResize){this._listeners.contentResize.remove();this._listeners.contentResize=null;}},_adjustFlyoutContentHeight:function(){var a=this._dialog&&this._dialog.getContent(),b=a&&DOM.scry(a,'.uiScrollableAreaWrap')[0];if(!b)return;var c=Vector2.getElementDimensions(b),d=Vector2.getElementPosition(b),e=DOM.scry(b,'.uiUfi .uiUfiComment'),f=Vector2.getViewportDimensions().y-this.FLYOUT_VIEWPORT_PADDING,g=Math.min(this.FLYOUT_MAX_HEIGHT,f),h=g-this.FLYOUT_TARGET_HEIGHT_OFFSET;for(var i=0;i<e.length;i++){var j=e[i],k=Vector2.getElementPosition(j),l=k.y-d.y;if(Math.abs(l-h)<=this.FLYOUT_OFFSET_THRESHOLD){h=l+this.FLYOUT_COMMENT_OFFSET;break;}}if(c.y>h){CSS.setStyle(b,'height',h+'px');CSS.setStyle(b,'max-height',null);}else{CSS.setStyle(b,'max-height',g+'px');CSS.setStyle(b,'height',null);}},_initObjectIDs:function(){stories=this._getAllStories();for(var a=0;a<stories.length;++a){var b=stories[a].getAttribute('data-story-key');b&&(this._objectIDs[b]=true);}},_handleChatOpened:function(){this._deactivateStory(true);},_handleChannelConnection:function(){this._checkChannelConnection();},_debug:function(a){this._tickerDebug&&false;},getNewest:function(){return this._newest;}});
window.__UIControllerRegistry=window.__UIControllerRegistry||{};
PageletCache=window.PageletCache||{init:function(){try{PageletCache._cache=window.sessionStorage;}catch(a){}Arbiter.subscribe('pre_page_transition',PageletCache.cleanup);},_processBeforeWrite:function(a){Bootloader.setResourceMap(a.resource_map);var b=(a.css||[]).concat(a.js||[]);for(var c in (a.bootloadable||{}))b.concat(a.bootloadable[c]);a.resource_map=a.resource_map||{};for(var d=0;d<b.length;d++){var e=b[d];if(!a.resource_map[e])a.resource_map[e]=Bootloader.resolveResources([e])[0];}if(a.cache_type=='overwrite'){delete a.onload;delete a.onafterload;delete a.jscc_map;delete a.jsmods;}},write:function(a){if(!PageletCache._cache||a.cache_type=='base')return;var b={},c={};copy_properties(c,a);try{PageletCache._processBeforeWrite(c);b[a.key]=c;PageletCache._cache.setItem(a.id,JSON.stringify(b));PageletCache._pagelets[a.id]=c;}catch(d){}},loadFromCache:function(a){var b={};copy_properties(b,PageletCache.read(a.id,a.key));if(is_empty(b))return a;b.id=a.id;b.cache_hit=true;b.display_dependency=a.display_dependency;b.phase=a.phase;b.is_last=a.is_last;return b;},read:function(a,b){if(!PageletCache._cache)return null;if(a.substr(0,6)=='cached')a=a.substr(7);var c=PageletCache._cache.getItem(a);if(c){var d;try{d=JSON.parse(c);}catch(e){}if(d&&d[b]){PageletCache._pagelets[a]=d[b];PageletCache._cache_hits[a]=true;return d[b];}}},isCacheHit:function(a){return !!PageletCache._cache_hits[a];},cleanup:function(){PageletCache._cache_hits={};},_cache:null,_pagelets:{},_cache_hits:{}};
function PageletCacheController(a,b,c){if(!PageletCache)return;if(!a)return;this._cacheKey=a;this._cacheType=b;this._subscriptions=[];this._controller=null;this._registerSnapshot(c);PageletCacheController._instances[a]=this;PageletCache.takeSnapshot(a,null,this.handlePageletDOMOnSnapshot.bind(this));}copy_properties(PageletCacheController,{registerController:function(a,b){if(!a||!b)return null;var c=PageletCacheController._instances[a];if(c){c.setController(b);if(c._cacheType=='update'&&PageletCache.isCacheHit(a))onafterloadRegister_DEPRECATED(c.updateAfterload.bind(c,b));}return c;},_instances:{}});copy_properties(PageletCacheController.prototype,{registerCleanup:function(a){Arbiter.subscribe(a,this._cleanup.bind(this));},setController:function(a){this._controller=a;return this;},loadData:function(){return PageletCache.fetchData(this._cacheKey);},populateControllerDataOnSnapshot:bagofholding,handlePageletDOMOnSnapshot:bagofholding,updateAfterload:bagofholding,_registerSnapshot:function(a){for(var b=0;b<a.length;b++)this._subscriptions.push(Arbiter.subscribe(a[b],this._update.bind(this)));},_update:function(){if(!$(this._cacheKey)){this._cleanup();return;}var a=this._controller?this.populateControllerDataOnSnapshot.bind(this,this._controller):bagofholding;PageletCache.takeSnapshot(this._cacheKey,a,this.handlePageletDOMOnSnapshot.bind(this));},_cleanup:function(){this._subscriptions.forEach(Arbiter.unsubscribe);this._subscriptions.length=0;delete PageletCacheController._instances[this._cacheKey];}});copy_properties(PageletCache,{takeSnapshot:function(a,b,c){var d=PageletCache._pagelets[a];if(d){var e=$(a);if(e){var f=e.cloneNode(true);if(c)c(f);d.content[a]=f.innerHTML;if(b){if(!d.data)d.data={};b(d.data);}PageletCache.write(d);}}},fetchData:function(a,b){var c=PageletCache._pagelets[a];if(c&&c.data)if(b){return c.data[b];}else return c.data;}});
function HomeNavigationCache(a,b,c){this.parent.construct(this,a,b,c);}Class.extend(HomeNavigationCache,'PageletCacheController');copy_properties(HomeNavigationCache.prototype,{handlePageletDOMOnSnapshot:function(a){var b=DOM.scry(a,'li.sideNavItem');if(b.length===0)return;for(var c=0;c<b.length;c++){var d=b[c];if(d.id=='navItem_app_4748854339'){CSS.addClass(d,'selectedItem');}else if(CSS.hasClass(d,'selectedItem')){CSS.removeClass(d,'selectedItem');CSS.removeClass(d,'open');}CSS.removeClass(d,'loading');}var e=DOM.scry(a,'.uiFutureSideNav')[0];if(e)CSS.addClass(e,'hideNavCounts');}});
var NewHigh={reset:function(){this.initialized=false;},ensureInitialized:function(){if(this.initialized)return;this.button=DOM.scry(document.body,'a.stream_header_button')[0];this.composer=DOM.scry(document.body,'div.UIComposer')[0];this.buttonArea=DOM.scry(this.composer,'div.UIComposer_ButtonArea')[0];this.initialized=true;},showComposer:function(a){this.ensureInitialized();if(this.composer){CSS.show(this.composer);UIComposer.focusInstance(this.composer.id);var b=UIComposer.getInstance(this.composer.id);b&&b.loadAttachment(parseInt(a,10));}this.button&&CSS.hide(this.button);},hideComposer:function(a){this.ensureInitialized();if(this.composer){var b=UIComposer.getInstance(this.composer.id);if(!a){b&&b.initialized&&b.blur();CSS.hide(this.composer);this.button&&CSS.show(this.button);}else{b&&b.initialized&&b.loadAttachment(0);CSS.show(this.composer);this.buttonArea&&CSS.hide(this.buttonArea);}}}};
__d("UIIntentionalStreamMessage",[],function(a,b,c,d,e,f){var g={SET_AUTO_INSERT:'UIIntentionalStream/setAutoInsert',UPDATE_STREAM:'UIIntentionalStreamRefresh/updateStream',REFRESH_STREAM:'UIIntentionalStreamRefresh/refreshStream',UPDATE_AUTOREFRESH_CONFIG:'UIIntentionalStream/updateAutoRefreshConfig',UPDATE_HTML_CONTENT:'UIIntentionalStream/updateHtmlContent',UPDATE_LAST_REFRESH_TIME:'UIIntentionalStream/updateLastRefreshTime',INSERT_STORIES:'UIIntentionalStream/updateLastRefreshTime'};e.exports=g;});
__d("legacy:UIIntentionalStream-message",["UIIntentionalStreamMessage"],function(a,b,c,d){a.UIIntentionalStreamMessage=b('UIIntentionalStreamMessage');},3);
function UIIntentionalStream(a,b,c,d,e,f,g,h,i,j,k){if(!a)throw new Error('UIIntentionalStream instantiated with no root.');copy_properties(this,{id:a.id,root:a,instanceName:b,newest:c,oldest:d,oldestMR:d,firstLoadIDs:h,shouldShowHidden:false,defaultFilter:e,currentFilterKey:j,sourceType:f,lastSeenTime:k,hasPendingRefresh:false,pauseAutoInsert:false,error:DOM.scry(a,'div.UIIntentionalStream_Error')[0],pager:DOM.scry(a,'div.uiMorePager')[0],filterNullState:DOM.scry(a,'div.friendListFilterNullState')[0],streamContent:DOM.find(a,'.UIIntentionalStream_Content'),requestNum:0,scrollLoadCount:1,maxScrollLoadCount:1,lastViewStateID:0,jslog:JSLogger.create('stream')});this.addScrollTrace('init',{});onleaveRegister(this.unload.bind(this));if(!UIIntentionalStream.instances)UIIntentionalStream.instances={};UIIntentionalStream.instances[b]=this;UIIntentionalStream.instance=this;this.setupAutoInsert();this.setupSubscriptions();}UIIntentionalStream.isHighlightsFilter=function(a){if(!a)return false;var b=startsWith(a,UIIntentionalStream.FEED_FILTER_KEY_NEW_HIGHLIGHTS);return b;};UIIntentionalStream.prototype.subscribeToComposerPublish=function(){this.subscriptions.push(Arbiter.subscribe('composer/publish',function(event,a){if(a.streamStory)this.addComposerContent(a.streamStory,500);}.bind(this)));};UIIntentionalStream.prototype.setupSubscriptions=function(){this.subscriptions=[];this.subscribeToComposerPublish();this.subscriptions.push(Arbiter.subscribe(UIIntentionalStreamMessage.UPDATE_STREAM,this.updateStream.bind(this)));this.subscriptions.push(Arbiter.subscribe(UIIntentionalStreamMessage.REFRESH_STREAM,this.refreshStream.bind(this)));};UIIntentionalStream.prototype.tearDownSubscriptions=function(){if(!this.subscriptions)return;this.subscriptions.forEach(Arbiter.unsubscribe);this.subscriptions=null;};UIIntentionalStream.prototype.unload=function(){this.tearDownSubscriptions();UIIntentionalStream.instance=null;UIIntentionalStream.instances[this.instanceName]=null;this.clearScrollLoader(true);window.disableScrollLoad=null;UIIntentionalStreamRefresh.instance&&UIIntentionalStreamRefresh.instance.unload();};UIIntentionalStream.getInstance=function(a){return UIIntentionalStream.instances[a];};UIIntentionalStream.prototype._getUpdateInsertType=function(){return UIIntentionalStream.REFRESH_PREPEND;};UIIntentionalStream.prototype.updateStream=function(a){if(a!=UIIntentionalStreamMessage.UPDATE_STREAM||this.hasPendingRefresh||this.isAutoRefreshPaused())return;this.loadNewer({showLoader:false,ignoreSelf:true,insertType:this._getUpdateInsertType()});};UIIntentionalStream.prototype.clearScrollLoader=function(a){if(this.currentScrollListener){this.currentScrollListener.remove();this.currentScrollListener=null;}if(a||this.scrollLoadCount>=this.maxScrollLoadCount)window.disableScrollLoad=true;};UIIntentionalStream.prototype.loadOlderPosts=function(a){var b={filter:this.getCurrentFilterKey(),oldest:this.oldest,oldestMR:this.oldestMR,last_seen_time:this.lastSeenTime,scroll_count:this.scrollLoadCount,scroll_position:this.scrollPosition,last_viewstate_id:this.lastViewStateID};b=merge(b,a);this.loadWithParams(b);};UIIntentionalStream.prototype.loadWithParams=function(a){var b=DOM.scry(this.root,'div.fbStreamPager.hasMorePosts')[0];if(b){if(CSS.hasClass(b,'async_saving'))return;CSS.addClass(b,'async_saving');}this.addScrollTrace('loadwithparams',a);UIPagelet.loadFromEndpoint('MoreStoriesPagelet','home_stream',a,{usePipe:true,append:true});};UIIntentionalStream.prototype.setScrollLoadCount=function(a){this.maxScrollLoadCount=a;};UIIntentionalStream.prototype.loadMoreOnScroll=function(a,b){if(window.disableScrollLoad)return;var c=function(){if(window.disableScrollLoad)return;if(window.ArbiterMonitor){var f=user_action('scroll',null,null,'FORCE',{gt:{ua_id:'stream:scroll:auto'}});f.set_namespace('stream');ArbiterMonitor.initUA(f);}var g={delay_load_count:b};this.loadOlderPosts(g);}.bind(this),d=DOM.scry(this.root,'ul.uiStream li.genericStreamStory');if(!d.length)return;this.addScrollTrace('loadmoreonscroll',{});var e=d[d.length-a-1];if(e){this.currentScrollListener=new OnVisible(e,c,null,0);}else c();};UIIntentionalStream.prototype.updateTimeRange=function(a,b){if(!this.newest||this.newest<a){this.newest=a;this.addScrollTrace('update_newest',{newest:this.newest});}if(!this.oldest||(b&&(b<this.oldest))){this.oldest=b;this.addScrollTrace('update_oldest',{oldest:this.oldest});}};UIIntentionalStream.prototype.updateOldestMR=function(a){if(!this.oldestMR||a<this.oldestMR){this.oldestMR=a;this.addScrollTrace('update_oldestmr',{oldestmr:this.oldestMR});}};UIIntentionalStream.prototype.updateScrollPosition=function(a){this.scrollPosition=a;this.addScrollTrace('update_scrollposition',{scrollposition:this.scrollPosition});};UIIntentionalStream.prototype.updateLastViewStateID=function(a){this.lastViewStateID=a;this.addScrollTrace('update_lastviewstateid',{lastviewstateid:this.lastViewStateID});};UIIntentionalStream.prototype.getID=function(){return this.id;};UIIntentionalStream.prototype.getCurrentFilterKey=function(){if(this.currentFilterKey)return this.currentFilterKey;var a=URI.getMostRecentURI().getQueryData();if(a&&a.sk){this.currentFilterKey=a.sk;}else if(a&&a.filter){this.currentFilterKey=a.filter;}else if(this.defaultFilter)this.currentFilterKey=this.defaultFilter;return this.currentFilterKey;};UIIntentionalStream.prototype.resetFilterKey=function(a){this.currentFilterKey=a;};UIIntentionalStream.prototype.loadOlder=function(a){a=a||{};if(!this.oldest)return;var b=this.getCurrentParams();b.oldest=this.oldest;this.refresh(UIIntentionalStream.REFRESH_APPEND,b,a);return this;};UIIntentionalStream.prototype.loadNewer=function(a){if(!this.newest)return;a=a||{};var b=this.getCurrentParams();b.newest=this.newest;if(a.ignoreSelf)b.ignore_self=true;b.load_newer=true;var c=coalesce(a.insertType,UIIntentionalStream.REFRESH_PREPEND);this.refresh(c,b,a);return this;};UIIntentionalStream.prototype.getCurrentParams=function(){var a={},b=URI.getMostRecentURI().getQueryData();b.filter=this.getCurrentFilterKey();var c=this.getValidParams();if(c){c.forEach(function(d){a[d]=b[d];});}else a=b;return a;};UIIntentionalStream.prototype.setHomeFilter=function(a){this._homeFilter=a;};UIIntentionalStream.prototype.setHomeFilterLoading=function(a){if(this._homeFilter)this._homeFilter.setLoading(a);};UIIntentionalStream.prototype.refresh=function(a,b,c){Arbiter.inform(UIIntentionalStreamMessage.UPDATE_LAST_REFRESH_TIME);this.addScrollTrace('refresh',{type:a,data:b,kwargs:c});this.currentFilterKey=b.filter;if(b.filter==UIIntentionalStream.FEED_FILTER_KEY_DUAL_NEWS_FEED){this.currentFilterKey=this.defaultFilter;}else if(UIIntentionalStream.isHighlightsFilter(b.filter)||b.filter===UIIntentionalStream.FEED_FILTER_KEY_NEWS_FEED)this.defaultFilter=this.currentFilterKey;c=c||{};var d=++this.requestNum,e=coalesce(c.showLoader,true),f=this.instanceName,g=function(k){UIIntentionalStream.getInstance(f).handleResponse(d,a,k,c);},h=function(k){UIIntentionalStream.getInstance(f).handleError(d,a,k,c);},i=function(k){UIIntentionalStream.getInstance(f).handleFinally(a,b.filter,k);};if(!(b.request_type=a))b.request_type='none';if(b.filter){c.show_hidden=b.show_hidden?b.show_hidden:false;}else c.show_hidden=this.shouldShowHidden;b=copy_properties(this.getCurrentParams(),b);this.hasPendingRefresh=true;var j;if(a==UIIntentionalStream.REFRESH_APPEND&&e)j=this.pager;new AsyncRequest().setURI(this.getEndpoint()).setReadOnly(true).setOption('retries',0).setMethod(this.getRefreshMethod()).setData(b).setHandler(g).setStatusElement(j).setErrorHandler(h).setFinallyHandler(i).send();if(a==UIIntentionalStream.REFRESH_TRANSITION){hide(this.pager);this.clearScrollLoader(true);this.oldest=this.newest=null;}if(e)this.setHomeFilterLoading(true);};UIIntentionalStream.prototype.addComposerContent=function(a,b){if(this.isOnNewsFeedFilter())CSS.addClass(a,'uiStreamBoulderHighlight');this.addContentPrepend(a,b);};UIIntentionalStream.prototype.addContentPrepend=function(a,b){if(a.length){$A(a).reverse().forEach(function(h){this.addContentPrepend(h,b);}.bind(this));return;}var c,d=Vector2.getScrollPosition().y,e=Vector2.getElementPosition(this.streamContent).y,f=this.scrollOnPrepend&&d>=e;if(f){var g=function(h){var i=DOM.find(h,'^li.uiStreamStory');if(!i)return;DataStore.set(i,'origHeight',i.offsetHeight);Event.listen(h,'load',function(){var j=DataStore.get(i,'origHeight');if(i.offsetHeight!=j){window.scrollBy(0,i.offsetHeight-j);DataStore.set(i,'origHeight',i.offsetHeight);}});};c=animation.insert.curry(this.streamContent,a,(function(h,i){DOM.prependContent(this.streamContent,i);Arbiter.inform('reflow');window.scrollBy(0,i.offsetHeight);DOM.scry(i,'img').forEach(g);}).bind(this));}else c=(function(){CSS.setStyle(a,'opacity',0);ScrollAwareDOM.prependContent(this.streamContent,a);Arbiter.inform('reflow');animation(a).from('opacity',0).to('opacity',1).duration(400).go();}).bind(this);if(b){CSS.hide(a);DOM.appendContent(document.body,a);setTimeout(function(){CSS.show(a);c();},b);}else c();};UIIntentionalStream.prototype.addContentAppend=function(a){DOM.appendContent(this.streamContent,a);};UIIntentionalStream.getStoriesByAssoc=function(a){return DOM.scry(UIIntentionalStream.instance.root,'div.aid_'+a);};UIIntentionalStream.prototype.handleResponse=function(a,b,c,d){this.addScrollTrace('handle_response',{requestnum:a,type:b,kwargs:d});d=d||{};var e=c.getPayload();this.filterNullState&&DOM.remove(this.filterNullState);if(is_empty(e))return;if(e.autoRefreshConfig)Arbiter.inform(UIIntentionalStreamMessage.UPDATE_AUTOREFRESH_CONFIG,e.autoRefreshConfig);this.setHomeFilterLoading(false);if(b==UIIntentionalStream.REFRESH_EXPAND){var f=DOM.find($(d.expandStoryID),'div.UIIntentionalStory_CollapsedStories');CSS.hide(f);CSS.removeClass(f,'UIIntentionalStory_CollapsedStoriesLoading');}if(this.error)hide(this.error);if(a!=this.requestNum)return;if('show_hidden' in d)this.shouldShowHidden=d.show_hidden;if('newestStoryTime' in e&&e.newestStoryTime>this.newest)this.newest=e.newestStoryTime;if(b!=UIIntentionalStream.REFRESH_PREPEND){if('oldestStoryTime' in e&&(!this.oldest||e.oldestStoryTime<this.oldest))this.oldest=e.oldestStoryTime;if('scrollPosition' in e)this.scrollPosition=e.scrollPosition;if('lastViewStateID' in e)this.lastViewStateID=e.lastViewStateID;if('oldestMRStoryTime' in e)this.oldestMR=e.oldestMRStoryTime;}if(e.html){var g=HTML(e.html).getNodes();switch(b){case UIIntentionalStream.REFRESH_PREPEND:this.addContentPrepend(g);break;case UIIntentionalStream.REFRESH_APPEND:this.addContentAppend(g);this.clearScrollLoader(true);break;case UIIntentionalStream.REFRESH_TRANSITION:DOM.setContent(this.streamContent,g);var h=this.streamContent.firstChild;if(!d.noScroll)DOMScroll.scrollTo(new Vector2(0,0,"document"),false);break;case UIIntentionalStream.REFRESH_EXPAND:DOM.insertAfter($(d.expandStoryID),g);break;case UIIntentionalStream.DELAYED_STREAM:this.addContentAppend(g);break;}Arbiter.inform(UIIntentionalStreamMessage.UPDATE_HTML_CONTENT);}};UIIntentionalStream.prototype.handleError=function(a,b,c,d){if(a!=this.requestNum)return;this.setHomeFilterLoading(false);var e=c.getError();if(e==1357001)AsyncResponse.defaultErrorHandler(c);if(b==UIIntentionalStream.REFRESH_EXPAND){var f=DOM.find($(d.expandStoryID),'div.UIIntentionalStory_CollapsedStories');CSS.removeClass(f,'UIIntentionalStory_CollapsedStoriesLoading');}if(!d.delayLoadCount&&b!=UIIntentionalStream.REFRESH_PREPEND&&this.error)CSS.setStyle(this.error,'display','block');};UIIntentionalStream.prototype.handleFinally=function(a,b){if(a==UIIntentionalStream.REFRESH_TRANSITION){PageTransitions.transitionComplete();Arbiter.inform(NavigationMessage.NAVIGATION_COMPLETED);}this.hasPendingRefresh=false;};UIIntentionalStream.prototype.getValidParams=function(){return UIIntentionalStream.VALID_PARAMS;};UIIntentionalStream.prototype.getEndpoint=function(){return UIIntentionalStream.ENDPOINT;};UIIntentionalStream.prototype.getRefreshMethod=function(){return UIIntentionalStream.REFRESH_METHOD;};UIIntentionalStream.prototype.isOnNewHighlights=function(){var a=this.getCurrentFilterKey();return (UIIntentionalStream.isHighlightsFilter(a)||(a==UIIntentionalStream.FEED_FILTER_KEY_DUAL_NEWS_FEED&&UIIntentionalStream.isHighlightsFilter(this.defaultFilter)));};UIIntentionalStream.prototype.isLiveStreamBox=function(){var a=this.getCurrentFilterKey();return a&&a.indexOf(UIIntentionalStream.FEED_FILTER_KEY_LIVE_STREAM_BOX)==0;};UIIntentionalStream.prototype.isOnNewsFeedFilter=function(){var a=this.getCurrentFilterKey();return (a==UIIntentionalStream.FEED_FILTER_KEY_NEWS_FEED||UIIntentionalStream.isHighlightsFilter(a)||a==UIIntentionalStream.FEED_FILTER_KEY_DUAL_NEWS_FEED);};UIIntentionalStream.prototype.setupAutoInsert=function(){Arbiter.subscribe(UIIntentionalStreamMessage.SET_AUTO_INSERT,UIIntentionalStream.setAutoInsert);};UIIntentionalStream.setAutoInsert=function(a,b){if(a!=UIIntentionalStreamMessage.SET_AUTO_INSERT)return;var c=UIIntentionalStream.instance;if(c)c.pauseAutoInsert=b.pause;};UIIntentionalStream.prototype.isAutoRefreshPaused=function(){if(this.isOnNewHighlights()||this.isLiveStreamBox())return false;return this.pauseAutoInsert;};UIIntentionalStream.prototype.addScrollTrace=function(a,b){this.jslog.debug(a,b);};UIIntentionalStream.prototype.refreshStream=function(a,b){if(a!=UIIntentionalStreamMessage.REFRESH_STREAM)return;var c=this.getCurrentFilterKey(),d={filter:c},e={filter:c};b.noScroll&&(e.noScroll=1);this.refresh(UIIntentionalStream.REFRESH_TRANSITION,d,e);};copy_properties(UIIntentionalStream,{ANIMATION_DURATION:300,REFRESH_METHOD:'GET',REFRESH_TRANSITION:1,REFRESH_PREPEND:2,REFRESH_APPEND:3,REFRESH_EXPAND:5,DELAYED_STREAM:6,FEED_FILTER_KEY_NEW_HIGHLIGHTS:'h',FEED_FILTER_KEY_NEWS_FEED:'lf',FEED_FILTER_KEY_DUAL_NEWS_FEED:'nf',FEED_FILTER_KEY_LIVE_STREAM_BOX:'pub',VALID_PARAMS:['filter','show_hidden'],ENDPOINT:'/ajax/intent.php'});
function FutureHomeSideNav(){this.parent.construct(this);}Class.extend(FutureHomeSideNav,'FutureSideNav');copy_properties(FutureHomeSideNav.prototype,{init:function(){this.parent.init.apply(this,arguments);this.ajaxPipe=true;this.seeAllEndpoint="/ajax/home/generic.php";this.typeSections={favorites:'pinnedNav',profiles:'pinnedNav',apps:'appsNav',groups:'groupsNav',pages:'pagesNav',lists:'listsNav',interests:'interestsNav',connect_apps:'connectNav'};this.switchingFromTitanFixedFrame=false;this._arbiterSubscriptions.push(Arbiter.subscribe('titan_fixed_frame_changed',this.handleFixedFrameChanged.bind(this)),Arbiter.subscribe(NavigationMessage.NAVIGATION_FAVORITE_UPDATE,this.updateFavorite.bind(this)),Arbiter.subscribe(NavigationMessage.NAVIGATION_FIRST_RESPONSE,this.navigationFirstResponse.bind(this)));this._ensureHover('homeSideNav');this._initPageletCache();},_initPageletCache:function(a){if(window.PageletCacheController){this._cache=PageletCacheController.registerController('pagelet_navigation',this);if(this._cache){this._cache.registerCleanup('HomeNav/cleanup');onleaveRegister(function(){Arbiter.inform('HomeNav/cleanup');});}}},initMoreLink:function(a){this._eventHandlers.push(Event.listen(a,'click',this._showMoreSections.bind(this,a)));},_showMoreSections:function(a){var b=DOM.scry(this.root,'div.belowThreshold');CSS.hide(a);b.forEach(function(c){CSS.removeClass(c,'belowThreshold');});},handleFixedFrameChanged:function(a,b,c){if(b){var d=function(e,f){UIPagelet.loadFromEndpoint(e,f,{fixed_frame:b,selected_key:c});};d('PinnedNavigationPagelet','pagelet_pinned_nav');d('BookmarkNavigationPagelet','pagelet_bookmark_nav');if(ge('chatFriendsOnline'))CSS.hide(ge('chatFriendsOnline'));}else this.switchingFromTitanFixedFrame=true;},handlePageTransition:function(a){if(this.switchingFromTitanFixedFrame){this.switchingFromTitanFixedFrame=false;return false;}else return this.parent.handlePageTransition(a);},_initSection:function(a){var b=this.parent._initSection(a);for(var c in this.typeSections){var d=this.typeSections[c];if(b.id==d){var e=DOM.scry(b.node,'div.navHeader')[0];if(e){var f='\/bookmarks\/('+c+')(\/)?';b.seeall=this._initItem({node:e,id:b.id,endpoint:this.seeAllEndpoint,key:['bookmarks'],path:[{regex:f}]});}}}return b;},_constructItem:function(a,b){return new FutureHomeSideNavItem(a,b);},_constructSection:function(a){return new FutureHomeSideNavSection(a);},getSection:function(a){return this.typeSections[a]&&this.sections[this.typeSections[a]];},_getItemForKey:function(a){var b=this.parent._getItemForKey("nf");if(b&&b.matchKey(a)){return b;}else return this.parent._getItemForKey(a);},_isCurrentPath:function(a){return ((a.getDomain()===this.uri.getDomain())&&(a.getPath()==='/'||a.getPath()==='/home.php'));},_handleMenuClick:function(a,b,c,event){if(CSS.hasClass(c,'favorite')){Arbiter.inform(NavigationMessage.NAVIGATION_FAVORITE_UPDATE,{key:b.numericKey,favorite:!a.equals(this.getSection("favorites")),movetop:CSS.hasClass(c,'movetop')});}else this.parent._handleMenuClick(a,b,c,event);},removeItemByKey:function(a){Arbiter.inform(NavigationMessage.NAVIGATION_ITEM_REMOVED,a);this.parent.removeItemByKey(a);},toggleItemByKey:function(a,b){var c=this.getNodeForKey(a);if(!b){Arbiter.inform(NavigationMessage.NAVIGATION_ITEM_HIDDEN,a);c&&CSS.hide(c);}else c&&CSS.show(c);var d=this._getItemForKey(a);this.getSection(d.type).refresh();},removeItem:function(a){var b=this.getSection(a.type);this.parent.removeItem(a);b.refresh();},updateFavorite:function(a,b){var c=this._findItem(function(l){return l.matchKey(b.key)&&l.canFavorite();}),d=this.getSection("favorites"),e=bagofholding,f=b.favorite?d.addEndpoint:d.removeEndpoint;if(b.movetop)f=d.editEndpoint;if(!c&&(b.favorite||b.movetop)){if(b.movetop)var g=DOM.scry(this.root,'.expandableSideNav'),h=g&&g.length&&CSS.hasClass(g[0],'expandedMode');e=function(){UIPagelet.loadFromEndpoint('PinnedNavigationPagelet','pagelet_pinned_nav',{expanded:h});};}else if(!c){e=function(){UIPagelet.loadFromEndpoint('BookmarkNavigationPagelet','pagelet_bookmark_nav');};}else{if(b.movetop){CSS.show(c.node);this.moveItem(d,c);var i=Parent.byClass(c.node,'uiSideNav');if(i&&i.childNodes.length){var j=Parent.byClass(DOM.scry(i,'.sortableItem')[0],'sideNavItem');DOM.insertBefore(j,c.node);CSS.removeClass(c.node,'hidden');}}else{var k=this.getSection(c.type);if(b.favorite){CSS.show(c.node);this.moveItem(d,c);c.showFavorite();}else if(!k.equals(d)){this.moveItem(k,c);c.hideFavorite();}else this.removeItem(c);k.refresh();}d.refresh();b.key=c.numericKey;Arbiter.inform('NavigationMessage.FAVORITES_UPDATED');}new AsyncRequest().setURI(f).setData({id:b.key,movetop:b.movetop}).setHandler(e).send();},_doPageTransition:function(a,b){this._unloadStreams();var c=this.parent._doPageTransition(a,b);if(c&&(a.type=='groups'||a.type=='lists'||a.type=='interests')){a.setCount(0);a.hideUnreadDot();}return c;},_unloadStreams:function(){var a=window.UIIntentionalStream&&UIIntentionalStream.instances,b=['nile','global','friends','blade'];a&&b.forEach(function(c){a[c]&&a[c].unload();});},navigationFirstResponse:function(){this.setSelected(this.loading);}});function FutureHomeSideNavSection(a){this.parent.construct(this,a);this.editEndpoint='/ajax/bookmark/edit/';this.addEndpoint='/ajax/bookmark/add/';this.removeEndpoint='/ajax/bookmark/delete/';}Class.extend(FutureHomeSideNavSection,'FutureSideNavSection');copy_properties(FutureHomeSideNavSection.prototype,{refresh:function(){var a=DOM.scry(this.node,'li.sideNavItem'),b=DOM.scry(this.node,'div.actionLinks'),c=a.some(CSS.shown);CSS.conditionShow(DOM.find(this.node,'div.navHeader'),c);b.length&&CSS.conditionShow(b[0],c);}});function FutureHomeSideNavItem(a,b){this.parent.construct(this,a,b);}Class.extend(FutureHomeSideNavItem,'FutureSideNavItem');copy_properties(FutureHomeSideNavItem.prototype,{canFavorite:function(){return !!this._getFavoriteLabel();},showFavorite:function(){DOM.setContent(this._getFavoriteLabel(),"Poista suosikeista");},hideFavorite:function(){DOM.setContent(this._getFavoriteLabel(),"Lis\u00e4\u00e4 suosikkeihin");},hideUnreadDot:function(){var a=DOM.scry(this.node,'img.unreadDot')[0];a&&CSS.hide(a);},_getFavoriteLabel:function(){return DOM.scry(this.node,'li.favorite span.itemLabel')[0];}});
__d("FeedTrackingAsync",["event-extensions","collectDataAttributes","copyProperties"],function(a,b,c,d,e,f){b('event-extensions');var g=b('collectDataAttributes'),h=b('copyProperties');function i(j){Event.listen(j,'AsyncRequest/send',function(event){var k=event.getTarget(),l=event.getData().request,m=l.getData(),n=g(k,['ft']);h(m,n);});}e.exports={init:i};});
function HomeTickerFirstRightColumnController(){}copy_properties(HomeTickerFirstRightColumnController.prototype,{_isFixed:false,_forcedStatic:false,_PADDING_RHC_TO_BOTTOM:75,_PADDING_RHC_TO_BOTTOM_SHORT:50,_TOP_PADDING:15,_refreshOn:false,_fixAdsOnScroll:false,init:function(a){copy_properties(this,{_adsRefreshInterval:a.adsRefreshInterval,_adsRefreshDelay:a.adsRefreshDelay,_adsRefreshOnmove:a.adsRefreshOnmove,_enableSidebar:a.enableSidebar,_fixAdsOnScroll:a.fixAdsOnScroll,_maxFixedAds:a.maxFixedAds,contentCol:$('contentCol'),blueBar:$('blueBar'),_tickerMaxHeight:(a.tickerMaxHeight||425),_tickerMinHeight:(a.tickerMinHeight||225),_tickerAbsMinHeight:(a.tickerAbsMinHeight||120),_listeners:[],_subscriptions:[]});this._listeners.push(Event.listen(window,'resize',throttle(this.handleResize.bind(this))));this.blueBarHeight=Vector2.getElementDimensions(this.blueBar).y;this.reloadRightCol();this._initSubscriptions();onleaveRegister(this.cleanup.bind(this));this._listeners.push(Event.listen(window,'scroll',throttle(this._handleScroll.bind(this))));if(this._adsRefreshOnmove)this._listeners.push(Event.listen(window,'mousemove',throttle(this._handleMove.bind(this))));this._lastAdLoadTime=Date.now();this._debounceReloadAdsIfNeeded=debounce(this._reloadAdsIfNeeded.bind(this),this._adsRefreshDelay,true);if(!CSS.hasClass(document.documentElement,'sidebarMode')){this._onSidebarHide();}else if(this._enableSidebar)this._onSidebarShow();this._handleAdsLoad();},_handleAdsLoad:function(){var a=this.handleResize.bind(this);function b(){a.defer();}var c=DOM.scry(this.egoPagelet,'img.img');c.forEach(function(d){if(!d.complete)Event.listen(d,{load:b,error:b,abort:b});});b();},_initSubscriptions:function(){this._subscriptions=[Arbiter.subscribe('page_transition',this.cleanup.bind(this)),Arbiter.subscribe('Ticker/storiesInserted',this.handleResize.bind(this)),Arbiter.subscribe('concierge/load',this.handleResize.bind(this)),Arbiter.subscribe(UIIntentionalStreamMessage.INSERT_STORIES,this.handleResize.bind(this))];if(this._enableSidebar){this._subscriptions.push(Arbiter.subscribe('sidebar/hide',this._onSidebarHide.bind(this)));this._subscriptions.push(Arbiter.subscribe('sidebar/show',this._onSidebarShow.bind(this)));}},reloadRightCol:function(){this.rightColumn=DOM.scry(ge('rightCol'),'div.home_right_column')[0];this.rightColumnWrapper=DOM.find(this.rightColumn,'div.rightColumnWrapper');this.egoPagelet=ge('pagelet_ego_pane_w');if(!this.egoPagelet)this.egoPagelet=ge('pagelet_ego_pane_m');this._refreshOn=!this.containsPremium();this.tickerPagelet=ge('pagelet_rhc_ticker');if(!this.tickerPagelet)return false;this.tickerContainer=DOM.scry(this.tickerPagelet,'.ticker_container')[0];this.tickerStream=DOM.scry(this.tickerPagelet,'.ticker_stream')[0];return this.tickerContainer&&this.tickerStream;},containsPremium:function(){if(this.egoPagelet){var a=DOM.scry(this.egoPagelet,'.fbAdUnit');for(var b=0;b<a.length;b++){var c=JSON.parse(a[b].getAttribute('data-ad')).segment;if(c==='premium')return true;}}return false;},cleanup:function(a,b){if(a==='page_transition'&&b&&b.uri){var c=b.uri;if(c.path==='/photo.php'){this._inSnowbox=true;return;}if(this._inSnowbox&&c.path==='/'){this._inSnowbox=false;return;}}this._subscriptions.forEach(Arbiter.unsubscribe);this._subscriptions=[];this._listeners.forEach(function(d){d.remove();});this._listeners=[];this._debounceReloadAdsIfNeeded.reset();},_calculateDistanceFromTopOfRHCToTopOfAds:function(){if(this.forceFixingEvaluation||!this._isFixed)this.distanceFromTopOfRHCToTopOfAds=Vector2.getElementPosition(this.egoPagelet,'viewport').y-Vector2.getElementPosition(this.rightColumnWrapper,'viewport').y;},_handleScroll:function(){this._debounceReloadAdsIfNeeded();this._calculateDistanceFromTopOfRHCToTopOfAds();this._topOffset=this.blueBarHeight+Vector2.getElementPosition(this.blueBar,'viewport').y;var a=this._topOffset,b=Vector2.getElementPosition(this.rightColumn,'viewport').y;if(this._forcedStatic||!this.tickerStream){if(this._fixAdsOnScroll&&this.adsStickPoint!==null){var c=b+this.distanceFromTopOfRHCToTopOfAds,d=c<=a-this.adsStickPoint;if(this.forceFixingEvaluation||d!==this._isFixed){this.forceFixingEvaluation=false;var e=a-this.adsStickPoint-this.distanceFromTopOfRHCToTopOfAds;this._setFixed(d,e);}}return;}var f=b<=a+this._TOP_PADDING;if(f!==this._isFixed)this._setFixed(f);},_handleMove:function(){this._debounceReloadAdsIfNeeded();},_reloadAdsIfNeeded:function(){var a=Date.now();if(this._refreshOn&&this._adsRefreshInterval>0&&a-this._lastAdLoadTime>=this._adsRefreshInterval)this._reloadAds();},_reloadAds:function(){this._lastAdLoadTime=Date.now();UIPagelet.loadFromEndpoint('WebEgoPane',this.egoPagelet,{pid:27,data:{organic_only:false,ads_only:false,is_refresh:true}},{crossPage:false,handler:this._handleAdsLoad.bind(this)});},_recalculateAndReposition:function(){this.forceFixingEvaluation=true;this._calculateDistanceFromTopOfRHCToTopOfAds();this._recalculateFixingPosition();this._handleScroll();},_recalculateFixingPosition:function(){if(!this._fixAdsOnScroll)return;var a=Vector2.getViewportDimensions().y-this.blueBarHeight-this._PADDING_RHC_TO_BOTTOM_SHORT,b=Vector2.getElementDimensions(this.rightColumnWrapper).y;if(b<=a){this.adsStickPoint=0-this.distanceFromTopOfRHCToTopOfAds-this._TOP_PADDING;return;}var c=b-this.distanceFromTopOfRHCToTopOfAds,d=DOM.scry(this.egoPagelet,'div.egoOrganicColumn')[0];if(c<=a&&d){this.adsStickPoint=0;}else{var e=DOM.scry(this.egoPagelet,'div.ego_unit').reverse(),f=DOM.scry(this.egoPagelet,'div.fbAdUnit').length,g=this._maxFixedAds;if(f<=this._maxFixedAds)g=e.length;var h=null;for(var i=0;i<g;i++){var j=e[i],k=Vector2.getElementPosition(j,'viewport').y-Vector2.getElementPosition(this.rightColumnWrapper,'viewport').y,l=Vector2.getElementDimensions(this.rightColumnWrapper).y-k;if(l>a){if(i>0)h=e[i-1];break;}if(i==g-1)h=j;}if(h==null){this.adsStickPoint=null;}else this.adsStickPoint=Vector2.getElementPosition(h,'viewport').y-Vector2.getElementPosition(this.egoPagelet,'viewport').y;}},_setFixed:function(a,b){this._isFixed=a;b=b||this._topOffset;var c=a?b+'px':'';CSS.setStyle(this.rightColumnWrapper,'top',c);CSS.conditionClass(this.rightColumnWrapper,'fixed_elem',a);var d=DOM.scry(this.rightColumnWrapper,'div.displayedTickerToggleWrapper')[0];d&&CSS.conditionClass(d,'toggleWrapperWithoutMargin',this._fixAdsOnScroll&&a&&!this.tickerStream);if(this._sidebarIsHidden){var e=a?'Ticker/fixed':'Ticker/unfixed';Arbiter.inform(e);}},handleResize:function(){if(!this._sidebarIsHidden||!this.tickerStream||CSS.hasClass(document.documentElement,'tinyViewport')){this._recalculateAndReposition();return;}this._handleScroll();var a=Vector2.getViewportDimensions().y,b=61,c=Vector2.getElementDimensions(this.rightColumnWrapper).y-Vector2.getElementDimensions(this.tickerContainer).y,d=Vector2.getElementDimensions(this.tickerStream).y,e=a-c-this._PADDING_RHC_TO_BOTTOM-this._topOffset-b,f=this._tickerAbsMinHeight,g=this._tickerMinHeight;this._forcedStatic=false;if(e<f){this._forcedStatic=true;this._setFixed(false);e=f;}else if(e<g)if(e>(g-b)){e=g;}else e+=b;var h=Math.min(e,d,this._tickerMaxHeight);CSS.setStyle(this.tickerContainer,'height',h+'px');},_onSidebarHide:function(){this._sidebarIsHidden=true;this.reloadRightCol();var a=function(){if(this.reloadRightCol()){this._forcedStatic=false;this._handleScroll();this.handleResize();}};this.tickerPagelet&&TickerController.show(this.tickerPagelet,a.bind(this));},_onSidebarShow:function(){this._sidebarIsHidden=false;this.reloadRightCol();if(this._fixAdsOnScroll){this._recalculateAndReposition();}else{this._forcedStatic=true;this._setFixed(false);}this.tickerPagelet&&TickerController.hide(this.tickerPagelet);}});
__d("ContextualLayerAsyncRelative",["event-extensions","copyProperties","Parent"],function(a,b,c,d,e,f){b('event-extensions');var g=b('copyProperties'),h=b('Parent');function i(j){this._layer=j;}g(i.prototype,{_layerSubscription:null,_listener:null,enable:function(){this._layerSubscription=this._layer.subscribe('show',this._attachListener.bind(this));if(this._layer.isShown())this._attachListener();},disable:function(){this._layer.unsubscribe(this._layerSubscription);this._layerSubscription=null;if(this._listener){this._listener.remove();this._listener=null;}},_attachListener:function(){this._listener=Event.listen(this._layer.getRoot(),'click',this._onclick.bind(this));},_onclick:function(j){var k=h.byTag(j.getTarget(),'A');if(!k)return;var l=k.getAttribute('ajaxify'),m=k.href,n=l||m;if(k.rel==='async'||k.rel==='async-post'){d(['AsyncRequest'],function(o){o.bootstrap(n,this._layer.getContext(),k.rel==='async-post');}.bind(this));return false;}}});e.exports=i;});
__d("MenuX",["event-extensions","Class","copyProperties","CSS","DataStore","DOM","HTML","Keys","Parent","PopoverMenuInterface"],function(a,b,c,d,e,f){b('event-extensions');var g=b('Class'),h=b('copyProperties'),i=b('CSS'),j=b('DataStore'),k=b('DOM'),l=b('HTML'),m=b('Keys'),n=b('Parent'),o=b('PopoverMenuInterface');function p(q,r,s){this.parent.construct(this);this._id=q;this._className=r;this._items=[];for(var t=0;t<s.length;t++)this._items[t]=new s[t].ctor(s[t]);}g.extend(p,o);h(p.prototype,{_focused:null,_root:null,addItem:function(q){this._items.push(q);if(this._root)this._insertItem(q);},getRoot:function(){if(!this._root)this._render();return this._root;},onHide:function(){this.blur();},focusAnItem:function(){return this._attemptFocus(0,1);},blur:function(){if(this._focused){this._focused.blur();this._focused=null;this.inform('blur');}},handleKeydown:function(q){var r=this._items.indexOf(this._focused);switch(q){case m.UP:case m.DOWN:var s=q===m.UP?-1:1;if(r!==-1){return this._attemptFocus(r+s,s);}else if(q===m.UP){return this._attemptFocus(this._items.length-1,-1);}else return this._attemptFocus(0,1);break;case m.SPACE:if(this._items.indexOf(this._focused)!==-1){this._handleItemClick(this._focused);return true;}return false;default:var t=String.fromCharCode(q).toLowerCase(),u;for(var v=r+1;v<this._items.length;v++){u=this._items[v].getAccessKey();if(u&&u.charAt(0).toLowerCase()===t)if(this._focusItem(this._items[v]))return true;}return false;}},_render:function(){var q='uiMenuX'+(this._className?' '+this._className:'');this._ul=k.create('ul',{className:q});this._id&&this._ul.setAttribute('id',this._id);this._ul.setAttribute('role','menu');this._items.forEach(this._insertItem.bind(this));Event.listen(this._ul,'click',this._handleClick.bind(this));Event.listen(this._ul,'mouseover',this._handleMouseOver.bind(this));Event.listen(this._ul,'mouseout',this._handleMouseOut.bind(this));this._root=k.create('div',{className:'uiMenuXWrapper'},this._ul);},_handleClick:function(q){var r=this._getItemInstance(q.getTarget());if(r)return this._handleItemClick(r);},_handleItemClick:function(q){this.inform('itemclick',q);if(q.hasAction())this.done();return q.handleClick();},_handleMouseOver:function(q){var r=this._getItemInstance(q.getTarget());r&&this._focusItem(r);},_handleMouseOut:function(q){var r=this._getItemInstance(q.getTarget());if(r&&this._focused===r)this.blur();},_insertItem:function(q){var r=q.getRoot();i.addClass(r,'__MenuXItem');j.set(r,'MenuXItem',q);k.appendContent(this._ul,r);},_attemptFocus:function(q,r){var s=this._items[q];if(s)if(this._focusItem(s)){return true;}else return this._attemptFocus(q+r,r);return false;},_focusItem:function(q){if(q.focus()!==false){if(this._focused!==q){this.blur();this._focused=q;this.inform('focus');}return true;}return false;},_getItemInstance:function(q){var r=n.byClass(q,'__MenuXItem');return r?j.get(r,'MenuXItem'):null;}});e.exports=p;});
__d("MenuXItemInterface",["copyProperties"],function(a,b,c,d,e,f){var g=b('copyProperties');function h(){}g(h.prototype,{_root:null,getRoot:function(){if(!this._root)this._root=this.render();return this._root;},render:bagofholding,getAccessKey:bagofholding,hasAction:bagof(false),focus:bagof(false),blur:bagof(false),handleClick:bagof(false)});e.exports=h;});
__d("MenuXItemBase",["Class","copyProperties","CSS","DOM","HTML","MenuXItemInterface"],function(a,b,c,d,e,f){var g=b('Class'),h=b('copyProperties'),i=b('CSS'),j=b('DOM'),k=b('HTML'),l=b('MenuXItemInterface');function m(n){this.parent.construct(this);this._data=n;}g.extend(m,l);h(m.prototype,{render:function(){var n='uiMenuXItem';if(this._data.className)n+=' '+this._data.className;var o={className:n,'aria-selected':'false'};for(var p in this._data)if(p.indexOf('data-')===0)o[p]=this._data[p];return j.create('li',o,this._renderItemContent());},_renderItemContent:function(){return k(this._data.markup).getNodes();}});e.exports=m;});
__d("MenuXItem",["event-extensions","Class","copyProperties","CSS","DOM","KeyStatus","MenuXItemBase"],function(a,b,c,d,e,f){b('event-extensions');var g=b('Class'),h=b('copyProperties'),i=b('CSS'),j=b('DOM'),k=b('KeyStatus'),l=b('MenuXItemBase');function m(n){this.parent.construct(this,n);}g.extend(m,l);h(m.prototype,{getValue:function(){return this._data.value;},getAccessKey:function(){return this._data.label&&this._data.label.charAt(0);},hasAction:bagof(true),focus:function(){if(!this._root.offsetParent)return false;i.addClass(this._anchor,'highlighted');i.addClass(this._root,'selected');this._root.setAttribute('aria-selected','true');if(k.isKeyDown())this._anchor.focus();},blur:function(){i.removeClass(this._anchor,'highlighted');i.removeClass(this._root,'selected');this._root.setAttribute('aria-selected','false');},handleClick:function(){if(typeof this._onclickHandler==='function')return this._onclickHandler();return !!((this._data.rel&&this._data.rel!=='ignore')||this._data.href);},setOnClickHandler:function(n){this._onclickHandler=n;},_renderItemContent:function(){this._anchor=j.create('a',{className:'itemAnchor'},j.create('span',{className:'itemLabel'},this._data.markup));if(this._data.icon_markup){j.prependContent(this._anchor,this._data.icon_markup);i.addClass(this._anchor,'hasIcon');}this._anchor.setAttribute('href',this._data.href||'#');if(this._data.rel){this._anchor.setAttribute('rel',this._data.rel);}else if(!this._data.href)this._anchor.setAttribute('rel','ignore');if(this._data.ajaxify)this._anchor.setAttribute('ajaxify',this._data.ajaxify);if(this._data.target)this._anchor.setAttribute('target',this._data.target);this._anchor.setAttribute('role','menuitem');return this._anchor;}});e.exports=m;});
__d("MenuXSelectableItem",["Class","copyProperties","CSS","MenuXItem"],function(a,b,c,d,e,f){var g=b('Class'),h=b('copyProperties'),i=b('CSS'),j=b('MenuXItem');function k(l){this.parent.construct(this,l);}g.extend(k,j);h(k.prototype,{_selected:false,getLabel:function(){return this._data.label;},isSelected:function(){return this._selected;},select:function(){i.addClass(this._root,'checked');this._selected=true;},deselect:function(){i.removeClass(this._root,'checked');this._selected=false;},render:function(){var l=this.parent.render();if(this._data.selected){i.addClass(l,'checked');this._selected=true;}return l;}});e.exports=k;});
__d("collectSubtreeData",[],function(a,b,c,d,e,f){function g(i,j,k,l,m){if(i.offsetWidth===0&&i.offsetHeight===0)return m;var n={};if(i.getAttribute)for(r=0;r<j.length;r++){t=j[r];var o=i.getAttribute(k[t]);if(o){n[t]={};var p=JSON.parse(o);for(var q in l)if(p[q]!==undefined){n[t][q]=true;if(m[t]===undefined)m[t]={};if(m[t][q]===undefined)m[t][q]=[];if(l[q].length>0)m[t][q].push(l[q]);m[t][q].push('('+p[q]);}}}for(var r=0;r<i.childNodes.length;r++){var s=i.childNodes[r];g(s,j,k,l,m);}for(var t in n)for(var u in n[t]){var v=m[t][u][m[t][u].length-1];if(v.length>0&&v.charAt(0)=='('){m[t][u][m[t][u].length-1]=v.substr(1);}else m[t][u].push(')');}return m;}function h(i,j){var k={};for(var l=0;l<j.length;++l)k[j[l]]='data-'+j[l];var m={tn:"","tn-debug":","},n={};g(i,j,k,m,n);for(var o in n)for(var p in n[o])n[o][p]=n[o][p].join('');return n;}e.exports=h;});
__d("StreamViewportTracking",["Arbiter","DOM","NavigationMessage","Run","Style","UIIntentionalStreamMessage","Vector","$","copyProperties","debounce","userAction","collectSubtreeData"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('DOM'),i=b('NavigationMessage'),j=b('Run'),k=b('Style'),l=b('UIIntentionalStreamMessage'),m=b('Vector'),n=b('$'),o=b('copyProperties'),p=b('debounce'),q=b('userAction'),r=b('collectSubtreeData'),s=51,t='vpv';function u(){}o(u.prototype,{init:function(v){o(this,{timeout:900,readStoryIDs:{},minSizeToBeVisible:200,timeoutHandler:null,listeners:[],arbiterSubscriptions:[],recordTNTree:v});this.fireTimer();var w=p(this.fireTimer,this.timeout,this);this.listeners.push(Event.listen(window,'scroll',w));this.listeners.push(Event.listen(window,'resize',w));this.arbiterSubscriptions.push(g.subscribe(l.UPDATE_HTML_CONTENT,w));j.onLeave(this.cleanup.bind(this));this.arbiterSubscriptions.push(g.subscribe(i.NAVIGATION_BEGIN,this.cleanup.bind(this)));},cleanup:function(){this.listeners.forEach(function(v){v.remove();});this.listeners=[];this.arbiterSubscriptions.forEach(function(v){v.unsubscribe();});this.arbiterSubscriptions=[];clearTimeout(this.timeoutHandle);this.timeoutHandle=null;},fireTimer:function(){this.getStoriesInView().forEach(this.markStoryRead.bind(this));},getStoriesInView:function(){var v=h.scry(n('home_stream'),'.uiStreamStory'),w=[],x=false;for(var y=0;y<v.length;y++){var z=v[y],aa=this.getStoryID(z);if(this.hasBeenVisible(aa))continue;if(this.isVisible(z)){w.push(z);x=true;}else if(x)break;}return w;},hasBeenVisible:function(v){return v in this.readStoryIDs;},getStoryID:function(v){var w=JSON.parse(v.getAttribute('data-ft'));return w.mf_story_key;},isVisible:function(v){var w=m.getViewportDimensions(),x=m.getElementPosition(v,'viewport'),y=m.getElementDimensions(v),z=Math.max(x.y,0),aa=Math.min(x.y+y.y,w.y),ba=Math.min(y.y,this.minSizeToBeVisible);return (aa-z)>=ba;},markStoryRead:function(v){var w=this.getStoryID(v);if(!w)return;if(!this.hasBeenVisible(w)){this.readStoryIDs[w]=true;var x={evt:s};if(this.recordTNTree){var y=r(v,['ft']);for(var z in y.ft){x[z+'_tree']=y.ft[z];if(z==='tn-debug')v.setAttribute('tn-debug_subtree',y.ft[z]);}}q(t,v,null,'FORCE',{ft:x});}}});e.exports.init=function(v){(new u()).init(v);};});
(function(){FbdEventLog={log:function(a,b,c,d){if(!a)return;var e=URI('/desktop/eventlog.php'),f=new AsyncSignal(e.toString(),{event:a,category:b||'unknown',payload:c||''});f.setHandler(d).send();}};})();
var ModalMask={_modalMask:null,_depth:0,show:function(){if(!this._modalMask){this._modalMask=$N('div',{id:'modalMaskOverlay'});DOM.appendContent(DOM.getDocumentBodyElement(),this._modalMask);}this._depth++;if(ua.ie()<7)this._modalMask.height=Vector2.getDocumentDimensions().y+'px';},hide:function(){this._depth--;if(!this._depth&&this._modalMask){DOM.remove(this._modalMask);this._modalMask=null;}}};
__d("legacy:Overlay",["Overlay"],function(a,b,c,d){a.Overlay=b('Overlay');},3);
function DownloadDialog(){this.parent.construct(this);return this;}Class.extend(DownloadDialog,'Overlay');copy_properties(DownloadDialog,{POSITIONS:{BOTTOM_LEFT:'bottom_left',TOP_LEFT:'top_left',IE9_BOTTOM:'ie9_bottom'},activeDialogs:{},dismissAll:function(){for(var a in this.POSITIONS)this.hideDialog(this.POSITIONS[a]);},hideDialog:function(a){var b=this.activeDialogs[a];b&&b.hide();this.activeDialogs[a]=null;}});copy_properties(DownloadDialog.prototype,{_cancelHandler:bagofholding,_closeHandler:bagofholding,_width:null,position:DownloadDialog.POSITIONS.BOTTOM_LEFT,init:function(a,b){this.parent.init(a);this.position=b;var c=(DataStore.get(this._root,'modal')==='true');DownloadDialog.hideDialog(b);DownloadDialog.activeDialogs[b]=this;Event.listen(this._root,'click',function(event){if(Parent.byClass(event.getTarget(),'closeButton'))if(this._cancelHandler()!==false)DownloadDialog.hideDialog(this.position);}.bind(this));this.subscribe('show',function(){if(c)ModalMask.show();Arbiter.inform('layer_shown',{type:'DownloadDialog'});}.bind(this));this.subscribe('hide',function(){if(c)ModalMask.hide();Arbiter.inform('layer_hidden',{type:'DownloadDialog'});this._closeHandler();}.bind(this));},setWidth:function(a){this._width=Math.floor(a);return this;},updatePosition:function(){if(this._width)CSS.setStyle(this._overlay,'width',this._width+'px');return true;},setCancelHandler:function(a){this._cancelHandler=a||bagofholding;return this;},setCloseHandler:function(a){this._closeHandler=a||bagofholding;return this;}});
(function(){FbdConversionTracking={logClick:function(a){new AsyncRequest().setURI('/ajax/desktop/log_clicks.php').setData({click_source:a}).setAllowCrossPageTransition(true).setErrorHandler(bagofholding).send();},logConversion:function(a){new AsyncRequest().setURI('/ajax/desktop/log_conversions.php').setData({conversion_action:a}).setAllowCrossPageTransition(true).setErrorHandler(bagofholding).send();}};})();
(function(){var a=1000,b=300*a;FbdInstall={cancelSetup:function(){var c=JSON.stringify({ref:this.ref});FbdEventLog.log('download_canceled','setup',c);FbdConversionTracking.logConversion('download_canceled');},hideMegaphone:function(){if(this.megaphoneId&&this.megaphoneLoc)MegaphoneHelper.hideStory(this.megaphoneId,this.megaphoneLoc,this.elementId,'',null);},init:function(c,d){this.downloadUrl=c;this.ref=d||'unknown';},initInstallWait:function(c,d,e){this.megaphoneId=c;this.megaphoneLoc=d;this.elementId=e;this._waitForInstall(b);},promptDownload:function(c){c=c||this.downloadUrl;if(c){var d=JSON.stringify({ref:this.ref});FbdEventLog.log('download_prompted','setup',d);FbdConversionTracking.logConversion('download_prompted');var e=DOM.create('iframe',{src:c,className:'hidden_elem'});DOM.appendContent(document.body,e);}},_responseHandler:function(c){if(c.payload){this._authToken=c.payload.access_token;this._userId=c.payload.id;}if(this._authToken&&this._userId){this._waitForRunningStart=new Date().getTime();setTimeout(bind(this,this._waitForRunning),a);}},setupPlugin:function(){new AsyncRequest('/ajax/desktop/download').send();this.promptDownload();},updateSidebarLinkVisibility:function(){if(!FbDesktopDetect.isPluginInstalled()){CSS.show($('sidebar-messenger-install-link'));CSS.show($('sidebar-messenger-install-separator'));}},_waitForInstall:function(c){var d=null,e=null,f=JSON.stringify({ref:this.ref});if(FbDesktopDetect.isPluginInstalled()){FbdEventLog.log('install_success','setup',f);FbdConversionTracking.logConversion('install_success');FbDesktopPlugin.recheck();new AsyncRequest("/desktop/fbdesktop2/transfer.php").setMethod("POST").setHandler(bind(this,this._responseHandler)).send();DownloadDialog.dismissAll();this.hideMegaphone();return;}if(c<=0){FbdEventLog.log('install_timeout','setup',f);FbdConversionTracking.logConversion('install_timeout');DownloadDialog.dismissAll();}else setTimeout(bind(this,this._waitForInstall,c-a),a);},_waitForRunning:function(){var c=new Date().getTime()-this._waitForRunningStart;if(FbDesktopPlugin.isAppRunning()){FbDesktopPlugin.transferAuthToken(this._authToken,this._userId);}else if(c<b)setTimeout(bind(this,this._waitForRunning),a);}};})();
function TickerRightHideController(){}TickerRightHideController._markAsClosedHelper=function(a){var b=ge('pagelet_reminders');if(b){var c=DOM.scry(b,'div.tickerToggleWrapper')[0];if(c)CSS.conditionClass(c,'displayedTickerToggleWrapper',a);}var d=ge('pagelet_rhc_ticker');if(d){var e=DOM.scry(d,'div.tickerToggleWrapper')[0];if(e)CSS.conditionClass(e,"displayedTickerToggleWrapper",!a);CSS.conditionClass(d,"hidden_rhc_ticker",a);}};TickerRightHideController.markAsClosed=function(){TickerRightHideController._markAsClosedHelper(true);};TickerRightHideController.markAsUnclosed=function(){TickerRightHideController._markAsClosedHelper(false);};
__d("legacy:SimpleDrag",["SimpleDrag"],function(a,b,c,d){a.SimpleDrag=b('SimpleDrag');},3);
function SidebarTicker(){}copy_properties(SidebarTicker.prototype,{ALMOST_ZERO:1e-07,init:function(){this._ticker=$('pagelet_ticker');this._initSubscriptions();CSS.addClass(document.documentElement,'ticker');if(CSS.hasClass(document.documentElement,'sidebarMode'))this._onSidebarShow();return this;},initResizeBehavior:function(a){var b=this._ticker,c=b.parentNode,d=this._saveResizedState.bind(this),e=this.ALMOST_ZERO,f,g,h,i=function(l,event){f=event.clientY;g=b.offsetHeight;h=c.offsetHeight;},j=function(l,event){var m=g+(event.clientY-f),n=100-(((h-m)/h)*100);n=Math.max(e,Math.min(90,n));b.style.height=n+'%';if(l=='end'){d(n);Arbiter.inform('Ticker/resized');}window.ChatSidebar&&ChatSidebar.resize();},k=new SimpleDrag(a);k.subscribe('start',i);k.subscribe(['update','end'],j);},_saveResizedState:function(a){new AsyncRequest('/ajax/feed/ticker/resize').setData({height:''+a}).setMethod('POST').send();},_initSubscriptions:function(){this._subscriptions=[Arbiter.subscribe('sidebar/show',this._onSidebarShow.bind(this))];},_onSidebarShow:function(){TickerController.show(this._ticker);}});
function FansJewel(){}copy_properties(FansJewel.prototype,{init:function(a){this.jewel=a;this.jewel.subscribe('marked-seen',this._markSeenCallback.shield(this));},_markSeenCallback:function(a,b){new AsyncRequest('/ajax/pages/fans_seen.php').setMethod('POST').send();}});
__d("Messaging",["AsyncRequest","DOM","Emote","Env","HTML","MessagingEvents","URI","createArrayFrom"],function(a,b,c,d,e,f){var g=b('AsyncRequest'),h=b('DOM'),i=b('Emote'),j=b('Env'),k=b('HTML'),l=b('MessagingEvents'),m=b('URI'),n=b('createArrayFrom');function o(q,r){if(!h.isTextNode(q)){var s=n(q.childNodes);for(var t=0;t<s.length;t++)o(s[t],r);return;}var u=q.nodeValue;if(r)u=q.nodeValue.replace(/\n/g,' ');var v=i.htmlEmote(u);if(!v||v==q.nodeValue)return;var w=k(v).getNodes();if(!w||!w.length)return;for(var x=w.length;x--;)h.insertAfter(q,w[x]);h.remove(q);}var p={getUserThreadURI:function(q){return m(j.www_base).setPath('/messages/'+q);},getInboxThreadURI:function(q){return m(j.www_base).setPath('/messages/?action=read&tid='+q);},markAsRead:function(q){q=n(q);new g().setURI('/ajax/messaging/async.php').setData({action:'markRead',tids:q}).setMethod('POST').setHandler(bagofholding).setErrorHandler(bagofholding).send();l.inform('mark-as-read',{tids:q});},markUserThreadAsRead:function(q){new g().setURI('/ajax/messaging/async.php').setData({action:'chatMarkRead',other_user:q}).setMethod('POST').setHandler(bagofholding).setErrorHandler(bagofholding).send();l.inform('mark-as-read',{chat_ids:[q]});},unsubscribeFromThread:function(q){new g().setURI('/ajax/messaging/async.php').setData({action:'unsubscribe',tids:q}).setMethod('POST').setHandler(bagofholding).setErrorHandler(bagofholding).send();},emoteContent:function(q,r){for(var s=0;s<q.length;s++)o(q[s],r);}};e.exports=p;});
__d("legacy:ad-logging",["Arbiter","AsyncRequest","collectDataAttributes"],function(a,b,c,d){var e=b('Arbiter'),f=b('AsyncRequest'),g=b('collectDataAttributes'),h={};function i(l){return (l.getAttribute&&(l.getAttribute('ajaxify')||l.getAttribute('data-endpoint'))||l.action||l.href||l.name);}function j(l,m){if(m.doublelog&&typeof(m.ei)==="string"){new f('/ajax/ssinfeed/end/').setData({doublelog:true,ei:m.ei}).setAllowCrossPageTransition(true).setMethod('POST').send();}else if(l!==null&&typeof(l.ei)==="string"){var n=Date.now(),o=500;l.duplicate_click=!!h[l.ei]&&(n-h[l.ei]<o);h[l.ei]=n;new f('/ajax/ssinfeed/end/').setData(l).setAllowCrossPageTransition(true).setMethod('POST').send();}}function k(l,m){if(!m.node)return;var n=i(m.node);if(!n||!m.event||m.event.type!=='click')return;var o=g(m.node,['ft','ad']);o.ft.href=n;j(o.ft,o.ad);}e.subscribe("UserAction/new",k);},3);
(function(){var a="show",b="install",c="cancel",d="learn_more";FbdPromo={cancelClick:function(){this.hidePromo();this.postPromoAction(c);},hidePromo:function(e){CSS.hide($('gear-balloon-promo'));ChatSidebar.resize();},installClick:function(e){FbdInstall.init(e,'sidebarpromo');FbdInstall.setupPlugin();this.postPromoAction(b);setTimeout(function(){FbdPromo.hidePromo();},3000);},learnMoreClick:function(){this.postPromoAction(d);},postPromoAction:function(e){new AsyncRequest("/ajax/desktop/promo_action.php").setMethod("POST").setData({action:e}).send();FbdConversionTracking.logClick('gear_balloon_promo_'+e);},showPromo:function(){if(FbDesktopDetect.isPluginInstalled())return;CSS.show($('gear-balloon-promo'));if(ChatSidebar.isVisible()){this.postPromoAction(a);}else{var e=true;Arbiter.subscribe('sidebar/show',bind(this,function(){if(e){e=false;this.postPromoAction(a);}}));}}};})();
function HomeAdFirstRightColumnController(){}copy_properties(HomeAdFirstRightColumnController.prototype,{init:function(a){copy_properties(this,{_enableSidebar:a.enableSidebar,_tickerHeightOffset:200,contentCol:$('contentCol'),blueBar:$('blueBar'),_tickerMaxHeight:(a.tickerMaxHeight||500),_listeners:[],_subscriptions:[]});this._topOffset=0;this.PADDING_TICKER_TO_TOP=5;this.PADDING_RHC_TO_BOTTOM=60;this._sidebarIsHidden=true;this._listeners.push(Event.listen(window,'resize',this.handleResize.bind(this)));this._blueBarHeight=Vector2.getElementDimensions(this.blueBar).y;this.reloadRightCol();this._initSubscriptions();onunloadRegister(this.cleanup.bind(this));this._listeners.push(Event.listen(window,'scroll',this._handleScroll.bind(this)));if(!CSS.hasClass(document.documentElement,'sidebarMode')){this._onSidebarHide();}else if(this._enableSidebar)this._onSidebarShow();this.handleResize();},_initSubscriptions:function(){this._subscriptions=[Arbiter.subscribe('Ticker/storiesInserted',this.handleResize.bind(this)),Arbiter.subscribe('concierge/load',this.handleResize.bind(this)),Arbiter.subscribe(UIIntentionalStreamMessage.INSERT_STORIES,this.handleResize.bind(this))];if(this._enableSidebar){this._subscriptions.push(Arbiter.subscribe('sidebar/hide',this._onSidebarHide.bind(this)));this._subscriptions.push(Arbiter.subscribe('sidebar/show',this._onSidebarShow.bind(this)));}},_onNavHandler:function(a,b){var c=b.params.key;if(c!='lf'&&c!='h')this.cleanup();},reloadRightCol:function(){this.fixedScrollingContainer=ge('fixed_scrolling_container');this.fixedScrollingWrapper=DOM.scry(this.fixedScrollingContainer,'.fixed_scrolling_wrapper')[0];this.tickerPagelet=ge('pagelet_rhc_ticker');if(!this.tickerPagelet)return false;this.tickerContainer=DOM.scry(this.tickerPagelet,'.ticker_container')[0];this.tickerStream=DOM.scry(this.tickerPagelet,'.ticker_stream')[0];return this.tickerContainer&&this.tickerStream;},cleanup:function(){this._subscriptions.forEach(Arbiter.unsubscribe);this._subscriptions=[];this._listeners.forEach(function(a){a.remove();});this._listeners=[];},_handleScroll:function(){if(!this._sidebarIsHidden||!this.tickerStream)return;this._topOffset=this.PADDING_TICKER_TO_TOP+this._blueBarHeight;var a=CSS.hasClass(document.documentElement,'tinyViewport'),b=!a;if(b){var c=Vector2.getElementPosition(this.fixedScrollingContainer,'viewport');if(!c||c.y>=this._topOffset)b=false;}if(b!==CSS.hasClass(this.fixedScrollingWrapper,'fixed_elem'))this._setFixedRightCol(b);},_setFixedRightCol:function(a){var b=a?this._topOffset+'px':'';CSS.setStyle(this.fixedScrollingWrapper,'top',b);CSS.conditionClass(this.fixedScrollingWrapper,'fixed_elem',a);var c=a?'Ticker/fixed':'Ticker/unfixed';Arbiter.inform(c);},handleResize:function(){if(!this._sidebarIsHidden||!this.tickerStream||CSS.hasClass(document.documentElement,'tinyViewport'))return;this._handleScroll();var a=Vector2.getViewportDimensions().y,b=Vector2.getElementDimensions(this.fixedScrollingWrapper).y-Vector2.getElementDimensions(this.tickerContainer).y,c=a-this._topOffset-b-this.PADDING_RHC_TO_BOTTOM,d=Vector2.getElementDimensions(this.tickerStream).y,e=Math.min(c,d,this._tickerMaxHeight);CSS.setStyle(this.tickerContainer,'height',e+'px');},_onSidebarHide:function(){this._sidebarIsHidden=true;this.reloadRightCol();var a=function(){if(this.reloadRightCol())this.handleResize();};this.tickerPagelet&&TickerController.show(this.tickerPagelet,a.bind(this));},_onSidebarShow:function(){this._sidebarIsHidden=false;this.reloadRightCol();this._setFixedRightCol(false);this.tickerPagelet&&TickerController.hide(this.tickerPagelet);}});
__d("OptionStorage",["copyProperties"],function(a,b,c,d,e,f){var g=b('copyProperties'),h=window.localStorage||null;function i(j,k,l){this.name=j;this.reviver=k||this._reviver;this.replacer=l||this._replacer;this._read();}g(i.prototype,{_read:function(j,k){if(h&&h[this.name]){this.options=JSON.parse(h[this.name],this.reviver);}else this.options={};},_write:function(){if(h){var j=g({},this.options);h[this.name]=JSON.stringify(j,this.replacer);}},_reviver:function(j,k){if(k){var l=/^\[RegExp (.*)\]$/.test(k)&&RegExp.$1;if(l)k=new RegExp(l.replace(/^\/|\/$/g,''));return k;}},_replacer:function(j,k){if(k instanceof RegExp){k='[RegExp '+k+']';this[j]=k;}return k;},get:function(j,k){return j in this.options?this.options[j]:k;},set:function(j,k){if(k==null){delete this.options[j];}else this.options[j]=k;this._write();}});e.exports=i;});
function UIIntentionalStreamRefresh(a,b){copy_properties(this,{isAutoRefreshing:false,lastRefresh:Date.now()});UIIntentionalStreamRefresh.instance=this;this.setAutoRefreshConfig(a);this.updateConfigHandler=Arbiter.subscribe(UIIntentionalStreamMessage.UPDATE_AUTOREFRESH_CONFIG,this.updateAutoRefreshConfig.bind(this));this.updateRefreshTimeHandler=Arbiter.subscribe(UIIntentionalStreamMessage.UPDATE_LAST_REFRESH_TIME,this.updateLastRefreshTime.bind(this));onleaveRegister(this.unload.bind(this));this.userActivity();this.uaToken=UserActivity.subscribe(this.userActivity.bind(this));this.autoRefreshInterval=setInterval(this.checkAutoPageRefresh.bind(this),this.checkAutoRefreshTimeInterval);this.activeRefreshInterval=setInterval(this.checkActiveRefresh.bind(this),this.checkActiveRefreshTimeInterval);this.enableAutoRefresh(b);Arbiter.subscribe(UIIntentionalStreamMessage.UPDATE_STREAM,LiveTimer.loop.bind(LiveTimer,true));Arbiter.subscribe(UIIntentionalStreamMessage.REFRESH_STREAM,LiveTimer.loop.bind(LiveTimer,true));if(this.usePresence)UIIntentionalStreamRefresh.presenceRegister();}copy_properties(UIIntentionalStreamRefresh,{_presenceInit:false,DISABLE_AUTOREFRESH_TIME:4*60*1000,CHECK_AUTOREFRESH_INTERVAL:5*60*1000,AUTOREFRESH_INACTIVE_TIME:30*60*1000,CHECK_ACTIVE_REFRESH_TIME:5*60*1000,ACTIVE_REFRESH_TIME:30*1000});UIIntentionalStreamRefresh.presenceRegister=function(){if(UIIntentionalStreamRefresh._presenceInit)return true;Arbiter.subscribe(ChannelConstants.getArbiterType('feedpub'),UIIntentionalStreamRefresh.handleNewStoryMessage);UIIntentionalStreamRefresh._presenceInit=true;};UIIntentionalStreamRefresh.prototype.updateAutoRefreshConfig=function(a,b){if(a==UIIntentionalStreamMessage.UPDATE_AUTOREFRESH_CONFIG)this.setAutoRefreshConfig(b);};UIIntentionalStreamRefresh.prototype.updateLastRefreshTime=function(a){if(a==UIIntentionalStreamMessage.UPDATE_LAST_REFRESH_TIME)this.lastRefresh=Date.now();};UIIntentionalStreamRefresh.prototype.setAutoRefreshConfig=function(a){a=a||{};var b=24*60*60*1000;if(!this.storyInterval)this.storyInterval=coalesce(a.story_interval,null);this.allowAutoRefresh=coalesce(a.allow_auto_refresh,false);this.inactiveThreshold=coalesce(a.inactive_threshold,0);this.activeRefreshTime=coalesce(a.fast_refresh_rate,b);this.inactiveRefreshTime=coalesce(a.slow_refresh_rate,b);this.allowPolling=coalesce(a.allow_polling,false);this.refreshFactor=coalesce(a.refresh_factor,10);this.minRefreshInterval=coalesce(a.min_refresh_interval,60*1000);this.usePresence=coalesce(a.use_presence,false);this.activeRefresh=coalesce(a.active_refresh,false);this.checkActiveRefreshTimeInterval=coalesce(a.check_active_refresh_interval,UIIntentionalStreamRefresh.CHECK_ACTIVE_REFRESH_TIME);this.activeRefreshTimeInterval=coalesce(a.active_refresh_interval,UIIntentionalStreamRefresh.ACTIVE_REFRESH_TIME);this.disableAutoRefreshTime=coalesce(a.disable_autorefresh_time,UIIntentionalStreamRefresh.DISABLE_AUTOREFRESH_TIME);this.checkAutoRefreshTimeInterval=coalesce(a.check_autorefresh_time_interval,UIIntentionalStreamRefresh.CHECK_AUTOREFRESH_INTERVAL);this.autoRefreshInactiveTime=coalesce(a.autorefresh_inactive_time,UIIntentionalStreamRefresh.AUTOREFRESH_INACTIVE_TIME);return this;};UIIntentionalStreamRefresh.prototype.unload=function(){this.enableAutoRefresh(false);this.cleanupRefreshInterval();UserActivity.unsubscribe(this.uaToken);this.updateConfigHandler&&this.updateConfigHandler.unsubscribe();this.updateRefreshTimeHandler&&this.updateRefreshTimeHandler.unsubscribe();};UIIntentionalStreamRefresh.prototype.userActivity=function(){var a=this.isInactive();this.lastActivity=Date.now();this.isAutoRefreshing=true;if(a&&this.canAutoRefresh())this.runAutoRefresh();return true;};UIIntentionalStreamRefresh.prototype.isInactive=function(){return this.getMSSinceLastActivity()>this.inactiveThreshold;};UIIntentionalStreamRefresh.prototype.getMSSinceLastActivity=function(){return Date.now()-this.lastActivity;};UIIntentionalStreamRefresh.prototype.getMSSinceLastRefresh=function(){return Date.now()-this.lastRefresh;};UIIntentionalStreamRefresh.prototype.getRefreshInterval=function(){if(this.isInactive()){return this.inactiveRefreshTime;}else if(this.storyInterval!=null){var a=this.storyInterval*this.refreshFactor;return Math.max(a,this.activeRefreshTime);}else return this.activeRefreshTime;};UIIntentionalStreamRefresh.prototype.canAutoRefresh=function(){return this.isAutoRefreshing&&this.allowAutoRefresh;};UIIntentionalStreamRefresh.handleNewStoryMessage=function(a,b){if(a!=ChannelConstants.getArbiterType('feedpub'))return;Arbiter.inform(UIIntentionalStreamMessage.UPDATE_STREAM);};UIIntentionalStreamRefresh.prototype.cancelUpdate=function(){if(this.updateTask){clearTimeout(this.updateTask);this.updateTask=null;}};UIIntentionalStreamRefresh.prototype.runUpdatePoll=function(){this.updateTask=null;if(this.canAutoRefresh())this.runAutoRefresh();};UIIntentionalStreamRefresh.prototype.runAutoRefresh=function(){var a=50;if(this.getMSSinceLastRefresh()>=this.minRefreshInterval-a)Arbiter.inform(UIIntentionalStreamMessage.UPDATE_STREAM);this.schedulePoll(this.getRefreshInterval());};UIIntentionalStreamRefresh.prototype.schedulePoll=function(a){this.cancelUpdate();if(this.allowPolling)this.updateTask=setTimeout(this.runUpdatePoll.bind(this),a);};UIIntentionalStreamRefresh.prototype.enableAutoRefresh=function(a,b){this.isAutoRefreshing=a;if(a){var c=b?0:this.getRefreshInterval();this.schedulePoll(c);}else this.cancelUpdate();};UIIntentionalStreamRefresh.prototype.checkAutoPageRefresh=function(){if(!this.allowAutoRefresh)return;if(this.isAutoRefreshing&&(this.getMSSinceLastActivity()>this.disableAutoRefreshTime))this.isAutoRefreshing=false;if(this.getMSSinceLastRefresh()<this.autoRefreshInactiveTime)return;var a=this.getMSSinceLastActivity();if(a>this.autoRefreshInactiveTime)Arbiter.inform(UIIntentionalStreamMessage.REFRESH_STREAM,{});};UIIntentionalStreamRefresh.prototype.checkActiveRefresh=function(){if(!this.allowAutoRefresh)return;if(this.getMSSinceLastRefresh()<this.activeRefreshTimeInterval)return;if(this.getMSSinceLastActivity()<this.activeRefreshTimeInterval)Arbiter.inform(UIIntentionalStreamMessage.UPDATE_STREAM);};UIIntentionalStreamRefresh.prototype.cleanupRefreshInterval=function(){if(this.autoRefreshInterval){clearInterval(this.autoRefreshInterval);this.autoRefreshInterval=null;}if(this.activeRefreshInterval){clearInterval(this.activeRefreshInterval);this.activeRefreshInterval=null;}};