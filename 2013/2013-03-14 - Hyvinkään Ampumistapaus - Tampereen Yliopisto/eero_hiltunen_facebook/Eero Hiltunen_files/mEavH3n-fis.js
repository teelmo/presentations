/*1337581402,176833975*/

if (window.CavalryLogger) { CavalryLogger.start_js(["MSpNs"]); }

__d("ModalLayer",["event-extensions","CSS","DOMQuery","Style","UserAgent","Vector","copyProperties","debounce"],function(a,b,c,d,e,f){b('event-extensions');var g=b('CSS'),h=b('DOMQuery'),i=b('Style'),j=b('UserAgent'),k=b('Vector'),l=b('copyProperties'),m=b('debounce');function n(q){i.set(q,'height',k.getDocumentDimensions().y+'px');}var o=0;function p(q){this._layer=q;}l(p.prototype,{_subscription:null,_resizeListener:null,enable:function(){this._subscription=this._layer.subscribe(['show','hide'],function(q){q=='show'?this._addModal():this._removeModal();}.bind(this));if(this._layer.isShown())this._addModal();},disable:function(){this._layer.unsubscribe(this._subscription);this._subscription=null;if(this._layer.isShown())this._removeModal();},_addModal:function(){o++;g.addClass(this._layer.getRoot(),'modalWrapper');g.addClass(h.getDocumentBodyElement(),'modalOpen');if(j.ie()<7&&!this._resizeListener){var q=this._layer.getRoot();n(q);this._resizeListener=Event.listen(window,'resize',m(n.shield(null,q)));}},_removeModal:function(){o--;g.removeClass(this._layer.getRoot(),'modalWrapper');g.conditionClass(h.getDocumentBodyElement(),'modalOpen',o!==0);if(this._resizeListener){this._resizeListener.remove();this._resizeListener=null;}}});e.exports=p;});
__d("DialogX",["event-extensions","function-extensions","AccessibleLayer","ArbiterMixin","Class","cx","DOM","Layer","LayerButtons","LayerFormHooks","LayerHideOnCancel","ModalLayer","Parent","Style","UserAgent","Vector","copyProperties","debounce","getOverlayZIndex"],function(a,b,c,d,e,f){b('event-extensions');b('function-extensions');var g=b('AccessibleLayer'),h=b('ArbiterMixin'),i=b('Class'),j=b('cx'),k=b('DOM'),l=b('Layer'),m=b('LayerButtons'),n=b('LayerFormHooks'),o=b('LayerHideOnCancel'),p=b('ModalLayer'),q=b('Parent'),r=b('Style'),s=b('UserAgent'),t=b('Vector'),u=b('copyProperties'),v=b('debounce'),w=b('getOverlayZIndex');function x(z,aa){this.parent.construct(this,z,aa);}i.extend(x,l);u(x,h);u(x.prototype,{_modal:false,_ie:null,_wrapper:null,_configure:function(z,aa){this.parent._configure(z,aa);if(z.modal){this._modal=true;this.enableBehavior(p);}if(z.autohide)var ba=this.subscribe('show',function(){ba.unsubscribe();this.hide.shield(this).defer(z.autohide);}.bind(this));},_getDefaultBehaviors:function(){return this.parent._getDefaultBehaviors().concat([y,g,m,n,o]);},_buildWrapper:function(z,aa){var ba=k.create('div',{className:"cx-uiDialog__content"},aa),ca;this._ie=s.ie();if(this._ie>6&&this._ie<9){ca=[k.create('div',{className:"cx-uiDialog__vertical"}),k.create('div',{className:"cx-uiDialog__horizontal"}),k.create('div',{className:"cx-uiDialog__topLeft"}),k.create('div',{className:"cx-uiDialog__topRight"}),k.create('div',{className:"cx-uiDialog__bottomLeft"}),k.create('div',{className:"cx-uiDialog__bottomRight"}),ba];}else ca=k.create('div',{className:"cx-uiDialog__border"},ba);this._wrapper=k.create('div',{className:"cx-uiDialog__wrapper"},ca);this.setWidth(z.width);var da="cx-uiDialog__positioner";if(z.className)da+=' '+z.className;var ea=k.create('div',{className:da},this._wrapper);if(z.id)ea.id=z.id;return ea;},updatePosition:function(){var z=t.getViewportDimensions().y-t.getElementDimensions(this._wrapper).y,aa;if(z<250){if(z>80){aa=z/2;}else aa=40;}else aa=125;if(!this._modal&&(!this._ie||this._ie<7))if(aa<=40){this.enableBehavior(p);}else this.disableBehavior(p);if(this._ie<7){var ba=t.getScrollPosition().y;r.set(this._wrapper,'top',aa+ba+'px');}else r.set(this._wrapper,'margin-top',aa+'px');if(this._causalElement){var ca=w(this._causalElement,this.getInsertParent());r.set(this.getRoot(),'z-index',ca>200?ca:'');}},setWidth:function(z){z=Math.floor(z);if(this._ie>6&&this._ie<9)z-=20;r.set(this._wrapper,'width',z+'px');}});function y(z){this._layer=z;}u(y.prototype,{_subscription:null,_resize:null,enable:function(){this._subscription=this._layer.subscribe(['show','hide'],function(z){z==='show'?this._attach():this._detach();}.bind(this));},disable:function(){this._layer.unsubscribe(this._subscription);this._subscription=null;this._resize&&this._detach();},_attach:function(){this._layer.updatePosition();this._resize=Event.listen(window,'resize',v(this._layer.updatePosition.bind(this._layer)));},_detach:function(){this._resize.remove();this._resize=null;}});e.exports=x;});
__d("AsyncDialog",["AsyncRequest","copyProperties","CSS","cx","DialogX","DOM","Parent","tx","URI"],function(a,b,c,d,e,f){var g=b('AsyncRequest'),h=b('copyProperties'),i=b('CSS'),j=b('cx'),k=b('DialogX'),l=b('DOM'),m=b('Parent'),n=b('tx'),o=b('URI'),p=new k({width:465,className:"cx-uiDialog__loadingDialog"},l.create('div',{className:"cx-uiDialog__loadingText"},"Ladataan...")),q=1,r=[],s=0;function t(v,w){var x=q++;r[x]=w;h(v.getData(),{__asyncDialog:x});s++;p.show();v.setFinallyHandler(function(y){var z=y.getPayload();if(z&&z.asyncURL)u.send(new g(z.asyncURL));s--;if(!s)p.hide();}).send();}var u={send:function(v,w){t(v,w||bagofholding);},bootstrap:function(v,w,x){var y=m.byClass(w,'stat_elem')||w;if(y&&i.hasClass(y,'async_saving'))return false;var z=new o(v).getQueryData();z.causal_element=w?l.getID(w):null;var aa=x==='dialog',ba=new g().setURI(v).setData(z).setMethod(aa?'GET':'POST').setReadOnly(aa).setRelativeTo(w).setStatusElement(y).setNectarModuleDataSafe(w);u.send(ba);},respond:function(v,w){r[v](w);}};e.exports=u;});
function PhotoAlbumPlacesTypeahead(){}copy_properties(PhotoAlbumPlacesTypeahead.prototype,{init:function(a){if(a.getCore().getHiddenValue()){data={uid:a.getCore().getHiddenValue(),text:a.getCore().getValue()};Arbiter.inform('PhotoAlbumPlacesTypeahead.EXIST_PLACE',data);}a.subscribe('select',function(b,c){Arbiter.inform('PhotoAlbumPlacesTypeahead.SELECTED_PLACE',c.selected);}.bind(this));a.subscribe('reset',function(){if(!a.getCore().getHiddenValue())Arbiter.inform('PhotoAlbumPlacesTypeahead.RESET_PLACE');}.bind(this));}});
function PhotoBulkEditTagger(a){this.parent.construct(this,a);this.editor=a;}Class.extend(PhotoBulkEditTagger,'PhotoTagger');copy_properties(PhotoBulkEditTagger.prototype,{TAG_BOX_SIZE:60,elemNames:{},init:function(a,b,c,d){this._qn=d;this.photoOwner=a;this.tokenizer=c;this.editor.registerTagger(this);this.root=this.editor.getRoot();this.tagger=b;this.hideNewTagTimer=null;this.photoKey=null;this._needTaggingData=true;this.setupHandlers();this._sendWaterfallLogSignal(PhotosTaggingWaterfall.BEGIN);return this;},setupUserActionLogging:function(){return null;},logUserActionEvent:function(a){return null;},saveTag:function(a,b){this.parent.saveTag(a,b);Arbiter.inform('PhotoBulkEditTagger.TAG_SAVED',{editor:this.root,fbid:this.photoData.fbid});},setNeedTaggingData:function(a){this._needTaggingData=a;return this;},needTaggingData:function(){return this._needTaggingData;},setupHandlers:function(){Event.listen(this.root,'click',this.clickHandler.bind(this));this.tokenizer.subscribe(['addToken','removeToken'],this.handleTokenAction.bind(this));this.tokenizer.subscribe('switchTarget',this.switchPhoto.bind(this));Arbiter.subscribe('PhotoBulkEditTagger.DATA_SOURCE_READY',this.useTaggingDataSource.bind(this));},done:function(){this._sendWaterfallLogSignal(PhotosTaggingWaterfall.FINISH);},handleTokenAction:function(a,b){var c=$(this.photoKey),d=DOM.find(c,'.peopleIcon'),e=DOM.find(c,'.editablePhotoTagList'),f=DOM.find(d,'.count'),g=this.tokenizer.getTokens().length;CSS.conditionClass(d,'hasPeople',!!g);CSS.conditionClass(e,'hasPeople',!!g);DOM.setContent(f,g);if(a=='addToken'){this.saveTag(a,b);}else this.removeTag(a,b);},updateWithSuggestions:function(){},useTaggingDataSource:function(a,b){if(!this._needTaggingData)return;var c=this.tokenizer.getTypeahead();c.swapData(b);this.setNeedTaggingData(false);},getTaggerPositioningOrigin:function(){return Vector2.getElementPosition(this.root);},clickHandler:function(event){var a=event.getTarget();if(Parent.byClass(a,'photoTagTypeahead'))return;if(Parent.byClass(a,'photoContextualSelector')||Parent.byClass(a,'removePhotoButton')){this.hideTagger();return;}var b=Parent.byClass(a,'editablePhotoImage');if(!b){var c=Parent.byClass(a,'peopleIcon');if(c){this.setupPhotoDataForTarget(c);this.hideTagger();return;}var d=Parent.byClass(a,'bulkEditTagger');if(d&&this.photoData.fbid&&this.getImageByID(this.photoData.fbid)){b=this.getImageByID(this.photoData.fbid);}else{this.hideTagger();return;}}this.setupPhotoDataForTarget(b);var e=DOM.find(b,'img'),f=Vector2.getEventPosition(event),g=this.calcTaggerPosition(e,f,this.TAG_BOX_SIZE);if(!g)return;this.calcClickPoint(e,f);g.setElementPosition(this.tagger);var h=Parent.byClass(a,'recognitionBox');h&&CSS.hide(h);CSS.hide(DOM.find(b,'.clickToTagMessage'));this._sendWaterfallLogSignal(PhotosTaggingWaterfall.TAG_FACE);this.showTagger();},switchPhoto:function(a,b){var c=ge(b);c&&this.setupPhotoDataForTarget(c);this.hideTagger();},getImageByID:function(a){return ge('editablePhoto_'+a);},setupPhotoDataForTarget:function(a){var b;if(a&&!CSS.hasClass(a,'editablePhoto')){b=Parent.byClass(a,'editablePhoto');}else b=a;if(!b){this.photoKey=null;this.photoData=null;return false;}var c=b.id;if(c===this.photoKey)return;this.photoKey=c;this.photoData=this.editor.getPhotoData(c);this.tokenizer.setTokenarea(DOM.find(b,'div.editablePhotoTagList'));},getPosition:function(){return this.photoData.fbid;},tagsChangeHandler:function(a){},removeTagByID:function(a,b,c){this.hideTagger();this.setupPhotoDataForTarget(this.getImageByID(a));this.parent.removeTagByID(a,b,c);}});
var PhotosBulkBackdateEditor=(function(){return {setup:function(a,b){b.setContext(a);Event.listen(a,'click',function(){b.show();});var c=DOM.find(b.getContent(),"^.photosBulkDatePicker .saveBackdatedTime");Event.listen(c,'click',function(){var d=Form.serialize(b.getContent()).backdated_date,e=DOM.scry(b.getContent(),'#hide_from_newsfeed'),f=e&&e.length>0&&e[0].checked;Arbiter.inform('PhotosBulkBackdateEditor.SAVED',{context:a,backdatedDate:d,hideFromNewsfeed:f});b.hide();});}};})();
__d("PhotoBulkEditTokenizer",["event-extensions","Class","DOM","Input","Parent","Tokenizer","UserAgent","copyProperties","getObjectValues"],function(a,b,c,d,e,f){b('event-extensions');var g=b('Class'),h=b('DOM'),i=b('Input'),j=b('Parent'),k=b('Tokenizer'),l=b('UserAgent'),m=b('copyProperties'),n=b('getObjectValues');function o(p,q){this.parent.construct(this,p,q);}g.extend(o,k);m(o.prototype,{init:function(p,q,r,s){this._tokenareaListeners={};this.parent.init(p,q,r,s);this.inform('initialized');},initEvents:function(){var p=l.firefox()<4?'keypress':'keydown';Event.listen(this.input,'paste',this.paste.bind(this));Event.listen(this.input,p,this.keydown.bind(this));},setTokenarea:function(p){this.tokenarea=p;this.addTokenareaListener(p);this.reset();},addTokenareaListener:function(p){if(this._tokenareaListeners[p.id])return;var q=this.handleEvents.bind(this);this._tokenareaListeners[p.id]=n(Event.listen(p,{click:q,keydown:q}));},handleEvents:function(event){var p=j.byClass(event.getTarget(),'editablePhotoTagList');if(!p){return;}else if(this.tokenarea!==p){this.setTokenarea(p);this.inform('switchTarget',this.tokenarea.id);}return this.parent.handleEvents(event);},reset:function(){var p=this.getTokenElements().map(function(q){return {uid:h.scry(q,'input')[0].value,text:h.scry(q,'input')[1].value};});i.reset(this.input);return this.parent.reset(p);},updateTokenareaVisibility:function(){return null;},insertToken:function(p){h.prependContent(this.tokenarea,p.getElement());}});e.exports=o;});
__d("legacy:AsyncDialog",["AsyncDialog"],function(a,b,c,d){a.AsyncDialog=b('AsyncDialog');},3);
function PhotosBulkEditablePhoto(){}copy_properties(PhotosBulkEditablePhoto.prototype,{init:function(a,b,c,d){this._root=a;this._mentionsTypeahead=b;this._placesTypeahead=c;this._photoData=d;this._hasOwnPlaceValue=!!c.getCore().getHiddenValue();var e=DOM.find(a,'.placesInput'),f=DOM.find(a,'.captionTextarea');this._metadataInputs=DOM.find(a,'.metadataInputs');this._photoDataKey=this._root.id;this._listeners=[Event.listen(a,'click',this._handleClick.bind(this)),Event.listen(e,'focus',this._placesFocus.bind(this)),Event.listen(f,'focus',this._captionFocus.bind(this)),Event.listen(f,'blur',this._save.bind(this)),Event.listen(a,'submit',function(){return false;})];var g=DOM.scry(a,'.photoContextualSelector')[0];if(g){var h=DOM.scry(g,'.moveAlbum')[0];h&&this._listeners.push(Event.listen(h,'click',this._move.bind(this)));}else{var i=DOM.find(a,'.removePhotoButton');this._listeners.push(Event.listen(i,'click',this.remove.bind(this)));}this._placesDataListener=[c.subscribe(['select','reset','render'],function(j,k){if(j=='render'){CSS.addClass(this._root,'focusedInput');return;}if(j=='reset'&&c.getCore().getHiddenValue())return;this._hasOwnPlaceValue=j=='select';CSS.conditionClass(DOM.find(a,'.placeIcon'),'hasPlace',this._hasOwnPlaceValue);CSS.removeClass(this._root,'focusedInput');this._save();}.bind(this))];this._placesInputBlurListener=c.getCore().subscribe('blur',function(j,k){CSS.removeClass(this._root,'focusedInput');}.bind(this));Arbiter.inform('PhotosBulkEditablePhoto.INITIALIZED',this);},getPhotoDataKey:function(){return this._photoDataKey;},getPhotoData:function(){return this._photoData;},getRoot:function(){return this._root;},swapData:function(a,b){var c=this._mentionsTypeahead.getData(),d=this._placesTypeahead.getData();if(c!==a)this._mentionsTypeahead.swapData(a);if(d!==b){var e=this._placesTypeahead.getCore().getValue(),f=this._placesTypeahead.getCore().getHiddenValue();this._placesTypeahead.swapData(b);if(this.hasOwnPlaceValue())this._placesTypeahead.getCore().select({text:e,uid:f});}},hasOwnPlaceValue:function(){return this._hasOwnPlaceValue;},setAlbumPlace:function(a){this._hasOwnPlaceValue=false;var b=this._placesTypeahead.getCore();CSS.conditionClass(DOM.find(this._root,'.placeIcon'),'hasPlace',!!a);if(a){b.select(a);this._save();}else b.reset();},addPlaceSelectHandler:function(a){this._placesDataListener.push(this._placesTypeahead.subscribe('select',a));},_doRemove:function(){this._listeners.forEach(function(a){a.remove();});this._listeners=[];this._placesDataListener.forEach(function(a){this._placesTypeahead.unsubscribe(a);}.bind(this));this._placesTypeahead.getCore().unsubscribe(this._placesInputBlurListener);DOM.remove(this._root);Arbiter.inform('PhotosBulkEditablePhoto.REMOVED',this);},_handleClick:function(a){var b=a.getTarget();if(Parent.byClass(b,'confirmPhotoBackdate')){this._saveDate();return;}if(!Parent.byClass(b,'metaIcon'))return;CSS.addClass(this._root,'showControls');if(Parent.byClass(b,'placeIcon')){this._showMetadataInput('place');Input.focus(this._placesTypeahead.getCore().getElement());}else if(Parent.byClass(b,'dateIcon')){this._showMetadataInput('date');}else if(Parent.byClass(b,'peopleIcon')){this._showMetadataInput('people');}else CSS.removeClass(this._root,'showControls');},hideMetadataInputs:function(){this._showMetadataInput();},_showMetadataInput:function(a){['people','date','place'].forEach(function(b){CSS.conditionClass(this._metadataInputs,b,a==b);}.bind(this));},_captionFocus:function(a){this.hideMetadataInputs();CSS.addClass(this._root,'focusedInput');},remove:function(){var a={fbid:this._photoData.fbid,version:PhotosConst.BULK_EDITOR,confirmed:true};new Dialog().setTitle("Poista kuva").setBody("Haluatko varmasti poistaa t\u00e4m\u00e4n kuvan?").setButtons(Dialog.OK_AND_CANCEL).setModal(true).setHandler(function(){CSS.addClass(this._root,'editablePhotoWillBeRemoved');new AsyncRequest().setURI('/ajax/photos/photo/delete/dialog.php').setData(a).setHandler(function(b){if(b.getPayload().success){this._doRemove();}else CSS.removeClass(this._root,'editablePhotoWillBeRemoved');}.bind(this)).setErrorHandler(function(b){CSS.removeClass(this._root,'editablePhotoWillBeRemoved');AsyncResponse.defaultErrorHandler(b);}.bind(this)).send();}.bind(this)).show();},_move:function(){var a={aid:this._photoData.aid,datakey:this._photoDataKey,fbid:this._photoData.fbid,owner:this._photoData.owner,pid:this._photoData.pid},b=new AsyncRequest().setURI('/ajax/photos/photo/move/dialog.php').setData(a).setAllowCrossPageTransition(false);AsyncDialog.send(b);},_timeclose:function(a,b){a=a||0;b=b||0;return Math.abs(a-b)<43200;},_locationclose:function(a,b,c,d){a=a||0;b=b||0;c=c||0;d=d||0;return (Math.abs(a-c)<1e-05)&&(Math.abs(b-d)<1e-05);},_placesFocus:function(a){CSS.addClass(this._root,'focusedInput');var b=DOM.scry(this._root,'input.latitude')[0],c=DOM.scry(this._root,'input.longitude')[0],d=DOM.scry(this._root,'input.takentime')[0],e=d?Input.getValue(d):null,f=this._placesTypeahead.getData(),g=f.getBootstrapData();if(b&&c){queryData={latitude:Input.getValue(b),longitude:Input.getValue(c),proximity_boost:'true',city_id:null,search_time:e};f.setQueryData(queryData,false);if(!this._locationclose(g.latitude,g.longitude,queryData.latitude,queryData.longitude)||!this._timeclose(g.search_time,queryData.search_time))f.setBootstrapData(queryData,false).setBootstrapEndpoint(f.getQueryEndpoint());}else{queryData={latitude:null,longitude:null,proximity_boost:null,city_id:null,search_time:e};f.setQueryData(queryData,false);if(!this._locationclose(g.latitude,g.longitude,queryData.latitude,queryData.longitude)||!this._timeclose(g.search_time,queryData.search_time))f.setBootstrapData(queryData,false).resetBootstrapEndpoint();}},_saveDate:function(){var a=DOM.find(this._root,'div.backdateInput'),b=Form.serialize(a);b.fbid=this._photoData.fbid;b.version=PhotosConst.BULK_EDITOR;CSS.addClass(a,'backdating');new AsyncRequest().setURI('/ajax/photos/photo/backdate/').setData(b).setRelativeTo(this._root).send();},_save:function(){CSS.removeClass(this._root,'focusedInput');new AsyncRequest().setURI('/ajax/photos/metadata/save/').setData(Form.serialize(this._root)).setAllowCrossPageTransition(true).send();}});
function PhotosBulkEditablePhotoPlaceholder(){}copy_properties(PhotosBulkEditablePhotoPlaceholder.prototype,{init:function(a,b){this._root=a;this._progressBar=b;},getProgressBar:function(){return this._progressBar;},getRoot:function(){return this._root;},setStatus:function(a){var b=DOM.find(this._root,'.editablePhotoPlaceholderStatus');DOM.setContent(b,a);},hide:function(){CSS.hide(this._root);},show:function(){CSS.show(this._root);}});
function PhotosBulkEditor(a){this.source=a;}copy_properties(PhotosBulkEditor.prototype,{init:function(a,b,c,d,e){PhotosBulkEditor.instance=this;this._root=a;this._photos={};this._tagger=null;this._placeholder=d;this._waitingTemplate=e;this._mentionsData=b;this._placesData=c;this._albumPlace=null;this._albumCoverListeners={};this._initSorting();var f=this._setPlace.bind(this),g=[Arbiter.subscribe('PhotosBulkEditablePhoto.INITIALIZED',this._registerPhoto.bind(this)),Arbiter.subscribe('PhotosBulkEditablePhoto.REMOVED',function(i,j){delete this._photos[j.getPhotoDataKey()];}.bind(this)),Arbiter.subscribe('PhotoAlbumPlacesTypeahead.SELECTED_PLACE',f),Arbiter.subscribe('PhotoAlbumPlacesTypeahead.EXIST_PLACE',f),Arbiter.subscribe('PhotoAlbumPlacesTypeahead.RESET_PLACE',f),Arbiter.subscribe('PhotosBulkEditablePhoto.MOVED',function(i,j){if(this.getPhotoData(j))this._photos[j]._doRemove();}.bind(this))],h=Selector.subscribe('select',function(i,j){var k=CSS.hasClass(j.option,'removePhoto'),l=CSS.hasClass(j.option,'albumCover');if(!k&&!l)return;var m=(DOM.find(j.option,'.photo_id')).value;if(!this._photos[m])return;var n=this._photos[m];if(k){n.remove();}else this._makeAlbumCover(n);Selector.toggle.bind(Selector,j.selector).defer(200);return false;}.bind(this));Event.listen(a,'click',function(i){var j=Parent.byClass(i.getTarget(),'editablePhoto'),k=this._photos;DOM.scry(a,'.showControls').forEach(function(l){if(j!==l){CSS.removeClass(l,'showControls');k[l.id].hideMetadataInputs();}});}.bind(this));PageTransitions.registerHandler(function(){g.forEach(function(i){i.unsubscribe();});h.unsubscribe;if(this._tagger)this._tagger.done();}.bind(this));},getRoot:function(){return this._root;},getSourceString:function(){if(this.source===PhotosConst.BULK_EDITOR){return 'bulk_editor';}else if(this.source===PhotosConst.FLASH_UPLOADER){return 'flash_uploader';}else return null;},getVersionConst:function(){return this.source;},registerTagger:function(a){this._tagger=a;},needTaggingData:function(){return this._tagger&&this._tagger.needTaggingData();},getPhotoData:function(a){var b=this._photos[a];if(b)return b.getPhotoData();return {};},getPlaceholder:function(){return this._placeholder;},getWaitingTemplate:function(){return this._waitingTemplate;},_registerPhoto:function(event,a){this._photos[a.getPhotoDataKey()]=a;var b=a.getPhotoData(),c=b.type==='group'?b.fbid:b.pid;this._sortableGroup.addSortable(c,a.getRoot());a.swapData(this._mentionsData,this._placesData);a.addPlaceSelectHandler(function(){this._sortableGroup.forceDrop(c);}.bind(this));if(this._albumPlace&&!a.hasOwnPlaceValue())a.setAlbumPlace(this._albumPlace);},_initSorting:function(){this._sortableGroup=new SortableGroup().setDropCallback(function(a,b){var c=this._photos[b.id].getPhotoData(),d={order:this._sortableGroup.getOrder(),owner:c.owner},e;if(c.type==='group'){d.set=c.set;e='/ajax/photos/sets/static/reorder.php';}else{d.aid=c.aid;e='/ajax/photos/reorder.php';}new AsyncRequest(e).setData(d).send();}.bind(this));},_setPlace:function(event,a){this._albumPlace=a||null;var b;for(var c in this._photos){b=this._photos[c];b.hasOwnPlaceValue()||b.setAlbumPlace(this._albumPlace);}},_showAlbumCoverSet:function(a){if(this._albumCover)CSS.removeClass(this._albumCover,"checked");var b=DOM.find(a.getRoot(),'.albumCover');CSS.addClass(b,"checked");this._albumCover=b;},_makeAlbumCover:function(a){new AsyncRequest().setURI('/ajax/photos/album/setcover').setData(a.getPhotoData()).setHandler(function(b){if(b.getPayload().success)this._showAlbumCoverSet(a);}.bind(this)).send();}});
__d("PhotosBulkHeader",["copyProperties","event-extensions","Arbiter","AsyncRequest","Form","DOM","goURI"],function(a,b,c,d,e,f){var g=b('copyProperties');b('event-extensions');var h=b('Arbiter'),i=b('AsyncRequest'),j=b('Form'),k=b('DOM'),l=b('goURI');function m(n,o,p){this._form=n;this._isAlbum=o;this._editable=p;this._backdatedTime=null;h.subscribe('PhotosBulkBackdateEditor.SAVED',function(q,r){if(!k.contains(this._form.getRoot(),r.context))return;this._backdatedTime=r.backdatedDate;this.save(bagofholding);}.bind(this));}g(m.prototype,{save:function(n){if(!this._editable)return n.call();var o=this._isAlbum?'/ajax/photos/album/edit':'/ajax/photos/sets/edit',p=j.serialize(this._form.getRoot());if(this._backdatedTime)p.backdated_time=this._backdatedTime;new i(o).setData(p).setMethod('POST').setHandler(n).send();}});g(m,{doneButtonSaveHandler:function(n,o){var p=n.save.bind(n,function(){l(o);return true;}),q=k.find(n._form.getRoot(),".uiButtonConfirm");n._listeners=[Event.listen(q,'click',p)];}});e.exports=m;});
__d("PlacesDataSource",["Class","DataSource","copyProperties"],function(a,b,c,d,e,f){var g=b('Class'),h=b('DataSource'),i=b('copyProperties');function j(k){this.parent.construct(this,k);this._origBootstrapEndpoint=this.bootstrapEndpoint;}g.extend(j,h);i(j.prototype,{mergeUids:function(k,l,m,n){if(this.queryData.new_js_ranking){this._checkExtendedMatch(n,k);return this.deduplicateByKey(k.concat(m,l));}else return this.parent.mergeUids(k,l,m,n);},resetBootstrapEndpoint:function(){this.setBootstrapEndpoint(this._origBootstrapEndpoint);return this;},setBootstrapEndpoint:function(k){if(this.bootstrapEndpoint!==k){this.bootstrapEndpoint=k;if(this._bootstrapped||this._bootstrapping)this.dirty().bootstrap();}return this;},getQueryEndpoint:function(){return this.queryEndpoint;},getBootstrapData:function(){return this.bootstrapData;}});e.exports=j;});
__d("legacy:photos-tagging-waterfall",["PhotosTaggingWaterfall"],function(a,b,c,d){a.PhotosTaggingWaterfall=b('PhotosTaggingWaterfall');},3);
__d("PlacesTypeaheadCore",["Arbiter","Class","CSS","Input","Run","StickyPlaceholderInput","Style","TypeaheadCore","UserAgent","copyProperties"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('Class'),i=b('CSS'),j=b('Input'),k=b('Run'),l=b('StickyPlaceholderInput'),m=b('Style'),n=b('TypeaheadCore'),o=b('UserAgent'),p=b('copyProperties');function q(r){this.parent.construct(this,r);}h.extend(q,n);p(q.prototype,{resetOnKeyup:false,init:function(r,s,t){this.parent.init(r,s,t);if(o.ie()<7)r.setMaxResults(5);this.arbiterToken=g.subscribe('Places/PlaceCreationCancel'+this.callbackID,function(u,v){this.view.allowPlaceCreation=false;this.view.allowFreeformOption=true;this.view.reset();this.focusElement();}.bind(this));k.onLeave(function(){this.arbiterToken.unsubscribe();}.bind(this));this._typeaheadID=t.id;this._citySet=false;this.data.subscribe('fetchComplete',this.update.bind(this));},initToggle:function(){var r=this.root.parentNode,s=m.get(r,'position')!='static'?r:this.root,t=this.view,u='PlacesTypeaheadFocused';this.subscribe('focus',function(){t.show();i.addClass(s,u);});this.subscribe('blur',function(){t.hide();i.removeClass(s,u);});},focusElement:function(){j.focus(this.element);this.value='';this.checkValue();},setLatLong:function(r){this._lat=r.coords.latitude;this._lon=r.coords.longitude;this.updateDataSource(true);},setValue:function(r){this.parent.setValue(r);l.update(this.element);},updateDataSource:function(r){this.data.setQueryData({latitude:this._lat,longitude:this._lon,city_id:this._cityId,city_set:this._citySet});this.data.setBootstrapData({city_id:this._cityId});if(r){this.data.dirty();this.data.bootstrap();}},setCity:function(r,s,t){this._citySet=t;if(this._cityId!==r){this._cityId=r;this.updateDataSource(t);}},update:function(r,s){var t=s.response;if(!t)return;var u=t.getPayload();if(u.cityId)if(!this._citySet)this.setCity(u.cityId,u.cityName,false);}});e.exports=q;});
var PlacesTypeaheadBehavior={init:function(a,b){a.subscribe(['reset','select','highlight'],function(c,d){if(c==='highlight'&&d.index!==-1&&d.selected.type!='freeform'&&d.selected.map&&!d.selected.changeCity){DOM.setContent(b,d.selected.map);CSS.show(b);}else CSS.hide(b);});}};
__d("PlacesTypeaheadView",["Arbiter","Class","copyProperties","CSS","Dialog","DOM","Parent","Run","ScrollableArea","tx","TypeaheadView"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('Class'),i=b('copyProperties'),j=b('CSS'),k=b('Dialog'),l=b('DOM'),m=b('Parent'),n=b('Run'),o=b('ScrollableArea'),p=b('tx'),q=b('TypeaheadView');function r(s,t){this.parent.construct(this,s,t);}h.extend(r,q);i(r.prototype,{ignoreNextMouseover:false,init:function(){this.content=l.find(this.element,'div.PlacesTypeaheadViewList');this.parent.init();this.subscribe(['render','reset'],this.renderBorders.bind(this));this.arbiterToken=g.subscribe('Places/PlaceCreated'+this.callbackID,function(s,t){var u={text:t.name,rawtext:t.name,uid:t.fbid,city_id:t.city_id,city_name:t.city_name,city_page_id:t.city_page_id};this.inform('select',{index:-1,clicked:true,selected:u});this.inform('afterSelect');}.bind(this));n.onLeave(function(){this.arbiterToken.unsubscribe();}.bind(this));},renderBorders:function(){j.conditionClass(this.element,'PlacesTypeaheadViewPopulated',this.items.length);},render:function(s,t,u){t.forEach(function(y){y.value=s;});if(this.allowFreeformOption&&s&&(!t||t.length===0||t[t.length-1].type!='freeform')){var v=p._("Valitse {custom_location}",{custom_location:s});t.push({uid:'0',rawtext:s,text:v,type:'freeform'});}if(this.allowPlaceCreation&&s&&(!t||t.length===0||t[t.length-1].type!='placecreate')){var w=p._("Lis\u00e4\u00e4 paikka {custom_location}",{custom_location:s});t.push({uid:'0',rawtext:s,text:w,type:'placecreate'});}this.parent.render(s,t,u);var x=o.getInstance(this.content);x&&x.adjustGripper();},select:function(s){var t=this.index,u=this.results[t];if(u){if(u.type==='freeform')u.text=u.rawtext;if(u.type==='placecreate'){k.bootstrap('/ajax/places/create/dialog.php',{name:u.rawtext,callback_id:this.callbackID});}else{this.inform('select',{index:t,clicked:!!s,selected:u});this.inform('afterSelect');}}},next:function(){this.parent.next();this._scrollIntoView(this.selected);},prev:function(){this.parent.prev();this._scrollIntoView(this.selected);},_scrollIntoView:function(s){if(!m.byClass(s,'uiScrollableArea'))return;this.ignoreNextMouseover=true;var t=m.byClass(s,'uiScrollableAreaWrap'),u=s.offsetTop-t.offsetTop;if(u<t.scrollTop){t.scrollTop=u;return;}var v=u+s.offsetHeight;if(v>t.scrollTop+t.offsetHeight)t.scrollTop=v-t.offsetHeight;},mouseover:function(event){this.ignoreNextMouseover||this.parent.mouseover(event);this.ignoreNextMouseover=false;},highlight:function(s){this.parent.highlight(s,true);}});e.exports=r;});
__d("ProgressiveDatepicker",["event-extensions","Arbiter","ArbiterMixin","Class","CSS","DataStore","DOM","Parent","copyProperties"],function(a,b,c,d,e,f){b('event-extensions');var g=b('Arbiter'),h=b('ArbiterMixin'),i=b('Class'),j=b('CSS'),k=b('DataStore'),l=b('DOM'),m=b('Parent'),n=b('copyProperties');function o(){}n(o,{PERIODS:['year','month','day','hour','minute'],getInstance:function(p){return k.get(p,'datepicker');}});n(o.prototype,h,{init:function(p,q){this._root=p;this._savedLabels={};this._menus={};this._mintime=q.mintime&&new Date(1000*q.mintime);this._maxtime=q.maxtime&&new Date(1000*q.maxtime);k.set(p,'datepicker',this);l.scry(p,'select').forEach(function(r){Event.listen(r,'change',this._handleChange.shield(this,r));var s=m.byClass(r,'period');Event.listen(r,'focus',j.addClass.curry(s,'periodFocus'));Event.listen(r,'blur',j.removeClass.curry(s,'periodFocus'));this._setMenuSelectionState(r);if(r.getAttribute('data-name')==='month')this._updateDaysInMonth();}.bind(this));l.scry(p,'a.periodLabel').forEach(function(r){var s=m.byClass(r,'period');Event.listen(r,'click',function(){j.addClass(s,'periodSelected');j.addClass(s,'periodFocus');});});this.inform('initialized',this,g.BEHAVIOR_STATE);},setDate:function(p,q,r,s,t){var u=o.PERIODS;for(var v=0;v<u.length;v++)this._setValueForPeriod(u[v],arguments[v]);this._resetIfBeyondRange('year');this._updateDaysInMonth();},setDateWithTimestamp:function(p){var q=new Date(p);this.setDate(q.getFullYear(),q.getMonth()+1,q.getDate(),q.getHours(),q.getMinutes());},isSet:function(){var p=o.PERIODS;for(var q=0;q<p.length;q++)if(this._getValueForPeriod(p[q]))return true;return false;},getRoot:function(){return this._root;},getValues:function(){var p=o.PERIODS,q={};for(var r=0;r<p.length;r++){var s=this._getValueForPeriod(p[r]);if(s)q[p[r]]=s;}return q;},getDate:function(){var p=this.getValues();return new Date(p.year||0,(p.month||1)-1,p.day||1,p.hour||0,p.minute||0);},getTimestamp:function(){return Math.round(this.getDate().getTime()/1000);},_setValueForPeriod:function(p,q){var r=this._menuForPeriodName(p);if(!r)return;if(q===undefined)q='';var s=r.options;for(var t=0,u=s.length;t<u;t++)if(s[t].value==q){r.selectedIndex=t;break;}this._setMenuSelectionState(r);},_getValueForPeriod:function(p){var q=this._menuForPeriodName(p);return (q&&q.options[q.selectedIndex].value);},_handleChange:function(p){this._setMenuSelectionState(p);this._resetIfBeyondRange(p.getAttribute('data-name'));this._updateDaysInMonth();this.inform('changed');},_setMenuSelectionState:function(p){var q=m.byClass(p,'period');if(!q)return;if(j.hasClass(q,'periodRequired')){if(p.selectedIndex===0)p.selectedIndex=1;}else this._updateLabel(p);var r=p.getAttribute('data-name'),s=p.options[p.selectedIndex].value;j.conditionClass(q,'periodSelected',s);j.conditionClass(this._root,this._selectedClass(r),s);if(!s)this._resetMenu(o.PERIODS.indexOf(r)+1);},_resetIfBeyondRange:function(p){var q=false,r=this.getValues(),s;if(this._maxtime){s=this.getDate();q=s>this._maxtime;}if(!q&&this._mintime){var t=r.year||9001,u=(r.month||12)-1,v=new Date(t,u,0).getDate();s=new Date(t,u,r.day||v,r.hour||23,r.minute||0);q=s<this._mintime;}if(q)this._resetMenu(o.PERIODS.indexOf(p));},_updateDaysInMonth:function(){var p=this._menuForPeriodName('day');if(!p)return;if(this._savedDays){while(this._savedDays.length)l.appendContent(p,this._savedDays.shift());}else this._savedDays=[];var q=p.options.length,r=this._daysInMonth()+1,s;while((s=p.options[r])&&(s.value<q)){s.selected=false;l.remove(s);this._savedDays.push(s);}this._setMenuSelectionState(p);},_updateLabel:function(p){var q=p.getAttribute('data-name'),r=p.options[0];if(!this._savedLabels[q])this._savedLabels[q]=l.getText(r);if(p.selectedIndex===0){l.setContent(r,this._savedLabels[q]);}else l.setContent(r,'--');},_daysInMonth:function(){return new Date(this._getValueForPeriod('year')||1999,this._getValueForPeriod('month')||1,0).getDate();},_menuForPeriodName:function(p){if(!this._menus[p])this._menus[p]=l.scry(this._root,'.'+p+'Menu')[0];return this._menus[p];},_selectedClass:function(p){return 'uiProgressiveDatepickerSelected-'+p;},_resetMenu:function(p){var q=o.PERIODS;for(;p<q.length;p++){var r=q[p],s=this._menuForPeriodName(r);if(!s)return;if(m.byClass(s,'periodRequired')){s.selectedIndex=1;}else{j.removeClass(m.byClass(s,'period'),'periodSelected');j.removeClass(this._root,this._selectedClass(r));s.selectedIndex=0;this._updateLabel(s);}}}});e.exports=o;});
__d("legacy:ProgressiveDatepicker",["ProgressiveDatepicker"],function(a,b,c,d){a.ProgressiveDatepicker=b('ProgressiveDatepicker');},3);
__d("TypeaheadShowResultsOnFocus",["event-extensions","copyProperties","Keys"],function(a,b,c,d,e,f){b('event-extensions');var g=b('copyProperties'),h=b('Keys');function i(j){this._typeahead=j;}g(i.prototype,{_subscription:null,_keyUpListener:null,_focusListener:null,enable:function(){var j=this._typeahead.getCore(),k=this._typeahead.getData();j.resetOnKeyup=false;function l(){if(!j.getValue()){var m=Object.keys(k.getAllEntries());j.setValue('');var n=k.buildUids(' ',m);k.respond('',n);}}this._subscription=this._typeahead.subscribe('bootstrap',function(m,n){!n.bootstrapping&&l();});this._keyUpListener=Event.listen(j.getElement(),'keyup',function(event){if(Event.getKeyCode(event)==h.BACKSPACE)l();});this._focusListener=Event.listen(j.getElement(),'focus',function(event){l();});},disable:function(){this._typeahead.unsubscribe(this._subscription);this._subscription=null;this._keyUpListener.remove();this._keyUpListener=null;this._focusListener.remove();this._focusListener=null;}});e.exports=i;});
__d("legacy:ShowResultsOnFocusTypeaheadBehavior",["TypeaheadShowResultsOnFocus"],function(a,b,c,d){var e=b('TypeaheadShowResultsOnFocus');if(!a.TypeaheadBehaviors)a.TypeaheadBehaviors={};a.TypeaheadBehaviors.showResultsOnFocus=function(f){f.enableBehavior(e);};},3);
var PlaceTypeaheadButton={toggleButton:function(a,b){CSS.addClass(a,'uiButtonDisabled');b.getView().subscribe('select',CSS.removeClass.curry(a,'uiButtonDisabled'));b.getView().subscribe('select',CSS.removeClass.curry(a,'hidden_elem'));b.getCore().subscribe('unselect',CSS.addClass.curry(a,'uiButtonDisabled'));}};