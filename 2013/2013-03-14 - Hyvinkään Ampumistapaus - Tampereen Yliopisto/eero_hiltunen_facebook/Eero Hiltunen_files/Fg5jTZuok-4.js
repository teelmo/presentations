/*1337576418,169775814*/

if (window.CavalryLogger) { CavalryLogger.start_js(["d6TCR"]); }

__d("legacy:DynamicFriendListEducation",["DynamicFriendListEducation"],function(a,b,c,d){a.DynamicFriendListEducation=b('DynamicFriendListEducation');},3);
__d("FriendListMenu",["event-extensions","Arbiter","AsyncRequest","CSS","DOM","HTML","Input","Keys","Menu","Parent"],function(a,b,c,d,e,f){b('event-extensions');var g=b('Arbiter'),h=b('AsyncRequest'),i=b('CSS'),j=b('DOM'),k=b('HTML'),l=b('Input'),m=b('Keys'),n=b('Menu'),o=b('Parent'),p={init:function(q){n.register(q,false);var r=j.find(q,'.FriendListCreateTrigger'),s=j.find(q,'.CreateListInputItem'),t=j.find(s,'.createListInput');n.subscribe('select',function(u,v){if(v.item==r){i.addClass(q,'FriendListMenuCreate');l.focus(t);}});Event.listen(t,'blur',function(u){if(l.isEmpty(t))i.removeClass(q,'FriendListMenuCreate');});Event.listen(t,'keydown',function(u){if(Event.getKeyCode(u)==m.RETURN&&/[^\s]/.test(t.value))new h().setURI('/ajax/friends/lists/create.php').setData({name:t.value,id:q.id}).setHandler(function(){l.reset(t);i.removeClass(q,'FriendListMenuCreate');}).send();});g.subscribe('friend-list/new',function(u,v){var w=k(v.new_li).getRootNode();j.insertBefore(r,w);var x=j.find(w,'input');if(v.id===q.id){n.focusItem(w);n.inform('select',{menu:o.byClass(w,'uiMenu'),item:w});}else n.toggleItem(w);});}};e.exports=p;});
__d("legacy:FriendListMenu",["FriendListMenu"],function(a,b,c,d){a.FriendListMenu=b('FriendListMenu');},3);
__d("RestrictedFriendListEducation",["Arbiter","AsyncRequest"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('AsyncRequest'),i,j;function k(m,n){if(n.flid==i)if(m=='FriendListHovercard/add'){if(j)return;j=true;new h().setURI('/ajax/friends/lists/restricted_edu.php').setData({target:n.uid,flid:n.flid}).send();}else if(m=='RestrictedListNUX/okay')new h().setURI('/ajax/friends/lists/nux_log.php').setData(n).send();return true;}var l={init:function(m){i=m;g.subscribe(['FriendListHovercard/add','RestrictedListNUX/okay'],k);}};e.exports=l;});
__d("legacy:FriendListRestrictedEducation",["RestrictedFriendListEducation"],function(a,b,c,d){a.RestrictedFriendListEducation=b('RestrictedFriendListEducation');},3);
__d("Token",["CSS","DataStore","DOM","copyProperties","tx"],function(a,b,c,d,e,f){var g=b('CSS'),h=b('DataStore'),i=b('DOM'),j=b('copyProperties'),k=b('tx');function l(m,n){this.info=m;this.paramName=n;}j(l.prototype,{getInfo:function(){return this.info;},getText:function(){return this.info.text;},getValue:function(){return this.info.uid;},isFreeform:function(){return !!this.info.freeform;},getElement:function(){if(!this.element)this.setElement(this.createElement());return this.element;},setElement:function(m){h.set(m,'Token',this);this.element=m;return this;},isRemovable:function(){return g.hasClass(this.element,'removable');},createElement:function(){var m=this.paramName,n=this.getText(),o=this.getValue(),p=i.$N('a',{href:'#',title:k._("Poista {item}",{item:n}),className:'remove uiCloseButton uiCloseButtonSmall'}),q=i.$N('input',{type:'hidden',value:o,name:m+'[]',autocomplete:'off'}),r=i.$N('input',{type:'hidden',value:n,name:'text_'+m+'[]',autocomplete:'off'}),s=i.$N('span',{title:n,className:'removable uiToken'},[n,q,r,p]);return s;}});e.exports=l;});
__d("Tokenizer",["array-extensions","event-extensions","Arbiter","ArbiterMixin","Class","CSS","DataStore","DOM","Input","Keys","Parent","Token","UserAgent","copyProperties","createObjectFrom"],function(a,b,c,d,e,f){b('array-extensions');b('event-extensions');var g=b('Arbiter'),h=b('ArbiterMixin'),i=b('Class'),j=b('CSS'),k=b('DataStore'),l=b('DOM'),m=b('Input'),n=b('Keys'),o=b('Parent'),p=b('Token'),q=b('UserAgent'),r=b('copyProperties'),s=b('createObjectFrom');function t(u,v){this.element=u;this.typeahead=v;this.input=v.getCore().getElement();k.set(this.element,'Tokenizer',this);}t.getInstance=function(u){var v=o.byClass(u,'uiTokenizer');return v?k.get(v,'Tokenizer'):null;};r(t.prototype,h,{inline:false,maxTokens:null,excludeDuplicates:true,placeholder:'',init:function(u,v,w,x){this.init=bagofholding;this.tokenarea=u;this.paramName=v;this.placeholder=this.input.getAttribute('data-placeholder')||'';r(this,x||{});this.initEvents();this.initTypeahead();this.reset(w);this.initBehaviors();g.inform('Tokenizer/init',this,g.BEHAVIOR_PERSISTENT);},reset:function(u){this.tokens=[];this.unique={};if(u){this.populate(u);}else l.empty(this.tokenarea);this.updateTokenarea();},populate:function(u){var v=[];this.tokens=this.getTokenElements().map(function(w,x){var y=u[x];v.push(this._tokenKey(y));return this.createToken(y,w);},this);this.unique=s(v,this.tokens);},getElement:function(){return this.element;},getTypeahead:function(){return this.typeahead;},getInput:function(){return this.input;},initBehaviors:function(){for(var u in (this.behaviors||{})){var v=window.TokenizerBehaviors&&window.TokenizerBehaviors[u];v.call(null,this,this.behaviors[u]);}},initTypeahead:function(){var u=this.typeahead.getCore();u.resetOnSelect=true;u.setValueOnSelect=false;u.preventFocusChangeOnTab=true;if(this.inline){var v=this.typeahead.getView();j.addClass(v.getElement(),'uiInlineTokenizerView');}this.typeahead.subscribe('select',function(w,x){var y=x.selected;if('uid' in y){this.updateInput();this.addToken(this.createToken(y));}}.bind(this));this.typeahead.subscribe('blur',this.handleBlur.bind(this));},handleBlur:function(event){this.inform('blur',{event:event});this.updatePlaceholder();},initEvents:function(){var u=this.handleEvents.bind(this),v=q.firefox()<4?'keypress':'keydown';Event.listen(this.tokenarea,{click:u,keydown:u});Event.listen(this.input,'paste',this.paste.bind(this));Event.listen(this.input,v,this.keydown.bind(this));},handleEvents:function(event){var u=event.getTarget(),v=u&&this.getTokenElementFromTarget(u);if(!v)return;if(event.type!='keydown'||Event.getKeyCode(event)==n.RETURN)this.processEvents(event,u,v);},processEvents:function(event,u,v){if(o.byClass(u,'remove')){var w=v.nextSibling;w=w&&l.scry(v.nextSibling,'.remove')[0];var x=this.getTokenFromElement(v);x=this.addTokenData(x,u);this.removeToken(x);this.focusOnTokenRemoval(event,w);event.kill();}},focusOnTokenRemoval:function(event,u){m.focus(event.type=='keydown'&&u||this.input);},addTokenData:function(u,v){return u;},keydown:function(event){this.inform('keydown',{event:event});var u=Event.getKeyCode(event),v=this.input;if(this.inline&&u==n.BACKSPACE&&m.isEmpty(v)){var w=this.getLastToken();if(w&&w.isRemovable())this.removeToken(w);}this.updateInput();},paste:function(event){this.inform('paste',{event:event});this.updateInput(true);},focusInput:function(){m.focus(this.input);},updateInput:function(u){if(!this.inline)return;var v=this.input;setTimeout(function(){v.size=v.value.length||1;if(u)v.value=v.value;},20);},updatePlaceholder:function(){if(!this.inline||this.stickyPlaceholder)return;var u=!this.tokens.length;this.input.size=u?this.placeholder.length*2||1:1;m.setPlaceholder(this.input,u?this.placeholder:'');},getToken:function(u){return this.unique[u]||null;},getTokens:function(){return this.tokens||[];},getTokenElements:function(){return l.scry(this.tokenarea,'span.uiToken');},getTokenElementFromTarget:function(u){return o.byClass(u,'uiToken');},getTokenFromElement:function(u){return k.get(u,'Token');},getTokenValues:function(){return this.tokens.map(function(u){return u.getValue();});},getFirstToken:function(){return this.tokens[0]||null;},getLastToken:function(){return this.tokens[this.tokens.length-1]||null;},hasMaxTokens:function(){return this.maxTokens&&this.maxTokens<=this.tokens.length;},createToken:function(u,v){var w=this.getToken(this._tokenKey(u));w=w||new p(u,this.paramName);v&&w.setElement(v);return w;},addToken:function(u){if(this.hasMaxTokens())return;var v=this._tokenKey(u.getInfo());if(v in this.unique)return;this.unique[v]=u;this.tokens.push(u);this.insertToken(u);this.updateTokenarea();this.inform('addToken',u);g.inform('Form/change',{node:this.element});},insertToken:function(u){l.appendContent(this.tokenarea,u.getElement());},removeToken:function(u){if(!u)return;var v=this.tokens.indexOf(u);if(v<0)return;this.tokens.splice(this.tokens.indexOf(u),1);delete this.unique[this._tokenKey(u.getInfo())];l.remove(u.getElement());this.updateTokenarea();this.inform('removeToken',u);g.inform('Form/change',{node:this.element});},removeAllTokens:function(){this.reset();this.inform('removeAllTokens');},updateTokenarea:function(){var u=this.typeahead.getCore(),v=this.getTokenValues();if(this.excludeDuplicates){this._exclusions||(this._exclusions=u.getExclusions());u.setExclusions(v.concat(this._exclusions));}u.setEnabled(!this.hasMaxTokens());this.updateTokenareaVisibility();this.updatePlaceholder();},updateTokenareaVisibility:function(){j.conditionShow(this.tokenarea,this.tokens.length!==0);},_tokenKey:function(u){return u.uid+(u.freeform?':':'');}});e.exports=t;});
__d("PhotoTagApproval",["array-extensions","event-extensions","Arbiter","CSS","copyProperties","DOM","Parent","PhotosConst","ge"],function(a,b,c,d,e,f){b('array-extensions');b('event-extensions');var g=b('Arbiter'),h=b('CSS'),i=b('copyProperties'),j=b('DOM'),k=b('Parent'),l=b('PhotosConst'),m=b('ge');function n(o){this.viewer=o;this.units=[];this.currentUnit=0;var p=o.getVersionConst();if(p==l.VIEWER_SNOWLIFT){this._root=m('fbPhotoSnowliftTagApproval');}else this._root=m('fbPhotoPageTagApproval');g.subscribe(o.getEventString('DATA_CHANGE'),this.restartTagApproval.bind(this));Event.listen(this._root,'click',this.handleClick.bind(this));Event.listen(this._root,'mousemove',function(q){this.hiliteCurrentPendingTag();Event.kill(q);}.bind(this));this.restartTagApproval();}i(n.prototype,{handleClick:function(event){var o=event.getTarget();if(h.hasClass(o,'nextPager')&&h.hasClass(o,'enabled')){this.showNextUnit();}else if(h.hasClass(o,'prevPager')&&h.hasClass(o,'enabled')){this.showPrevUnit();}else if(k.byClass(o,'fbPhotoApprovalPendingButtons')){var p=this.units[this.currentUnit],q=this.getTagNameID(p);if(q){var r=k.byClass(o,'approve');g.inform('PhotoTagApproval.UPDATE_TAG_BOX',{id:q,approve:r,version:this.viewer.getVersionConst()});}this.removeSelectedUnit.bind(this).defer();}return true;},loadUnits:function(o){this.units=j.scry(this._root,'div.fbPhotoApprovalUnit');if(this.units.length){h.show(this._root);this.showUnit(o);h.conditionClass(this._root,'hidePagers',this.units.length==1);}else{h.hide(this._root);g.inform('PhotoTagApproval.HILITE_TAG',{tag:null,version:this.viewer.getVersionConst()});}},restartTagApproval:function(){this.loadUnits(0);},removeSelectedUnit:function(){var o=this.units[this.currentUnit];j.remove(o);this.loadUnits(this.currentUnit);},showNextUnit:function(){this.showUnit(this.currentUnit+1);},showPrevUnit:function(){this.showUnit(this.currentUnit-1);},getTagNameID:function(o){var p=o.id.indexOf(':');return o.id.slice(p+1);},showUnit:function(o){this.units.forEach(h.hide);this.currentUnit=(o+this.units.length)%this.units.length;var p=this.units[this.currentUnit];h.show(p);this.hiliteCurrentPendingTag();h.conditionClass(j.find(this._root,'a.prevPager'),'enabled',this.currentUnit>0);h.conditionClass(j.find(this._root,'a.nextPager'),'enabled',this.currentUnit<this.units.length-1);},hiliteCurrentPendingTag:function(){var o=this.units[this.currentUnit],p=this.getTagNameID(o);g.inform('PhotoTagApproval.HILITE_TAG',{tag:p,version:this.viewer.getVersionConst()});}});e.exports=n;});
__d("legacy:photo-tag-approval",["PhotoTagApproval"],function(a,b,c,d){a.PhotoTagApproval=b('PhotoTagApproval');},3);
__d("legacy:photos-constants",["PhotosConst"],function(a,b,c,d){a.PhotosConst=b('PhotosConst');},3);
__d("Photocrop2",["array-extensions","event-extensions","CSS","DOM","Vector","copyProperties"],function(a,b,c,d,e,f){b('array-extensions');b('event-extensions');var g=b('CSS'),h=b('DOM'),i=b('Vector'),j=b('copyProperties');function k(l,m){this.photo=l;j(this,j({target:this.photo.parentNode,width:200,height:200,min_width:100,min_height:100,center_x:(this.photo.offsetWidth||200)/2,center_y:(this.photo.offsetHeight||200)/2},m));var n=this.center_x-this.width/2,o=this.center_y-this.height/2;this.box=[o,n+this.width,o+this.height,n];g.addClass(this.target,'photocrop');['bg','wrapper','viewport'].forEach(function(p){this[p]=h.create('div');g.addClass(this[p],p);}.bind(this));this.highlight=h.create('img',{src:l.src});g.addClass(this.highlight,'highlight');this.target.appendChild(this.bg);this.target.appendChild(this.wrapper);this.wrapper.appendChild(this.highlight);this.wrapper.appendChild(this.viewport);['ne','nw','sw','se'].forEach(function(p){var q=h.create('div');g.addClass(q,p);this.viewport.appendChild(q);}.bind(this));Event.listen(this.viewport,{mousedown:this.mousedown.bind(this),dragstart:Event.kill,selectstart:Event.kill,click:Event.stop});Event.listen(document,{mousemove:this.mousemove.bind(this),mouseup:this.mouseup.bind(this)});[this.bg,this.wrapper].forEach(function(p){p.style.width=l.offsetWidth+'px';p.style.height=l.offsetHeight+'px';p.style.top=l.offsetTop+'px';p.style.left=l.offsetLeft+'px';});this.redraw();}k.prototype.redraw=function(){this.highlight.style.clip="rect("+this.box.join("px ")+"px)";this.viewport.style.top=this.box[0]+"px";this.viewport.style.left=this.box[3]+"px";this.viewport.style.height=(this.box[2]-this.box[0])+"px";this.viewport.style.width=(this.box[1]-this.box[3])+"px";};k.prototype.done=function(){[this.bg,this.wrapper].forEach(h.remove);g.removeClass(this.target,'photocrop');var l=this.box.map(Math.round);return {x:Math.max(l[3],0),y:Math.max(l[0],0),width:l[1]-Math.max(l[3],0),height:l[2]-Math.max(l[0],0)};};k.prototype.mousedown=function(l){this.mouseTarget=l.getTarget();this.pos=i.getEventPosition(l);g.addClass(document.body,'draggingMode');return false;};k.prototype.mousemove=function(l){if(!this.mouseTarget)return;var m=i.getEventPosition(l).sub(this.pos);function n(t,u,v){return Math.max(t,Math.min(v,u));}var o=this.box,p=this.min_width,q=this.min_height,r=this.wrapper.offsetWidth,s=this.wrapper.offsetHeight;if(this.mouseTarget==this.viewport){m.x=n(-o[3],m.x,r-o[1]);m.y=n(-o[0],m.y,s-o[2]);o[0]+=m.y;o[1]+=m.x;o[2]+=m.y;o[3]+=m.x;}else if(g.hasClass(this.mouseTarget,'ne')){o[1]+=m.x=n(o[3]+p-o[1],m.x,r-o[1]);o[0]+=m.y=n(-o[0],m.y,o[2]-q-o[0]);}else if(g.hasClass(this.mouseTarget,'nw')){o[3]+=m.x=n(-o[3],m.x,o[1]-p-o[3]);o[0]+=m.y=n(-o[0],m.y,o[2]-q-o[0]);}else if(g.hasClass(this.mouseTarget,'se')){o[1]+=m.x=n(o[3]+p-o[1],m.x,r-o[1]);o[2]+=m.y=n(o[0]+q-o[2],m.y,s-o[2]);}else if(g.hasClass(this.mouseTarget,'sw')){o[3]+=m.x=n(-o[3],m.x,o[1]-p-o[3]);o[2]+=m.y=n(o[0]+q-o[2],m.y,s-o[2]);}this.redraw();this.pos=this.pos.add(m);return false;};k.prototype.mouseup=function(l){this.mouseTarget=null;g.removeClass(document.body,'draggingMode');};e.exports=k;});
__d("PhotosTaggingWaterfall",["AsyncSignal","copyProperties"],function(a,b,c,d,e,f){var g=b('AsyncSignal'),h=b('copyProperties');function i(j){i._queueName=j||i._queueName;}h(i,{BEGIN:"begin",TAG_FACE:"tag_face",ADD_NAME:"add_name",TAG_CONFIRMED:"tag_confirmed",FINISH:"finish",TYPE_NAME:'type_name',SELECT_NAME:'select_name',_queueName:null,sendSignal:function(j,k){new g('/ajax/photos/tag_waterfall.php',{data:JSON.stringify(j)}).setHandler(k).send();}});e.exports=i;});
__d("PhotoTagger",["event-extensions","array-extensions","function-extensions","Arbiter","AsyncRequest","CSS","DOM","ErrorDialog","Input","Keys","Parent","PhotosConst","PhotosUtils","PhotosTaggingWaterfall","Style","Vector","copyProperties","ge","userAction"],function(a,b,c,d,e,f){b('event-extensions');b('array-extensions');b('function-extensions');var g=b('Arbiter'),h=b('AsyncRequest'),i=b('CSS'),j=b('DOM'),k=b('ErrorDialog'),l=b('Input'),m=b('Keys'),n=b('Parent'),o=b('PhotosConst'),p=b('PhotosUtils'),q=b('PhotosTaggingWaterfall'),r=b('Style'),s=b('Vector'),t=b('copyProperties'),u=b('ge'),v=b('userAction');function w(x){this.viewer=x;this.version=x.getVersionConst();w.instances[this.version]=this;}w.instances={};w.getInstance=function(x){return w.instances[x];};t(w.prototype,{TAG_BOX_SIZE:100,EPSILON:.0025,datasources:{},photoData:{},tagRects:{},elemNames:{6:{addTagLink:'div.fbPhotosPhotoOwnerButtons',overlayActions:'div.snowliftOverlayBar'}},init:function(x,y){this.setupUserActionLogging();this.root=this.viewer.getRoot();this.tagger=x;this.tokenizer=y;this._qn=null;this.typeahead=y.getTypeahead();this.faceboxes=[];this.currentFacebox=null;this.revokedFaceboxes=[];this.requestFaceboxNextTag=false;this.clickState=j.find(this.root,'div.stageActions');this.newTagBox=j.find(this.clickState,'div.newTagBox');this.addTagLink=j.find(this.root,this.elemNames[this.version].addTagLink);this.overlayActions=j.find(this.root,this.elemNames[this.version].overlayActions);this.setupHandlers();this.hideNewTagTimer=null;this.addedSuggestions=[];this.featuredSuggestions=[];this.albumSuggestions=[];this.friendSuggestions=[];this.suggestionAlbum=-1;this.needAlbumSuggestionsFetch=true;this.fetchTaggingSuggestions({owner:this.photoData.owner});this.setDataSource(this.typeahead.getData());this.updateFaceboxes();return this;},setupUserActionLogging:function(){this.ua=v('tagging').set_namespace(this.viewer.getSourceString()).set_ua_id('tagging').add_event('init');},logUserActionEvent:function(x){this.ua.add_event(x);},fetchTaggingSuggestions:function(x){this.logUserActionEvent('sugg_fetch');new h().setURI('/ajax/photos/photo/tags/tags_init.php').setData(x).setOption('retries',1).setAllowCrossPageTransition(true).setHandler(function(z){var aa=z.getPayload();this.featuredSuggestions=aa.featuredTaggees;this.friendSuggestions=aa.friendTaggees;this.updateTypeaheadSuggestions();this.logUserActionEvent('sugg_fetch_done');}.bind(this)).send();var y=this.typeahead.subscribe('bootstrap',function(z,aa){if(aa&&!aa.bootstrapping){this.updateWithSuggestions();this.typeahead.unsubscribe(y);this.typeahead.subscribe('focus',this.updateWithSuggestions.bind(this));this.tokenizer.subscribe('removeToken',this.updateWithSuggestions.bind(this));this.tokenizer.subscribe('addToken',this.addSuggestion.bind(this));this.typeahead.subscribe('respond',function(ba,ca){if(ca&&!ca.results.length)this.updateWithSuggestions();}.bind(this));}}.bind(this));},fetchAlbumTaggingSuggestions:function(){this.logUserActionEvent('sugg_album_fetch');new h().setURI('/ajax/photos/photo/tags/tags_album.php').setData({cachedAlbum:this.suggestionAlbum,photo:this.photoData.fbid}).setOption('retries',1).setAllowCrossPageTransition(true).setHandler(function(x){this.needAlbumSuggestionsFetch=false;var y=x.getPayload();if(y.length===0)return;this.suggestionAlbum=y.album;this.albumSuggestions=y.taggees;this.updateTypeaheadSuggestions();this.logUserActionEvent('sugg_album_fetch_done');}.bind(this)).send();},resetAlbumTaggingSuggestions:function(){this.needAlbumSuggestionsFetch=true;this.updateTypeaheadSuggestions();},updateTypeaheadSuggestions:function(){this.typeahead.getView().setSuggestions(this.addedSuggestions.concat(this.featuredSuggestions,this.needAlbumSuggestionsFetch?[]:this.albumSuggestions,this.friendSuggestions));},setupHandlers:function(){this.handlers=[Event.listen(this.clickState,'click',this.addTag.bind(this)),Event.listen(window,'resize',this.hideTagger.bind(this)),Event.listen(this.addTagLink,'click',this.checkActions.bind(this)),Event.listen(this.overlayActions,'click',this.checkActions.bind(this))];Event.listen(document.documentElement,'keydown',function(event){if(Event.getKeyCode(event)===m.ESC)if(this.taggingMode)this.deactivateTagging();}.bind(this));this.subscriptions=[g.subscribe(this.viewer.getEventString('PAGE'),this.restartTagging.bind(this)),g.subscribe(this.viewer.getEventString('DATA_CHANGE'),this.setPhotoData.bind(this)),g.subscribe(this.viewer.getEventString('EXTRA_DATA_CHANGE'),this.setExtraData.bind(this)),g.subscribe(this.viewer.getEventString('CLOSE'),this.deactivateTagging.bind(this))];this.tokenizer.subscribe('addToken',this.saveTag.bind(this));this.tokenizer.subscribe('removeToken',this.removeTag.bind(this));this.tokenizer.subscribe('markTagAsSpam',this.markTagAsSpam.bind(this));},updateWithSuggestions:function(x,y){var z=this.typeahead.getData().buildUids(' ',this.typeahead.getView().getSuggestions(),this.typeahead.getCore().getExclusions());if(!z.length)return;var aa=this.typeahead.getData().respond('',z);for(var ba=0;ba<aa.length;ba++)aa[ba].index=-1000+ba;},addSuggestion:function(x,y){var z=y.info&&y.info.uid;if(z){this.addedSuggestions.unshift(z);this.updateTypeaheadSuggestions();}},setQueueName:function(x){this._qn=x;return this;},_sendWaterfallLogSignal:function(x){q.sendSignal({qn:this._qn,source:this.viewer.getSourceString(),step:x,pid:this.photoData.pid});},_bumpQueueName:function(){if(this._qn)this._qn+=1;},activateTagging:function(){this.logUserActionEvent('activate');g.inform('PhotoTagger.ACTIVATE_TAGGING');if(this.getDataSource()){this.dataSourceFetched(this.getDataSource());}else new h('/ajax/photos/photo/tags/fetch_datasource.php').setData({fbid:this.photoData.fbid,version:this.version}).send();if(this.needAlbumSuggestionsFetch)this.fetchAlbumTaggingSuggestions();},restartTagging:function(){this.hideNewTag();this.hideTagger();this.revokedFaceboxes=[];if(this.taggingMode===true){this.setCurrentFacebox(null);this.requestFaceboxNextTag=true;this.activateTagging();}},getDataSource:function(){return this.datasources[this.getDataSourceKey()];},getDataSourceKey:function(){if(this.photoData.ownertype=='user'&&!this.photoData.obj_id)return 'friends';return this.photoData.obj_id||this.photoData.owner;},setDataSource:function(x){if(this.typeahead.getData()!=x)this.typeahead.swapData(x);this.datasources[this.getDataSourceKey()]=x;},dataSourceFetched:function(x){this.taggingMode=true;i.addClass(this.root,'taggingMode');this._bumpQueueName();this._sendWaterfallLogSignal(q.BEGIN);this.setDataSource(x);},deactivateTagging:function(){this.logUserActionEvent('deactivate');if(this.taggingMode===true)this._sendWaterfallLogSignal(q.FINISH);this.taggingMode=false;this.hideNewTag();this.hideTagger();this.setCurrentFacebox(null);i.removeClass(this.root,'taggingMode');},checkActions:function(event){var x=event.getTarget();if(n.byClass(x,'fbPhotosPhotoActionsTag'))if(this.taggingMode){this.deactivateTagging();}else{this.activateTagging();this.addNextTagFromFacebox();}},hideTagger:function(){i.hide(this.tagger);},showTagger:function(){i.show(this.tagger);this.focusTaggerInput.bind(this).defer();this.updateWithSuggestions();this.hideNewTag();},focusTaggerInput:function(){var x=j.find(this.tagger,'input.textInput');l.reset(x);x.focus();},showNewTag:function(x){if(!this.newTagBox)return;j.setContent(j.find(this.newTagBox,'div.tagName'),j.create('span',null,x));i.show(this.newTagBox);this.hideNewTagTimer=setTimeout(this.hideNewTag.bind(this),3000);},hideNewTag:function(){if(!this.newTagBox)return;if(this.hideNewTagTimer!==null){clearTimeout(this.hideNewTagTimer);this.hideNewTagTimer=null;}i.hide(this.newTagBox);},getTaggerPositioningOrigin:function(){return s.getElementPosition(this.clickState,'document');},addTag:function(event){var x=event.getTarget(),y=n.byClass(x,'fbPhotosPhotoButtons');if(!this.taggingMode||(y&&x!==y)||n.byClass(x,'fbPhotosPhotoActions')||n.byClass(x,'photoTagTypeahead'))return;var z=this.viewer.getImage(),aa=s.getEventPosition(event),ba=p.absoluteToNormalizedPosition(z,aa);this.setCurrentFacebox(this.findNearestFacebox(ba));if(this.currentFacebox){this.addTagFromFacebox(this.currentFacebox);}else{i.removeClass(j.find(this.tagger,'.faceBox'),'faceBoxHidden');this.addTagFromPosition(aa,this.TAG_BOX_SIZE);}},findNearestFacebox:function(x){var y=Infinity,z=null;this.faceboxes.forEach(function(aa){if(aa.rect.contains(x)){var ba=x.distanceTo(aa.rect.getCenter());if(ba<y){y=ba;z=aa;}}});return z;},addNextTagFromFacebox:function(){if(this.faceboxes.length===0)return;if(!this.currentFacebox){this.setCurrentFacebox(this.faceboxes[0]);}else{var x=this.faceboxes.indexOf(this.currentFacebox),y=(x+1)%this.faceboxes.length;this.setCurrentFacebox(this.faceboxes[y]);}this.addTagFromFacebox(this.currentFacebox);},addTagFromFacebox:function(x){i.addClass(x.node,'active');i.addClass(j.find(this.tagger,'.faceBox'),'faceBoxHidden');var y=x.rect.getCenter(),z=this.viewer.getImage(),aa=p.normalizedToAbsolutePosition(z,y),ba=(x.rect.w()/100)*s.getElementDimensions(z).x;this.addTagFromPosition(aa,ba);},addTagFromPosition:function(x,y){var z=this.viewer.getImage(),aa=this.calcTaggerPosition(z,x,y);this.calcClickPoint(z,x);if(!aa){this.hideTagger();return;}aa.setElementPosition(this.tagger);if(this.newTagBox)aa.setElementPosition(this.newTagBox);this.showTagger();this._sendWaterfallLogSignal(q.TAG_FACE);},calcTaggerPosition:function(x,y,z){var aa=s.getElementPosition(x),ba=s.getElementDimensions(x),ca=new s(z/2,z/2),da=y.sub(aa);for(var ea in {x:1,y:1}){if(y[ea]<aa[ea]||y[ea]>aa[ea]+ba[ea])return null;if(da[ea]<(z/2)){ca[ea]=da[ea];}else if(ba[ea]<da[ea]+(z/2))ca[ea]=z-(ba[ea]-da[ea]);}var fa=3,ga=j.find(this.tagger,'.faceBox');r.set(ga,'width',(z-fa*2)+'px');r.set(ga,'height',(z-fa*2)+'px');var ha=y.sub(this.getTaggerPositioningOrigin());return ha.sub(ca.x,ca.y);},calcClickPoint:function(x,y){var z=s.getElementDimensions(x),aa=s.getElementPosition(x),ba=y.sub(aa);this.clickPoint={x:ba.x/z.x,y:ba.y/z.y};},saveTag:function(x,y){var z=this.getTaggingData('add',y.isFreeform()?'':y.getValue(),y.getText());z.x=this.clickPoint.x*100;z.y=this.clickPoint.y*100;this.logUserActionEvent('save');new h().setURI('/ajax/photo_tagging_ajax.php').setMethod('POST').setData(z).setAllowCrossPageTransition(true).setHandler(this.tagsChangeHandler.bind(this)).setErrorHandler(this.checkError.bind(this,y)).send();this.showNewTag(y.getText());this.hideTagger();if(this.currentFacebox){this.removeFacebox(this.currentFacebox);this.addNextTagFromFacebox();}},getTaggingData:function(x,y,z){return {cs_ver:this.version,pid:this.photoData.pid,id:this.photoData.owner,subject:y,name:z,action:x,source:this.viewer.getSourceString(),qn:this._qn,position:this.getPosition()};},getPosition:function(){return this.viewer.getPosition();},tagsChangeHandler:function(x){this.logUserActionEvent('save_done');},checkError:function(x,y){if(y.getPayload()&&y.getPayload().clear_tag){x.already_untagged=true;this.tokenizer.removeToken(x);}k.showAsyncError(y);},removeTag:function(x,y,z){if(y.already_untagged)return;var aa='remove';if(j.scry(y.element,'a.pending')[0])aa='retract';if(y.blockUser)aa='remove_block';this.logUserActionEvent('save');new h().setURI('/ajax/photo_tagging_ajax.php').setMethod('POST').setData(this.getTaggingData(aa,y.isFreeform()?'':y.getInfo().uid,y.getInfo().text)).setHandler(function(ba){this.tagsChangeHandler(ba);z&&z();}.bind(this)).setAllowCrossPageTransition(true).send();},removeTagByID:function(x,y,z){var aa=this.tokenizer.tokens;for(var ba=0;ba<aa.length;ba++)if(aa[ba].info.uid==y)return this.removeTag(null,aa[ba],z);},removeTagByIDFromHovercardLink:function(x,y,z){this.removeTagByID(x,y,function(){if(window.Hovercard)window.Hovercard.contains(z)&&window.Hovercard.hide(true);});},setPhotoData:function(x,y){this.photoData=y;return this;},setExtraData:function(x,y){this.tagRects=y.tagRects;this.updateFaceboxes();return this;},markTagAsSpam:function(x,y){new h().setURI('/ajax/photo_tagging_ajax.php').setMethod('POST').setData(this.getTaggingData('mark_as_spam',y,null)).send();},removeFacebox:function(x){if(x===null)return;this.revokedFaceboxes.push(x.rect.getCenter());this.faceboxes.remove(x);j.remove(x.node);if(x===this.currentFacebox)this.setCurrentFacebox(null);},setCurrentFacebox:function(x){if(this.currentFacebox)i.removeClass(this.currentFacebox.node,'active');this.currentFacebox=x;},updateRevokedFaceboxes:function(){this.revokedFaceboxes=this.revokedFaceboxes.filter(function(x){for(var y=0;y<this.faceboxes.length;++y){var z=this.faceboxes[y],aa=x.distanceTo(z.rect.getCenter());if(aa<this.EPSILON)return true;}return false;}.bind(this));this.revokedFaceboxes.forEach(function(x){var y=this.findNearestFacebox(x);this.faceboxes.remove(y);j.remove(y.node);}.bind(this));},updateFaceboxes:function(){if(this.version!==o.VIEWER_SNOWLIFT)return;this.faceboxes=[];for(var x in this.tagRects)if(x.match(/^face:/))this.faceboxes.push({node:u(x),id:x,rect:this.tagRects[x]});this.updateRevokedFaceboxes();this.faceboxes.sort(function(z,aa){return z.rect.getCenter().x-aa.rect.getCenter().x;});if(this.currentFacebox){var y=this.currentFacebox.rect.getCenter();this.setCurrentFacebox(this.findNearestFacebox(y));i.addClass(this.currentFacebox.node,'active');}if(this.requestFaceboxNextTag){this.addNextTagFromFacebox();this.requestFaceboxNextTag=false;}}});e.exports=w;});
__d("legacy:PhotoTagger",["PhotoTagger"],function(a,b,c,d){a.PhotoTagger=b('PhotoTagger');},3);
__d("PhotoPermalink",["array-extensions","event-extensions","function-extensions","Arbiter","AsyncRequest","Bootloader","Class","CSS","DOM","KeyEventController","Keys","PageTransitions","Parent","PhotosConst","PhotoSessionLog","PhotoStreamCache","PhotosUtils","PhotoViewer","Style","UserAgent","Vector","$","copyProperties","createArrayFrom","ge","goURI"],function(a,b,c,d,e,f){b('array-extensions');b('event-extensions');b('function-extensions');var g=b('Arbiter'),h=b('AsyncRequest'),i=b('Bootloader'),j=b('Class'),k=b('CSS'),l=b('DOM'),m=b('KeyEventController'),n=b('Keys'),o=b('PageTransitions'),p=b('Parent'),q=b('PhotosConst'),r=b('PhotoSessionLog'),s=b('PhotoStreamCache'),t=b('PhotosUtils'),u=b('PhotoViewer'),v=b('Style'),w=b('UserAgent'),x=b('Vector'),y=b('$'),z=b('copyProperties'),aa=b('createArrayFrom'),ba=b('ge'),ca=b('goURI');function da(){this.parent.construct(this);this.encodingMode=false;}z(da,{STATE_ERROR:'error',STATE_HTML:'html',STATE_IMAGE_DATA:'image',MIN_TAG_DISTANCE:80,_instance:null,getInstance:function(){if(!da._instance)da._instance=new da();return da._instance;},addPhotoFbids:function(ea,fa,ga){da.getInstance().addPhotoFbids(ea,fa,ga);},attachTagger:function(ea){da.getInstance().attachTagger(ea);},init:function(){da.getInstance().init();},recacheData:function(ea){da.getInstance().recacheData(ea);},saveTagsFromPayload:function(ea){da.getInstance().saveTagsFromPayload(ea);},saveTagsFromPayloadDelayed:function(ea){da.saveTagsFromPayload.curry(ea).defer(2000);},setErrorBoxContent:function(ea){da.getInstance().setErrorBoxContent(ea);},setHasLocation:function(ea){da.getInstance().setHasLocation(ea);},storeFromData:function(ea){da.getInstance().storeFromData(ea);},swapData:function(){da.getInstance().swapData();},touchMarkup:bagofholding,updateTotalCount:function(ea,fa,ga){da.getInstance().updateTotalCount(ea,fa,ga);},isInVideoEncodingMode:function(){return da.getInstance().isInVideoEncodingMode();},disableAutoRefresh:function(){da.getInstance().disableAutoRefresh();},enableAutoRefresh:function(ea){da.getInstance().enableAutoRefresh(ea);}});j.extend(da,u);z(da.prototype,{init:function(){this.stream=new s();this.stream.init(q.VIEWER_PERMALINK,'PhotoViewerPagelet');this.reset();this.root=y('fbPhotoPageContainer');this.header=y('fbPhotoPageHeader');this.stageWrapper=ba('photoborder');this.videoStage=l.find(this.stageWrapper,'div.videoStage');this.buttonActions=l.find(this.root,'div.stageButtons');this.feedback=ba('fbPhotoPageFeedback');this.image=ba('fbPhotoImage');this.errorBox=ba('fbPhotoPageError');this.actionList=ba('fbPhotoPageActions');this.stageActions=l.find(this.root,'div.stageActions');this.loadingStates={image:false,html:false};this.unhiliteTimer=null;this.pageHandlers=[Event.listen(this.root,'mouseout',this.mouseOutListener.bind(this)),Event.listen(this.root,'mousemove',this.mouseMoveListener.bind(this)),Event.listen(this.stageWrapper,'click',this.stageClickListener.bind(this)),Event.listen(this.stageWrapper,'dragstart',this.killDrag.bind(this)),Event.listen(this.stageWrapper,'selectstart',this.killDrag.bind(this)),Event.listen(this.buttonActions,'click',this.buttonListener.bind(this)),Event.listen(this.actionList,'click',this.rotateListener.bind(this)),Event.listen(this.feedback,'click',function(event){if(p.byClass(event.getTarget(),'like_link'))k.toggleClass(l.find(this.buttonActions,'div.likeCommentGroup'),'viewerLikesThis');}.bind(this))];o.registerHandler(this.transitionHandler.bind(this));m.registerKey('LEFT',this.goNav.bind(this));m.registerKey('RIGHT',this.goNav.bind(this));r.initLogging(r.PERMALINK);g.subscribe('PhotoTagApproval.HILITE_TAG',this.onHiliteTag.bind(this));g.subscribe('PhotoTagApproval.UPDATE_TAG_BOX',this.onUpdateTagBox.bind(this));},getEventPrefix:function(){return 'PhotoPermalink';},getSourceString:function(){return 'permalink';},getVersionConst:function(){return q.VIEWER_PERMALINK;},saveTagsFromPayload:function(ea){this.storeFromData(ea);if('data' in ea&&this.stream.getCursor() in ea.data)this.swapData();},goNav:function(event){var ea=Event.getKeyCode(event)||event.getTarget();if(this.theaterModeOn())return true;var fa=event.type==='click'&&p.byClass(ea,'stageWrapper')&&!p.byClass(ea,'tagBoxPending')&&!p.byClass(ea,'tagBoxPendingResponse');if(fa&&k.hasClass(this.root,'taggingMode'))return false;if(ea==n.LEFT){this.page(-1);}else if(ea==n.RIGHT||fa)this.page(1);return false;},theaterModeOn:function(){return k.hasClass(document.documentElement,'theaterMode');},pagerClick:function(ea){if(this.theaterModeOn())return true;if(ea=='prev'){this.page(-1);}else if(ea=='next')this.page(1);return false;},setLoadingState:function(ea,fa){switch(ea){case da.STATE_IMAGE_DATA:this.loadingStates[ea]=fa;k.conditionClass(this.root,'imageLoading',fa);break;case da.STATE_HTML:this.loadingStates[ea]=fa;k.conditionClass(this.root,'dataLoading',fa);break;}},checkState:function(ea){if(ea!=da.STATE_ERROR&&!this.loadingStates[ea])return;switch(ea){case da.STATE_IMAGE_DATA:var fa=this.stream.getCurrentImageData();if(fa){if(fa.url){this.switchImage(fa.url,true);}else if(fa.video)this.switchVideo(fa.video,true);this.setLoadingState(ea,false);}break;case da.STATE_HTML:if(this.stream.getCurrentHtml()){this.swapData();this.setLoadingState(ea,false);}break;default:if(this.stream.errorInCurrent()){k.hide(this.image);k.show(this.errorBox);}break;}},reHilitePendingTag:function(){var ea=ba(this.hilitedTag);if(ea&&k.hasClass(ea,'showPendingTagName'))return;var fa=l.scry(this.root,'div.tagsWrapper div.showPendingTagName')[0];if(fa)this.switchHilitedTags(fa.id);},page:function(ea){if(!this.stream.isValidMovement(ea))return;this.unhiliteAllTags();var fa=this.getVideoOnStage();if(fa)this.switchVideo(fa,false);g.inform('PhotoPermalink.PAGE');this.recacheData();this.stream.moveCursor(ea);k.hide(this.image);if(this.stream.errorInCurrent()){this.setLoadingState(da.STATE_HTML,true);k.show(this.errorBox);}else{var ga=this.stream.getCurrentImageData();if(ga){if(ga.url){this.switchImage(ga.url,true);}else if(ga.video)this.switchVideo(ga.video,true);ca(ga.info.permalink);}else{this.waitForLoadCount++;this.setLoadingState(da.STATE_IMAGE_DATA,true);}if(this.stream.getCurrentHtml()){this.swapData();}else this.setLoadingState(da.STATE_HTML,true);}},transitionHandler:function(ea){if(ea.getPath()=='/photo.php')if(ea.getQueryData().permPage){o.transitionComplete();return true;}else if(!this.theaterModeOn()&&ea.getQueryData().makeprofile&&ea.getQueryData().fbid==this.stream.getCursor()&&!this.getVideoOnStage()){i.loadModules(['PhotoCropper'],function(fa){fa.start();});o.transitionComplete();return true;}},recacheData:function(ea){if(!this.loadingStates.html){var fa=this.stream.getCurrentHtml();for(var ga in fa){fa[ga]=aa(y(ga).childNodes);if(ea!==true&&ga!=='fbPhotoPageHeader')l.empty(y(ga));}}},getCurrentPhotoInfo:function(){var ea=this.stream.getCurrentImageData();return ea&&ea.info;},getVideoOnStage:function(){var ea=this.stream.getCurrentImageData();return ea&&ea.video;},switchImage:function(ea,fa){k.hide(this.image);k.hide(this.errorBox);var ga=this.stream&&this.stream.getCurrentImageData();if(ga)r.addPhotoView(ga.info);var ha=l.create('img',{id:'fbPhotoImage',className:'fbPhotoImage',alt:'',src:ea});l.replace(this.image,ha);this.image=ha;if(fa)this.stream.preloadImages();},switchVideo:function(ea,fa){var ga='swf_'+ea;if(fa){k.addClass(this.stageWrapper,'showVideo');this.videoStage.id=ea;if(window[ga]&&!ba(ga))window[ga].write(ea);}else{this.videoStage.id='fbPageVideoStage';window[ga].addVariable('video_autoplay',0);l.empty(this.videoStage);k.removeClass(this.stageWrapper,'showVideo');}},swapData:function(){if(this.dataLoadTimer){this.setLoadingState(da.STATE_HTML,true);clearTimeout(this.dataLoadTimer);this.dataLoadTimer=setTimeout(this.clearTimer.bind(this,true),100);return;}var ea,fa=this.stream.getCurrentHtml();if(fa){for(var ga in fa){ea=ba(ga);ea&&l.setContent(ea,fa[ga]);}g.inform('PhotoPermalink.DATA_CHANGE',this.stream.getCurrentImageData().info,g.BEHAVIOR_STATE);if(this.stream.getCurrentExtraData())g.inform('PhotoPermalink.EXTRA_DATA_CHANGE',this.stream.getCurrentExtraData(),g.BEHAVIOR_STATE);this.setLoadingState(da.STATE_HTML,false);this.dataLoadTimer=setTimeout(this.clearTimer.bind(this,false),100);}this.adjustForNewData();},clearTimer:function(ea){this.dataLoadTimer=false;ea&&this.swapData();},adjustForNewData:function(){if(!this.image)return;var ea=l.scry(this.stageWrapper,'div.tagsWrapper')[0],fa=x.getElementDimensions(this.image);if(ea){v.set(ea,'width',fa.x+'px');v.set(ea,'height',fa.y+'px');if(w.ie()<=7){var ga=l.scry(this.root,'div.tagContainer')[0];if(ga)k.conditionClass(ea,'ie7VerticalFix',x.getElementDimensions(ga).y>fa.y);}}},fetchInitBucket:function(ea){if(!this.stream.isLoaded())return;this.stream.fetch(ea,true);},addPhotoFbids:function(ea,fa,ga){var ha=this.stream.getCursor()===null;this.stream.attachToFbidsList(ea,fa,ga);if(ga&&ha)this.page(0);},attachTagger:function(ea){l.appendContent(this.stageActions,ea);},storeFromData:function(ea){var fa=this.stream.storeToCache(ea);if('init' in ea){r.setPhotoSet(this.stream.getPhotoSet());r.setLogFbids(true);r.addPhotoView(this.stream.getCurrentImageData().info);}if('error' in fa){this.checkState(da.STATE_ERROR);return;}if('image' in fa)this.checkState(da.STATE_IMAGE_DATA);if('data' in fa)this.checkState(da.STATE_HTML);},setErrorBoxContent:function(ea){l.setContent(this.errorBox,ea);},updateTotalCount:function(ea,fa,ga){var ha=ba('fbPhotoPagePositionAndCount');ha&&l.setContent(ha,ga);this.stream.setTotalCount(ea);this.stream.setFirstCursorIndex(fa);},buttonListener:function(event){var ea=event.getTarget();if(p.byClass(ea,'likeButton')){l.find(y('fbPhotoPageFeedback'),'button.like_link').click();}else if(p.byClass(ea,'commentButton')){l.find(this.root,'div.commentBox textarea').focus();this.root.scrollTop=this.root.scrollHeight;}},rotateListener:function(event){var ea=event.getTarget();if(p.byClass(ea,'rotateRight')){this.rotate('right');}else if(p.byClass(ea,'rotateLeft'))this.rotate('left');},stageClickListener:function(event){var ea=event.getTarget();if(p.byClass(ea,'fbPhotoTagApprovalBox')){return true;}else if(p.byClass(ea,'videoStage')){return true;}else this.goNav(event);},rotate:function(ea){var fa=this.stream.getCursor();if(this.getVideoOnStage()){var ga=(ea=='left')?270:90;i.loadModules(['VideoRotate'],function(ia){new ia(fa,this.actionList).motionRotate(ga);}.bind(this));return;}var ha=z({fbid:fa,cs_ver:q.VIEWER_PERMALINK},this.stream.getPhotoSetQuery());ha[ea]=1;this.setLoadingState(da.STATE_IMAGE_DATA,true);k.hide(this.image);new h('/ajax/photos/photo/rotate/').setMethod('POST').setAllowCrossPageTransition(true).setReadOnly(false).setData(ha).setFinallyHandler(this.rotateComplete.bind(this,fa)).send();},rotateComplete:function(ea,fa){if(ea==this.stream.getCursor()){this.setLoadingState(da.STATE_IMAGE_DATA,false);this.switchImage(this.stream.getCurrentImageData().url);this.swapData();}},mouseOutListener:function(event){var ea=event.getTarget(),fa=event.getRelatedTarget(),ga=p.byClass(ea,'stageActions'),ha=p.byClass(ea,'stageWrapper'),ia=p.byClass(fa,'stageActions'),ja=p.byClass(fa,'stageWrapper'),ka=(!ja&&(ha&&!ia)||(ga&&!ja));if(ka)this.unhiliteAllTags(true);},mouseMoveListener:function(event){var ea=event.getTarget();if(!p.byClass(ea,'stageActions')&&!p.byClass(ea,'stageWrapper'))return;this.hiliteTagsOnMouseMove(event);},unhiliteAllTags:function(ea,event){l.scry(this.stageWrapper,'div.tagsWrapper div.hover').forEach(function(fa){if(ea&&k.hasClass(fa,'tagBoxPending'))return;k.removeClass(fa,'hover');});if(ea)return;if(this.unhiliteTimer!==null){clearTimeout(this.unhiliteTimer);this.unhiliteTimer=null;}this.hilitedTag=null;},switchHilitedTags:function(ea,fa){this.unhiliteAllTags();var ga=ba(ea);if(ga){this.hilitedTag=ea;k.addClass(ga,'hover');if(k.hasClass(ga,'tagBoxPending')&&!k.hasClass(ga,'showPendingTagName')&&fa===true){l.scry(this.stageWrapper,'div.tagsWrapper div.showPendingTagName').forEach(function(ha){k.removeClass(ha,'showPendingTagName');});k.addClass(ga,'showPendingTagName');}}},hiliteTagsOnMouseMove:function(event){if(!this.stream.getCurrentExtraData()||this.getVideoOnStage())return;if(this.unhiliteTimer!==null)return;var ea=event.getTarget();if(p.byClass(ea,'fbPhotoPageTagApproval'))return;var fa=p.byClass(ea,'tagBoxPending'),ga=(this.hilitedTag&&k.hasClass(y(this.hilitedTag),'tagBoxPending')),ha=((!this.hilitedTag&&fa)||(!ga&&fa));if(ha){this.switchHilitedTags(fa.id);return;}if(fa&&(fa.id==this.hilitedTag))return;var ia=250,ja=t.absoluteToNormalizedPosition(this.image,x.getEventPosition(event)),ka=t.getNearestBox(this.stream.getCurrentExtraData().tagRects,ja);if(!ka){if(!ga){this.unhiliteAllTags();this.reHilitePendingTag();}return;}var la=null;if(ga){var ma={};ma[this.hilitedTag]=this.stream.getCurrentExtraData().tagRects[this.hilitedTag];la=t.getNearestBox(ma,ja);}if(la!==null&&ga)return;if(this.hilitedTag!=ka)if(ga){this.unhiliteTimer=this.unhiliteAllTags.bind(this,false,event).defer(ia);}else this.switchHilitedTags(ka);},updateTagBox:function(ea,fa){this.unhiliteAllTags();var ga=ba(ea);if(!ga)return;k.addClass(ga,'tagBox');k.addClass(ga,'tagBoxPendingResponse');k.removeClass(ga,'tagBoxPending');k.hide(l.find(ga,'span.tagForm'));if(fa){k.show(l.find(ga,'span.tagApproved'));}else k.show(l.find(ga,'span.tagIgnored'));},killDrag:function(){if(k.hasClass(this.root,'taggingMode'))return false;},reset:function(){while(this.pageHandlers&&this.pageHandlers.length)this.pageHandlers.pop().remove();m.getInstance().resetHandlers();},onHiliteTag:function(ea,fa){if(fa.version!=q.VIEWER_PERMALINK)return;var ga=fa.tag;if(ga){this.switchHilitedTags(ga,true);}else this.unhiliteAllTags();},onUpdateTagBox:function(ea,fa){if(fa.version==q.VIEWER_PERMALINK)this.updateTagBox(fa.id,fa.approve);},disableAutoRefresh:function(){clearTimeout(this.timerId);},isInVideoEncodingMode:function(){return this.encodingMode;},enableAutoRefresh:function(ea){this.encodingMode=true;this.timerId=window.location.reload.bind(window.location).defer(ea);},setHasLocation:function(ea){k.conditionClass(this.root,'hasLocation',ea);}});e.exports=da;});
__d("legacy:fb-photos-permalink-js",["PhotoPermalink"],function(a,b,c,d){a.PhotoPermalink=b('PhotoPermalink');},3);
function PhotoPermalinkTagger(a){this.parent.construct(this,PhotoPermalink.getInstance());this.photoData=a;}Class.extend(PhotoPermalinkTagger,'PhotoTagger');copy_properties(PhotoPermalinkTagger.prototype,{elemNames:{0:{addTagLink:'div.fbPhotosPhotoActions',overlayActions:'div.fbPhotosPhotoButtons'}},setupHandlers:function(){var a=$('imagestage'),b=$('fbPhotoPageTagBoxes');this.handlers=[Event.listen(this.clickState,'click',this.addTag.bind(this)),Event.listen(a,'click',this.addTag.bind(this)),Event.listen(b,'click',this.addTag.bind(this)),Event.listen(this.addTagLink,'click',this.checkActions.bind(this)),Event.listen(this.overlayActions,'click',this.checkActions.bind(this))];this.subscriptions=[Arbiter.subscribe('PhotoPermalink.PAGE',this.restartTagging.bind(this)),Arbiter.subscribe('PhotoPermalink.DATA_CHANGE',this.setPhotoData.bind(this))];this.tokenizer.subscribe('addToken',this.saveTag.bind(this));this.tokenizer.subscribe('removeToken',this.removeTag.bind(this));this.tokenizer.subscribe('markTagAsSpam',this.markTagAsSpam.bind(this));},setDataForTokenizer:function(){this.tokenizer.setup(null,this.photoData);return this;}});
__d("PhotoCropper",["event-extensions","function-extensions","Arbiter","CSS","DOM","Form","Photocrop2","PhotoPermalink","copyProperties"],function(a,b,c,d,e,f){b('event-extensions');b('function-extensions');var g=b('Arbiter'),h=b('CSS'),i=b('DOM'),j=b('Form'),k=b('Photocrop2'),l=b('PhotoPermalink'),m=b('copyProperties'),n={initialize:function(o){if(this.photocrop)this.destroy();this.root=l.getInstance().getRoot();this.options=o||{};this.actionLinks=i.find(this.root,'div.fbPhotosPhotoActions');var p=i.scry(this.actionLinks,'a.fbPhotoActionsCrop');if(p.length===0)return;var q=i.find(p[0],'.startCropping');Event.listen(q,'click',function(){this.start();return false;}.bind(this));g.subscribe('PhotoPermalink.PAGE',this.destroy.bind(this),g.SUBSCRIBE_NEW);},start:function(){if(this.photocrop)return;this.cropLink=i.find(this.actionLinks,'a.fbPhotoActionsCrop');h.addClass(this.cropLink,'croppingModeOn');if(h.hasClass(this.cropLink,'profileAlbum')){this.reuseProfilePic.bind(this).defer();return false;}h.addClass(this.root,'croppingMode');var o=i.find(this.root,'img.fbPhotoImage'),p=i.find(this.root,'a.doneCroppingLink'),q=i.find(this.root,'a.cancelCroppingLink'),r=i.find(this.cropLink,'.doneCropping');this.wrapper=i.create('div');h.addClass(this.wrapper,'stageCropper');i.find(this.root,'.stageWrapper').appendChild(this.wrapper);this.wrapper.style.marginTop=o.parentNode.style.marginTop;Event.listen(this.wrapper,'click',this.cancelAndStopEvent.bind(this));Event.listen(p,'click',this.done.bind(this));Event.listen(q,'click',this.cancelAndStopEvent.bind(this));Event.listen(r,'click',this.done.bind(this));var s={target:this.wrapper,min_width:this.options.min_width},t=(function(){this.photocrop=new k(o,s);}).bind(this);if(o.complete){t();}else Event.listen(o,'load',t);return false;},done:function(){var o=l.getInstance().getCurrentPhotoInfo(),p=this.getProfilePicTarget(o).id,q=this.destroy(),r=m({pid:o.pid,owner:o.owner,id:p,'return':'profile.php?id='+p,error_return:'photo.php?pid='+o.pid+'&id='+o.owner},q);j.post('/crop_profile_pic.php',r);return false;},cancelAndStopEvent:function(){this.destroy();return false;},destroy:function(){if(this.photocrop){h.removeClass(this.cropLink,'croppingModeOn');h.removeClass(this.root,'croppingMode');i.remove(this.wrapper);var o=this.photocrop.done();this.photocrop=null;return o;}},reuseProfilePic:function(){var o=l.getInstance().getCurrentPhotoInfo(),p=this.getProfilePicTarget(o),q=m({pid:o.pid,owner:o.owner,id:p.id,type:p.type,profile_pic_id:p.id});j.post('/pic_upload.php',q);return false;},getProfilePicTarget:function(o){if(h.hasClass(this.cropLink,'makePageProfile'))return {id:o.owner,type:'object'};return {id:this.options.uid,type:'profile'};}};e.exports=n;});
__d("PhotoTags",["array-extensions","event-extensions","Arbiter","CSS","DOM","Parent","PhotosConst","copyProperties","ge"],function(a,b,c,d,e,f){b('array-extensions');b('event-extensions');var g=b('Arbiter'),h=b('CSS'),i=b('DOM'),j=b('Parent'),k=b('PhotosConst'),l=b('copyProperties'),m=b('ge');function n(o,p,q){this.tagTargets=o;this.tagBox=p;this.version=q||k.VIEWER_PERMALINK;this.handlers=[];this.tagTargets.forEach(function(r){this.handlers.push(Event.listen(r,{mouseover:this.showTag.bind(this),mouseout:this.hideTags.bind(this)}));}.bind(this));this.subscriptions=[];if(this.version==k.VIEWER_SNOWLIFT)this.subscriptions.push(g.subscribe("PhotoSnowlift.PAGE",this.hideTags.bind(this)));}l(n.prototype,{showTag:function(event){var o=event.getTarget(),p=h.hasClass(o,'taggee'),q=h.hasClass(o,'uiProfilePhotoMedium'),r=null;if(p){r=o.getAttribute('data-tag');}else if(q){var s=j.byTag(o,'a');r=s&&s.getAttribute('data-tag');}var t=this.version==k.VIEWER_PERMALINK?'perm:tag:'+r:'tag:'+r,u=t&&m(t);if(u){h.addClass(u,'showTag');h.addClass(this.tagBox,'showingTag');}},hideTags:function(){h.removeClass(this.tagBox,'showingTag');i.scry(this.tagBox,'div.showTag').forEach(function(o){h.removeClass(o,'showTag');});},destroy:function(){for(var o in this.handlers)this.handlers[o].remove();this.subscriptions.forEach(g.unsubscribe.bind(g));}});e.exports=n;});
__d("legacy:PhotoTags",["PhotoTags"],function(a,b,c,d){a.PhotoTags=b('PhotoTags');},3);
__d("TagToken",["Class","DOM","Token","copyProperties"],function(a,b,c,d,e,f){var g=b('Class'),h=b('DOM'),i=b('Token'),j=b('copyProperties');function k(l){this.parent.construct(this,l,'tag');}g.extend(k,i);j(k.prototype,{createElement:function(){var l=this.isFreeform(),m=h.create('span',{className:'separator'},', '),n=h.create(l?'span':'a',{className:'taggee','data-tag':this.getValue()},this.getText());if(!l)n.href=this.getInfo().path;return h.create('span',{className:'tagItem'},[m,n]);}});e.exports=k;});
__d("TagTokenizer",["Arbiter","Class","CSS","DOM","Input","Parent","PhotosConst","Run","TagToken","Tokenizer","copyProperties","ge","tx"],function(global,require,requireDynamic,requireLazy,module,exports){var Arbiter=require('Arbiter'),Class=require('Class'),CSS=require('CSS'),DOM=require('DOM'),Input=require('Input'),Parent=require('Parent'),PhotosConst=require('PhotosConst'),Run=require('Run'),TagToken=require('TagToken'),Tokenizer=require('Tokenizer'),copyProperties=require('copyProperties'),ge=require('ge'),tx=require('tx');function TagTokenizer(viewer_js,createdbyapp,root,typeahead){this.parent.construct(this,root,typeahead);Arbiter.subscribe('PhotoInlineEditor.CANCEL_INLINE_EDITING',this.updateTokenareaVisibility.bind(this),Arbiter.SUBSCRIBE_NEW);this.appphoto=createdbyapp;Run.onLoad(function(){var viewer=eval(viewer_js);Arbiter.subscribe(viewer.getEventString('DATA_CHANGE'),this.setup.bind(this),Arbiter.SUBSCRIBE_NEW);}.bind(this));}Class.extend(TagTokenizer,Tokenizer);copyProperties(TagTokenizer.prototype,{setup:function(_,info){this.appphoto=info.byapp;this.byowner=info.isowner;return this.reset();},reset:function(){var info=this.getTokenElements().map(this.getTokenDataFromTag.bind(this));this.withTagKeys={};var withKeys=this.getWithTagTokenElements().map(function(elem){return this._tokenKey(this.getTokenDataFromTag(elem));}.bind(this));this.withTagKeys=Object.from(withKeys);Input.reset(this.input);return this.parent.reset(info);},processEvents:function(event,target,element){if(Parent.byClass(target,'remove')){var token=this.getTokenFromElement(element);token=this.addTokenData(token,target);this.removeToken(token);event.kill();}},insertToken:function(token){return null;},removeToken:function(token){if(this.appphoto){return this.replaceToken(token);}else{this.inform('removeToken',token);Arbiter.inform('Form/change',{node:this.element});}},addTokenData:function(token,target){if(Parent.byClass(target,'blockuser'))token.blockUser=true;return token;},getTokenDataFromTag:function(element){return {uid:DOM.find(element,'input').value,text:DOM.getText(DOM.find(element,'.taggee'))};},getTokenElementFromTarget:function(target){return Parent.byClass(target,'tagItem');},getTokenElements:function(){return DOM.scry(this.tokenarea,'span.tagItem').filter(this.filterNonTokenElements.bind(this));},getWithTagTokenElements:function(){return DOM.scry(this.tokenarea,'span.withTagItem');},filterNonTokenElements:function(element){return !CSS.hasClass(element,'markasspam')&&!CSS.hasClass(element,'reported')&&!CSS.hasClass(element,'withTagItem');},createToken:function(info,element){var token=this.getToken(this._tokenKey(info));token=token||new TagToken(info);element&&token.setElement(element);return token;},updateTokenareaVisibility:function(){var visibleTokens=this.getTokenElements().filter(function(elem){return CSS.shown(elem);}),withTagTokens=this.getWithTagTokenElements();CSS.conditionShow(this.tokenarea,visibleTokens.length!==0||withTagTokens.length!==0);},replaceToken:function(token){if(!token)return;var index=this.tokens.indexOf(token);if(index<0)return;this.tokens.splice(this.tokens.indexOf(token),1);delete this.unique[this._tokenKey(token.getInfo())];var el=ge('tagspam'+token.getValue());el&&DOM.remove(el);var newcontent=[' [',"Merkint\u00e4 poistettu.",' '];newcontent.push(DOM.create('a',{onclick:this.markAsSpam.bind(this,token.getValue())},"Merkitse merkint\u00e4 roskapostiksi"));newcontent.push('] ');var newtoken=DOM.create('span',{className:'fbPhotosTaglistTag tagItem markasspam',id:'tagspam'+token.getValue()},newcontent);DOM.replace(token.getElement(),newtoken);this.updateTokenarea();this.inform('removeToken',token);Arbiter.inform('Form/change',{node:this.element});},markAsSpam:function(subject){var el=ge('tagspam'+subject),newcontent=[' [',"Merkint\u00e4 ilmiannettu",'] '],newtoken=DOM.create('span',{className:'fbPhotosTaglistTag tagItem reported',id:'tagspam'+subject},newcontent);DOM.replace(el,newtoken);this.inform('markTagAsSpam',subject);}});module.exports=TagTokenizer;});
__d("TagTypeaheadView",["Class","TypeaheadView","copyProperties"],function(a,b,c,d,e,f){var g=b('Class'),h=b('TypeaheadView'),i=b('copyProperties');function j(k,l){this.parent.construct(this,k,l);this.hintText=l.hintText;this.origAutoSelect=l.autoSelect;this.setSuggestions(l.suggestions);}g.extend(j,h);i(j.prototype,{buildResults:function(k){if(!this.value)k.unshift({subtext:this.hintText,type:'hintText'});var l=this.parent.buildResults(k);if(!this.value)k.shift();return l;},render:function(k,l,m){this.autoSelect=this.origAutoSelect&&k.length;this.disableAutoSelect=k.length===0;this.parent.render(k,l,m);},getItems:function(){var k=this.parent.getItems();if(!this.value)k.shift();return k;},getSuggestions:function(){return this.suggestions;},setSuggestions:function(k){this.suggestions=k||[];this.visible=!!this.suggestions;},addSuggestion:function(k){this.suggestions.unshift(k);}});e.exports=j;});
__d("StickyPlaceholderInput",["event-extensions","CSS","DOM","Parent"],function(a,b,c,d,e,f){b('event-extensions');var g=b('CSS'),h=b('DOM'),i=b('Parent'),j=h.$N;function k(o){return i.byClass(o,'uiStickyPlaceholderInput');}function l(o){return h.scry(o,'.placeholder')[0];}function m(o){o=o||window.event;var p=o.target||o.srcElement;if(h.isNodeOfType(p,['input','textarea'])){var q=k(p);if(q){var r=o.type;(function(){if(r=='keydown'&&p.value.length)g.removeClass(q,'uiStickyPlaceholderEmptyInput');if((r=='blur'||r=='focusout')&&!p.value.length)g.addClass(q,'uiStickyPlaceholderEmptyInput');}).defer();}}}var n={init:function(){n.init=bagofholding;Event.listen(document.documentElement,'keydown',m);if(document.documentElement.addEventListener){document.documentElement.addEventListener('blur',m,true);}else Event.listen(document.documentElement,'focusout',m);},registerInput:function(o){n.init();var p=o.getAttribute('placeholder')||'';if(p.length)if(document.activeElement===o){var q=Event.listen(o,'blur',function(){n.manipulateInput(o,p);q.remove();});}else n.manipulateInput(o,p);},manipulateInput:function(o,p){var q=j('div',{className:'placeholder',ariaHidden:true},p),r=j('div',{className:'uiStickyPlaceholderInput'},q);if(h.isNodeOfType(o,'textarea'))g.addClass(r,'uiStickyPlaceholderTextarea');Event.listen(q,'click',function(){o.focus();});if(o.value===p)o.value='';g.removeClass(o,'DOMControl_placeholder');o.setAttribute('placeholder','');h.replace(o,r);h.appendContent(r,o);g.conditionClass(r,'uiStickyPlaceholderEmptyInput',!o.value.length);},setPlaceholderText:function(o,p){var q=k(o),r=l(q);r&&h.setContent(r,p);},getPlaceholderText:function(o){var p=k(o),q=l(p);return q&&h.getText(q);},update:function(o){var p=k(o);if(p)g.conditionClass(p,'uiStickyPlaceholderEmptyInput',!o.value.length);},getVisibleText:function(o){var p=k(o);if(g.hasClass(p,'uiStickyPlaceholderEmptyInput')){var q=l(p);return q&&h.getText(q);}else return o.value;}};e.exports=n;});
__d("legacy:StickyPlaceholderInput",["StickyPlaceholderInput"],function(a,b,c,d){a.StickyPlaceholderInput=b('StickyPlaceholderInput');},3);
add_properties('TokenizerBehaviors',{freeform:function(a,b){var c=b.tokenize_on_blur!==false,d=b.tokenize_on_paste!==false,e=b.matcher&&new RegExp(b.matcher,'i');function f(event){var g=Input.getValue(a.getInput()).trim();if(g&&(!e||e.test(g))){var h={uid:g,text:g,freeform:true};a.addToken(a.createToken(h));if(event){a.getTypeahead().getCore().afterSelect();event.kill();}}}a.subscribe('keydown',function(g,h){var event=h.event,i=Event.getKeyCode(event);if(i==KEYS.COMMA||i==KEYS.RETURN){var j=a.getTypeahead().getView();if(j.getSelection()){j.select();event.kill();}else f(event);}});a.subscribe('paste',function(g,h){if(d)f.bind(null,h.event).defer(20);});a.subscribe('blur',function(g,h){if(c)f();a.getTypeahead().getCore().reset();});}});
__d("TypeaheadHintText",["copyProperties"],function(a,b,c,d,e,f){var g=b('copyProperties');function h(i){this._typeahead=i;}g(h.prototype,{enable:function(){this._typeahead.getCore().resetOnKeyup=false;},disable:bagofholding});e.exports=h;});
__d("legacy:HintTextTypeaheadBehavior",["TypeaheadHintText"],function(a,b,c,d){var e=b('TypeaheadHintText');if(!a.TypeaheadBehaviors)a.TypeaheadBehaviors={};a.TypeaheadBehaviors.hintText=function(f){f.enableBehavior(e);};},3);
__d("TypeaheadRequireSelection",["event-extensions","copyProperties"],function(a,b,c,d,e,f){b('event-extensions');var g=b('copyProperties');function h(i){this._typeahead=i;}g(h.prototype,{_subscription:null,_eventListener:null,enable:function(){var i=this._typeahead.getCore(),j=i.getElement().form;function k(){!i.getHiddenValue()&&i.reset();}k();this._subscription=i.subscribe('blur',k);if(j)this._eventListener=Event.listen(j,'submit',k);},disable:function(){this._typeahead.getCore().unsubscribe(this._subscription);this._subscription=null;if(this._eventListener){this._eventListener.remove();this._eventListener=null;}}});e.exports=h;});
__d("legacy:RequireSelectionTypeaheadBehavior",["TypeaheadRequireSelection"],function(a,b,c,d){var e=b('TypeaheadRequireSelection');if(!a.TypeaheadBehaviors)a.TypeaheadBehaviors={};a.TypeaheadBehaviors.requireSelection=function(f){f.enableBehavior(e);};},3);