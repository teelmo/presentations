/*1337638944,176820662*/

if (window.CavalryLogger) { CavalryLogger.start_js(["94Qud"]); }

__d("ChatTabSheetView",["event-extensions","Animation","ChatTabSheetPolicy","CSS","DOM","Style","Vector","copyProperties","ChatTabTemplates"],function(a,b,c,d,e,f){b('event-extensions');var g=b('Animation'),h=b('ChatTabSheetPolicy'),i=b('CSS'),j=b('DOM'),k=b('Style'),l=b('Vector'),m=b('copyProperties'),n=c('ChatTabTemplates'),o=5000,p=function(q,r,s){this._threadID=q;this._rootElement=r;this._tabMainElement=s;this._openSheet=null;};m(p.prototype,{destroy:function(){j.empty(this._rootElement);},_openCommon:function(q,r){if(this._openSheet&&!h.canReplaceOpenSheet(this._openSheet,q))return;this.clear(function(){this._openSheet=q;var s=n[':fb:mercury:chat:tab-sheet:loading'].build().getRoot();j.setContent(this._rootElement,s);i.show(s);i.show(this._rootElement);q.render();if(r){i.addClass(this._tabMainElement,'sheetSlide');var t=l.getElementDimensions(this._rootElement).y;k.set(this._rootElement,'bottom',t+'px');this._animation=new g(this._rootElement).to('bottom',0).duration(150).ease(g.ease.both).ondone(function(){i.removeClass(this._tabMainElement,'sheetSlide');}.bind(this)).go();}if(!q.isPermanent()){var u=o;if(q.getCloseTimeout)u=q.getCloseTimeout();this._sheetCloseHandler=this.close.bind(this,q).defer(u,false);}}.bind(this));},set:function(q){return this._openCommon(q,false);},open:function(q){return this._openCommon(q,true);},close:function(q,r){if(this._openSheet!=q)return;if(!this._openSheet){r&&r();return;}if(this._animation)this._animation.stop();if(this._sheetCloseHandler){clearTimeout(this._sheetCloseHandler);this._sheetCloseHandler=null;}i.addClass(this._tabMainElement,'sheetSlide');var s=l.getElementDimensions(this._rootElement).y;this._animation=new g(this._rootElement).to('bottom',s+'px').duration(100).ease(g.ease.begin).ondone(function(){j.empty(this._rootElement);i.hide(this._rootElement);i.removeClass(this._tabMainElement,'sheetSlide');this._openSheet=null;r&&r();}.bind(this)).go();},clear:function(q){this.close(this._openSheet,q);}});e.exports=p;});
__d("MercuryTypingReceiver",["Arbiter","ChannelConstants","MercuryParticipants","MercuryServerRequests","MercuryThreads","TypingDetector","setTimeoutAcrossTransitions","MercuryConstants"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('ChannelConstants'),i=b('MercuryParticipants'),j=b('MercuryServerRequests'),k=b('MercuryThreads'),l=b('TypingDetector'),m=b('setTimeoutAcrossTransitions'),n=c('MercuryConstants'),o,p={},q=30000,r=new g();function s(){return new Date().getTime();}function t(){o=null;var w=s(),x={};for(var y in p)if(p[y]<w-q){delete p[y];x[y]=false;}for(var z in x){r.inform('state-changed',x);break;}for(z in p){o=m(t,3000);return;}}function u(w){if(w in p){delete p[w];v(w);}}function v(w){var x={};x[w]=w in p;r.inform('state-changed',x);}g.subscribe(h.getArbiterType('typ'),function(w,x){var y=x.obj,z='user:'+y.from;if(y.st==l.TYPING){var aa=z in p;p[z]=s();if(!o)o=m(t,3000);!aa&&v(z);}else if(y.st==l.INACTIVE)u(z);});j.subscribe('update-typing-state',function(w,x){var y=x.payload_source;if(y!=n.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE)return;var z=x.actions;if(!z||!z.length)return;var aa=n.MercuryActionType.USER_GENERATED_MESSAGE;z.forEach(function(ba){var ca=ba.thread_id;if(ba.action_type==aa&&k.getCanonicalUserInThread(ca)&&ba.author!=i.user)u(ca);});});e.exports=r;});
__d("cx",[],function(a,b,c,d,e,f){function g(h){throw new Error('cx(...): Unexpected class transformation.');}e.exports=g;});
__d("StickyArea",["event-extensions","ContextualLayer","CSS","DataStore","DOM","LayerHideOnTransition","Style","Vector","copyProperties","cx"],function(a,b,c,d,e,f){b('event-extensions');var g=b('ContextualLayer'),h=b('CSS'),i=b('DataStore'),j=b('DOM'),k=b('LayerHideOnTransition'),l=b('Style'),m=b('Vector'),n=b('copyProperties'),o=b('cx');function p(r){var s=l.getScrollParent(r.parentNode);this.node=r;this._extracted=false;this._placeholder=j.create('div',{className:"cx-uiStickyArea__placeholder"});q.getInstance(s).register(this);}n(p.prototype,{update:function(){if(this._extracted){m.getElementDimensions(this._placeholder).setElementWidth(this.node);m.getElementDimensions(this.node).setElementHeight(this._placeholder);}else m.getElementDimensions(this.node).setElementWidth(this.node).setElementHeight(this._placeholder);return this;},setExtracted:function(r){if(r===this._extracted)return this;if(r){this.update();j.replace(this.node,this._placeholder);}else{l.set(this.node,'height',null);l.set(this.node,'width',null);j.replace(this._placeholder,this.node);}this._extracted=r;return this;},getOffsetTop:function(){return (this._extracted?this._placeholder:this.node).offsetTop;}});function q(r){this.node=r;this._areas=[];this._fixTarget=null;this._fixedArea=null;this._initialized=false;this._layer=new g({},j.create('div')).setInsertParent(this.node.parentNode).disableBehavior(k);this._listener=Event.listen(r,'scroll',this.update.bind(this));h.addClass(r,"cx-uiStickyArea__container");i.set(r,'StickyContainer',this);}q.getInstance=function(r){var s=i.get(r,'StickyContainer');return s||new q(r);};n(q.prototype,{isDisplayed:function(){return this.node.offsetParent!==null;},register:function(r){this._areas.push(r);return this;},update:function(){if(!this.isDisplayed())return this;var r=null,s=this,t=this.node.scrollTop;for(var u=0;u<this._areas.length;u++){var v=this._areas[u],w=v.getOffsetTop();if(w<=t){r=v;}else if(r){var x=m.getElementDimensions(r.node).y;if(w-x<t)s=v;break;}}this._init();if(this._fixedArea===r&&this._fixTarget===s){this._fixedArea&&this._fixedArea.update();}else{if(this._fixedArea&&this._fixedArea!==r)this._unfixArea(this._fixedArea);if(r)this._fixAreaTo(r,s);this._fixedArea=r;this._fixTarget=s;}return this;},destroy:function(){this._listener&&this._listener.remove();this._listener=null;},_init:function(){if(this._initialized)return;this._initialized=true;this._layer.updatePosition();},_fixAreaTo:function(r,s){this._layer.hide();r.setExtracted(true);if(s instanceof q){this._layer.setInsertParent(this.node.parentNode).setContext(this.node);}else this._layer.setInsertParent(this.node).setContext(s.node);this._layer.setContent(r.node).show();},_unfixArea:function(r){this._layer.hide();r.setExtracted(false);}});e.exports=p;});
__d("Dock",["event-extensions","function-extensions","Arbiter","ArbiterMixin","ChatQuietLinks","CSS","DataStore","DOM","Parent","Style","Toggler","Vector","copyProperties","ge"],function(a,b,c,d,e,f){b('event-extensions');b('function-extensions');var g=b('Arbiter'),h=b('ArbiterMixin'),i=b('ChatQuietLinks'),j=b('CSS'),k=b('DataStore'),l=b('DOM'),m=b('Parent'),n=b('Style'),o=b('Toggler'),p=b('Vector'),q=b('copyProperties'),r=b('ge');function s(){}q(s,h,{MIN_HEIGHT:140,INITIAL_FLYOUT_HEIGHT_OFFSET:10,init:function(t){this.init=bagofholding;this.rootEl=t;this.calculateViewportDimensions();this.calculateFlyoutHeightOffset();i.silence(this.rootEl);Event.listen(t,'click',this._onClick.bind(this));Event.listen(window,'resize',this._onWindowResize.bind(this));o.subscribe(['show','hide'],function(u,v){var w=v.getActive();if(!l.contains(t,w))return;if(j.hasClass(w,'fbNub')){this.notifyNub(w,u);if(u==='show')this._resizeNubFlyout(w);}else{var x=m.byClass(w,'fbNubFlyout');if(x)j.conditionClass(x,'menuOpened',u==='show');}}.bind(this));this.inform('init',{},g.BEHAVIOR_PERSISTENT);},calculateViewportDimensions:function(){return (this.viewportDimensions=p.getViewportDimensions());},calculateFlyoutHeightOffset:function(){this.flyoutHeightOffset=this.INITIAL_FLYOUT_HEIGHT_OFFSET+p.getElementDimensions(this.rootEl).y;var t=r('blueBar');if(t){var u=n.isFixed(t)?'viewport':'document';this.flyoutHeightOffset+=p.getElementPosition(t,u).y+p.getElementDimensions(t).y;}},toggle:function(t){var u=this._findFlyout(t);if(!u)return;this.subscribe('init',function(){o.toggle(t);});},show:function(t){this.subscribe('init',function(){o.show(t);});},showNub:function(t){j.show(t);},hide:function(t){this.subscribe('init',function(){var u=o.getInstance(t);l.contains(t,u.getActive())&&u.hide();});},hideNub:function(t){j.hide(t);this.hide(t);},setUseMaxHeight:function(t,u){j.conditionClass(t,'maxHeight',u!==false);this._resizeNubFlyout(t);},_resizeNubFlyout:function(t){var u=this._findFlyout(t);if(!u||!(j.hasClass(t,'openToggler')||j.hasClass(t,'opened')))return;var v=l.find(u,'div.fbNubFlyoutOuter'),w=l.find(v,'div.fbNubFlyoutInner'),x=l.find(w,'div.fbNubFlyoutBody'),y=x.scrollTop,z=x.offsetHeight;n.set(x,'height','auto');var aa=p.getElementPosition(u,'viewport'),ba=p.getElementDimensions(u),ca=p.getElementDimensions(x),da=Math.max(this.MIN_HEIGHT,this.viewportDimensions.y-this.flyoutHeightOffset)-(this.viewportDimensions.y-aa.y-ba.y);da=Math.max(da,0);n.set(u,'max-height',da+'px');n.set(v,'max-height',da+'px');ba=p.getElementDimensions(u);var ea=p.getElementDimensions(w),fa=ea.y-ca.y;if(ba.y>fa)n.set(x,'height',(ba.y-fa)+'px');j.removeClass(u,'swapDirection');var ga=p.getElementPosition(u).x;j.conditionClass(u,'swapDirection',function(){if(ga<0)return true;return (ga+ba.x>this.viewportDimensions.x);}.bind(this)());if(y+z>=ca.y){x.scrollTop=ca.y;}else x.scrollTop=y;this.notifyNub(t,'resize');},resizeAllFlyouts:function(){var t=l.scry(this.rootEl,'div.fbNub.openToggler');t=t.concat(l.scry(this.rootEl,'div.fbNub.opened'));var u=t.length;while(u--)this._resizeNubFlyout(t[u]);},_onClick:function(event){var t=event.getTarget(),u=m.byClass(t,'fbNub');if(u){if(m.byClass(t,'fbNubFlyoutTitlebar')){var v=m.byTag(t,'a');if(!v){this.hide(u);return false;}}this.notifyNub(u,'click');}},_onWindowResize:function(event){this.calculateViewportDimensions();this.resizeAllFlyouts();},_findFlyout:function(t){return j.hasClass(t,'fbNubFlyout')?t:l.scry(t,'div.fbNubFlyout')[0]||null;},registerNubController:function(t,u){k.set(t,'dock:nub:controller',u);u.subscribe('nub/button/content-changed',this.inform.shield(this,'resize',t));u.subscribe('nub/flyout/content-changed',this._resizeNubFlyout.shield(this,t));},unregisterNubController:function(t){k.remove(t,'dock:nub:controller');},notifyNub:function(t,u,v){var w=k.get(t,'dock:nub:controller');w&&w.inform(u,v);}});e.exports=a.Dock||s;});
__d("legacy:dock",["Dock"],function(a,b,c,d){a.Dock=b('Dock');},3);
__d("NubController",["ArbiterMixin","Class","Dock","copyProperties"],function(a,b,c,d,e,f){var g=b('ArbiterMixin'),h=b('Class'),i=b('Dock'),j=b('copyProperties');function k(){}j(k.prototype,g,{init:function(l){this.el=l;i.registerNubController(l,this);return this;},buttonContentChanged:function(){this.inform('nub/button/content-changed');},flyoutContentChanged:function(){this.inform('nub/flyout/content-changed');},hide:function(){i.hide(this.el);},show:function(){i.show(this.el);}});e.exports=k;});
__d("ChatActivity",["Arbiter","AvailableList","AvailableListConstants","ChatConfig","copyProperties","event-extensions","JSLogger","math-extensions","MercuryThreads","PresenceState","UserActivity"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('AvailableList'),i=b('AvailableListConstants'),j=b('ChatConfig'),k=b('copyProperties');b('event-extensions');var l=b('JSLogger'),m=b('math-extensions'),n=b('MercuryThreads'),o=b('PresenceState'),p=b('UserActivity'),q=j.get('activity_limit')||60000,r=j.get('idle_limit')||1800000,s=j.get('idle_poll_interval')||300000,t=l.create('chat_activity'),u=Date.now(),v=u,w=true;function x(){var ba=Date.now();return !!(w&&(ba-u<q));}var y=k(new g(),{isActive:x});function z(){var ba=u;u=Date.now();if(u-ba>r){t.debug('idle_to_active',ba);o.doSync();}y.inform('activity');}h.subscribe(i.ON_AVAILABILITY_CHANGED,function(){if(!h.isUserIdle())v=Date.now();});Event.listen(window,'focus',function(){w=true;z();});Event.listen(window,'blur',function(){w=false;});p.subscribe(function(){z();});function aa(ba){var ca=ba&&ba.at&&m.verifyNumber(ba.at);if(typeof ca!=='number')ca=null;return ca||0;}setInterval(function(){var ba=Date.now(),ca=aa(o.get()),da=Math.max(u,ca,v);if(ba-da>r){t.debug('idle',{cookie:ca,local:u,presence:v});y.inform('idle',ba-da);}},s);o.registerStateStorer(function(ba){var ca=aa(ba);if(ca<u)ba.at=u;return ba;});g.subscribe(l.DUMP_EVENT,function(ba,ca){ca.chat_activity={activity_limit:q,idle_limit:r,idle_poll_interval:s,last_active_time:u,last_global_active_time:v};});e.exports=y;});
__d("ChatTabPresence",["Arbiter","AvailableList","ChatTabModel","MercuryThreads"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('AvailableList'),i=b('ChatTabModel'),j=b('MercuryThreads'),k={};function l(m){var n=j.getCanonicalUserInThread(m);if(n)h.updateForID(n);}i.subscribe('chat/tabs-changed',function(event,m){m.tabs.forEach(function(n){if(n.raised&&!k[n.id])l(n.id);});k={};m.tabs.forEach(function(n){if(n.raised)k[n.id]=true;});});e.exports={};},3);
__d("ChatTabViewSelector",["Arbiter","copyProperties","CSS","DataStore","DOM","Menu","MercuryThreadInformer","MercuryThreads","NubController","MercuryThreadMetadataRenderer","Toggler","ChatTabTemplates"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('copyProperties'),i=b('CSS'),j=b('DataStore'),k=b('DOM'),l=b('Menu'),m=b('MercuryThreadInformer'),n=b('MercuryThreads'),o=b('NubController'),p=b('MercuryThreadMetadataRenderer'),q=b('Toggler'),r=c('ChatTabTemplates');function s(t){var u=r[':fb:chat:tab:selector'].build(),v=u.getRoot(),w=u.getNode('menu'),x=k.find(w,'.uiMenuInner'),y={},z=new o().init(v);i.hide(v);k.insertBefore(t,v);function aa(da){var ea=0;for(var fa in y){var ga=y[fa],ha=n.getThreadMetaNow(fa),ia=ga.getNode('unreadCount'),ja=(ha&&ha.unread_count)||0;ea+=ja;if(ja>9)ja='+';i.conditionClass(ia,'invisible_elem',!ja);k.setContent(ia,ja);}var ka=u.getNode('numMessages');i.conditionShow(ka,ea);k.setContent(ka,ea);}this.setTabData=function(da){y={};if(da.length<1){i.hide(v);return;}i.show(v);k.empty(x);da.forEach(function(ea){var fa=r[':fb:chat:tab:selector:item'].build();y[ea.id]=fa;var ga=fa.getNode('content');p.renderAndSeparatedParticipantList(ea.id,ga);k.prependContent(x,fa.getRoot());j.set(fa.getRoot(),'threadID',ea.id);});z.flyoutContentChanged();k.setContent(u.getNode('numTabs'),da.length);aa();};function ba(event,da){if(da.menu!=w)return;var ea=j.get(da.item,'threadID');s.inform('selected',ea);q.hide(v);}function ca(event,da){l.register(w);}l.subscribe('select',ba.bind(this));q.listen('show',v,function(){g.inform('layer_shown',{type:'ChatTabSelector'});ca();});q.listen('hide',v,function(){g.inform('layer_hidden',{type:'ChatTabSelector'});});m.subscribe('threads-updated',aa);}h(s,new g());e.exports=s;});
__d("ChatBrowserNotificationHandler",["ChatConfig","ChatOptions","ChatTabViewSelector","MercuryThreadInformer","MercuryParticipants","Run"],function(a,b,c,d,e,f){var g=b('ChatConfig'),h=b('ChatOptions'),i=b('ChatTabViewSelector'),j=b('MercuryThreadInformer'),k=b('MercuryParticipants'),l=b('Run'),m={},n=false;function o(){return a.chrome&&a.chrome.app&&!!a.chrome.app.getDetails();}var p={display:function(q){if(window.webkitNotifications&&window.webkitNotifications.checkPermission()===0&&h.getSetting('browser_notif')&&g.get('chat_browser_notifications')&&!o()){if(!n){this._initialize();n=true;}k.get(q.author,function(r){var s=window.webkitNotifications.createHTMLNotification('/desktop_notifications/get.php?type=inbox&unlinked=true');s.onclick=function(){window.focus();i.inform('selected',q.thread_id);s.cancel();m[q.thread_id]=null;}.bind(this);m[q.thread_id]=s;s.replaceId='com.facebook.alert.inbox.'+q.thread_id;s.show();}.bind(this));}},_initialize:function(){j.subscribe('thread-read-changed',function(q,r){for(var s in r){var t=m[s];if(t){t.cancel();m[s]=null;}}}.bind(this));l.onUnload(function(){for(var q in m)m[q].cancel();});}};e.exports=p;});
__d("ChatSound",["ChatOptions","MercuryParticipants","Sound"],function(a,b,c,d,e,f){var g=b('ChatOptions'),h=b('MercuryParticipants'),i=b('Sound');i.init(['audio/ogg','audio/mpeg']);function j(k){i.play(['/sound/pling.ogg','/sound/pling.mp3'],k,false);}e.exports={messageReceived:function(k){if(g.getSetting('sound')&&k.sender!=h.user)j(k.timestamp);}};});
__d("VideoCallPromo",["ArbiterMixin","AsyncRequest","AvailableList","AvailableListConstants","ChatConfig","ChatVisibility","ContextualDialogX","copyProperties","CSS","MercuryThreads","MercuryParticipants","VideoCallCore","ChatTabTemplates"],function(a,b,c,d,e,f){var g=b('ArbiterMixin'),h=b('AsyncRequest'),i=b('AvailableList'),j=b('AvailableListConstants'),k=b('ChatConfig'),l=b('ChatVisibility'),m=b('ContextualDialogX'),n=b('copyProperties'),o=b('CSS'),p=b('MercuryThreads'),q=b('MercuryParticipants'),r=c('ChatTabTemplates'),s=b('VideoCallCore');function t(){this._dialog=null;}function u(w){if(!(s.isSupported()&&k.get('video.show_promo')))return false;var x=p.getCanonicalUserInThread(w);if(!x)return false;return l.isOnline()&&s.availableForCall(x);}function v(w){new h().setURI('/ajax/chat/video/log_promo.php').setData({viewedUserID:w}).setAllowCrossPageTransition(true).setErrorHandler(bagofholding).send();}n(t.prototype,g);n(t.prototype,{render:function(w,x){var y=u(x);if(!y)return;var z=p.getCanonicalUserInThread(x);q.get('fbid:'+z,function(aa){if(!aa.call_promo)return;var ba=r[':fb:mercury:call:promo'].build();this._dialog=new m();this._dialog.init(ba.getRoot()).setWidth(250).setAlignH('center').setContext(w).show();o.addClass(this._dialog.getRoot(),'uiContextualDialogWithFooterArrowBottom');o.addClass(w,'video_call_promo');v(p.getCanonicalUserInThread(x));this.inform('chat/dialog-rendered',{dialog:this,thread_id:x});}.bind(this));},updatePosition:function(){if(this._dialog&&this._dialog.isShown())this._dialog.updatePosition();},hide:function(){if(this._dialog&&this._dialog.isShown()){this._dialog.hide();this._dialog=null;}}});e.exports=t;});
__d("VideoCallTourDialog",["ArbiterMixin","ContextualDialogX","copyProperties","CSS","MercuryThreads","VideoCallCore","VideoCallingTour","ChatTabTemplates"],function(a,b,c,d,e,f){var g=b('ArbiterMixin'),h=b('ContextualDialogX'),i=b('copyProperties'),j=b('CSS'),k=b('MercuryThreads'),l=c('ChatTabTemplates'),m=b('VideoCallCore'),n=b('VideoCallingTour');function o(){this._dialog=null;}i(o.prototype,g);i(o.prototype,{render:function(p,q){var r=k.getCanonicalUserInThread(q);if(!r||!m.availableForCall(r))return;var s=l[':fb:mercury:call:tour'].build();this._dialog=new h();this._dialog.init(s.getRoot()).setWidth(250).setAlignH('center').setContext(p).show();j.addClass(this._dialog.getRoot(),'uiContextualDialogWithFooterArrowBottom');j.addClass(p,'video_call_tour');this.inform('chat/dialog-rendered',{dialog:this,thread_id:q});n.inform('videocallingtour/end');},updatePosition:function(){if(this._dialog&&this._dialog.isShown())this._dialog.updatePosition();},hide:function(){if(this._dialog&&this._dialog.isShown()){this._dialog.hide();this._dialog=null;}}});e.exports=o;});
__d("ChatContextualDialogController",["ArbiterMixin","ChatTabModel","copyProperties","setTimeoutAcrossTransitions","VideoCallPromo","VideoCallingTour","VideoCallTourDialog"],function(a,b,c,d,e,f){var g=b('ArbiterMixin'),h=b('ChatTabModel'),i=b('copyProperties'),j=b('setTimeoutAcrossTransitions'),k=b('VideoCallPromo'),l=b('VideoCallingTour'),m=b('VideoCallTourDialog'),n=60000,o=false,p=false,q=function(x,y){this._videoCallPromo=new k();this._videoCallTour=new m();this._threadID=x;this._tabMainElement=y;this._openDialog=null;this._subscriptionTokens=[];this._scrollListener=null;this._timeout=null;};function r(x,event,y){if(x._openDialog)x._openDialog.updatePosition();}function s(x){if(x._openDialog)x._openDialog.updatePosition();}function t(x){if(x._openDialog){x._openDialog.hide();x._openDialog=null;}if(x._timeout){clearTimeout(x._timeout);x._timeout=null;}while(x._subscriptionTokens.length)x._subscriptionTokens.pop().unsubscribe();if(x._scrollListener){x._scrollListener.remove();x._scrollListener=null;}}function u(x,event,y){if(y.thread_id===x._threadID){x._openDialog=y.dialog;o=true;w(x);x._timeout=j(x.destroy.bind(x,x._threadID),n);x._scrollListener=Event.listen(window,'scroll',s.curry(x));}}function v(x,y){if(!x._openDialog){x._subscriptionTokens.push(y.subscribe('chat/dialog-rendered',u.curry(x)));y.render(x._tabMainElement,x._threadID);}}function w(x){x._subscriptionTokens.push(h.subscribe('chat/tabs-changed',r.curry(x)),q.subscribe('dialog/close-all',t.curry(x)));}i(q,g);i(q.prototype,{destroy:function(){t(this);},tabFocused:function(){if(p){v(this,this._videoCallTour);return;}if(!o)v(this,this._videoCallPromo);},tabNotActive:function(){t(this);},hideVideoCallouts:function(){t(this);}});l.subscribe('videocallingtour/start',function(){p=true;q.inform('dialog/close-all');});l.subscribe('videocallingtour/end',function(){p=false;});e.exports=q;});
__d("ChatPrivacyActionController",["Arbiter","ChatVisibility","JSLogger","PresencePrivacy","copyProperties"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('ChatVisibility'),i=b('JSLogger'),j=b('PresencePrivacy'),k=b('copyProperties'),l=function(m,n){this._userID=m;this._logger=i.create('blackbird');this._getState=function(){if(h.isOnline())return j.allows(this._userID)?l.NORMAL:l.BLOCKED;return l.OFFLINE;};this._togglePrivacy=function(){var o=this._getState();switch(this._getState()){case l.OFFLINE:if(h.isOnline()){this._logger.error('tabs_already_online');break;}this._logger.log('tabs_go_online',{tab_id:this._userID});h.goOnline(function(){if(!j.allows(this._userID)){if(this._getState()!==l.BLOCKED)this._logger.error('privacy_action_controller_blocked_inconsistency');this._togglePrivacy();}}.bind(this));break;case l.BLOCKED:j.allow(this._userID);this._logger.log('tabs_unblock',{tab_id:this._userID});break;case l.NORMAL:j.disallow(this._userID);this._logger.log('tabs_block',{tab_id:this._userID});break;}};(function(){var o=function(){n&&n(this._getState());}.bind(this);o();j.subscribe('privacy-changed',o);}.bind(this)).defer();};l.OFFLINE='offline';l.BLOCKED='blocked';l.NORMAL='normal';k(l.prototype,{togglePrivacy:function(){this._logger.log('gear_menu_toggle_privacy',{tab_id:this._userID});this._togglePrivacy();}});e.exports=l;});
__d("MercuryLiveListenMessageRenderer",["CSS","DOM","Env","JSLogger","MercuryConstants"],function(a,b,c,d,e,f){var g=b('CSS'),h=b('DOM'),i=b('Env'),j=b('JSLogger'),k=c('MercuryConstants'),l=k.MusicLiveListenCommands,m=j.create('live_listen_renderer');function n(u,v){return h.$N('a',{href:u},v);}function o(u){var v=u.actor;if(v.id==i.user){return h.tx._("Kuuntelet nyt musiikkia henkil\u00f6n {name} kanssa.",{name:n(v.leader_profile_url,v.leader_name)});}else if(v.leader_id==i.user)return h.tx._("{name} kuuntelee musiikkia kanssasi.",{name:n(v.url,v.name)});}function p(u){var v=u.actor,w=n(v.url,v.name),x=n(v.leader_profile_url,v.leader_name),y=v.action===l.LISTENER_ADD,z=i.user==v.id,aa=i.user==v.leader_id;if(y){if(z){return h.tx._("Kuuntelet nyt musiikkia henkil\u00f6n {name} kanssa.",{name:x});}else return h.tx._("{name} alkoi kuunnella.",{name:w});}else if(v.leader_id==v.id&&!aa){return h.tx._("{name} poistui viestiketjusta. Et kuule en\u00e4\u00e4 h\u00e4nen toistamaansa musiikkia.",{name:x});}else if(z&&v.id!=v.leader_id){return h.tx._("Et en\u00e4\u00e4 kuuntele musiikkia henkil\u00f6n {name} kanssa.",{name:x});}else if(!z){return h.tx._("{name} lopetti kuuntelun.",{name:w});}else return '';}function q(u){return h.$N('span',{},[h.$N('strong',{},u.title),h.$N('br'),u.body]);}function r(){var u=null;if(a.MusicLiveListen){var v=a.MusicLiveListen.getInstance().getCurrentSession();u=v&&v.provider_name;}return u||'Spotify';}function s(u){var v=r(),w=n(u.url,u.title);w.target='_blank';var x=n(u.artist_url,u.artist);return h.tx._("{title} artistilta {artist} palvelussa {provider}",{title:w,artist:x,provider:v});}var t={getIconSpriteClass:function(u){var v=u.log_message_data;if(v)switch(v.music_type){case 'begin_session':return 'addActionIcon';case 'listener_update':if(v.actor)if(v.actor.action===l.LISTENER_ADD){return 'addActionIcon';}else return 'leaveActionIcon';break;case 'song':return 'songIcon';case 'play_error':return 'playErrorIcon';}m.error('bad_message',u);return null;},getLogMessageText:function(u){var v=u.log_message_data;if(v)switch(v.music_type){case 'begin_session':return o(v);case 'listener_update':return p(v);case 'song':return s(v);case 'play_error':return q(v);}m.error('bad_message',u);return '';}};e.exports=t;});
__d("MercuryMessageRenderer",["CSS","DOM","Emote","HTML","htmlHyperlink","MercuryLiveListenMessageRenderer","MercuryParticipants","tx","MercuryConstants"],function(a,b,c,d,e,f){var g=b('CSS'),h=b('DOM'),i=b('Emote'),j=b('HTML'),k=b('htmlHyperlink'),l=b('MercuryLiveListenMessageRenderer'),m=b('MercuryParticipants'),n=c('MercuryConstants'),o=b('tx'),p={renderLogMessage:function(ca,da,ea){q(ca,ea);r(da,ea);},formatMessageBody:function(ca){ca=(ca||'').replace(/\n+$/,'');ca=k(ca,i.htmlEmote,null,true);return j(ca);}};function q(ca,da){var ea='';switch(da.log_message_type){case n.MercuryLogMessageType.SUBSCRIBE:ea='MercurySubscribeIcon';break;case n.MercuryLogMessageType.UNSUBSCRIBE:ea='MercuryUnsubscribeIcon';break;case n.MercuryLogMessageType.THREAD_NAME:ea='MercuryThreadNameIcon';break;case n.MercuryLogMessageType.THREAD_IMAGE:ea='MercuryThreadImageIcon';break;case n.MercuryLogMessageType.VIDEO_CALL:var fa=da.log_message_data.answered;if(fa||ba(da)){ea='MercuryVideoCallIcon';}else ea='MercuryMissedVideoCallIcon';break;case n.MercuryLogMessageType.SERVER_ERROR:ea='MercuryErrorIcon';break;case n.MercuryLogMessageType.LIVE_LISTEN:ea=l.getIconSpriteClass(da);break;}g.addClass(ca,ea);}function r(ca,da){switch(da.log_message_type){case n.MercuryLogMessageType.SUBSCRIBE:y(ca,da);break;case n.MercuryLogMessageType.UNSUBSCRIBE:z(ca,da);break;case n.MercuryLogMessageType.VIDEO_CALL:if(ba(da)){s(ca,da);}else t(ca,da);break;case n.MercuryLogMessageType.THREAD_NAME:u(ca,da);break;case n.MercuryLogMessageType.THREAD_IMAGE:v(ca,da);break;case n.MercuryLogMessageType.SERVER_ERROR:aa(ca,da);break;case n.MercuryLogMessageType.LIVE_LISTEN:var ea=l.getLogMessageText(da);if(ea)h.setContent(ca,ea);break;}}var s=function(ca,da){m.get(da.author,function(ea){var fa=ea.short_name,ga;switch(da.log_message_data.event_name){case 'installing':ga=h.tx._("{firstname} asentaa videopuheluja...",{firstname:fa});break;case 'installed':ga=h.tx._("{firstname} on asentanut videopuhelut.",{firstname:fa});break;case 'install_canceled':ga=h.tx._("Peruutit videopuhelun asentamisen.",{firstname:fa});break;}if(ga)h.setContent(ca,ga);});},t=function(ca,da){var ea=da.log_message_data.caller,fa=da.log_message_data.callee,ga=[ea,fa];m.getMulti(ga,function(ha){if(ea==m.user){var ia=ha[fa].short_name;if(da.log_message_data.answered){message_text=h.tx._("Soitit k\u00e4ytt\u00e4j\u00e4lle {firstname}.",{firstname:ia});}else message_text=h.tx._("{firstname} ei vastannut puheluusi.",{firstname:ia});}else{var ja=ha[ea].short_name;if(da.log_message_data.answered){message_text=h.tx._("{firstname} soitti sinulle.",{firstname:ja});}else message_text=h.tx._("Missasit puhelun k\u00e4ytt\u00e4j\u00e4lt\u00e4 {firstname}.",{firstname:ja});}h.setContent(ca,message_text);});},u=function(ca,da){var ea=da.log_message_data.name,fa=h.$N('b',{},ea);if(da.author==m.user){if(ea){h.setContent(ca,h.tx._("Nimesit viestiketjun: {name}.",{name:fa}));}else h.setContent(ca,h.tx._("Poistit viestiketjun nimen."));}else m.get(da.author,function(ga){var ha,ia=w(ga);if(ea){ha=h.tx._("{actor} antoi viestiketjulle nimen: {name}.",{actor:ia,name:fa});}else ha=h.tx._("{actor} poisti viestiketjun nimen.",{actor:ia});h.setContent(ca,ha);});},v=function(ca,da){if(da.author==m.user){if(da.log_message_data.image){h.setContent(ca,h.tx._("Vaihdoit viestiketjun kuvan."));}else h.setContent(ca,h.tx._("Poistit viestiketjun kuvan."));}else m.get(da.author,function(ea){var fa=w(ea),ga;if(da.log_message_data.image){ga=h.tx._("{actor} vaihtoi viestiketjun kuvaa.",{actor:fa});}else ga=h.tx._("{actor} poisti viestiketjun kuvan.",{actor:fa});h.setContent(ca,ga);});},w=function(ca){if(ca.href)return h.$N('a',{href:ca.href},ca.name);return ca.name;},x=function(ca){if(ca.href)return h.$N('a',{href:ca.href},ca.short_name);return ca.short_name;},y=function(ca,da){var ea=da.log_message_data.added_participants,fa=null,ga;if(ea.length==1){fa=[da.author,ea[0]];m.getMulti(fa,function(ha){if(da.author==m.user){ga=h.tx._("Sin\u00e4 lis\u00e4sit k\u00e4ytt\u00e4j\u00e4n {subscriber1}.",{subscriber1:w(ha[ea[0]])});}else ga=h.tx._("{actor} lis\u00e4si k\u00e4ytt\u00e4j\u00e4n {subscriber1}.",{actor:w(ha[da.author]),subscriber1:w(ha[ea[0]])});h.setContent(ca,ga);});}else if(ea.length==2){fa=[da.author].concat(ea.slice(0,2));m.getMulti(fa,function(ha){if(da.author==m.user){ga=h.tx._("Sin\u00e4 lis\u00e4sit k\u00e4ytt\u00e4j\u00e4t {subscriber1} ja {subscriber2}.",{subscriber1:w(ha[ea[0]]),subscriber2:w(ha[ea[1]])});}else ga=h.tx._("{actor} lis\u00e4si k\u00e4ytt\u00e4j\u00e4t {subscriber1} ja {subscriber2}.",{actor:w(ha[da.author]),subscriber1:w(ha[ea[0]]),subscriber2:w(ha[ea[1]])});h.setContent(ca,ga);});}else{fa=[da.author].concat(ea.slice(0,2));m.getMulti(fa,function(ha){if(da.author==m.user){ga=h.tx._("Sin\u00e4 lis\u00e4sit k\u00e4ytt\u00e4j\u00e4t {subscriber1}, {subscriber2} ja {more_people}.",{subscriber1:w(ha[ea[0]]),subscriber2:w(ha[ea[1]]),more_people:ea.length-2});}else ga=h.tx._("{actor} lis\u00e4si k\u00e4ytt\u00e4j\u00e4t {subscriber1}, {subscriber2} ja {more_people}.",{actor:w(ha[da.author]),subscriber1:w(ha[ea[0]]),subscriber2:w(ha[ea[1]]),more_people:ea.length-2});h.setContent(ca,ga);});}},z=function(ca,da){m.get(da.author,function(ea){h.setContent(ca,h.tx._("{actor} poistui keskustelusta.",{actor:w(ea)}));});},aa=function(ca,da){var ea="Emme pystyneet hakemaan t\u00e4m\u00e4n viestiketjun aikaisempia viestej\u00e4.";h.setContent(ca,ea);},ba=function(ca){return ca.log_message_data.event_name==='installing'||ca.log_message_data.event_name==='install_canceled';};e.exports=p;});
__d("MercuryMessages",["Arbiter","copyProperties","Env","JSLogger","math-extensions","tx","KeyedCallbackManager","MercuryAssert","MercuryParticipants","PresenceUtil","RangedCallbackManager","MercuryServerRequests","MercuryThreadInformer","MercuryThreads","MercuryConstants"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('copyProperties'),i=b('Env'),j=b('JSLogger'),k=b('math-extensions'),l=b('tx'),m=b('KeyedCallbackManager'),n=b('MercuryAssert'),o=b('MercuryParticipants'),p=b('PresenceUtil'),q=b('RangedCallbackManager'),r=b('MercuryServerRequests'),s=b('MercuryThreadInformer'),t=b('MercuryThreads'),u=c('MercuryConstants'),v={},w={},x={},y=function(ia){var ja=ia;if(w[ia])ja=w[ia];return v[ja];},z={};function aa(ia){ia.message_id=ia.message_id||ga.generateNewClientMessageID(ia.timestamp);var ja=o.user;ia.specific_to_list=ia.specific_to_list||[];if(ia.specific_to_list.length&&ia.specific_to_list.indexOf(ja)===-1)ia.specific_to_list.push(ja);if(!ia.thread_id){if(ia.specific_to_list.length==1){ia.thread_id='user:'+i.user;}else if(ia.specific_to_list.length==2){var ka=ia.specific_to_list[0]==ja?ia.specific_to_list[1]:ia.specific_to_list[0],la=ka.indexOf(':');if(ka.substr(0,la)=='fbid')ia.thread_id='user:'+ka.substr(la+1);}ia.thread_id=ia.thread_id||'root:'+ia.message_id;}if(!ia.specific_to_list.length){var ma=r.tokenizeThreadID(ia.thread_id);if(ma.type=='user')ia.specific_to_list=['fbid:'+ma.value,ja];}}function ba(ia,ja,ka){var la=(new Date()).getTime(),ma={action_type:ia,thread_id:ka,author:o.user,timestamp:la,timestamp_absolute:(new Date(la)).toLocaleString(),timestamp_relative:"muutama sekunti sitten",is_unread:false,is_cleared:false,is_forward:false,source:ja};return ma;}function ca(ia){switch(ia){case u.MercuryPayloadSource.UNKNOWN:case u.MercuryPayloadSource.SERVER_INITIAL_DATA:case u.MercuryPayloadSource.SERVER_FETCH_THREAD_INFO:case u.MercuryPayloadSource.SERVER_THREAD_SYNC:return true;}return false;}function da(ia){return ia&&ia.substr(0,6)==='server';}function ea(ia){if(!z[ia])z[ia]=new q(function(ja){return y(ja).timestamp;},function(ja,ka){return ka-ja;});return z[ia];}g.subscribe(j.DUMP_EVENT,function(ia,ja){var ka={};for(var la in v){var ma=v[la],na=ma.thread_id;ka[na]=ka[na]||{};ka[na][ma.message_id]=h({},ma);}ja.messaging=ja.messaging||{};ja.messaging.local_message_ids=h({},w);ja.messaging.messages=ka;});function fa(ia){ia.forEach(function(ja){var ka=ea(ja);ka.setReachedEndOfArray();});}var ga={getMessagesFromIDs:function(ia){return (ia||[]).map(y).filter(function(ja){return ja;});},getThreadMessagesRange:function(ia,ja,ka,la){var ma=ea(ia),na=function(ra){la(ha(ra));},oa=ma.executeOrEnqueue(ja,ka,na),pa=ma.getUnavailableResources(oa),qa=x[ia];if(pa.length&&!qa){r.fetchThreadMessages(ia,ja,ka);}else x[ia]=false;return oa;},getThreadMessagesSinceTimestamp:function(ia,ja){var ka=ea(ia),la=ka.getElementsUntil(ja);return ha(la);},unsubscribe:function(ia,ja){n.isThreadID(ja);var ka=ea(ja);ka.unsubscribe(ia);},handleUpdates:function(ia,ja,ka){var la={},ma={},na=u.MercuryActionStatus;for(var oa=0;oa<ia.length;oa++){var pa=ia[oa];if(pa.is_forward){if(!v[pa.message_id])v[pa.message_id]=pa;continue;}var qa=pa.action_type;if(qa==u.MercuryActionType.SEND_MESSAGE){var ra=pa.client_message_id;if(ra&&w[ra]&&pa.status){if(pa.status==na.UNCONFIRMED){if(!ma[pa.thread_id])ma[pa.thread_id]=[];ma[pa.thread_id].push(pa.client_message_id);}else if(!la[pa.thread_id])la[pa.thread_id]=[];var sa=y(pa.client_message_id),ta=sa.status;sa.status=pa.status;if(pa.status==na.SUCCESS)this.updateLocalMessage(pa,ka);if(typeof ta!='undefined'||pa.status==na.REQUEST_ERROR||pa.status==na.TRANSPORT_ERROR||pa.status==na.FAILED_UNKNOWN_REASON||pa.status==na.UNABLE_TO_CONFIRM||pa.status==na.RESENT)s.updatedMessage(pa.thread_id,y(pa.client_message_id).message_id,ka);}continue;}else if(qa==u.MercuryActionType.USER_GENERATED_MESSAGE){if(pa.status==na.RESENDING)s.updatedMessage(pa.thread_id,pa.message_id,ka);}else if(qa==u.MercuryActionType.DELETE_THREAD){ea(pa.thread_id).removeAllResources();continue;}else if(qa==u.MercuryActionType.LOG_MESSAGE){if(pa.log_message_type==u.MercuryLogMessageType.SERVER_ERROR)x[pa.thread_id]=true;}else if(qa==u.MercuryActionType.CLEAR_CHAT){var ua=ea(pa.thread_id).getAllResources();ua.map(y).forEach(function(bb){bb.is_cleared=true;});continue;}var va=y(pa.message_id);if((pa.threading_id&&w[pa.threading_id])||(va&&!va.is_forward))continue;if(!la[pa.thread_id])la[pa.thread_id]=[];la[pa.thread_id].push(pa.message_id);v[pa.message_id]=pa;if(!ja)s.receivedMessage(pa);}for(var wa in la){var xa=ea(wa),ya=xa.getAllResources(),za=ya.filter(function(bb){var cb=v[bb];return cb.action_type==u.MercuryActionType.LOG_MESSAGE&&cb.log_message_type==u.MercuryLogMessageType.SERVER_ERROR;});xa.removeResources(za);if(ja){xa.addResources(la[wa]);s.reorderedMessages(wa,ka);}else xa.addResourcesWithoutSorting(la[wa].reverse(),0);s.updatedThread(wa);}var ab=Object.keys(ma);if(ab.length)r.requestMessageConfirmation(ma);},sendMessage:function(ia){aa(ia);w[ia.message_id]=ia.message_id;s.synchronizeInforms(function(){this.handleUpdates([ia],false,u.MercuryPayloadSource.CLIENT_SEND_MESSAGE);r.sendNewMessage(ia);}.bind(this));return ia.thread_id;},resendMessage:function(ia){var ja=h({},ia);ja.status=u.MercuryActionStatus.RESENDING;ja.timestamp=(new Date()).getTime();ja.message_id=ga.generateNewClientMessageID(ja.timestamp);y(ia.message_id).status=u.MercuryActionStatus.RESENT;this.sendMessage(ja);},updateLocalMessage:function(ia,ja){var ka=ia.message_id,la=ia.client_message_id;w[la]=ka;v[ka]=v[la];v[la]={};if(ia.timestamp)y(la).timestamp=ia.timestamp;if(ia.attachments&&ia.attachments.length){y(la).raw_attachments=null;y(la).attachments=ia.attachments;s.updatedMessage(ia.thread_id,y(la).message_id,ja);}},constructUserGeneratedMessageObject:function(ia,ja,ka,la){var ma=ba(u.MercuryActionType.USER_GENERATED_MESSAGE,ja,ka);ma.body=ia;ma.has_attachment=false;ma.is_html=false;ma.attachments=[];ma.specific_to_list=la||[];return ma;},constructLogMessageObject:function(ia,ja,ka,la){var ma=ba(u.MercuryActionType.LOG_MESSAGE,ia,ja);ma.log_message_type=ka;ma.log_message_data=la;return ma;},generateNewClientMessageID:function(ia){var ja=ia+':'+(k.rand32()+1)+'-'+p.getSessionID();return '<'+ja+'@mail.projektitan.com>';}};r.subscribe('update-messages',function(ia,ja){var ka=(ja.actions||[]).filter(function(ma){var na=ma.action_type;return (ma.is_forward||ma.thread_id)&&(na==u.MercuryActionType.LOG_MESSAGE||na==u.MercuryActionType.USER_GENERATED_MESSAGE||na==u.MercuryActionType.SEND_MESSAGE||na==u.MercuryActionType.CLEAR_CHAT||na==u.MercuryActionType.DELETE_THREAD);}),la=ca(ja.payload_source);if(da(ja.payload_source))ka.forEach(function(ma){if(!ma.is_forward){var na=t.getThreadMetaNow(ma.thread_id);if(na)ma.is_cleared=ma.timestamp<na.chat_clear_time;}});ga.handleUpdates(ka,la,ja.payload_source);if(ja.end_of_history)fa(ja.end_of_history);});function ha(ia){var ja=ia.map(y);return ja.reverse();}e.exports=ga;});
__d("MercuryRoger",["ArbiterMixin","MercuryServerRequests","LiveTimer","copyProperties"],function(a,b,c,d,e,f){var g=b('ArbiterMixin'),h=b('MercuryServerRequests'),i=b('LiveTimer'),j=b('copyProperties'),k={},l={getSeenBy:function(m){if(!m)return [];var n=[],o=k[m.thread_id];for(var p in o)if(o[p]>m.timestamp&&p!=m.author)n.push(p);return n;},getSeenTimestamp:function(m,n){var o=k[m];return o?o[n]:null;}};j(l,g);h.subscribe('update-roger',function(m,n){for(var o in n){if(!k[o])k[o]={};for(var p in n[o]){var q=k[o][p],r=n[o][p];if(!q||r>q)k[o][p]=r;}}if(n)l.inform('state-changed',n);});e.exports=l;});
__d("ChatTabMessagesView",["Arbiter","ArbiterMixin","Bootloader","ChannelConstants","ChatVisibility","ChatConfig","CSS","DOM","Emote","Env","MercuryMessageRenderer","MercuryAttachment","MercuryAttachmentRenderer","MercuryMessages","MercuryThreadMetadataRenderer","MercuryThreads","MercuryParticipants","MercuryThreadInformer","Tooltip","VideoCallCore","copyProperties","isRTL","tx","date-extensions","MercuryRoger","ChatTabTemplates","MercuryAttachmentTemplates","MercuryConstants"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('ArbiterMixin'),i=b('Bootloader'),j=b('ChannelConstants'),k=b('ChatVisibility'),l=b('ChatConfig'),m=b('CSS'),n=b('DOM'),o=b('Emote'),p=b('Env'),q=b('MercuryMessageRenderer'),r=b('MercuryAttachment'),s=b('MercuryAttachmentRenderer'),t=b('MercuryMessages'),u=b('MercuryThreadMetadataRenderer'),v=b('MercuryThreads'),w=b('MercuryParticipants'),x=b('MercuryThreadInformer'),y=b('Tooltip'),z=b('VideoCallCore'),aa=c('ChatTabTemplates'),ba=c('MercuryAttachmentTemplates'),ca=c('MercuryConstants'),da=b('copyProperties'),ea=b('isRTL'),fa=b('tx');b('date-extensions');b('MercuryRoger');function ga(ra){return Date.format(l.get('24h_times')?'H:i':'g:ia',ra/1000);}function ha(ra){var sa=aa[':fb:chat:conversation:message-group'].build();sa.setNodeContent('timestamp',ga(ra.timestamp));w.get(ra.author,function(ta){var ua=sa.getNode('profileLink');ua.href=ta.href;var va=ta.fbid==p.user?"Sin\u00e4":ta.name;y.set(ua,va,'left');sa.setNodeProperty('profilePhoto','src',ta.image_src);});return sa;}function ia(ra){var sa=aa[':fb:chat:conversation:message:event'].build();sa.setNodeContent('timestamp',ga(ra.timestamp));q.renderLogMessage(sa.getNode('icon'),sa.getNode('message'),ra);var ta=ja(ra);if(ta)n.appendContent(sa.getNode('message'),ta);return sa.getRoot();}function ja(ra){var sa,ta;if(ra.log_message_type==ca.MercuryLogMessageType.VIDEO_CALL)if(ra.log_message_data.event_name=='install_canceled'){sa=n.tx._("Retry setup and call back.");ta='callback_cancelinstall_link';return ka(sa,ra.thread_id,ra.log_message_data.to,ta);}else if(!ra.log_message_data.event_name&&ra.log_message_data.callee==w.user&&!ra.log_message_data.answered){sa=n.tx._("Soita takaisin");ta='callback_link';return ka(sa,ra.thread_id,ra.log_message_data.caller.split(':')[1],ta);}return null;}function ka(ra,sa,ta,ua){if(z.isSupported()){var va=!k.isOnline()||!z.availableForCall(ta),wa=n.$N('a',{href:'#',className:'callBackLink'},ra);if(va)m.hide(wa);wa.setAttribute('data-gt',JSON.stringify({videochat:'clicked_callback_link'}));Event.listen(wa,'click',function(){pa.inform('video-call-clicked',{userID:ta,threadID:sa,clickSource:ua});});return wa;}return null;}function la(ra){var sa=aa[':fb:mercury:chat:message:forward'].build(),ta=sa.getNode('forwardText');if(ta){m.hide(sa.getRoot());u.renderTitanLink(ra.thread_id,sa.getNode('forwardLink'),m.show.bind(m,sa.getRoot()));if(ra.forward_count>1){n.appendContent(ta,fa._("{count} edelleen v\u00e4litetty\u00e4 viesti\u00e4",{count:ra.forward_count}));}else n.appendContent(ta,"1 v\u00e4litetty viesti");}return sa.getRoot();}var ma=["tammikuu","helmikuu","maaliskuu","huhtikuu","toukokuu","kes\u00e4kuu","hein\u00e4kuu","elokuu","syyskuu","lokakuu","marraskuu","joulukuu"];function na(ra){var sa=new Date();sa.setHours(0);sa.setMinutes(0);sa.setSeconds(0);sa.setMilliseconds(0);var ta=24*60*60*1000,ua=sa.getTime()-ra.getTime();if(ua<=0){return "T\u00e4n\u00e4\u00e4n";}else if(ua<ta)return "Eilen";return fa._("{date}. {month}ta",{month:ma[ra.getMonth()],date:ra.getDate()});}var oa=[];function pa(ra,sa,ta,ua){this.threadID=ra;this.scrollContainer=sa;this.conversationElem=ta;this.messageGroup=null;this.prevMessage=null;var va=ca.MercuryThreadlistConstants.MESSAGE_TIMESTAMP_THRESHOLD;this._olderTimestamp=(new Date()).getTime()-va;oa.push(this);this._subscription=g.subscribe('overflow-applied-to-body',this.scrollToBottom.bind(this));if(ua)i.loadModules(['ChatTabIndicatorLine'],function(wa){if(!this.destroyed){this.indicatorLine=new wa(this.threadID,ua,this);this.indicatorLine.setLastMessage(this.prevMessage);this.scrollToBottom();}}.bind(this));t.getThreadMessagesRange(this.threadID,0,ca.MercuryThreadlistConstants.RECENT_MESSAGES_LIMIT,Function.prototype);this.rerender();}da(pa,h);da(pa.prototype,{destroy:function(){n.empty(this.conversationElem);this._subscription.unsubscribe();oa.remove(this);this.indicatorLine&&this.indicatorLine.destroy();this.destroyed=true;},_appendMessage:function(ra){if(ra==this.prevMessage)return;var sa=ca.MercuryThreadlistConstants,ta=sa.GROUPING_THRESHOLD,ua=ra.action_type==ca.MercuryActionType.LOG_MESSAGE&&ra.log_message_type==ca.MercuryLogMessageType.SERVER_ERROR;if(ra.status==ca.MercuryActionStatus.RESENT)return;if(ra.is_cleared)return;var va=null;if(this.prevMessage)va=new Date(this.prevMessage.timestamp);var wa=new Date(ra.timestamp);if(!ua&&(!va||va.getDate()!=wa.getDate()||va.getMonth()!=wa.getMonth()||va.getFullYear()!=wa.getFullYear())){var xa=aa[':fb:chat:conversation:date-break'].build();n.setContent(xa.getRoot(),na(wa));n.appendContent(this.conversationElem,xa.getRoot());this.messageGroup=null;}if(ra.action_type==ca.MercuryActionType.LOG_MESSAGE){n.appendContent(this.conversationElem,ia(ra));this.messageGroup=null;this.prevMessage=ra;return;}if(!this.messageGroup||this.prevMessage.author!=ra.author||this.prevMessage.timestamp<ra.timestamp-ta){this.messageGroup=ha(ra);n.appendContent(this.conversationElem,this.messageGroup.getRoot());}var ya=this._renderSingleMessage(ra);n.appendContent(this.messageGroup.getNode('messages'),ya);this.prevMessage=ra;},rerender:function(){n.empty(this.conversationElem);this.messageGroup=null;this.prevMessage=null;var ra=t.getThreadMessagesSinceTimestamp(this.threadID,this._olderTimestamp);this._appendMessages(ra);},_appendMessages:function(ra){ra.forEach(this._appendMessage.bind(this));this.indicatorLine&&this.indicatorLine.setLastMessage(this.prevMessage);this.scrollToBottom();},isScrolledToBottom:function(){var ra=this.scrollContainer;return ra.scrollTop+ra.clientHeight>=ra.scrollHeight;},scrollToBottom:function(){this.scrollContainer.scrollTop=this.scrollContainer.scrollHeight;},_renderSingleMessage:function(ra){var sa=aa[':fb:chat:conversation:message'].render();if(ra.subject){var ta=aa[':fb:chat:conversation:message:subject'].render();n.setContent(ta,ra.subject);n.appendContent(sa,ta);}if(ra.body.substr(0,4)=='?OTR'){n.setContent(sa,"[salattu viesti]");m.addClass(sa,'cyphertext');}else{m.addClass(sa,ea(ra.body)?'direction_rtl':'direction_ltr');n.appendContent(sa,q.formatMessageBody(ra.body));}if(ra.has_attachment)this._appendMessageAttachments(sa,ra.attachments);if(ra.forward_count)n.appendContent(sa,la(ra));if(ra.status!==undefined&&ra.status!=ca.MercuryActionStatus.SUCCESS&&ra.status!=ca.MercuryActionStatus.UNCONFIRMED){var ua=u.renderStatusIndicator(ra.status,t.resendMessage.bind(t,ra));m.addClass(sa,'errorStatus');var va=aa[':fb:chat:conversation:message:status'].build();n.appendContent(va.getNode('message'),sa);n.appendContent(va.getNode('status'),ua);return va.getRoot();}return sa;},_appendMessageAttachments:function(ra,sa){var ta=ca.MercuryAttachmentType;for(var ua=0,va=sa.length;ua<va;++ua){var wa=sa[ua],xa=wa.attach_type,ya=wa.share_data_type;if(xa==ta.ERROR)n.appendContent(ra,s.renderError(wa));if(xa==ta.FILE)n.appendContent(ra,s.renderFileLink(wa));var za=null,ab;if(xa==ta.SHARE&&ya==ca.MercurySupportedShareType.FB_VIDEO){za=s.renderVideoThumb(wa);ab=n.find(za,'img');Event.listen(ab,'load',this._thumbLoaded.shield(this,ab));}else if(xa==ta.SHARE&&(ya==ca.MercurySupportedShareType.FB_MUSIC_ALBUM||ya==ca.MercurySupportedShareType.FB_SONG)){za=s.renderMusic(wa);ab=n.find(za,'img');Event.listen(ab,'load',this._thumbLoaded.shield(this,ab));}else if(xa==ta.SHARE&&(ya==ca.MercurySupportedShareType.EXTERNAL||ya==ca.MercurySupportedShareType.FB_TEMPLATE)){za=s.renderExternalLink(wa);ab=n.find(za,'img');Event.listen(ab,'load',this._thumbLoaded.shield(this,ab));}else if(wa.preview_url){za=s.renderPreview(wa);ab=n.find(za,'img');Event.listen(ab,'load',this._thumbLoaded.shield(this,ab));}else if(xa==ta.SHARE)za=s.renderShareLink(wa);if(za)n.appendContent(ra,za);}},_thumbLoaded:function(ra){var sa=this.scrollContainer.scrollTop+this.scrollContainer.clientHeight;if(sa+ra.offsetHeight>=this.scrollContainer.scrollHeight)this.scrollToBottom();}});x.subscribe(['messages-reordered','messages-updated'],function(ra,sa){oa.forEach(function(ta){sa[ta.threadID]&&ta.rerender();});});x.subscribe('messages-received',function(ra,sa){oa.forEach(function(ta){var ua=sa[ta.threadID];ua&&ta._appendMessages(ua);});});g.subscribe(j.getArbiterType('chat_event'),function(ra,sa){if(qa(sa.obj)){var ta=(p.user==sa.obj.from)?sa.obj.to:sa.obj.from,ua=v.getThreadIdForUser(ta),va=oa.filter(function(ya){return ya.threadID===ua;});if(va.length>0){var wa=va[0],xa=t.constructLogMessageObject(ca.MercurySourceType.CHAT_WEB,ua,ca.MercuryLogMessageType.VIDEO_CALL,sa.obj);xa.author='fbid:'+sa.obj.from;wa._appendMessages([xa]);}}});function qa(ra){return (ra.event_name==='installing'||ra.event_name==='install_canceled');}e.exports=pa;});
__d("ChatTabSheetPolicy",[],function(a,b,c,d,e,f){var g={canReplaceOpenSheet:function(h,i){if(h.getType()==i.getType())return false;if(h.isPermanent()&&!i.isPermanent())return false;return true;}};e.exports=g;});
__d("MercuryTypeahead",["ArbiterMixin","Bootloader","DOM","Env","Input","copyProperties","MercuryTypeaheadTemplates"],function(a,b,c,d,e,f){var g=b('ArbiterMixin'),h=b('Bootloader'),i=b('DOM'),j=b('Env'),k=b('Input'),l=b('copyProperties'),m=c('MercuryTypeaheadTemplates'),n=function(o,p){this._domElement=null;this._typeahead=null;this._tokenizer=null;this._placeholder='';this._exclusions=[];this._viewNodeID=null;this._viewOptions={renderer:'compact',autoSelect:true};this._tokenizerBehaviors={};this._dataSource=o;this._view=p;};l(n.prototype,g);l(n.prototype,{setPlaceholder:function(o){this._placeholder=o;return this;},setExcludedParticipants:function(o){this._exclusions=[];o.forEach(function(p){var q=p.indexOf(':');if(p.substr(0,q)=='fbid')this._exclusions.push(p.substr(q+1));}.bind(this));return this;},setViewNodeID:function(o){this._viewNodeID=o;},setViewOption:function(o,p){this._viewOptions[o]=p;},addTokenizerBehavior:function(o){this._tokenizerBehaviors[o]=true;},build:function(o){if(this._domElement){o(this._domElement);return;}h.loadModules(['Typeahead','TypeaheadCore','Tokenizer'],function(p,q,r){var s=m[':fb:mercury:tokenizer'].build(),t=m[':fb:mercury:typeahead'].build();this._domElement=s.getRoot();i.appendContent(this._domElement,t.getRoot());var u=t.getNode('textfield');k.setPlaceholder(u,this._placeholder);u.setAttribute('data-placeholder',this._placeholder);var v={node_id:this._viewNodeID,ctor:this._view,options:this._viewOptions},w={ctor:q,options:{setValueOnSelect:true}};this._typeahead=new p(this._dataSource,v,w,t.getRoot());this._typeahead.init();var x={inline:true,behaviors:this._tokenizerBehaviors};this._tokenizer=new r(this._domElement,this._typeahead);this._tokenizer.init(s.getNode('tokenarea'),'participants',[],x);this._tokenizer.subscribe(['addToken','removeToken','removeAllTokens'],function(){this.inform('tokens-changed');}.bind(this));Event.listen(u,'focus',function(){this._resetDataSource();this._typeahead.init();}.bind(this));Event.listen(this._domElement,'click',this.focus.bind(this));o(this._domElement);}.bind(this));},getElement:function(){return this._domElement;},getSelectedParticipantIDs:function(){var o=[];if(this._tokenizer)(this._tokenizer.getTokenValues()||[]).forEach(function(p){o.push('fbid:'+p);});return o;},getTokens:function(){var o=[];if(this._tokenizer)o=this._tokenizer.getTokens();return o;},reset:function(){this._tokenizer&&this._tokenizer.removeAllTokens();this._typeahead&&this._typeahead.getCore().reset();},focus:function(){this._tokenizer&&this._tokenizer.focusInput();},getTypeahead:function(){return this._typeahead;},_resetDataSource:function(){this._dataSource.setExclusions(this._exclusions);}});e.exports=n;});
__d("MultiChatController",["Arbiter","AsyncSignal","copyProperties","Dialog","MercuryMessages","MercuryServerRequests","MercuryThreads"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('AsyncSignal'),i=b('copyProperties'),j=b('Dialog'),k=b('MercuryMessages'),l=b('MercuryServerRequests'),m=b('MercuryThreads');function n(){}i(n,{createGroupThreadFromChooserDialog:function(o){var p=JSON.parse(j.getCurrent().getFormData().profileChooserItems),q=[];for(var r in p)if(p[r])q.push(r);var s=n.createThreadForFBIDs(q);l.subscribe('update-thread-ids',function(t,u){for(var v in u)if(u[v]==s)new h('/ajax/groups/chat/log',{group_id:o,message_id:v}).send();});j.getCurrent().hide();},createThreadForTokens:function(o){if(!o.length)return;var p;if(o.length==1){p='user:'+o[0].split(':')[1];}else p='root:'+k.generateNewClientMessageID((new Date()).getTime());m.createNewLocalThread(p,o);g.inform('chat/open-tab',{thread_id:p});return p;},createThreadForFBIDs:function(o){var p=[];for(var q=0;q<o.length;q++)p.push("fbid:"+o[q]);return n.createThreadForTokens(p);}});e.exports=n;});
__d("ChatAddFriendsTabSheet",["Arbiter","ChatTabSheetView","ContextualTypeaheadView","copyProperties","DOM","MercuryTypeahead","MercuryMessages","MultiChatController","MercuryServerRequests","MercuryThreads","tx","MercuryConstants","MercuryDataSource","ChatTabTemplates"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('ChatTabSheetView'),i=b('ContextualTypeaheadView'),j=b('copyProperties'),k=b('DOM'),l=b('MercuryTypeahead'),m=b('MercuryMessages'),n=b('MultiChatController'),o=b('MercuryServerRequests'),p=b('MercuryThreads'),q=c('MercuryConstants'),r=c('MercuryDataSource'),s=c('ChatTabTemplates'),t=b('tx');function u(x,y,z){this._threadID=x;this._rootElement=y;this._sheetView=z;}j(u.prototype,{render:function(){var x=s[':fb:mercury:chat:tab-sheet:add-friends'].build();p.getThreadMeta(this._threadID,function(y){var z=new l(r,i);z.setExcludedParticipants(y.participants);z.setPlaceholder("Kirjoita kaverisi nimi");z.build(function(ca){k.replace(x.getNode('participantsTypeahead'),ca);k.setContent(this._rootElement,x.getRoot());z.focus();}.bind(this));var aa=y.participants,ba=y.is_canonical_user?v.bind(null,this,this._sheetView,aa,z):w.bind(null,this,this._sheetView,this._threadID,z);Event.listen(x.getNode('doneButton'),'click',ba);}.bind(this));},isPermanent:function(){return true;},getType:function(){return 'add_friends_type';},open:function(){this._sheetView.open(this);}});function v(x,y,z,aa){var ba=aa.getSelectedParticipantIDs();if(ba.length)n.createThreadForTokens(z.concat(ba));y.close(x);}function w(x,y,z,aa){var ba=aa.getSelectedParticipantIDs();if(ba.length)if(p.isEmptyLocalThread(z)){p.addParticipantsToThreadLocally(z,ba);}else m.sendMessage(m.constructLogMessageObject(q.MercurySourceType.CHAT_WEB,z,q.MercuryLogMessageType.SUBSCRIBE,{added_participants:ba}));y.close(x);}e.exports=u;});
__d("ChatAvailabilityTabSheet",["Arbiter","AvailableListConstants","AvailableList","ChatConfig","CSS","DOM","GenderConst","MercuryThreads","ShortProfiles","copyProperties","ChatTabTemplates"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('AvailableListConstants'),i=b('AvailableList'),j=b('ChatConfig'),k=b('CSS'),l=b('DOM'),m=b('GenderConst'),n=b('MercuryThreads'),o=b('ShortProfiles'),p=b('copyProperties'),q=c('ChatTabTemplates');function r(v,w,x,y){this._handledAvailability=w;this._sheetView=y;this._rootElement=x;this._canonicalUser=n.getCanonicalUserInThread(v);if(this._canonicalUser){this._currentAvailability=h.ACTIVE;this._handleAvailabilityChange();g.subscribe(h.ON_AVAILABILITY_CHANGED,this._handleAvailabilityChange.bind(this));}}r.createSheets=function(v,w,x){var y={};if(j.get('roger.ui')){y[h.OFFLINE]=new r(v,h.OFFLINE,w,x);return y;}[h.ACTIVE,h.OFFLINE,h.MOBILE].forEach(function(z){y[z]=new r(v,z,w,x);});return y;};p(r.prototype,{render:function(){!this._canonicalUser;var v=q[':fb:mercury:chat:tab-sheet:message-icon-sheet'].build();o.get(this._canonicalUser,function(w){var x=null;switch(this._currentAvailability){case h.ACTIVE:k.addClass(v.getRoot(),'active');x=s(w);break;case h.MOBILE:k.addClass(v.getRoot(),'mobile');x=t(w);break;case h.OFFLINE:x=u(w);break;}l.setContent(v.getNode('text'),x);l.setContent(this._rootElement,v.getRoot());}.bind(this));},isPermanent:function(){return false;},getType:function(){switch(this._handledAvailability){case h.ACTIVE:return 'availability_active_type';case h.MOBILE:return 'availability_mobile_type';case h.OFFLINE:return 'availability_offline_type';default:throw new Error("Invalid handled availability");}},getCloseTimeout:function(){return 5000;},_handleAvailabilityChange:function(){var v=i.get(this._canonicalUser);if(v==this._currentAvailability)return;this._currentAvailability=v;if(v==this._handledAvailability)this._sheetView.open(this);}});function s(v){return l.tx._("{name} on nyt paikalla.",{name:v.firstName});}function t(v){return l.tx._("Viestisi l\u00e4hetet\u00e4\u00e4n henkil\u00f6n {name} matkapuhelimeen.",{name:v.firstName});}function u(v){switch(v.gender){case m.FEMALE_SINGULAR:case m.FEMALE_SINGULAR_GUESS:return l.tx._("{name} on offline-tilassa, mutta voit silti l\u00e4hett\u00e4\u00e4 h\u00e4nelle viestin.",{name:v.firstName});case m.MALE_SINGULAR:case m.MALE_SINGULAR_GUESS:return l.tx._("{name} on offline-tilassa, mutta voit silti l\u00e4hett\u00e4\u00e4 h\u00e4nelle viestin.",{name:v.firstName});default:return l.tx._("{name} ei ole kirjautuneena, mutta voit silti l\u00e4hett\u00e4\u00e4 h\u00e4nelle viestin.",{name:v.firstName});}}e.exports=r;});
__d("ChatNoListenersTabSheet",["Arbiter","copyProperties","DOM","MusicConstants","MercuryAssert","MercuryIDs","MercuryParticipants","ChatTabTemplates"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('copyProperties'),i=b('DOM'),j=b('MusicConstants'),k=b('MercuryAssert'),l=b('MercuryIDs'),m=b('MercuryParticipants'),n=c('ChatTabTemplates');function o(p,q,r){k.isThreadID(p);var s=l.tokenize(p);if(s.type!='live_listen')throw 'bad live_listen thread id';this._sessionID=s.value;this._rootElement=q;this._sheetView=r;a.MusicEvents.subscribe([j.LIVE_LISTEN_OP.END_SESSION],this._handleEndSession.bind(this),g.SUBSCRIBE_NEW);}h(o.prototype,{render:function(){var p=n[':fb:mercury:chat:tab-sheet:message-icon-sheet'].build();i.setContent(p.getNode('text'),i.tx._("Kukaan ei en\u00e4\u00e4 kuuntele kanssasi."));i.setContent(this._rootElement,p.getRoot());},isPermanent:function(){return true;},getType:function(){return 'no_listeners_type';},_handleEndSession:function(p,q){if(q&&q.session&&q.session.session_id==this._sessionID)this._sheetView.open(this);}});e.exports=o;});
__d("ChatNoRecipientsTabSheet",["DOM","MercuryParticipants","MercuryThreadInformer","MercuryThreads","copyProperties","ChatTabTemplates"],function(a,b,c,d,e,f){var g=b('DOM'),h=b('MercuryParticipants'),i=b('MercuryThreadInformer'),j=b('MercuryThreads'),k=b('copyProperties'),l=c('ChatTabTemplates');function m(n,o,p){this._threadID=n;this._rootElement=o;this._sheetView=p;i.subscribe('threads-updated',this._handleThreadsUpdated.bind(this));}k(m.prototype,{render:function(){var n=l[':fb:mercury:chat:tab-sheet:message-icon-sheet'].build();g.setContent(n.getNode('text'),g.tx._("Kaikki vastaanottajat ovat j\u00e4tt\u00e4neet t\u00e4m\u00e4n viestiketjun. Sulje vanha v\u00e4lilehti."));g.setContent(this._rootElement,n.getRoot());},isPermanent:function(){return true;},getType:function(){return 'no_recipients_type';},_handleThreadsUpdated:function(){j.getThreadMeta(this._threadID,function(n){var o=h.user,p=n.participants.filter(function(q){return q!=o;});if(p.length<1){this._sheetView.open(this);}else this._sheetView.close(this);}.bind(this));}});e.exports=m;});
__d("ChatOfflineTabSheet",["ChatPrivacyActionController","ChatTabSheetView","ChatVisibility","copyProperties","CSS","DOM","JSLogger","MercuryThreads","MercuryParticipants","ChatTabTemplates"],function(a,b,c,d,e,f){var g=b('ChatPrivacyActionController'),h=b('ChatTabSheetView'),i=b('ChatVisibility'),j=b('copyProperties'),k=b('CSS'),l=b('DOM'),m=b('JSLogger'),n=b('MercuryThreads'),o=b('MercuryParticipants'),j=b('copyProperties'),p=c('ChatTabTemplates');function q(r,s,t){this._rootElement=s;this._sheetView=t;this._logger=m.create('blackbird');this._canonicalUser=n.getCanonicalUserInThread(r);if(this._canonicalUser)this._privacyActionController=new g(this._canonicalUser,this._handlePrivacyChange.bind(this));}j(q.prototype,{render:function(){if(!this._canonicalUser)this._logger.error('offline_sheet_open_with_non_friend');var r=p[':fb:mercury:chat:tab-sheet:message-icon-sheet'].build(),s='fbid:'+this._canonicalUser;o.get(s,function(t){var u='fbChatGoOnlineLink',v=l.$N('a',{href:'#',className:u},l.tx._("siirry paikalle")),w=l.tx._("Olet poissa keskustelusta. Keskustellaksesi {name} ja muiden kavereidesi kanssa, {link}.",{name:t.short_name,link:v});l.setContent(r.getNode('text'),w);k.addClass(r.getRoot(),'chatOffline');l.setContent(this._rootElement,r.getRoot());Event.listen(this._rootElement,'click',function(event){if(k.hasClass(event.getTarget(),u)){if(i.isOnline())this._logger.error('tab_sheet_already_online');this._privacyActionController.togglePrivacy();this._logger.log('tab_sheet_go_online',{tab_id:this._canonicalUser});return false;}}.bind(this));}.bind(this));},_handlePrivacyChange:function(r){if(!this._canonicalUser)this._logger.error('user_blocked_sheet_privacy_changed_non_friend');switch(r){case g.OFFLINE:this._sheetView.open(this);break;case g.NORMAL:case g.BLOCKED:this._sheetView.close(this);break;}},isPermanent:function(){return true;},getType:function(){return 'offline_type';}});e.exports=q;});
__d("ChatUserBlockedTabSheet",["ChatPrivacyActionController","ChatTabSheetView","copyProperties","CSS","DOM","GenderConst","JSLogger","MercuryThreads","MercuryParticipants","tx","ChatTabTemplates"],function(a,b,c,d,e,f){var g=b('ChatPrivacyActionController'),h=b('ChatTabSheetView'),i=b('copyProperties'),j=b('CSS'),k=b('DOM'),l=b('GenderConst'),m=b('JSLogger'),n=b('MercuryThreads'),o=b('MercuryParticipants'),p=c('ChatTabTemplates'),q=b('tx');function r(s,t,u){this._rootElement=t;this._sheetView=u;this._logger=m.create('blackbird');this._canonicalUser=n.getCanonicalUserInThread(s);if(this._canonicalUser)this._privacyActionController=new g(this._canonicalUser,this._handlePrivacyChange.bind(this));}i(r.prototype,{render:function(){if(!this._canonicalUser)this._logger.error('user_blocked_sheet_open_with_non_friend');var s=p[':fb:mercury:chat:tab-sheet:user-blocked'].build(),t='fbid:'+this._canonicalUser;o.get(t,function(u){var v=null;switch(u.gender){case l.FEMALE_SINGULAR:case l.FEMALE_SINGULAR_GUESS:v=q._("{name} n\u00e4kee sinut offline-tilassa chatissa, mutta voit silti l\u00e4hett\u00e4\u00e4 h\u00e4nelle viestin.",{name:u.short_name});break;case l.MALE_SINGULAR:case l.MALE_SINGULAR_GUESS:v=q._("{name} n\u00e4kee sinut poissaolevana keskustelussa, mutta voit silti l\u00e4hett\u00e4\u00e4 h\u00e4nelle viestin.",{name:u.short_name});break;default:v=q._("{name} n\u00e4kee sinut poissaolevana keskustelussa, mutta voit silti l\u00e4hett\u00e4\u00e4 heille viestin.",{name:u.short_name});}k.setContent(s.getNode('text'),v);var w=q._("Siirry online-tilaan k\u00e4ytt\u00e4j\u00e4lle {name}",{name:u.short_name});k.setContent(s.getNode('actionLink'),w);j.addClass(s.getRoot(),'blocked');k.setContent(this._rootElement,s.getRoot());Event.listen(s.getNode('actionLink'),'click',this._privacyActionController.togglePrivacy.bind(this._privacyActionController));}.bind(this));},_handlePrivacyChange:function(s){if(!this._canonicalUser)this._logger.error('user_blocked_sheet_privacy_changed_non_friend');switch(s){case g.BLOCKED:this._sheetView.open(this);break;case g.NORMAL:case g.OFFLINE:this._sheetView.close(this);break;}},isPermanent:function(){return true;},getType:function(){return 'user_blocked_type';}});e.exports=r;});
__d("ChatTabView",["event-extensions","function-extensions","Arbiter","ArbiterMixin","AvailableList","AvailableListConstants","ChatConfig","ChatContextualDialogController","ChatQuietLinks","ChatPrivacyActionController","ChatTabMessagesView","ChatTabSheetController","ChatVisibility","CSS","Dialog","Dock","DOM","JSLogger","Keys","MercuryMessages","MercuryParticipants","MercuryServerRequests","MercuryThreadInformer","MercuryThreadMetadataRenderer","MercuryThreads","MercuryTypingReceiver","NubController","Parent","PresencePrivacy","Style","TextAreaControl","Tooltip","TypingIndicator","URI","UserAgent","VideoCallCore","copyProperties","setIntervalAcrossTransitions","tx","MercuryConstants","ChatTabTemplates"],function(a,b,c,d,e,f){b('event-extensions');b('function-extensions');var g=b('Arbiter'),h=b('ArbiterMixin'),i=b('AvailableList'),j=b('AvailableListConstants'),k=b('ChatConfig'),l=b('ChatContextualDialogController'),m=b('ChatQuietLinks'),n=b('ChatPrivacyActionController'),o=b('ChatTabMessagesView'),p=b('ChatTabSheetController'),q=b('ChatVisibility'),r=b('CSS'),s=b('Dialog'),t=b('Dock'),u=b('DOM'),v=b('JSLogger'),w=b('Keys'),x=b('MercuryMessages'),y=b('MercuryParticipants'),z=b('MercuryServerRequests'),aa=b('MercuryThreadInformer'),ba=b('MercuryThreadMetadataRenderer'),ca=b('MercuryThreads'),da=b('MercuryTypingReceiver'),ea=b('NubController'),fa=b('Parent'),ga=b('PresencePrivacy'),ha=b('Style'),ia=b('TextAreaControl'),ja=b('Tooltip'),ka=b('TypingIndicator'),la=b('URI'),ma=b('UserAgent'),na=b('VideoCallCore'),oa=c('MercuryConstants'),pa=c('ChatTabTemplates'),qa=b('copyProperties'),ra=b('setIntervalAcrossTransitions'),sa=b('tx'),ta=v.create('tab_view'),ua={};function va(za,ab){var bb=u.$N('div');ab=ab.filter(function(cb){return cb!=y.user;});y.getMulti(ab,function(cb){for(var db in cb){var eb=cb[db],fb=pa[':fb:mercury:chat:multichat-tooltip-item'].build();u.setContent(fb.getNode('name'),eb.name);var gb=y.getUserID(db),hb=gb&&i.get(gb)==j.ACTIVE;r.conditionShow(fb.getNode('icon'),hb);r.conditionClass(fb.getNode('name'),'tooltipItemWithIcon',hb);u.appendContent(bb,fb.getRoot());}ja.set(za,bb,'above','center');});}function wa(za){var ab=z.tokenizeThreadID(za);switch(ab.type){case 'user':return pa[':fb:mercury:chat:user-tab'].build();case 'group':return pa[':fb:mercury:chat:group-tab'].build();case 'live_listen':return pa[':fb:mercury:chat:live-listen-tab'].build();}return pa[':fb:mercury:chat:multichat-tab'].build();}function xa(za,ab){if(ab)z.ensureThreadIsFetched(ab);this._threadID=za;this._eventListeners=[];this._tabTemplate=wa(za);this._tabElem=this._tabTemplate.getRoot();if(!(this._getNode instanceof Function))ta.log('getnode_undefined',{is_getnode_set:!!this._getNode,is_prototype_set:!!xa.prototype,is_window:window==this,is_chat_tab_view:this instanceof xa,ctor_name:this.constructor&&this.constructor.name});this._sheetController=new p(this._threadID,this._getNode('sheet'),this._tabElem);this._contextualDialogController=new l(this._threadID,this._getNode('videoCallLink'));this._messagesView=null;var bb=this._getNode('conversationLink');if(bb){r.hide(bb);ba.renderTitanLink(za,bb,r.show.bind(r,bb));}if(ca.isMultichatThread(this._threadID))this._titlebarTooltipAnchor=this._getNode('titlebarText');var cb=this._getCanonicalUserID();if(this._isTitleTextLinked())y.get('fbid:'+cb,function(gb){var hb=this._getNode('titlebarText');hb.setAttribute('href',gb.href);hb.removeAttribute('rel');r.removeClass(hb,'noLink');}.bind(this));this._nubController=new ea().init(this._tabElem);ia.getInstance(this._getNode('input')).subscribe('resize',function(){this._nubController.flyoutContentChanged();}.bind(this));this._listen('closeButton','click',this._closeClicked);this._listen('titlebarCloseButton','click',this._closeClicked);this._listen('dockButton','click',this._nubClicked);this._listen('dockButton','keydown',this._dockKeyDown);this._listen('nubFlyoutTitlebar','click',this._titleClicked);this._listen('chatConv','click',this._chatConvClicked);this._listen('addFriendLink','click',this._addFriendLinkClicked,true);this._listen('addToThreadLink','click',this._addFriendLinkClicked,true);this._listen('clearWindowLink','click',this._clearHistory,true);this._listen('unsubscribeLink','click',this._unsubscribeLinkClicked,true);this._listen('videoCallLink','click',this._callClicked,true);this._listen('reportSpamLink','click',this._reportSpamClicked,true);this._listen('input','focus',this._focusTab);this._listen('input','blur',this._blurTab);if(ma.firefox()){this._listen('input','keypress',this._inputKeyDown);}else this._listen('input','keydown',this._inputKeyDown);this._privacyLink=this._getNode('privacyLink');if(this._privacyLink){var db=new n(cb,this._updatePrivacyLink.bind(this));this._eventListeners.push(Event.listen(this._privacyLink,'click',db.togglePrivacy.bind(db)));}if(cb){this._typingIndicator=new ka(cb,this._getNode('input'),'mercury-chat');if(!k.get('roger.ui'))y.get('fbid:'+cb,function(gb){var hb=this._getNode('typingIndicator'),ib=sa._("{name} kirjoittaa...",{name:gb.short_name});u.setContent(hb,ib);}.bind(this));}if(k.get('roger.ui'))r.addClass(this._tabElem,'roger');var eb=this._getNode('muteGroupLink');if(eb){var fb=ca.getCanonicalGroupInThread(this._threadID);if(fb)eb.setAttribute('ajaxify',la(eb.getAttribute('ajaxify')).addQueryData({id:fb}));}m.removeLinkHrefs(this._tabElem);ua[za]=this;this.updateAvailableStatus();this.updateTab();}function ya(){for(var za in ua){ua[za].updateAvailableStatus();ua[za].updateMultichatTooltip();}}g.subscribe(['buddylist/availability-changed'],ya);ga.subscribe(['privacy-changed','privacy-availability-changed'],ya);da.subscribe('state-changed',function(za,ab){for(var bb in ab){var cb=ua[bb];cb&&cb.showTypingIndicator(ab[bb]);}});aa.subscribe('threads-updated',function(za,ab){for(var bb in ua)ab[bb]&&ua[bb].updateTab();});aa.subscribe('threads-deleted',function(za,ab){for(var bb in ua)xa.inform('thread-deleted',bb);});qa(xa,h,{get:function(za){return ua[za];}});qa(xa.prototype,{getThreadID:function(){return this._threadID;},isVisible:function(){return r.shown(this._tabElem);},setVisibleState:function(za,ab){var bb=r.shown(this._tabElem),cb=r.hasClass(this._tabElem,'opened');r.conditionShow(this._tabElem,za);r.conditionClass(this._tabElem,'opened',ab);if(!(bb&&cb)&&za&&ab){if(!this._messagesView)this._messagesView=new o(this._threadID,this._getNode('chatConv'),this._getNode('conversation'),k.get('roger.ui')?this._getNode('typingIndicator'):null);this._nubController.flyoutContentChanged();this._messagesView.scrollToBottom();}if(bb&&cb&&!(za&&ab))this._contextualDialogController.tabNotActive();},focus:function(){var za=r.hasClass(this._tabElem,'opened')?'input':'dockButton';this._getNode(za).focus();},isFocused:function(){var za=document.activeElement;return fa.byClass(za,'fbMercuryChatTab')===this._tabElem;},setInput:function(za){this._getNode('input').value=za;},insertBefore:function(za){u.insertBefore(za._tabElem,this._tabElem);},appendTo:function(za){u.appendContent(za,this._tabElem);},nextTabIs:function(za){var ab=za&&za._tabElem;return this._tabElem.nextSibling==ab;},destroy:function(){u.remove(this._tabElem);while(this._eventListeners.length)this._eventListeners.pop().remove();this._messagesView&&this._messagesView.destroy();this._sheetController.destroy();this._contextualDialogController.destroy();delete ua[this._threadID];t.unregisterNubController(this._nubController);},updateAvailableStatus:function(){var za={active:false,mobile:false,greenring:false},ab=this._getCanonicalUserID(),bb=true,cb=false;if(ab){var db=i.get(ab);bb=!q.isOnline();cb=!ga.allows(ab);var eb=k.get('chat_mobile_icon_experiment_condition')||'normal';switch(eb){case 'mobile_green_circle':za.active=(db===j.ACTIVE)||(db===j.MOBILE);break;case 'mobile_green_ring':za.active=(db===j.ACTIVE);za.greenring=(db===j.MOBILE);break;case 'all_green_ring':za.greenring=(db===j.ACTIVE)||(db===j.MOBILE);break;default:za.active=(db===j.ACTIVE);za.mobile=(db===j.MOBILE);break;}this._updateCallLink(db);}r.conditionClass(this._tabElem,'chatOffline',bb);r.conditionClass(this._tabElem,'blocked',!bb&&cb);for(var fb in za)r.conditionClass(this._tabElem,fb,!bb&&!cb&&za[fb]);},updateTab:function(){ca.getThreadMeta(this._threadID,function(za){if(!za.is_subscribed){xa.inform('unsubscribed',this._threadID);return;}ba.renderAndSeparatedParticipantList(this._threadID,[this._getNode('name'),this._getNode('titlebarText')],true,true);this._updateUnreadCount(za);this.updateMultichatTooltip();this._updateArchiveWarning(za);}.bind(this));},_updateArchiveWarning:function(za){var ab=false;y.get(y.user,function(bb){ab=bb.employee;if(ab)y.getMulti(za.participants,this._showArchiveWarningIfAllParticipantsAreEmployees.bind(this));}.bind(this));},_showArchiveWarningIfAllParticipantsAreEmployees:function(za){var ab=true;for(var bb in za)ab=ab&&za[bb].employee;var cb=this._getNode('titanArchiveWarning');if(cb){if(this._titlebarTooltipAnchor)r.conditionClass(this._titlebarTooltipAnchor,'narrowTitleBar',ab);r.conditionShow(cb,ab);}},updateMultichatTooltip:function(){if(ca.isMultichatThread(this._threadID))ca.getThreadMeta(this._threadID,function(za){va(this._titlebarTooltipAnchor,za.participants);}.bind(this));},_getNode:function(za){return this._tabTemplate.getNode(za);},_getCanonicalUserID:function(){return ca.getCanonicalUserInThread(this._threadID);},_listen:function(za,event,ab,bb){var cb=this._getNode(za);if(cb){this._eventListeners.push(Event.listen(cb,event,ab.bind(this)));}else if(!bb)throw new Error('Could not find node "'+za+'"');},_closeClicked:function(za){xa.inform('closed-tab',this._threadID);za.prevent();},_nubClicked:function(){return xa.inform('nub-activated',this._threadID);},_dockKeyDown:function(event){if(event.keyCode===w.RETURN||event.keyCode===w.SPACE){xa.inform('nub-activated',this._threadID);event.kill();}else this._handleHotkeyPressed(event);},_handleHotkeyPressed:function(event){if(event.keyCode===w.ESC){xa.inform('esc-pressed',this._threadID);event.kill();}else if(event.keyCode===w.TAB){var za=xa.inform('tab-pressed',{id:this._threadID,shiftPressed:event.shiftKey});!za&&event.kill();}},_isTitleTextLinked:function(){var za=this._getCanonicalUserID();return za&&k.get('chat_tab_title_link_timeline');},_titleClicked:function(event){var za=event.getTarget(),ab=fa.byClass(za,'titlebarText'),bb=ab&&this._isTitleTextLinked();if(!bb&&!fa.byClass(za,'uiSelector')&&!fa.byClass(za,'addToThread'))xa.inform('lower-activated',this._threadID);},_callClicked:function(za){var ab=this._getCanonicalUserID();if(na.availableForCall(ab)){var bb='chat_tab_icon';if(za.target&&r.hasClass(za.target,'video_call_promo')){bb='chat_tab_icon_promo';}else if(za.target&&r.hasClass(za.target,'video_call_tour'))bb='chat_tab_icon_tour';xa.inform('video-call-clicked',{threadID:this._threadID,userID:ab,clickSource:bb});}return false;},_addFriendLinkClicked:function(){this._sheetController.openAddFriendsSheet();},_clearHistory:function(){var za=ca.getThreadMetaNow(this._threadID);if(za){var ab=this._getCanonicalUserID();z.clearChat(this._threadID,ab,za.timestamp);}},_unsubscribeLinkClicked:function(){var za=[];za.push({name:'unsubscribe',label:"Poistu viestiketjusta",handler:this._unsubscribeToThread.bind(this)});za.push(s.CANCEL);new s().setTitle("Poistutko viestiketjusta?").setBody("Et en\u00e4\u00e4 saa t\u00e4m\u00e4n viestiketjun viestej\u00e4, ja muut n\u00e4kev\u00e4t sinun l\u00e4hteneen.").setButtons(za).show();},_reportSpamClicked:function(){var za=this._getCanonicalUserID(),ab=la('/ajax/chat/report.php').addQueryData({id:za}).addQueryData({src:'top_report_link'});s.bootstrap(ab.toString(),null,false);},_focusTab:function(){r.addClass(this._tabElem,'focusedTab');xa.inform('focused',this._threadID);this._contextualDialogController.tabFocused();},_blurTab:function(){r.removeClass(this._tabElem,'focusedTab');},_inputKeyDown:function(event){if(event.keyCode===w.RETURN&&!event.shiftKey){var za=this._getNode('input'),ab=za.value||'';if(!/^\s*$/.test(ab))ca.getThreadMeta(this._threadID,function(bb){var cb=x.constructUserGeneratedMessageObject(ab,oa.MercurySourceType.CHAT_WEB,this._threadID);if(ca.isEmptyLocalThread(this._threadID)){var db=z.tokenizeThreadID(this._threadID);cb.message_id=db.value;cb.specific_to_list=bb.participants;}x.sendMessage(cb);this._getNode('input').value='';this._typingIndicator&&this._typingIndicator.resetState();}.bind(this));event.kill();}if(event.keyCode===w.DOWN&&event.shiftKey&&this._getNode('input').value===''){xa.inform('lower-activated',this._threadID);event.kill();return;}this._handleHotkeyPressed(event);},_chatConvClicked:function(){!u.getSelection()&&this.focus();},showTypingIndicator:function(za){if(!k.get('roger.ui'))r.conditionClass(this._getNode('typingIndicator'),'typing',za);r.conditionClass(this._tabElem,'typing',za);},_updateUnreadCount:function(za){var ab=za.unread_count;if(typeof ab!='undefined'){var bb=this._getNode('numMessages');r.conditionShow(bb,ab);r.conditionClass(this._tabElem,'highlightTab',ab);if(k.get('chat_mark_read_on_focus'))r.conditionClass(this._tabElem,'highlightTitle',ab);u.setContent(bb,ab);}},_updateCallLink:function(za){var ab=this._getNode('videoCallLink');if(q.isOnline()){var bb=this._getCanonicalUserID(),cb='fbid:'+bb;y.get(cb,function(db){if(na.availableForCall(bb)){ja.set(ab,sa._("Aloita videopuhelu henkil\u00f6n {firstname} kanssa",{firstname:db.short_name}));this._updateCallBackLinks(this._tabElem,true);}else{ja.set(ab,sa._("{firstname} ei ole t\u00e4ll\u00e4 hetkell\u00e4 paikalla videopuhelua varten",{firstname:db.short_name}));this._hideVideoCallouts();this._updateCallBackLinks(this._tabElem,false);}}.bind(this));}else{ja.set(ab,"Siun on oltava paikalla, jotta voit soittaa puhelun.");this._hideVideoCallouts();this._updateCallBackLinks(document.body,false);}},_updateCallBackLinks:function(za,ab){var bb=u.scry(za,'a.callBackLink');if(ab){bb.forEach(r.show);}else bb.forEach(r.hide);},_hideVideoCallouts:function(){this._contextualDialogController.hideVideoCallouts();},_updatePrivacyLink:function(za){if(za==n.OFFLINE){u.setContent(this._privacyLink,"Siirry paikalle");}else{var ab=this._getCanonicalUserID(),bb='fbid:'+ab;y.get(bb,function(cb){var db=null;if(za==n.BLOCKED){db=sa._("Siirry online-tilaan k\u00e4ytt\u00e4j\u00e4lle {name}",{name:cb.short_name});}else db=sa._("Poistu k\u00e4ytt\u00e4j\u00e4n {name} saatavilta",{name:cb.short_name});u.setContent(this._privacyLink,db);}.bind(this));}},_unsubscribeToThread:function(){if(ca.isEmptyLocalThread(this._threadID)){xa.inform('unsubscribed',this._threadID);}else{var za=x.constructLogMessageObject(oa.MercurySourceType.CHAT_WEB,this._threadID,oa.MercuryLogMessageType.UNSUBSCRIBE,{});x.sendMessage(za);}return true;}});e.exports=xa;});
__d("MercuryNotificationRenderer",["MercuryAssert","MercuryMessages","MercuryParticipants","MercuryThreads","tx"],function(a,b,c,d,e,f){var g=b('MercuryAssert'),h=b('MercuryMessages'),i=b('MercuryParticipants'),j=b('MercuryThreads'),k=b('tx');function l(m,n){g.isThreadID(m);j.getThreadMeta(m,function(o){h.getThreadMessagesRange(m,0,1,function(p){var q=p.length&&p[p.length-1];if(q&&q.author!=i.user){i.get(q.author,function(r){if(o.name&&!o.is_canonical_live_listen){n(k._("{senderName} l\u00e4hetti viestin ryhm\u00e4lle {groupName}",{senderName:r.short_name,groupName:o.name}));}else n(k._("{name} l\u00e4hetti sinulle viestin",{name:r.short_name}));});}else n("Uusi viesti!");});});}e.exports={renderDocumentTitle:l};});
__d("ChatTitleBarBlinker",["ChatActivity","DocumentTitle","JSLogger","math-extensions","MercuryThreadInformer","MercuryNotificationRenderer","PresenceState","MercuryTimestampTracker","MercuryUnseenState","UserActivity"],function(a,b,c,d,e,f){var g=b('ChatActivity'),h=b('DocumentTitle'),i=b('JSLogger'),j=b('math-extensions'),k=b('MercuryThreadInformer'),l=b('MercuryNotificationRenderer'),m=b('PresenceState'),n=b('MercuryTimestampTracker'),o=b('MercuryUnseenState'),p=b('UserActivity'),q=i.create('chat_title'),r=null,s=0,t=false;function u(){if(r){r.stop();r=null;return true;}return false;}function v(aa){var ba=aa||n.getLastUserMessageTimestamp();if(s<=ba){s=ba;if(u()||t)m.doSync();}}var w={blink:function(aa,ba){if(!r&&s<ba)l.renderDocumentTitle(aa,function(ca){if(!r)r=h.blink(ca);});},stopBlinking:function(){v();},blinkingElsewhere:function(){t=true;}};function x(aa){var ba=j.verifyNumber(aa.sb2);if(!ba||ba<=s)return null;return ba;}function y(aa){var ba=aa&&x(aa);if(ba){s=ba;q.debug('load',s);u();t=false;}}function z(aa){var ba=x(aa);if(!ba){q.debug('store',s);aa.sb2=s;t=false;}return aa;}m.registerStateStorer(z);m.registerStateLoader(y);k.subscribe('thread-read-changed',function(aa,ba){var ca=n.getLastUserMessageTimestamp(),da=0;for(var ea in ba)if(ba[ea].mark_as_read&&ba[ea].timestamp>=ca&&ba[ea].timestamp>da)da=ba[ea].timestamp;da&&v(da);});g.subscribe('activity',function(){v();});(function(){var aa=m.getInitial();if(aa)s=x(aa)||0;})();e.exports=w;});
__d("ChatNewMessageHandler",["ChatActivity","ChatConfig","ChatBrowserNotificationHandler","ChatSound","ChatTabModel","ChatTabView","ChatTitleBarBlinker","JSLogger","MercuryAssert","MercuryThreads","MercuryUnseenState"],function(a,b,c,d,e,f){var g=b('ChatActivity'),h=b('ChatConfig'),i=b('ChatBrowserNotificationHandler'),j=b('ChatSound'),k=b('ChatTabModel'),l=b('ChatTabView'),m=b('ChatTitleBarBlinker'),n=b('JSLogger'),o=b('MercuryAssert'),p=b('MercuryThreads'),q=b('MercuryUnseenState'),r=n.create('chat_new_message');function s(u){p.changeThreadReadStatus(u,true);q.markThreadSeen(u);}var t={_raiseTab:function(u,v){var w=k.getTab(u),x=false;if(w){x=w.raised;}else{k.raiseTab(u,false);x=true;}v.to_new_tab=!w;v.to_raised_tab=!!x;},_notify:function(u,v,w){var x=l.get(u);w.view_is_visible=x&&x.isVisible();w.view_is_focused=x&&x.isFocused();if(!w.view_is_visible)r.log('message_to_hidden');var y=g.isActive();w.is_active=y;if(y){if(x){var z=false;if(h.get('chat_mark_read_on_focus')){z=x.isVisible()&&x.isFocused();}else{var aa=k.getTab(u).raised;z=x.isVisible()&&aa;}if(z)s(u);}if(!x||!x.isFocused())j.messageReceived(v);}else{m.blink(u,v.timestamp);i.display(v);j.messageReceived(v);}m.blinkingElsewhere();},newMessage:function(u,v){o.isThreadID(u);var w={thread_id:u,message_id:v.message_id};this._raiseTab(u,w);this._notify(u,v,w);r.log('message',w);}};e.exports=t;});
__d("ChatTabPolicy",["ChatBehavior","FBDesktopPlugin","JSLogger","MercuryAssert","MercuryParticipants","MercuryThreads","MercuryUnseenState","PresencePrivacy","ShortProfiles","MercuryConstants"],function(a,b,c,d,e,f){var g=b('ChatBehavior'),h=b('FBDesktopPlugin'),i=b('JSLogger'),j=b('MercuryAssert'),k=b('MercuryParticipants'),l=b('MercuryThreads'),m=b('MercuryUnseenState'),n=b('PresencePrivacy'),o=b('ShortProfiles'),p=c('MercuryConstants'),q=i.create('tab_policy');function r(s,t){m.markThreadSeen(s,t);}e.exports={messageIsAllowed:function(s,t,u){var v=s.thread_id,w=t.message_id;j.isThreadID(v);j.isParticipantID(t.author);var x;if(s.mode==p.MercuryThreadMode.OBJECT_ORIGINATED){x={thread_id:v,message_id:w,mode:s.mode};q.log('message_object_originated',x);return;}var y=p.MercurySourceType;if(t.source==y.EMAIL||t.source==y.TITAN_EMAIL_REPLY){x={thread_id:v,message_id:w,source:t.source};q.log('message_source_not_allowed',x);return;}var z=k.getUserID(t.author);if(!z){q.log('message_bad_author',{thread_id:v,message_id:w,user:z});return;}if(t.action_type!=p.MercuryActionType.USER_GENERATED_MESSAGE){x={thread_id:v,message_id:w,type:t.action_type};q.log('message_non_user_generated',x);return;}if(s.is_canonical_user&&!g.notifiesUserMessages()){q.log('message_jabber',{thread_id:v,message_id:w});r(v,true);return;}if(s.is_canonical_user&&h.shouldSuppressUserMessages()){q.log('message_desktop',{thread_id:v,message_id:w});return;}if(!s.is_canonical_group&&!s.is_canonical_live_listen&&s.folder!=p.MessagingTag.INBOX){q.log('message_folder',{thread_id:v,message_id:w,folder:s.folder});return;}o.get(z,function(aa){if(!n.allows(z)){q.log('message_privacy',{thread_id:v,message_id:w,user:z});return;}if(!s.is_canonical_group&&!s.is_canonical_live_listen)if(aa.type!='friend'){q.log('message_non_friend',{thread_id:v,message_id:w,user:z});return;}u();});}};},3);
__d("ChatTabController",["ChatTabPresence","Arbiter","AsyncRequest","ChatActivity","ChatConfig","ChatNewMessageHandler","ChatSound","ChatTabMessagesView","ChatTabModel","ChatTabPolicy","ChatTabView","ChatTabViewSelector","ChatTitleBarBlinker","Dialog","JSLogger","MercuryMessages","MercuryParticipants","MercuryServerRequests","MercuryThreadInformer","MercuryThreads","MercuryUnseenState","Style","UserAgent","VideoCallCore"],function(a,b,c,d,e,f){b('ChatTabPresence');var g=b('Arbiter'),h=b('AsyncRequest'),i=b('ChatActivity'),j=b('ChatConfig'),k=b('ChatNewMessageHandler'),l=b('ChatSound'),m=b('ChatTabMessagesView'),n=b('ChatTabModel'),o=b('ChatTabPolicy'),p=b('ChatTabView'),q=b('ChatTabViewSelector'),r=b('ChatTitleBarBlinker'),s=b('Dialog'),t=b('JSLogger'),u=b('MercuryMessages'),v=b('MercuryParticipants'),w=b('MercuryServerRequests'),x=b('MercuryThreadInformer'),y=b('MercuryThreads'),z=b('MercuryUnseenState'),aa=b('Style'),ba=b('UserAgent'),ca=b('VideoCallCore'),da=j.get('tab_auto_close_timeout')||7200000,ea=t.create('tab_controller');function fa(na){y.changeThreadReadStatus(na,true);ga(na);}function ga(na){z.markThreadSeen(na);}function ha(){var na=n.get();na.tabs.forEach(function(oa){var pa=p.get(oa.id);if(oa.raised&&pa&&pa.isVisible())fa(oa.id);});}function ia(){var na=n.get();na.tabs.forEach(function(oa){ga(oa.id);});}function ja(na,oa,pa){var qa=n.get().tabs;na+=oa?1:-1;while(na>=0&&na<qa.length){var ra=qa[na],sa=p.get(ra.id);if(sa&&sa.isVisible()&&(!pa||ra.raised)){sa.focus();return true;}na+=oa?1:-1;}return false;}function ka(na){function oa(ra){var sa=na.shouldPromoteOnRaise(ra);g.inform("chat/promote-tab",ra);if(sa){n.raiseAndPromoteTab(ra,true);}else n.raiseTab(ra,true);if(!j.get('chat_mark_read_on_focus'))fa(ra);var ta=p.get(ra);ta&&ta.focus();}function pa(ra,sa){var ta=n.get(),ua=na.getMaxTabsToShow(),va=n.indexOf(ra);n.closeTabAndDemote(ra,ua-2,sa);return va;}q.subscribe('selected',function(ra,sa){oa(sa);});g.subscribe('chat/open-tab',function(ra,sa){oa(sa.thread_id);});g.subscribe('page_transition',function(ra,sa){n.closeFragileTabs();});w.subscribe('model-update-completed',ia);if(!j.get('chat_mark_read_on_focus')){i.subscribe('activity',function(){na.checkWidth();ha();});na.subscribe('max-to-show-change-completed',function(){if(i.isActive())ha();});}else p.subscribe('focused',function(event,ra){fa(ra);});i.subscribe('idle',function(ra,sa){if(sa>da){var ta=n.get().tabs;ta.forEach(function(ua){var va=ua.id;y.getThreadMeta(va,function(wa){if(!wa.unread_count){ea.log('autoclose_idle_seen',{thread_id:va,idleness:sa});n.closeTab(va,'autoclose_idle_seen');}});});}});p.subscribe('nub-activated',function(ra,sa){oa(sa);});p.subscribe('lower-activated',function(ra,sa){n.lowerTab(sa);var ta=p.get(sa);ta&&ta.focus();fa(sa);});function qa(ra,sa){ca.showOutgoingCallDialog(sa.userID,sa.clickSource);n.lowerTab(sa.threadID);}p.subscribe('video-call-clicked',qa);m.subscribe('video-call-clicked',qa);p.subscribe('closed-tab',function(ra,sa){ea.log('close_view',{thread_id:sa});pa(sa,'close_view');fa(sa);return false;});p.subscribe('thread-deleted',function(ra,sa){ea.log('close_thread_deleted',{thread_id:sa});pa(sa,'close_thread_deleted');return false;});p.subscribe('unsubscribed',function(ra,sa){ea.log('close_view_unsubscribed',{thread_id:sa});pa(sa,'close_view_unsubscribed');return false;});p.subscribe('esc-pressed',function(ra,sa){ea.log('close_esc',{thread_id:sa});var ta=pa(sa,'close_esc');ja(ta-1,true,true)||ja(ta,false,true);});x.subscribe('messages-received',function(ra,sa){for(var ta in sa){var ua=sa[ta];for(var va=0;va<ua.length;va++){var wa=ua[va];if(wa.author!=v.user){if(!wa.is_unread){ea.log('message_already_read',{action_id:wa.action_id,thread_id:wa.thread_id});continue;}y.getThreadMeta(ta,function(xa){o.messageIsAllowed(xa,wa,function(){k.newMessage(ta,wa);});});}}}});x.subscribe('thread-read-changed',function(ra,sa){for(var ta in sa)if(!sa[ta].mark_as_read){ea.log('autoclose_marked_unread',{thread_id:ta});n.closeTab(ta,'autoclose_marked_unread');}});p.subscribe('tab-pressed',function(ra,sa){return !ja(n.indexOf(sa.id),sa.shiftPressed);});g.subscribe(t.DUMP_EVENT,function(ra,sa){sa.chat_controller={auto_close_timeout:da};});}if(ba.firefox()){var la=function(){return aa.get(document.body,'overflowX')+' '+aa.get(document.body,'overflowY');},ma=la();document.documentElement.addEventListener('DOMAttrModified',function(event){if(event.getTarget()===document.documentElement&&(event.attrName==='class'||event.attrName==='style')){var na=la();if(na!==ma){ma=na;g.inform('overflow-applied-to-body');}}},false);}e.exports=ka;});
__d("MercuryLiveListenHandler",["Arbiter","Bootloader","ChannelConstants","ChatSound","copyProperties","JSLogger","MercuryServerRequests","MusicConstants","MercuryConstants"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('Bootloader'),i=b('ChannelConstants'),j=b('ChatSound'),k=b('copyProperties'),l=b('JSLogger'),m=b('MercuryServerRequests'),n=b('MusicConstants'),o=a.MusicEvents,p=c('MercuryConstants'),q=l.create('live_listen_handler');function r(x,y,z,aa){var ba='live_listen:'+x.session_id,ca=x.session_id+':'+y+':'+z,da={action_id:null,action_type:p.MercuryActionType.LOG_MESSAGE,author:'fbid:'+y,folder:false,forward_count:0,is_unread:false,log_message_data:aa,log_message_type:p.MercuryLogMessageType.LIVE_LISTEN,message_id:ca,source:p.MercurySourceType.CHAT_WEB,thread_id:ba,threading_id:'',timestamp:z,timestamp_absolute:(new Date(z)).toLocaleString()},ea=p.MercuryPayloadSource.CLIENT_LIVE_LISTEN;m.handleUpdateWaitForThread({actions:[k({},da)],payload_source:ea},ba);}function s(x,y){q.log('end_session',{type:x,data:y});}function t(x,y){var z=y.actor,aa=y.session;if(aa&&z){q.log('listener_update',{type:x,data:y});var ba={actor:z,music_type:'listener_update'};r(aa,z.id,z.time*1000,ba);}}function u(x,y){var z=y.actor,aa=y.session;if(aa&&z&&z.time){q.log('begin_session',{type:x,data:y});var ba={actor:z,music_type:'begin_session'};r(aa,z.id,z.time*1000,ba);}}function v(x,y){var z=y.session,aa=y.song;if(z&&y.title&&y.body&&aa){q.log('play_error',{type:x,data:y});var ba={title:y.title,body:y.body,song:aa,music_type:'play_error'};r(z,z.leader,aa.published*1000,ba);}}function w(x,y){var z=y.session,aa=y.song?y.song:{};if(z&&aa.title&&aa.artist&&aa.artist_url&&aa.published&&aa.published>=z.creation_time){q.log('song_play',{type:x,data:y});var ba={title:aa.title,url:aa.url,artist:aa.artist,artist_url:aa.artist_url,music_type:'song'};r(z,z.leader,aa.published*1000,ba);}}o.subscribe([n.LIVE_LISTEN_OP.NOW_LEADING,n.LIVE_LISTEN_OP.NOW_LISTENING],u);o.subscribe([n.LIVE_LISTEN_OP.END_SESSION],s);o.subscribe([n.LIVE_LISTEN_OP.SONG_PLAYING],w);o.subscribe([n.LIVE_LISTEN_OP.LISTENER_UPDATE],t);o.subscribe([n.LIVE_LISTEN_OP.PLAY_ERROR],v);g.subscribe(i.getArbiterType('livelisten_update'),function(x,y){h.loadModules(['MusicLiveListen'],function(z){z.handleUpdate(y.obj);});});e.exports={};});
__d("MercuryStateCheck",["Arbiter","copyProperties","ChannelConnection","ChannelConstants","MercuryFolders","MercuryServerRequests","URI","MercuryConstants"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('copyProperties'),i=b('ChannelConnection'),j=b('ChannelConstants'),k=b('MercuryFolders'),l=b('MercuryServerRequests'),m=b('URI'),n=c('MercuryConstants'),o=h(new g(),{initialize:function(){g.subscribe(j.ON_INVALID_HISTORY,p);i.subscribe(i.CONNECTED,function(q,r){if(!r.init)p();});}});function p(){var q;if(m.getRequestURI().getPath().search(/webmessenger/)!==-1){q=k.getSupportedFolders();}else q=[n.MessagingTag.INBOX];l.fetchMissedMessages(q);}o.initialize();e.exports=o;});
__d("ChatTabViewCoordinator",["Arbiter","ChatConfig","ChatTabModel","ChatTabView","ChatTabViewSelector","CSS","VideoCallCore"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('ChatConfig'),i=b('ChatTabModel'),j=b('ChatTabView'),k=b('ChatTabViewSelector'),l=b('CSS'),m=b('VideoCallCore');function n(o,p){var q=new k(o),r={},s=false;function t(){var aa=i.get(),ba={};aa.tabs.forEach(function(da){ba[da.id]=1;});for(var ca in r)if(!ba[ca]){r[ca].destroy();delete(r[ca]);}u(aa);v(aa);}function u(aa){var ba=null;aa.tabs.forEach(function(ca){var da=ca.id,ea=false;if(!r[da]){r[da]=new j(da,ca.server_id);ea=true;}if(ea||!r[da].nextTabIs(ba))if(ba){r[da].insertBefore(ba);}else r[da].appendTo(o);ba=r[da];});}function v(aa){if(h.get('chat_show_more_tabs')){w(aa);}else x(aa);}function w(aa){var ba=p.getTabsToShow(aa),ca=[],da=false;aa.tabs.forEach(function(ea){if(!ba[ea.id]){r[ea.id].setVisibleState(false,ea.raised);ca.push(ea);}});aa.tabs.forEach(function(ea){if(ba[ea.id]){r[ea.id].setVisibleState(true,ea.raised);da|=ea.raised;}});q.setTabData(ca);z(da);}function x(aa){var ba=i.indexOf(aa.promoted),ca=p.getMaxTabsToShow(),da;if(ba==-1||ba<ca)ba=ca-1;var ea={};for(var fa=0;fa<aa.tabs.length;fa++){da=aa.tabs[fa].id;var ga=(fa<ca-1)||(fa==ba);if(ga){ea[da]=aa.tabs[fa].raised;}else r[da].setVisibleState(false,aa.tabs[fa].raised);}for(da in ea)r[da].setVisibleState(true,ea[da]);var ha=aa.tabs.slice(ca-1);ha.splice(ba-ca+1,1);q.setTabData(ha);var ia=y(aa);z(ia);}function y(aa){for(var ba=0,ca=aa.tabs.length;ba<ca;ba++){var da=aa.tabs[ba];if(da.raised)if(da.id===aa.promoted||ba<p.getMaxTabsToShow()-1)return true;}return false;}function z(aa){if(!aa&&s){g.inform('layer_hidden',{type:'ChatTab'});s=false;}else if(aa&&!s){g.inform('layer_shown',{type:'ChatTab'});s=true;}}if(m.isSupported())l.addClass(o,'videoCallEnabled');p.subscribe('tabs-changed',t);t();}e.exports=n;});
__d("TabsViewport",["event-extensions","ArbiterMixin","ChatConfig","ChatTabModel","Class","CSS","Dock","DOM","Parent","Vector","areObjectsEqual","copyProperties"],function(a,b,c,d,e,f){b('event-extensions');var g=b('ArbiterMixin'),h=b('ChatConfig'),i=b('ChatTabModel'),j=b('Class'),k=b('CSS'),l=b('Dock'),m=b('DOM'),n=b('Parent'),o=b('Vector'),p=b('areObjectsEqual'),q=b('copyProperties');function r(s){this._root=s;Event.listen(window,'resize',this._recalculateWidth.bind(this));l.subscribe('resize',this._recalculateWidth.bind(this));i.subscribe('chat/tabs-changed',this._recalculateTabs.shield(this,true));this._recalculateWidth();this._initialized=true;}q(r.prototype,g,{_root:null,_initialized:false,_availableWidth:0,_maxShown:1,_viewState:null,_recalculateWidth:function(){var s=r._getAvailableDockWidth(this._root),t=Math.max(1,Math.floor(s/264)),u=t!=this._maxShown;if(!this._viewState||u||s<=this._viewState.usedWidth||s>this._viewState.widthToShowNext){this._availableWidth=s;this._maxShown=t;this._viewState=null;this._recalculateTabs(u);}},_onTabsChanged:function(){if(this._initialized){this.inform('tabs-changed');this.inform('max-to-show-changed',this._maxShown);this.inform('max-to-show-change-completed');}},_recalculateTabs:function(s){var t=r._getTabsToShow(i.get(),this._availableWidth);if(s||!p(this._viewState,t)){this._viewState=t;this._onTabsChanged();}},getMaxTabsToShow:function(){return this._maxShown;},checkWidth:function(){this._recalculateWidth();},getTabsToShow:function(){return JSON.parse(JSON.stringify(this._viewState.tabsToShow));},shouldPromoteOnRaise:function(s){var t=i.indexOf(s);if(h.get('chat_show_more_tabs')){if(!this._viewState.tabsToShow[s])return true;if(this._viewState.nextToHide!=s)return false;var u=i.get().tabs[t].raised;return !u&&(this._availableWidth-this._viewState.usedWidth<100);}else return t==-1||t>=this._maxShown-1;}});q(r,{_getAvailableDockWidth:function(s){var t=o.getViewportDimensions().x;t-=230;t-=50;var u=n.byClass(s,'fbDock'),v=o.getElementDimensions(u),w=n.byClass(s,'fbDockChat'),x=o.getElementDimensions(w),y=v.x-x.x;t-=y;t-=20;return Math.max(t,0);},_getTabsToShow:function(s,t){var u=164,v=264;t=Math.max(t,v+1);function w(la){return la.raised?v:u;}var x=JSON.parse(JSON.stringify(s.tabs)),y=-1,z=null;if(s.promoted)x.forEach(function(la,ma){if(la.id===s.promoted){y=ma;z=la;}});var aa=0,ba=0,ca=!z;x.forEach(function(la,ma){var na=w(la);la.leftmostOffset=aa+v;aa+=na;if(la.leftmostOffset<t)ba++;ca|=ma==y;la.alreadyPlacedPromoted=ca;});function da(la,ma,na){var oa={};for(var pa=0;pa<ma;pa++){var qa=la[pa];if(!qa.alreadyPlacedPromoted&&pa==ma-1){oa[na]=true;}else oa[qa.id]=true;}return oa;}var ea=da(x,ba,s.promoted),fa=da(x,ba-1,s.promoted),ga=null;for(var ha in ea)if(!fa[ha])ga=ha;var ia=x[ba-1],ja=ia?ia.leftmostOffset:0,ka=Infinity;if(ba<x.length)ka=x[ba].leftmostOffset;return {nextToHide:ga,tabsToShow:ea,usedWidth:ja,widthToShowNext:ka};}});e.exports=r;});
__d("ChatApp",["MercuryChannelHandler","ChatTabController","MercuryLiveListenHandler","MercuryStateCheck","ChatTabViewCoordinator","MercuryServerRequests","TabsViewport"],function(a,b,c,d,e,f){b('MercuryChannelHandler');b('ChatTabController');b('MercuryLiveListenHandler');b('MercuryStateCheck');var g=b('ChatTabController'),h=b('ChatTabViewCoordinator'),i=b('MercuryServerRequests'),j=b('TabsViewport');e.exports=function(k,l){i.handleUpdate(l);this.tabsViewport=new j(k);this.tabController=new g(this.tabsViewport);this.tabViewCoordinator=new h(k,this.tabsViewport);};});